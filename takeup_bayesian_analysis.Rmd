---
title: "TakeUp Bayesian Analysis Notebook"
author:
- Anne Karing^[University of California Berkeley]
- Karim Naguib^[Evidence Action]
output:
  html_notebook:
    fig_align: "center"
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 5
header-includes:
   - \usepackage{bbm}
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r setup, include=FALSE}
library(magrittr)
library(purrr)
library(plyr)
library(dplyr)
library(multidplyr)
library(tibble)
library(tidyr)
library(lubridate)
library(forcats)
library(readr)
library(haven)
library(broom)
library(ggplot2)
library(ggrepel)
library(ggmap)
library(stringr)
library(knitr)
library(modelr)
library(rstan)

library(econometr)

source("takeup_rct_assign_clusters.R")
source("analysis_util.R")

knitr::read_chunk("analysis_util.R", labels = "analysis-util")

options(dplyr.show_progress = FALSE, digits = 4, mc.cores = max(1, parallel::detectCores()))
rstan_options(auto_write = TRUE)
```

```{r load-data, include=FALSE}
load(file.path("data", "analysis.RData"))
```

```{r name-match-priors}
name_match_false_pos_alpha <- 1
name_match_false_pos_beta <- 15

ggplot(tibble(x = c(0, 1)), aes(x)) + 
  stat_function(fun = . %>% dbeta(shape1 = name_match_false_pos_alpha, shape2 = name_match_false_pos_beta)) + 
  labs(x = "Probability of False Positive", y = "Density", title = "Prior Distribution for the Name Matching Model") +
  scale_x_continuous(breaks = seq(0, 1, 0.1))
```

```{r scale-prior-plots}
ggplot(tibble(x = c(0, 5)), aes(x)) + 
  stat_function(aes(color = "Cauchy"), fun = . %>% dcauchy(0, 2.5)) + 
  stat_function(aes(color = "Student t(2)"), fun = . %>% dt(2)) + 
  stat_function(aes(color = "Student t(4)"), fun = . %>% dt(4)) + 
  stat_function(aes(color = "Student t(7)"), fun = . %>% dt(7)) + 
  scale_x_continuous(breaks = seq(0, 5, 0.5))
```

```{r model-data}
stan_data <- analysis.data %>% 
  prepare_bayesian_analysis_data(
    treatment_formula = ~ assigned.treatment * sms.treatment.2 * phone_owner * hh.baseline.sample - assigned.treatment * hh.baseline.sample * sms.treatment.2 + assigned.treatment * phone_owner * hh.baseline.sample * name_matched,
    
    name_match_false_pos_alpha, 
    name_match_false_pos_beta)
```

```{r basic-model-0}
basic_model_0 <- stan_model(file = "takeup_model_0.stan", model_name = "model_0")
basic_model_0_fit <- sampling(basic_model_0, data = stan_data, chains = 2, iter = 50, sample_file = file.path("stanfit", "basic_model_0.csv"), control = lst(adapt_delta = 0.99, max_treedepth = 15))
```

```{r}
print(basic_model_0_fit, pars = c("cluster_effects", "missing_dewormed_any", "Sigma", "latent_utility", "cluster_effects_raw", "stratum_intercept_raw", "hyper_beta_raw", "beta_raw", "hyper_census_covar_coef_raw", "census_covar_coef_raw", "hyper_beta_census_covar_interact_raw", "beta_census_covar_interact_raw", "beta_census_covar_interact", "tau_beta_census_covar_interact"), include = FALSE)
```

```{r, eval=FALSE}
pairs(basic_model_0_fit, pars = c("hyper_baseline_takeup", "tau_stratum_intercept", "tau_cluster_effect", "tau_treatment[1]", "hyper_beta[1]"))
```

# Covariates Model

```{r covar-model-0, eval=FALSE}
covar_model_0 <- stan_model(file = "takeup_covar_model_0.stan", model_name = "covar_model_0")
covar_model_0_fit <- sampling(covar_model_0, data = stan_data, sample_file = file.path("stanfit", "covar_model_0.csv")) #, control = lst(adapt_delta = 0.99, max_treedepth = 15))
```

# Name Matching Model

```{r name-match-model-0, eval=FALSE}
name_match_model_0 <- stan_model(file = "name_matching.stan", model_name = "name_match_model_0")
name_match_model_0_fit <- sampling(name_match_model_0, iter = 4000, data = stan_data, sample_file = file.path("stanfit", "name_match_model_0.csv"), control = lst(adapt_delta = 0.99)) #, max_treedepth = 15))

print(name_match_model_0_fit)
```

# Model Parametrization

## Willingness-to-Pay

```{r wtp-stan-data}
incentive_choice_data <- analysis.data %>% 
  filter(!is.na(gift_choice) & gift_choice != "neither", 
         assigned.treatment == "control", 
         sms.treatment.2 == "sms.control") %>% 
  select(county, cluster.id, gift_choice) %>% 
  mutate(offer = 0,
         response = "keep") 

incentive_choice_data <- wtp.data %>% 
  filter(!is.na(first_choice)) %>% 
  transmute(county, cluster.id,
            gift_choice = first_choice,
            offer = price,
            response = second_choice) %>% 
  bind_rows(incentive_choice_data) %>% 
  left_join(stan_data$stratum_map, c("county" = "stratum")) %>% 
  mutate(gift_choice = 2 * (gift_choice == "calendar") - 1,
         response = 2 * (response == "switch") - 1) %>% 
         # gift_and_response = gift_choice * response) %>% 
  arrange(stratum_id, response)

wtp_stan_data <- lst(
  # gift_and_response_count = count(incentive_choice_data, gift_choice, response) %>% arrange(gift_choice, response),
  # 
  # gift_and_response_map = gift_and_response_count %>% select(-n),
  # num_gift_and_response_cells = nrow(gift_and_response_count),
  # gift_and_response_count = gift_and_response_count$n
  num_obs = nrow(incentive_choice_data),
  num_strata = n_distinct(incentive_choice_data$stratum_id),
  strata_sizes = count(incentive_choice_data, stratum_id) %>% arrange(stratum_id) %>% pull(n),
  gift_choice = incentive_choice_data$gift_choice,
  offer = incentive_choice_data$offer,
  response = incentive_choice_data$response,
  response_keep_size = num_obs - sum((1 + incentive_choice_data$response)/2),
  # gift_and_response = incentive_choice_data$gift_and_response
  
  tau_mu_diff = 100,
  mu_df_student_t = 7,
  tau_sigma_diff = 50,
  sigma_df_student_t = 2.5
)
```

```{r}
wtp_model_0 <- stan_model(file = "wtp_model.stan", model_name = "wtp_model_0")
wtp_model_0_fit <- sampling(wtp_model_0, data = wtp_stan_data, chains = 6, iter = 2000) 

print(wtp_model_0_fit)
```


## Calendar Private Utility

```{r}
calendar_param_stan_data <- analysis.data %>% 
  filter(assigned.treatment %in% c("control", "calendar"), 
         sms.treatment.2 == "sms.control",
         !phone_owner,
         true.monitored) %>% 
  prepare_bayesian_analysis_data(treatment_formula = ~ assigned.treatment * phone_owner)
```

```{r calendar-param-0}
param_model_0 <- stan_model(file = "takeup_param_model_0.stan", model_name = "param_model_0")
param_model_0_fit <- sampling(param_model_0, data = calendar_param_stan_data, chains = 4, iter = 2000, 
                              sample_file = file.path("stanfit", "param_model_0.csv"), control = lst(adapt_delta = 0.99, max_treedepth = 15))
```

```{r}
print(param_model_0_fit, pars = c("cluster_effects_raw", "cluster_effects", "latent_utility"), include = FALSE)
```

