---
title: "TakeUp Bayesian Analysis Notebook"
author:
- Anne Karing^[University of California Berkeley]
- Karim Naguib^[Evidence Action]
output:
  html_notebook:
    fig_align: "center"
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 5
header-includes:
   - \usepackage{bbm}
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r setup, include=FALSE}
library(magrittr)
library(purrr)
library(plyr)
library(dplyr)
library(multidplyr)
library(tibble)
library(tidyr)
library(lubridate)
library(forcats)
library(readr)
library(haven)
library(broom)
library(ggplot2)
library(ggrepel)
library(ggmap)
library(stringr)
library(knitr)
library(modelr)
library(rstan)

library(econometr)

source("takeup_rct_assign_clusters.R")
source("analysis_util.R")

knitr::read_chunk("analysis_util.R", labels = "analysis-util")

options(dplyr.show_progress = FALSE, digits = 4, mc.cores = max(1, parallel::detectCores()))
rstan_options(auto_write = TRUE)
```

```{r load-data, include=FALSE}
load(file.path("data", "analysis.RData"))
```

```{r name-match-priors}
name_match_false_pos_alpha <- 1
name_match_false_pos_beta <- 15

ggplot(tibble(x = c(0, 1)), aes(x)) + 
  stat_function(fun = . %>% dbeta(shape1 = name_match_false_pos_alpha, shape2 = name_match_false_pos_beta)) + 
  labs(x = "Probability of False Positive", y = "Density", title = "Prior Distribution for the Name Matching Model") +
  scale_x_continuous(breaks = seq(0, 1, 0.1))
```

```{r scale-prior-plots}
ggplot(tibble(x = c(0, 5)), aes(x)) + 
  stat_function(aes(color = "Cauchy"), fun = . %>% dcauchy(0, 2.5)) + 
  stat_function(aes(color = "Student t(2)"), fun = . %>% dt(2)) + 
  stat_function(aes(color = "Student t(4)"), fun = . %>% dt(4)) + 
  stat_function(aes(color = "Student t(7)"), fun = . %>% dt(7)) + 
  scale_x_continuous(breaks = seq(0, 5, 0.5))
```

```{r model-data}
stan_data <- analysis.data %>% 
  prepare_bayesian_analysis_data(
    wtp.data,
    treatment_formula = ~ assigned.treatment * sms.treatment.2 * phone_owner * hh.baseline.sample - assigned.treatment * hh.baseline.sample * sms.treatment.2 + assigned.treatment * phone_owner * hh.baseline.sample * name_matched,
    
    name_match_false_pos_alpha, 
    name_match_false_pos_beta,
    
    wtp_utility_df = 3,
    tau_mu_wtp_diff = 100,
    mu_wtp_df_student_t = 7,
    tau_sigma_wtp_diff = 50,
    sigma_wtp_df_student_t = 2.5,
  )
```

```{r basic-model-0}
basic_model_0 <- stan_model(file = "takeup_model_0.stan", model_name = "model_0")
basic_model_0_fit <- sampling(basic_model_0, data = stan_data, chains = 2, iter = 50, sample_file = file.path("stanfit", "basic_model_0.csv"), control = lst(adapt_delta = 0.99, max_treedepth = 15))
```

```{r}
print(basic_model_0_fit, pars = c("cluster_effects", "missing_dewormed_any", "Sigma", "latent_utility", "cluster_effects_raw", "stratum_intercept_raw", "hyper_beta_raw", "beta_raw", "hyper_census_covar_coef_raw", "census_covar_coef_raw", "hyper_beta_census_covar_interact_raw", "beta_census_covar_interact_raw", "beta_census_covar_interact", "tau_beta_census_covar_interact"), include = FALSE)
```

```{r, eval=FALSE}
pairs(basic_model_0_fit, pars = c("hyper_baseline_takeup", "tau_stratum_intercept", "tau_cluster_effect", "tau_treatment[1]", "hyper_beta[1]"))
```

# Covariates Model

```{r covar-model-0, eval=FALSE}
covar_model_0 <- stan_model(file = "takeup_covar_model_0.stan", model_name = "covar_model_0")
covar_model_0_fit <- sampling(covar_model_0, data = stan_data, sample_file = file.path("stanfit", "covar_model_0.csv")) #, control = lst(adapt_delta = 0.99, max_treedepth = 15))
```

# Name Matching Model

```{r name-match-model-0, eval=FALSE}
name_match_model_0 <- stan_model(file = "name_matching.stan", model_name = "name_match_model_0")
name_match_model_0_fit <- sampling(name_match_model_0, iter = 4000, data = stan_data, sample_file = file.path("stanfit", "name_match_model_0.csv"), control = lst(adapt_delta = 0.99)) #, max_treedepth = 15))

print(name_match_model_0_fit)
```

# Model Parametrization

## Willingness-to-Pay

```{r}
wtp_model_0 <- stan_model(file = "wtp_model.stan", model_name = "wtp_model_0")
wtp_model_0_fit <- sampling(wtp_model_0, data = stan_data, chains = 4, iter = 2000) 

print(wtp_model_0_fit)
```

## Calendar-Bracelet Private Utility

```{r}
calendar_param_stan_data <- analysis.data %>% 
  filter(assigned.treatment %in% c("control", "calendar", "bracelet"), 
         sms.treatment.2 == "sms.control",
         !phone_owner,
         true.monitored) %>% 
  mutate(assigned.treatment.2 = fct_collapse(assigned.treatment, private_value = c("calendar", "bracelet"))) %>% 
  prepare_bayesian_analysis_data(
    wtp.data, 
    treatment_formula = ~ assigned.treatment.2 * phone_owner,
    
    scale_df = 3,
    scale_sigma = 1,
    
    coef_df = 7,
    coef_sigma = 10,
    bracelet_val_coef_sigma = 100,
    
    wtp_utility_df = 3,
    tau_mu_wtp_diff = 100,
    mu_wtp_df_student_t = 7,
    tau_sigma_wtp_diff = 50,
    sigma_wtp_df_student_t = 2.5
  )
```

```{r calendar-param-0}
param_model_0 <- stan_model(file = "takeup_param_model_0.stan", model_name = "param_model_0")
param_model_0_fit <- sampling(param_model_0, data = calendar_param_stan_data, chains = 8, iter = 500, 
                              sample_file = file.path("stanfit", "param_model_0.csv"), control = lst(adapt_delta = 0.99, max_treedepth = 15))
```

```{r}
print(param_model_0_fit, pars = c("cluster_effects_raw", "cluster_effects", "latent_utility", "latent_bracelet_val_diff"), include = FALSE)
```

