---
title: "TakeUp Bayesian Analysis Notebook"
author:
- Anne Karing^[University of California Berkeley]
- Karim Naguib^[Evidence Action]
output:
  html_notebook:
    fig_align: "center"
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 5
header-includes:
   - \usepackage{bbm}
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r setup, include=FALSE}
library(magrittr)
library(purrr)
library(plyr)
library(dplyr)
library(multidplyr)
library(tibble)
library(tidyr)
library(lubridate)
library(forcats)
library(readr)
library(haven)
library(broom)
library(ggplot2)
library(ggrepel)
library(ggmap)
library(stringr)
library(knitr)
library(modelr)
library(rstan)

library(econometr)

source("takeup_rct_assign_clusters.R")
source("analysis_util.R")

knitr::read_chunk("analysis_util.R", labels = "analysis-util")

config <- yaml::yaml.load_file("../local_config.yaml")

options(dplyr.show_progress = FALSE, digits = 4, mc.cores = max(1, parallel::detectCores() - 1))
rstan_options(auto_write = TRUE)
```

```{r load-data, include=FALSE}
load(file.path("data", "analysis.RData"))
```

```{r basic-model-0}
basic_model_0 <- stan_model(file = "takeup_model_0.stan", model_name = "model_0")

stan_data <- analysis.data %>% 
  filter(sms.treatment.2 == "sms.control", !hh.baseline.sample) %>% 
  # filter(monitored, sms.treatment.2 == "sms.control", !hh.baseline.sample) %>% 
  mutate(new_cluster_id = factor(cluster.id) %>% as.integer(),
         obs_index = seq_len(n()),
         name_matched = !monitored,
         phone_owner = sms.treatment.2 != "sms.control" | sms.ctrl.subpop == "phone.owner") %>% 
  mutate_at(vars(county_dist_stratum, county_dist_mon_stratum, county), funs(id = as.integer)) %>% 
  arrange(county_id) %>% 
  (function(prepared_analysis_data, 
            treat_variables = lst(interact = c("assigned.treatment", "dist.pot.group"), direct_only = c("name_matched", "phone_owner")),
            exclude_from_eval = "name_matched") {
    treatment_map <- expand_(prepared_analysis_data, unlist(treat_variables, use.names = FALSE)) %>% 
      mutate(
        all_treatment_id = seq_len(n())) %>% 
      mutate_if(is.factor, funs(id = as.integer(.)))
    
    design_matrix_formula <- str_c(str_c(treat_variables$interact, collapse = "*"),
                                   str_c(treat_variables$direct_only, collapse = "+"), sep = "+") %>% 
      str_c("~", .) %>% 
      as.formula()
    
    treatment_map_design_matrix <- treatment_map %>%  
      model_matrix(design_matrix_formula) %>% # + hh.baseline.sample) %>% 
      magrittr::extract(, -1)
    
    # name_match_interact_design_matrix <- model_matrix(treatment_map, ~ assigned.treatment * dist.pot.group * name_matched * hh.baseline.sample) %>% 
    #   select(ends_with(":name_matchedTRUE"), ends_with(":hh.baseline.sampleTRUE"))
    
    prepared_analysis_data %<>% 
      left_join(treatment_map, unlist(treat_variables, use.names = FALSE)) 
    
    missing_treatment <- prepared_analysis_data %>% 
      ddply(., .(all_treatment_id), 
            function(treatment_group, all_obs) { 
              filter(all_obs, all_treatment_id != treatment_group$all_treatment_id[1]) %>% 
                select(obs_index)
            }, 
            all_obs = .)
    
    if (!is.null(exclude_from_eval)) {
      eval_treatment_prop_id <- filter_(treatment_map, sprintf("%s == 0", exclude_from_eval)) %$% all_treatment_id
    } else {
      eval_treatment_prop_id <- treatment_map$all_treatment_id
    }
    
    lst(
      treatment_map,
      
      county_map = distinct(prepared_analysis_data, county_id, county),
      cluster_map = distinct(prepared_analysis_data, new_cluster_id, cluster.id),
      
      treatment_map_design_matrix,
      num_all_treatments = nrow(treatment_map_design_matrix),
      num_all_treatment_coef = ncol(treatment_map_design_matrix), 
      
      obs_treatment = prepared_analysis_data$all_treatment_id,
    
      treatment_id = prepared_analysis_data %>% 
        arrange(all_treatment_id, obs_index) %$% 
        obs_index,
      
      missing_treatment_id = missing_treatment %>% 
        arrange(all_treatment_id) %$% 
        obs_index,
      
      eval_treatment_prop_id,
      num_eval_treatment_prop = length(eval_treatment_prop_id),
      
      num_obs = length(obs_treatment), 
      num_missing = nrow(missing_treatment),
      
      treatment_sizes = count(prepared_analysis_data, all_treatment_id) %>% arrange(all_treatment_id) %$% n,
      missing_treatment_sizes = count(missing_treatment, all_treatment_id) %>% arrange(all_treatment_id) %$% n,
      
      dewormed_any = prepared_analysis_data$dewormed.any,
      
      cluster_id = prepared_analysis_data$new_cluster_id,
      stratum_id = distinct(prepared_analysis_data, new_cluster_id, county_id) %>% 
        arrange(new_cluster_id) %$% 
        county_id,
      num_clusters = n_distinct(cluster_id),
      
      num_strata = n_distinct(stratum_id),
      strata_sizes = count(prepared_analysis_data, county_id) %>% arrange(county_id) %$% n 
    )
  }) 
```

```{r}
basic_model_0_fit <- sampling(basic_model_0, data = stan_data, chains = 4, sample_file = file.path("stanfit", "basic_model_0.csv")) #, control = lst(adapt_delta = 0.99, max_treedepth = 15))
# basic_model_0_fit <- sampling(basic_model_0, data = stan_data, chains = 1, iter = 1000) #, control = lst(adapt_delta = 0.99, max_treedepth = 15))

print(basic_model_0_fit, pars = c("cluster_effects", "missing_dewormed_any", "Sigma_beta"), include = FALSE)
```
