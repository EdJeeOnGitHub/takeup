---
title: "TakeUp Bayesian Analysis Notebook"
author:
- Anne Karing^[University of California Berkeley]
- Karim Naguib^[Evidence Action]
output:
  html_notebook:
    fig_align: "center"
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 5
header-includes:
   - \usepackage{bbm}
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r bayes-setup, include=FALSE}
library(magrittr)
library(purrr)
library(plyr)
library(dplyr)
library(multidplyr)
library(tibble)
library(tidyr)
library(lubridate)
library(forcats)
library(readr)
library(haven)
library(broom)
library(ggplot2)
library(ggrepel)
library(ggmap)
library(stringr)
library(knitr)
library(modelr)
library(rstan)

library(econometr)

source("takeup_rct_assign_clusters.R")
source("analysis_util.R")

knitr::read_chunk("analysis_util.R", labels = "analysis-util")

options(dplyr.show_progress = TRUE, digits = 4) #, mc.cores = max(1, parallel::detectCores()))
```

```{r parallel-setup}
num_cores <- tryCatch({
  yaml::yaml.load_file("../local_config.yaml") %$% cores
}, error = function(err) parallel::detectCores())

cl <- parallel::makeCluster(max(1, num_cores))
# doMC::registerDoMC(max(1, parallel::detectCores() - 1))
# doParallel::registerDoParallel(cores = config$cores)
doParallel::registerDoParallel(cl)
```

```{r rstan-setup}
options(mc.cores = max(1, parallel::detectCores()))
rstan_options(auto_write = TRUE)
```

```{r load-bayes-data, include=FALSE}
load(file.path("data", "analysis.RData"))
```

# Common Notation

Subscripts:

* $i$: individuals
* $j$: clusters
* $k$: strata (counties)

Randomized treatment variables:

* Incentives/signals are split into
    - Private incentives: $Z^p_j \in \mathcal{Z}^p = \{\text{control, calendar, bracelet}\}$
    - Social incentives: $Z^r_j \in \mathcal{Z}^r = \{\text{control, ink, bracelet}\}$
* Assigned distance to treatment location: $D_j \in \{0, 1\}$ is an indicator of being assigned _far_ treatment (vs. _close_).
* SMS treatment: $S_i \in \mathcal{S} = \{\text{control, reminders-only, social-info}\}$ 
* Baseline survey indicator: $B_i = \{0, 1\}$.

For convenience, define:

* $T_i \equiv (Z^p_{j[i]}, Z^r_{j[i]}, D_{j[i]}, S_i, B_i)'$ be a vector of all randomly assigned treatments. 
* $\widetilde{\mathcal{Z}}^p \equiv \mathcal{Z}^p \setminus \{control\}$, $\widetilde{\mathcal{Z}}^r \equiv \mathcal{Z}^r \setminus \{control\}$, and $\widetilde{\mathcal{S}} \equiv \mathcal{S} \setminus \{control\}$

Furthermore:

* Phone ownership subgroup: $H_i = \{0, 1\}$.
* Controls/covariates vector: $X_i$.
* Deworming outcome: $Y_i(t) \in \{0, 1\}$, in response to randomly assigned treatment.

# Willingness-to-Pay
Let

* $V^c_i$ and $V^b_i$ be an individual's monetary valuation of calendars and bracelets, respectively.
* $G_i \in \{0, 1\}$ indicates initial gift choice of calendar (vs bracelet). Also, let $\widetilde{G}_i \equiv 2\cdot G_i - 1$.
* $M_i \in \{0, 10, 20,\ldots, 100\}$ be the randomly assigned offer (in Ksh) to switch gifts choice (calendar instead of bracelet and v.v.)
* $W_i(m) \in \{0, 1\}$ indicates accepting $m$ Ksh to switch gift choice.

$$
\begin{align}
V_i = V^c_i - V^b_i &\sim \mathcal{StudentT}(\nu_v, \mu_{j[i]}, \sigma) \\
\mu_j &\sim \mathcal{StudentT}(\nu_\mu, \mu, \tau_\mu) \\
\mu &\sim \mathcal{StudentT}(\nu_\mu, 0, \tau_\mu) \\
\sigma &\sim \mathcal{StudentT}[0, \infty](\nu_\sigma, 0, \tau_\sigma)
\end{align}
$$

with fixed hyperparameters: $\nu_v, \nu_\mu, \nu_\sigma, \tau_\mu, \tau_\sigma$.

We estimate our model parameters using the likelihood probability:

$$
\mathcal{L}_i = \left\{\widetilde{G}\cdot [F_V(\widetilde{G}_i M_i|\mu, \mu_{j[i]}, \sigma) - F_V(0|\mu, \mu_{j[i]}, \sigma)]\right\}^{W_i}\cdot\left\{ F_V(\widetilde{G}_i M_i|\mu, \mu_{j[i]}, \sigma)\right\}^{(1 - W_i)} 
$$

```{r wtp-stan-data, warning=FALSE}
wtp_stan_data <- analysis.data %>% 
  mutate(stratum = county) %>% 
  prepare_bayes_wtp_data(
    wtp.data,
    
    wtp_utility_df = 3,
    tau_mu_wtp_diff = 100,
    mu_wtp_df_student_t = 7,
    tau_sigma_wtp_diff = 50,
    sigma_wtp_df_student_t = 2.5
  )
```


```{r wtp-sim-run, eval=FALSE}
wtp_model_0 <- stan_model(file = "wtp_model.stan", model_name = "wtp_model_0")
wtp_model_0_fit <- sampling(wtp_model_0, data = wtp_stan_data, chains = 8, iter = 800, sample_file = file.path("stanfit", "wtp_model.csv")) 
```

```{r load-wtp-fit}
wtp_model_0_fit <- dir("stanfit", pattern = "wtp_model_[1-8].csv", full.names = TRUE) %>% 
  read_stan_csv()
```

```{r}
print(wtp_model_0_fit, pars = c("sim_gift_choice", "sim_wtp_response"), include = FALSE)
```

```{r prepare-wtp-sim-data}
wtp_sim_data <- as.data.frame(wtp_model_0_fit, pars = c("sim_gift_choice", "sim_wtp_response")) %>% 
  mutate(run_id = seq_len(n())) %>% 
  gather(outcome_id, sim_outcome, -run_id) %>% 
  separate(outcome_id, c("outcome", "obs_id"), "(\\[)|\\]", extra = "drop") %>% 
  mutate_at(vars(obs_id), as.integer) 
```

```{r wtp-model-check-plot}
wtp_sim_data %>% 
  mutate(sim_outcome = (sim_outcome + 1) / 2) %>% 
  group_by(run_id, outcome) %>% 
  summarize(mean_sim_outcome = mean(sim_outcome)) %>% 
  ggplot() +
  scale_color_discrete("", labels = c("Proportion prefer calendars", "Proportion switch")) +
  scale_x_continuous("") +
  geom_vline(xintercept = mean((wtp_stan_data$gift_choice + 1) / 2), linetype = "dashed") +
  geom_vline(xintercept = mean((wtp_stan_data$wtp_response + 1) / 2), linetype = "dashed") +
  geom_density(aes(x = mean_sim_outcome, color = outcome)) +
  labs(title = "Simulated vs Observed WTP Outcomes", subtitle = "Initial gift choice and response to an offer to switch") +
  theme(legend.position = "bottom")
```

# Private/Social Value Parameterized Model

The probability of take-up is
$$
\Pr[Y_i = 1 | T_i = t, H_i, X_i] = \Pr[Y_i(t) = 1 |H_i, X_i] = \Pr[Y^*_i(t) > 0 |H_i, X_i]
$$

where the latent utility is:

$$
\begin{align}
Y^*_i(t | H_i = h, X_i = x) &= \alpha_0 + \alpha^{clust}_{j[i]} + \alpha^{strat}_{k[i]} + U(t, h;\beta_{k[i]}) + x'\delta + \varepsilon_i \\\\
U(t, h; \beta) &= U(z^p, z^r, d, s, b, h; \beta) \\
               &= \sum_{w\in\widetilde{Z}^p} \left\{Z^p_w(z^p)\times\beta^p_{w1} + Z^p_w(z^p)\times h\times\beta^p_{w2}\right\} \\
                                                {} &+ \sum_{w\in\widetilde{Z}^r} \left\{Z^r_w(z^r)\times\beta^r_{w1} + Z^r_w(z^r)\times h\times\beta^r_{w2} + Z^r_w(z^r)\times d \times \beta^r_{w3} + Z^r_w(z^r)\times h\times d\times\beta^r_{w4} + Z^r_w(z^r)\times b \times \beta^r_{w5} + Z^r_w(z^r)\times h\times b\times\beta^r_{w6}\right\} \\
                                                {} &+ \sum_{w\in\widetilde{S}} \left\{S_w(s)\times\beta^s_{w1} + S_w(s)\times h\times\beta^s_{w2} + S_w(s)\times d \times \beta^s_{w3} + S_w(s)\times h\times d\times\beta^s_{w4} + S_w(S)\times b \times \beta^s_{w5} + S_w(s)\times h\times b\times\beta^s_{w6}\right\} \\
                                                {} &+ \sum_{u\in\widetilde{Z}^r}\sum_{w\in\widetilde{S}} Z^r_u(z^r) \times \left\{S_w(s)\times\beta^{rs}_{uw1} + S_w(s)\times h\times\beta^{rs}_{uw2} + S_w(s)\times d \times \beta^{rs}_{uw3} + S_w(s)\times h\times d\times\beta^{rs}_{uw4} + S_w(S)\times b \times \beta^{rs}_{uw5} + S_w(s)\times h\times b\times\beta^{rs}_{uw6}\right\} \\
                                                {} &+ h\times \beta^h + d\times \beta^d + b\times\beta^b 
\end{align}
$$

with priors

$$
\begin{align}
\alpha_0 &\sim \mathcal{Uniform}(0, 1) \\
\alpha^{clust}_j &\sim \mathcal{StudentT}(\nu^{coef}, 0, \tau^{clust}) \\
\alpha^{strat}_k &\sim \mathcal{StudentT}(\nu^{coef}, 0, \tau^{strat}) \\
\delta &\sim \mathcal{StudentT}\left(\nu^{coef}, 0, \begin{pmatrix} \sigma^{coef} & 0             & \cdots & 0  \\
                                                     0             & \sigma^{coef} & \cdots & 0 \\ 
                                                     \vdots        &               & \ddots &   \\
                                                     0             &               &        & \sigma^{coef} \end{pmatrix}\right) \\\\
\beta &\sim \mathcal{StudentT}\left(\nu^{coef}, 0, \begin{pmatrix} \sigma^{coef} & 0             & \cdots & 0  \\
                                                     0             & \sigma^{coef} & \cdots & 0 \\ 
                                                     \vdots        &               & \ddots &   \\
                                                     0             &               &        & \sigma^{coef} \end{pmatrix}\right) \\\\
\beta_k &\sim \mathcal{StudentT}\left(\nu^{coef}, \beta, \begin{pmatrix} \tau_1 & 0             & \cdots & 0  \\
                                                     0             & \tau_2 & \cdots & 0 \\ 
                                                     \vdots        &               & \ddots &   \\
                                                     0             &               &        &  \end{pmatrix}\right)
\end{align}
$$

and hyper-priors

$$
\tau^{clust} \sim \mathcal{StudentT}[0,\infty](\nu^{scale}, 0, \sigma^{scale}) \\ 
\tau^{strat} \sim \mathcal{StudentT}[0,\infty](\nu^{scale}, 0, \sigma^{scale}) \\
\tau \sim \mathcal{StudentT}[0,\infty](\nu^{scale}, 0, \sigma^{scale}) 
$$

With constant hyperparameters: $\nu^{coef}, \nu^{scale}, \sigma^{coef}, \sigma^{scale}$.

## Inference

```{r static-model-ate}
param_sms_control_ate <- tribble(
  ~ private_value_left, ~ social_value_left, ~ private_value_right, ~ social_value_right,
  "control",            "ink",               "control",             "control",
  "calendar",           "control",           "control",             "control",
  "bracelet",           "bracelet",          "control",             "control",
  "bracelet",           "bracelet",          "calendar",            "control",
  
  "control",           "bracelet",           "control",            "control" 
) %>%
  bind_rows("close" = ., "far" = ., .id = "dist.pot.group") %>% 
  bind_rows(`TRUE` = ., `FALSE` = ., .id = "phone_owner") %>%
  mutate(sms.treatment.2_left = "sms.control", sms.treatment.2_right = "sms.control",
         phone_owner = as.logical(phone_owner),
         hh.baseline.sample = FALSE) 

param_phone_owners_ate <- tribble(
  ~ private_value_left, ~ social_value_left, ~ sms.treatment.2_left, ~ private_value_right, ~ social_value_right, ~ sms.treatment.2_right,
  "control",            "control",           "reminder.only",        "control",             "control",            "sms.control",
  "control",            "control",           "social.info",          "control",             "control",            "sms.control",
  "control",            "control",           "social.info",          "control",             "control",            "reminder.only",

  "control",            "ink",               "social.info",          "control",             "control",            "sms.control",
  "control",            "ink",               "social.info",          "control",             "control",            "social.info",
  "control",            "ink",               "social.info",          "control",             "ink",                "sms.control",

  "calendar",           "control",           "social.info",          "control",             "control",            "sms.control",
  "calendar",           "control",           "social.info",          "control",             "control",            "social.info",
  "calendar",           "control",           "social.info",          "calendar",            "control",            "sms.control",

  "bracelet",           "bracelet",          "social.info",          "control",             "control",            "sms.control",
  "bracelet",           "bracelet",          "social.info",          "control",             "control",            "social.info",
  "bracelet",           "bracelet",          "social.info",          "calendar",            "control",            "social.info",
  "bracelet",           "bracelet",          "social.info",          "bracelet",            "bracelet",           "sms.control",
  
  "control",           "bracelet",           "social.info",          "control",             "control",            "sms.control",
  "control",           "bracelet",           "social.info",          "control",             "control",            "social.info",
  "control",           "bracelet",           "social.info",          "calendar",            "control",            "social.info",
  "control",           "bracelet",           "social.info",          "bracelet",            "control",            "sms.control"
) %>%
  bind_rows("close" = ., "far" = ., .id = "dist.pot.group") %>%
  mutate(phone_owner = TRUE,
         hh.baseline.sample = FALSE) 

param_all_ate <- bind_rows(param_sms_control_ate, param_phone_owners_ate) 
```

We are interested in estimating the finite sample average treatment effect

$$
\tau(t', t; h) = \frac{1}{N}\sum_{i: H_i = h}^N Y_i(t') - Y_i(t) = \frac{1}{N}\sum_{i: H_i = h}^N \widehat{Y}_i(t') - \widehat{Y}_i(t)
$$
where substitute $\widehat{Y}_i(t)$ with either the observed or imputed value of $Y_i(t)$. Below are the ATE in take-up we are interested in estimating (at this point).  

```{r}
param_all_ate %>% 
  select(phone_owner, dist.pot.group, private_value_left, social_value_left, sms.treatment.2_left, private_value_right, social_value_right, sms.treatment.2_right) %>% 
  mutate_at(vars(starts_with("sms")), funs(fct_recode(., control = "sms.control"))) %>% 
  kable(col.names = c("Phone Owner", "Distance", sprintf(c("Private Value (%s)", "Social Value (%s)", "SMS (%s)"), rep(c("L", "R"), each = 3))))
```

```{r static-model-stan-data, warning=FALSE}
param_stan_data <- analysis.data %>%
  mutate(private_value = fct_collapse(assigned.treatment, control = c("control", "ink")),
         social_value = fct_collapse(assigned.treatment, control = c("control", "calendar"))) %>% 
  prepare_bayesian_analysis_data(
    wtp.data, 
    
    treatment_map = data_grid(., private_value, social_value, dist.pot.group, sms.treatment.2, hh.baseline.sample, phone_owner) %>%
      filter(phone_owner | sms.treatment.2 == "sms.control",
            (private_value == "control" & social_value == "control") | sms.treatment.2 != "reminder.only",
            private_value != "calendar" | social_value == "control",
            private_value != "bracelet" | social_value == "bracelet"),
    
    treatment_formula = ~ (private_value + social_value * sms.treatment.2 * (dist.pot.group + hh.baseline.sample)) * phone_owner,
    
    subgroup_col = NULL,
    
    all_ate = param_all_ate,
    
    # name_match_false_pos_alpha, 
    # name_match_false_pos_beta,
    
    scale_df = 3,
    scale_sigma = 1,
    # real scale_sigma_ksh_util_gamma = 0.05;
  
    coef_df = 7,
    coef_sigma = 5,
    
    wtp_utility_df = 3,
    tau_mu_wtp_diff = 100,
    mu_wtp_df_student_t = 7,
    tau_sigma_wtp_diff = 50,
    sigma_wtp_df_student_t = 2.5,
    sigma_ksh_util_gamma = 5,
  )
```

```{r basic-model-1, eval=FALSE}
basic_model_1 <- stan_model(file = "takeup_model_1.stan", model_name = "model_1")
basic_model_1_fit <- sampling(basic_model_1, data = param_stan_data, chains = 8, iter = 400, sample_file = file.path("stanfit", "basic_model_1_12.csv"), control = lst(max_treedepth = 15)) # adapt_delta = 0.99, 
```

```{r load-static-model-fit, echo=TRUE}
basic_model_1_fit <- dir("stanfit", pattern = "basic_model_1_13_[1-8].csv", full.names = TRUE) %>% 
  read_stan_csv()

basic_model_1_fit %>% 
  get_sampler_params(inc_warmup = FALSE) %>% 
  map_dbl(~ sum(magrittr::extract(.x, , "divergent__"))) %>% 
  sum()

load(file.path("stan_analysis_data", "model_1_13.RData"))
```

```{r, eval=FALSE}
print(basic_model_1_fit, pars = c("treatment_cell_takeup"))
```

```{r basic-model-1-prep-data}
treatment_cell_size <- with(param_stan_data, missing_treatment_sizes + observed_treatment_sizes)

est_deworming_takeup_ate <- basic_model_1_fit %>% 
  as.data.frame(pars = c("treatment_cell_ate")) %>% 
  mutate(iter_id = seq_len(n())) %>% 
  gather(ate_pair_rank, sim_outcome, -iter_id) %>% 
  mutate(ate_pair_rank = str_extract(ate_pair_rank, "\\d+") %>% as.integer()) %>% 
  bind_cols(param_stan_data$ate_pairs[.$ate_pair_rank, ]) %>%
  mutate(all_treatment_id_left = param_stan_data$ate_treatments[rank_id_left],
         all_treatment_id_right = param_stan_data$ate_treatments[rank_id_right],
         treatment_size_left = treatment_cell_size[rank_id_left],
         treatment_size_right = treatment_cell_size[rank_id_right]) 

assertthat::assert_that(is_empty(setdiff(c(all_treatment_id_left, all_treatment_id_right), param_stan_data$ate_treatments)), env = est_deworming_takeup_ate)
assertthat::assert_that(all(treatment_size_left == treatment_size_right), env = est_deworming_takeup_ate)

num_raw_takeup_ate <- nrow(est_deworming_takeup_ate)

est_deworming_takeup_ate %<>% 
  left_join(param_stan_data$treatment_map, c("all_treatment_id_left" = "all_treatment_id")) %>% 
  left_join(param_stan_data$treatment_map, c("all_treatment_id_right" = "all_treatment_id"), suffix = c("_left", "_right")) %>% 
  select(-matches("_id_(left|right)$"))

assertthat::assert_that(num_raw_takeup_ate == nrow(est_deworming_takeup_ate),
                        env = est_deworming_takeup_ate)

est_deworming_takeup_ate %<>% 
  filter(sms.treatment.2_right %in% c("sms.control", "social.info"),
         private_value_right == "control" | (private_value_right == private_value_left & social_value_right == social_value_left & sms.treatment.2_left == "social.info" & sms.treatment.2_right == "sms.control"),
         social_value_right == "control" | (private_value_right == private_value_left & social_value_right == social_value_left & sms.treatment.2_left == "social.info" & sms.treatment.2_right == "sms.control"),
         private_value_left != "control" | social_value_left != "control" | sms.treatment.2_left != "sms.control") 

prepare_est_ate <- function(est_data, subgroups = NULL) { 
  est_data %>% 
    group_by_at(c(vars(matches("((private|social)_value|sms.treatment.2)_(left|right)"), iter_id), subgroups)) %>% 
    summarize(wtd_sim_outcome = weighted.mean(sim_outcome, treatment_size_left)) %>% 
    ungroup() %>% 
    group_by_at(c(vars(matches("((private|social)_value|sms.treatment.2)_(left|right)")), subgroups)) %>% 
    summarize(mean_ate = mean(wtd_sim_outcome),
              ub_90 = quantile(wtd_sim_outcome, 0.95),
              ub_95 = quantile(wtd_sim_outcome, 0.975),
              lb_90 = quantile(wtd_sim_outcome, 0.05),
              lb_95 = quantile(wtd_sim_outcome, 0.025)) %>% 
    ungroup() %>% 
    unite(incentive_treatment_left, str_c(c("private", "social"), "_value_left"), sep = "-", remove = FALSE) %>% 
    unite(incentive_treatment_right, str_c(c("private", "social"), "_value_right"), sep = "-", remove = FALSE) %>% 
    mutate_at(vars(matches("incentive_treatment_left")), 
              funs(fct_relevel(factor(.), "control-control", "control-ink", "calendar-control", "control-bracelet", "bracelet-bracelet")))
}

phone_est_deworming_takeup_ate <- est_deworming_takeup_ate %>% prepare_est_ate("phone_owner_left")
dist_pot_est_deworming_takeup_ate <- est_deworming_takeup_ate %>% prepare_est_ate("dist.pot.group_left")
phone_dist_pot_est_deworming_takeup_ate <- est_deworming_takeup_ate %>% prepare_est_ate(c("phone_owner_left", "dist.pot.group_left"))
est_deworming_takeup_ate %<>% prepare_est_ate()

est_deworming_takeup <- basic_model_1_fit %>% 
  as.data.frame(pars = "treatment_cell_takeup") %>% 
  mutate(iter_id = seq_len(n())) %>% 
  gather(treatment_rank, sim_outcome, -iter_id) %>% 
  mutate(treatment_rank = str_extract(treatment_rank, "\\d+") %>% as.integer()) %>% 
  mutate(all_treatment_id = param_stan_data$ate_treatments[treatment_rank],
         treatment_size = treatment_cell_size[treatment_rank])

num_raw_takeup <- nrow(est_deworming_takeup)

est_deworming_takeup %<>% 
  left_join(param_stan_data$treatment_map, "all_treatment_id") 

assertthat::assert_that(num_raw_takeup == nrow(est_deworming_takeup), env = est_deworming_takeup)

prepare_est_takeup <- function(est_data, subgroups = NULL) { 
  est_data %>%
    group_by_at(c(vars(matches("((private|social)_value|sms.treatment.2)"), iter_id), subgroups)) %>% 
    summarize(wtd_sim_outcome = weighted.mean(sim_outcome, treatment_size)) %>% 
    ungroup() %>% 
    group_by_at(c(vars(matches("((private|social)_value|sms.treatment.2)")), subgroups)) %>% 
    summarize(mean_takeup_prop = mean(wtd_sim_outcome),
              ub_90 = quantile(wtd_sim_outcome, 0.95),
              ub_95 = quantile(wtd_sim_outcome, 0.975),
              lb_90 = quantile(wtd_sim_outcome, 0.05),
              lb_95 = quantile(wtd_sim_outcome, 0.025)) %>% 
    ungroup() %>% 
    unite(incentive_treatment, str_c(c("private", "social"), "_value"), sep = "-", remove = FALSE) %>% 
    mutate(incentive_treatment = fct_relevel(incentive_treatment, "control-control", "control-ink", "calendar-control", "control-bracelet", "bracelet-bracelet"))
}

phone_est_deworming_takeup <- est_deworming_takeup %>% prepare_est_takeup("phone_owner")
dist_pot_est_deworming_takeup <- est_deworming_takeup %>% prepare_est_takeup("dist.pot.group")
phone_dist_pot_est_deworming_takeup <- est_deworming_takeup %>% prepare_est_takeup(c("phone_owner", "dist.pot.group"))
est_deworming_takeup %<>% prepare_est_takeup()
```

```{r static-model-ate-plot, fig.height=6, fig.width=12}
plot_static_est_ate <- . %>% 
  mutate(incentive_treatment_left = fct_relabel(incentive_treatment_left, . %>% str_replace( "-?control-?", "") %>% str_to_title()),
         ref = if_else(incentive_treatment_right == "control-control" & sms.treatment.2_right == "sms.control", 
                       "control-sms.control", 
                       if_else(sms.treatment.2_right == "sms.control", "own sms.control", "control-social.info")),
         ref = fct_relevel(ref, "control-sms.control", "own sms.control", "control-social.info")) %>% {
    ggplot(., aes(incentive_treatment_left, mean_ate, color = sms.treatment.2_left, shape = ref)) +
      geom_pointrange(aes(ymin = lb_95, ymax = ub_95), size = 0.5, fatten = 6, position = position_dodge(width = 0.4)) +
      geom_linerange(aes(ymin = lb_90, ymax = ub_90), size = 1.25, position = position_dodge(width = 0.4)) +
      geom_hline(yintercept = 0, linetype = "dotted") +
      geom_text_repel(aes(label = sprintf("%.2f", mean_ate), color = NULL), nudge_x = 0.3, size = 3, segment.colour = NA) +
      scale_shape_discrete("Reference", labels = c("Control, No SMS", "Same Arm, No SMS", "Control, Social Info")) +
      scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
      labs(title = "Treatment Effect on Deworming Take-up", 
           x = "Incentive/Signal Treatment", 
           y = "Posterior Difference in Probability of Deworming", 
           caption = "Points on plot are the mean point estimates.\nThe thick and thin vertical lines show the 90% and 95% posterior probability ranges, respectively.") +
      coord_flip() +
      theme(axis.text.x = element_text(angle = 25, hjust = 1))
  }

plot_static_est_ate(est_deworming_takeup_ate) 
```

```{r static-model-phone-ate-plot, fig.height=10, fig.width=10}
phone_est_deworming_takeup_ate %>%
  mutate(phone_owner_left = if_else(phone_owner_left, "Phone Owners", "Non-Phone Owners")) %>% 
  plot_static_est_ate() +
  facet_wrap(~ phone_owner_left, ncol = 1, scales = "free_y", drop = TRUE)
```

```{r static-model-dist-ate-plot, fig.height=10, fig.width=10}
dist_pot_est_deworming_takeup_ate %>%
  plot_static_est_ate() +
  facet_wrap(~ dist.pot.group_left, ncol = 1,
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)))) 
```

```{r static-model-phone-dist-ate-plot, fig.height=15, fig.width=10}
phone_dist_pot_est_deworming_takeup_ate %>%
  mutate(phone_owner_left = if_else(phone_owner_left, "Phone Owners", "Non-Phone Owners")) %>% 
  plot_static_est_ate() +
  facet_wrap(~ dist.pot.group_left + phone_owner_left, ncol = 1, scales = "free_y",
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)))) 
```

```{r static-model-takeup-plot, fig.height=4, fig.width=12}
plot_static_est_takeup <- . %>% 
  mutate(incentive_treatment = fct_relabel(incentive_treatment, . %>% str_replace_all(c("control-bracelet" = "bracelet social", 
                                                 "bracelet-bracelet" = "bracelet",
                                                 "control-control" = "control", 
                                                 "(-control)|(control-)" = "")) %>% 
                                             str_to_title())) %>% {
  ggplot(., aes(incentive_treatment, mean_takeup_prop, color = sms.treatment.2)) + #, color = monitored)) + 
    geom_pointrange(aes(ymin = lb_95, ymax = ub_95), size = 0.5, fatten = 5, position = position_dodge(width = 0.5)) +
    geom_linerange(aes(ymin = lb_90, ymax = ub_90), size = 1.5, position = position_dodge(width = 0.5)) +
    geom_text_repel(aes(label = sprintf("%.2f", mean_takeup_prop), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA) +
    scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
    coord_flip(ylim = c(0, 1)) +
    scale_x_discrete("Signal/Incentive Treatment") +
    scale_y_continuous("Posterior Probability of Deworming") + #, breaks = seq(0, 1, 0.1)) +
    labs(title = "Deworming Take-up", 
         subtitle = "Across all treatments", 
         x = "Incentive/Signal Treatment", 
         y = "Posterior Probability of Deworming", 
         caption = "Points on plot are the mean point estimates.\nThe thick and thin vertical lines show the 90% and 95% posterior probability ranges, respectively.")
  }

plot_static_est_takeup(est_deworming_takeup)
```

```{r static-model-phone-takeup-plot, fig.height=7, fig.width=10}
phone_est_deworming_takeup %>%
  mutate(phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners")) %>% 
  plot_static_est_takeup() +
  facet_wrap(~ phone_owner, ncol = 1, scales = "free_y", drop = TRUE)
```

```{r static-model-dist-takeup-plot, fig.height=7, fig.width=10}
dist_pot_est_deworming_takeup %>%
  plot_static_est_takeup() +
  facet_wrap(~ dist.pot.group, ncol = 1,
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)))) 
```

```{r static-model-phone-dist-takeup-plot, fig.height=15, fig.width=10}
phone_dist_pot_est_deworming_takeup %>%
  mutate(phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners")) %>% 
  plot_static_est_takeup() +
  facet_wrap(~ dist.pot.group + phone_owner, ncol = 1, scales = "free_y",
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)))) 
```

# Dynamic Model

Subscripts:

* $m \in \{0, 1, \ldots, 13\}$: deworming day. There were 12 possible days of deworming: $1 \geq m \leq 12$.

Model variables:

* $Y_{im}(t, m) \in \{0, 1\}$, indicator of deworming on day $m$, in response to time-invariant and time-varying treatments. We define $Y_{i0}(t, m) = 0, \forall i, t, m$.
* $M_i \in \{1, \ldots, 13\}$ is the day an individual got dewormed. We reserved day 13 for those who did not get dewormed at all ($Y_i = 0$).
* We use the same time-invariant treatments as in the above static model.
* The time-varying treatments we introduce in this model is simply a quadratic (we can modify this later) function of the
    - number of days observing an ink or bracelet signal
    - number of reminders
    - number of social information messages
    
  Thus we add two more possible random treatments:
    - $Z^{dyn}_j \in \{\text{control, ink, bracelet}\}$, the observable social signals.
    - $S^{dyn}_i \in \{\text{control, reminders-only, social-info}\}$, the SMS treatment received.

$$
\begin{align}
\Pr[Y_{im}(t, m) = 1 | Y_{i,m-1} = 0, H_i = h] &= 1 - \alpha_m(t, m, h;\beta_{j[i]}, \gamma_{j[i]}, \lambda_{j[i],m})  \\
\Pr[Y_{im}(t, m) = 0 | Y_{i,m-1} = 0, H_i = h] &=  \alpha_m(t, m, h;\beta_{j[i]}, \gamma_{j[i]}, \lambda_{j[i],m}) \\
\Pr[Y_{im}(t, m) = 1 | Y_{i,m-1} = 1, H_i = h] &= 1 \\
\Pr[Y_{im}(t, m) = 0 | Y_{i,m-1} = 1, H_i = h] &= 0 \\\\
\alpha_m(t, m, h;\beta_{j[i]}, \gamma_{j[i]}, \lambda_{j[i],m}) &= \exp[-\kappa(t, m, h;\beta_{j[i]}, \gamma_{j[i]})\lambda_{j[i],m}] \\
\kappa(t,m,h;\beta,\gamma) &= \exp\left[U(t,h;\beta) + M(t,m,h;\gamma)\right] \\
\lambda_{jm} &= v_j v_{k[j]} \lambda_m
\end{align}
$$

where $U(t,h;\beta)$ is the same as in the basic model, excluding the intercept and cluster and stratum effects.

$$
\begin{align}
M(t, m, h; \gamma) &= M(z^{dyn}, s^{dyn}, d, s, b, m, h; \gamma) \\
                   &= \sum_{w\in\widetilde{Z}^r} \sum_{q = 1}^2 (m - 1)^q\cdot\left\{Z^r_w(z^{dyn})\times\gamma^r_{qw1} + Z^r_w(z^{dyn})\times h\times\gamma^r_{qw2}\right\} \\
                   {} &+ \sum_{w\in\widetilde{S}} \sum_{q = 1}^2\lfloor (m - 1)/2 \rfloor^q\cdot\left\{S_w(s^{dyn})\times\gamma^s_{qw1} + S_w(s^{dyn})\times h\times\gamma^s_{qw2}\right\} \\
\end{align}
$$

In addition to the applicable priors from the static model above:

$$
\begin{align}
-\exp(\lambda_m) &\sim \mathcal{Uniform}[0, 1] \\
v^{clust}_j &\sim \mathcal{Gamma}(\delta^{clust}, \delta^{clust}) \\
v^{strat}_k &\sim \mathcal{Gamma}(\delta^{strat}, \delta^{strat}) \\
\gamma &\sim \mathcal{StudentT}\left(\nu^{coef}, 0, \begin{pmatrix} \sigma^{coef} & 0             & \cdots & 0  \\
                                                     0             & \sigma^{coef} & \cdots & 0 \\ 
                                                     \vdots        &               & \ddots &   \\
                                                     0             &               &        & \sigma^{coef} \end{pmatrix}\right) \\\\
\gamma_k &\sim \mathcal{StudentT}\left(\nu^{coef}, \gamma, \begin{pmatrix} \tau^{dyn}_{1} & 0             & \cdots & 0  \\
                                                     0             & \tau^{dyn}_2 & \cdots & 0 \\ 
                                                     \vdots        &               & \ddots &   \\
                                                     0            &               &        &  \end{pmatrix}\right) \\
\delta^{clust} &\sim StudentT[0, \infty)(\nu^{scale}, 0, \tau^{scale}) \\
\delta^{strat} &\sim StudentT[0, \infty)(\nu^{scale}, 0, \tau^{scale}) 
\end{align}
$$

To estimate this model we use the likelihood probability:

$$
\mathcal{L}_i = \prod_{m = 1}^{M_i - 1} \alpha_m(t, m, h;\beta_{j[i]}, \gamma_{j[i]}, \lambda_{j[i],m}) \cdot (1 - \alpha_{M_i}(t, M_i, h;\beta_{j[i]}, \gamma_{j[i]}, \lambda_{j[i],m})^{Y_i}
$$

## Qualitative Plots

These are plots using raw data, not from an estimated model.

```{r, fig.width=10, fig.height=10}
prop_deworm_day_data <- analysis.data %>% 
  filter(!name_matched) %>% 
  group_by(wave, assigned.treatment, dist.pot.group, sms.treatment.2) %>% 
  mutate(cell_size = n()) %>% 
  group_by(dewormed.date.any, add = TRUE) %>% 
  summarize(prop_dewormed = n() / first(cell_size)) %>% 
  group_by(wave, assigned.treatment, dist.pot.group, sms.treatment.2) %>% 
  mutate(cumul_prop_dewormed = cumsum(prop_dewormed)) %>% 
  ungroup() %>% 
  mutate(dewormed.weekday = factor(weekdays(dewormed.date.any), 
                                   levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))

base_plot <- function(.data, col, lt = NULL) {
  .data %>% 
    filter(!is.na(dewormed.date.any)) %>% 
    ggplot(aes_string(x = "dewormed.date.any", y = "cumul_prop_dewormed", color = col)) +
    geom_line(aes_string(color = col, linetype = lt)) +
    geom_point() +
    scale_x_date("", labels = scales::date_format("%a")) +
    scale_y_continuous("Cumulative Deworming Proportion") +
    theme(legend.position = "bottom")
}

dist_incentive_plot <- prop_deworm_day_data %>% 
  base_plot("sms.treatment.2") + 
  facet_grid(assigned.treatment ~ dist.pot.group + wave, scales = "free_x")
  # facet_grid(assigned.treatment ~ dist.pot.group, scales = "free_x")

dist_sms_plot <- prop_deworm_day_data %>% 
  base_plot("assigned.treatment", lt = "sms.treatment.2") + 
  facet_grid(~ dist.pot.group + wave, scales = "free_x")
  # facet_grid(~ dist.pot.group, scales = "free_x")

dist_sms_plot_split <- prop_deworm_day_data %>% 
  base_plot("assigned.treatment", lt = "sms.treatment.2") + 
  facet_grid(sms.treatment.2 ~ dist.pot.group + wave, scales = "free_x")

plot(dist_incentive_plot)
```

```{r, fig.width=14, fig.height=6}
plot(dist_sms_plot)
```

```{r, fig.width=14, fig.height=10}
plot(dist_sms_plot_split)
```

```{r, fig.width=10}
analysis.data %>% 
  filter(!is.na(endline_deworm_rate)) %>% 
  ggplot() +
  geom_violin(aes(assigned.treatment, endline_deworm_rate, color = dist.pot.group, linetype = sms.treatment.2), draw_quantiles = c(0.25, 0.5, 0.75)) +
  scale_y_continuous(breaks = 0:10)
```

## Inference

The finite sample average treatment effects we are interested in estimating is similar to that of the static model; we are interested in the impact on deworming $Y_i \equiv \mathbbm{1}\{M_i \leq 12\}$. We are not interested in the timing of take-up. We use the dynamic model to analyze impute unobservable counterfactuals. For example, estimating the impact of bracelets without any learning, assuming that learning can be captured by the time-varying dynamics of bracelets (days of observable signals). We can't completely shutdown learning, but we can fix at the baseline (control) level.

```{r dyn-model-ate, echo=TRUE, warning=FALSE}
dyn_sms_control_ate <- tribble(
  ~ private_value_left, ~ social_value_left, ~ private_value_right, ~ social_value_right,
  "control",            "ink",               "control",             "control",
  "calendar",           "control",           "control",             "control",
  # "bracelet",           "bracelet",          "control",             "control",
  "control",           "bracelet",          "calendar",            "control",
  
  "control",           "bracelet",           "control",            "control" 
) %>% 
  mutate(signal_observed_left = social_value_left,
         signal_observed_right = social_value_right) %>% 
  bind_rows(
    tribble(
      ~ private_value_left, ~ social_value_left, ~ signal_observed_left, ~ private_value_right, ~ social_value_right, ~ signal_observed_right,
      "control",            "bracelet",          "control",              "control",             "control",            "control",
      "control",            "ink",               "control",              "control",             "control",            "control"
  )) %>%
  mutate(days_observed_left = 12,
         days_observed_right = 12) %>% 
  bind_rows(
    tribble(
      ~ private_value_left, ~ social_value_left, ~ signal_observed_left, ~days_observed_left, ~ private_value_right, ~ social_value_right, ~ signal_observed_right, ~ days_observed_right,
      "control",            "bracelet",          "control",              12,                  "control",             "control",            "control",               0,
      "control",            "ink",               "control",              12,                  "control",             "control",            "control",               0
  )) %>%
  bind_rows("close" = ., "far" = ., .id = "dist.pot.group") %>% 
  bind_rows(`TRUE` = ., `FALSE` = ., .id = "phone_owner") %>%
  bind_rows(`TRUE` = ., `FALSE` = ., .id = "name_matched") %>%
  mutate(sms.treatment.2_left = "sms.control", sms.treatment.2_right = "sms.control",
         days_sms_left = 12,
         days_sms_right = 12,
         hh.baseline.sample = FALSE, 
         reminder_info_stock_left = fct_recode(sms.treatment.2_left, control = "sms.control"),
         reminder_info_stock_right = fct_recode(sms.treatment.2_right, control = "sms.control")) %>% 
  mutate_at(vars(phone_owner, name_matched), as.logical)

dyn_phone_owners_ate <- tribble(
  ~ private_value_left, ~ social_value_left, ~ sms.treatment.2_left, ~ private_value_right, ~ social_value_right, ~ sms.treatment.2_right,
  "control",            "control",           "reminder.only",        "control",             "control",            "sms.control",
  "control",            "control",           "social.info",          "control",             "control",            "sms.control",
  "control",            "control",           "social.info",          "control",             "control",            "reminder.only",

  "control",            "ink",               "social.info",          "control",             "control",            "sms.control",
  "control",            "ink",               "social.info",          "control",             "control",            "social.info",
  "control",            "ink",               "social.info",          "control",             "ink",                "sms.control",

  "calendar",           "control",           "social.info",          "control",             "control",            "sms.control",
  "calendar",           "control",           "social.info",          "control",             "control",            "social.info",
  "calendar",           "control",           "social.info",          "calendar",            "control",            "sms.control",

  "bracelet",           "bracelet",          "social.info",          "control",             "control",            "sms.control",
  "bracelet",           "bracelet",          "social.info",          "control",             "control",            "social.info",
  "bracelet",           "bracelet",          "social.info",          "calendar",            "control",            "social.info",
  "bracelet",           "bracelet",          "social.info",          "bracelet",            "bracelet",           "sms.control",
  
  "control",           "bracelet",           "social.info",          "control",             "control",            "sms.control",
  "control",           "bracelet",           "social.info",          "control",             "control",            "social.info",
  "control",           "bracelet",           "social.info",          "calendar",            "control",            "social.info",
  "control",           "bracelet",           "social.info",          "bracelet",            "control",            "sms.control"
) %>%
  mutate(signal_observed_left = social_value_left,
         signal_observed_right = social_value_right,
         reminder_info_stock_left = fct_recode(sms.treatment.2_left, control = "sms.control"),
         reminder_info_stock_right = fct_recode(sms.treatment.2_right, control = "sms.control")) %>% 
  bind_rows(
    tribble(
      ~ private_value_left, ~ social_value_left, ~ signal_observed_left, ~ sms.treatment.2_left, ~ reminder_info_stock_left, ~ private_value_right, ~ social_value_right, ~ signal_observed_right, ~ sms.treatment.2_right, ~ reminder_info_stock_right,
      "control",            "bracelet",         "control",               "social_info",          "control",                  "control",             "bracelet",            "control",    "sms.control",           "control",
      
      
      "control",            "bracelet",         "control",               "social_info",          "control",                  "control",             "control",             "control",    "sms.social_info",       "control")) %>% 
  mutate(days_sms_left = 12,
         days_sms_right = 12) %>% 
  bind_rows(
    tribble(
      ~ private_value_left, ~ social_value_left, ~ signal_observed_left, ~ sms.treatment.2_left, ~ reminder_info_stock_left, ~ days_sms_left, ~ private_value_right, ~ social_value_right, ~ signal_observed_right, ~ sms.treatment.2_right, ~ reminder_info_stock_right, ~ days_sms_right,
      "control",            "bracelet",         "bracelet",              "social_info",          "social_info",              12,               "control",                    "bracelet",         "bracelet",               "social_info",           "social_info",               0,
      "control",            "bracelet",         "bracelet",              "social_info",          "social_info",              0,                "control",                    "bracelet",         "bracelet",               "sms.control",           "control",                   0
  )) %>% 
  bind_rows("close" = ., "far" = ., .id = "dist.pot.group") %>%
  mutate(phone_owner = TRUE,
         hh.baseline.sample = FALSE, 
         name_matched = FALSE,
         days_observed_left = 12,
         days_observed_right = 12) %>% 
  bind_rows(filter(., sms.treatment.2_left == "sms.control" & sms.treatment.2_right == "sms.control") %>% mutate(name_matched = TRUE))

dyn_all_ate <- bind_rows(dyn_sms_control_ate, dyn_phone_owners_ate) 
```

```{r dyn-stan-data, warning=FALSE}
dyn_stan_data <- analysis.data %>%
  mutate(private_value = fct_collapse(assigned.treatment, control = c("control", "ink")),
         social_value = fct_collapse(assigned.treatment, control = c("control", "calendar")),
         signal_observed = social_value,
         reminder_info_stock = fct_recode(sms.treatment.2, control = "sms.control"),
         days_observed = 12,
         days_sms = 12) %>% 
  # filter(!name_matched) %>%
  filter(!name_matched | sms.treatment.2 == "sms.control") %>% 
  prepare_bayesian_analysis_data(
    wtp.data, 
    
    treatment_map = 
      data_grid(., private_value, social_value, signal_observed, reminder_info_stock, dist.pot.group, sms.treatment.2, hh.baseline.sample, phone_owner, name_matched,
                days_observed = c(0, 12), days_sms = c(0, 12)) %>%
      filter(phone_owner | sms.treatment.2 == "sms.control",
            (private_value == "control" & social_value == "control") | sms.treatment.2 != "reminder.only",
             private_value != "calendar" | social_value == "control",
             private_value != "bracelet" | social_value == "bracelet",
             !name_matched | sms.treatment.2 == "sms.control",
             signal_observed == social_value | signal_observed == "control",
             reminder_info_stock == fct_recode(sms.treatment.2, control = "sms.control"),
             signal_observed != "control" | days_observed == 12,
             reminder_info_stock != "control" | days_sms == 12),
    
    # treatment_map = data_grid(., private_value, social_value, signal_observed, dist.pot.group, hh.baseline.sample, phone_owner) %>%
    #   filter(private_value != "calendar" | social_value == "control",
    #          private_value != "bracelet" | social_value == "bracelet",
    #          signal_observed == social_value | signal_observed == "control"),
    
    dynamic_treatment_map = lst(formula = ~ (signal_observed + reminder_info_stock)*phone_owner, 
                                trends = tibble(signal_observed = 0:11,
                                                reminder_info_stock = rep(0:5, each = 2))),
    
    # treatment_formula = ~ (private_value + social_value * (dist.pot.group + hh.baseline.sample)) * phone_owner,
    treatment_formula = ~ (private_value + social_value * sms.treatment.2 * (dist.pot.group + hh.baseline.sample)) * phone_owner * name_matched,
    subgroup_col = NULL,
    
    all_ate = dyn_all_ate,
    # all_ate = dyn_sms_control_ate %>% select(-contains("sms.treatment")),
    
    # name_match_false_pos_alpha, 
    # name_match_false_pos_beta,
    
    scale_df = 7,
    scale_sigma = 1,
    scale_sigma_dynamic = 1,
   
    coef_df = 7,
    coef_sigma = 1,
    coef_sigma_dynamic = 5,
    
    wtp_utility_df = 3,
    tau_mu_wtp_diff = 100,
    mu_wtp_df_student_t = 7,
    tau_sigma_wtp_diff = 50,
    sigma_wtp_df_student_t = 2.5,
    sigma_ksh_util_gamma = 5,
  )
```

```{r load-dyn-model-fit}
basic_model_2_simple_fit <- dir("stanfit", pattern = "basic_model_2_simple_centered_4_[1-8].csv", full.names = TRUE) %>% 
  read_stan_csv()

basic_model_2_simple_fit %>% 
  get_sampler_params(inc_warmup = FALSE) %>% 
  map_dbl(~ sum(magrittr::extract(.x, , "divergent__"))) %>% 
  sum()
```

```{r basic-model-2-simple-centered, eval=FALSE}
basic_model_2_simple <- stan_model(file = "takeup_model_2_simple_centered.stan", model_name = "model_2_simple_centered")
basic_model_2_simple_fit <- dyn_stan_data %>% 
  sampling(basic_model_2_simple, data = ., #init = .$dynamic_initializer,
           chains = 8, iter = 800, control = lst(max_treedepth = 15), # adapt_delta = 0.99, 
           sample_file = file.path("stanfit", "basic_model_2_simple_centered_4.csv")) 
```

```{r basic-model-2-simple-debug, eval=FALSE}
basic_model_2_simple <- stan_model(file = "takeup_model_2_simple_centered.stan", model_name = "model_2_simple")
basic_model_2_simple_fit <- dyn_stan_data %>% 
  sampling(basic_model_2_simple, data = ., #init = .$dynamic_initializer,
           chains = 2, iter = 20, control = lst(max_treedepth = 15), # adapt_delta = 0.99, 
           sample_file = file.path("stanfit", "basic_model_2_simple_debug.csv")) 
```

```{r}
basic_model_2_simple_fit %>% 
  print(pars = c("hyper_baseline_cond_takeup", "hyper_baseline_hazard", 
                 "stratum_hazard_effect", "stratum_hazard_frailty_var", 
                 sprintf("cluster_hazard_effect[%d]", 1:10), "cluster_hazard_frailty_var"))
```

```{r dyn-model-prep-data}
est_deworming_days <- basic_model_2_simple_fit %>% 
  as.data.frame( pars = c("non_phone_deworming_days", "phone_deworming_days")) %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(outcome_id, sim_outcome, -iter_id) %>% 
  separate(outcome_id, c("phone_owner", "all_treatment_rank", "day"), "(_deworming_days\\[)|,|\\]", extra = "drop") %>% 
  mutate_at(vars(day, all_treatment_rank), as.integer) %>% 
  group_by(phone_owner) %>% 
  mutate(all_treatment_id = dyn_stan_data[[str_interp("${first(phone_owner)}_owner_treatments")]][all_treatment_rank]) %>%
  ungroup() %>% 
  mutate(phone_owner = phone_owner == "phone") %>% 
  inner_join(dyn_stan_data$treatment_map, "all_treatment_id") 

assertthat::assert_that(all(phone_owner.x == phone_owner.y), env = est_deworming_days)

est_deworming_days %<>% 
  mutate(phone_owner = phone_owner.x) %>% 
  select(-matches("phone_owner\\.[xy]"))

summ_dyn_takeup <- est_deworming_days %>% 
  unite(incentive_treatment, private_value, social_value, sep = "-", remove = FALSE) %>% 
  group_by(day, phone_owner, dist.pot.group, private_value, social_value, sms.treatment.2, incentive_treatment, name_matched) %>% 
  summarize(mean_takeup_prop = mean(sim_outcome),
            ub_90 = quantile(sim_outcome, 0.95),
            lb_90 = quantile(sim_outcome, 0.05)) %>% 
  ungroup() %>% {
    treated <- filter(., incentive_treatment != "control-control") %>% 
      mutate(comparator = incentive_treatment)
    baseline <- filter(., incentive_treatment == "control-control") %>% 
      left_join(select(treated, day, phone_owner, dist.pot.group, comparator), c("day", "phone_owner", "dist.pot.group"))
    
    bind_rows(treated, baseline)
  }

dyn_ate <- bind_rows(non_phone = dyn_stan_data$non_phone_owner_ate_pairs,
                     phone = dyn_stan_data$phone_owner_ate_pairs, .id = "phone_owner") %>% 
  group_by(phone_owner) %>% 
  mutate(all_treatment_id_left = dyn_stan_data[[str_interp("${first(phone_owner)}_owner_treatments")]][rank_id_left],
         all_treatment_id_right = dyn_stan_data[[str_interp("${first(phone_owner)}_owner_treatments")]][rank_id_right],
         all_treatment_size_left = dyn_stan_data[[str_interp("observed_${first(phone_owner)}_owner_treatment_sizes")]][rank_id_left] +
           dyn_stan_data[[str_interp("missing_${first(phone_owner)}_owner_treatment_sizes")]][rank_id_left],
         all_treatment_size_right = dyn_stan_data[[str_interp("observed_${first(phone_owner)}_owner_treatment_sizes")]][rank_id_right] +
           dyn_stan_data[[str_interp("missing_${first(phone_owner)}_owner_treatment_sizes")]][rank_id_right]) %>% 
  ungroup() %>% 
  mutate(ate_id = seq_len(n()),
         phone_owner = phone_owner == "phone") %>% 
  left_join(dyn_stan_data$treatment_map, c("all_treatment_id_left" = "all_treatment_id")) %>%
  left_join(dyn_stan_data$treatment_map, c("all_treatment_id_right" = "all_treatment_id"), suffix = c("_left", "_right")) %>% 
  left_join(select(est_deworming_days, iter_id, all_treatment_id, day, sim_outcome, phone_owner), c("all_treatment_id_left" = "all_treatment_id")) %>% 
  left_join(select(est_deworming_days, iter_id, all_treatment_id, day, sim_outcome, phone_owner), 
            c("all_treatment_id_right" = "all_treatment_id", "iter_id", "day"),
            suffix = c("_left", "_right")) %>% 
  unite(incentive_treatment_left, private_value_left, social_value_left, sep = "-", remove = FALSE) %>% 
  unite(incentive_treatment_right, private_value_right, social_value_right, sep = "-", remove = FALSE) 

assertthat::assert_that(all(phone_owner.x == phone_owner.y) && all(phone_owner.x.x == phone_owner.y.y) & all(phone_owner == phone_owner.y.y), env = dyn_ate)
assertthat::assert_that(all(dist.pot.group_left == dist.pot.group_right), env = dyn_ate)

dyn_ate %<>% 
  select(-contains("phone_owner.")) %>% 
  filter(day == 13) %>% 
  group_by_at(c("day", "phone_owner", "iter_id", "all_treatment_size_left", "all_treatment_size_right",
                c("dist.pot.group", "private_value", "social_value", "sms.treatment.2", "incentive_treatment") %>%
                  str_c(rep(c("_left", "_right"), each = length(.))))) %>% 
  summarize(iter_ate = weighted.mean(1 - sim_outcome_left, all_treatment_size_left) - weighted.mean(1 - sim_outcome_right, all_treatment_size_right)) %>% 
  # summarize_at(vars(mean_ate))
  # mutate(iter_ate = (1 - sim_outcome_left) - (1 - sim_outcome_right)) %>% 
  group_by_at(c("day", "phone_owner", 
                c("dist.pot.group", "private_value", "social_value", "sms.treatment.2", "incentive_treatment") %>%
                # c("dist.pot.group", "private_value", "social_value", "sms.treatment.2", "incentive_treatment", "name_matched") %>%
                  str_c(rep(c("_left", "_right"), each = length(.))))) %>% 
  summarize(mean_ate = mean(iter_ate),
            ub_90 = quantile(iter_ate, 0.95),
            ub_95 = quantile(iter_ate, 0.975),
            lb_90 = quantile(iter_ate, 0.05),
            lb_95 = quantile(iter_ate, 0.025)) %>% 
  ungroup() %>% 
  mutate_at(vars(matches("incentive_treatment")), 
            funs(fct_relevel(factor(.), "control-ink", "calendar-control", "control-bracelet", "bracelet-bracelet")))

```

```{r, fig.width=12}
summ_dyn_takeup %>% 
  filter(day < 13,
         sms.treatment.2 == "sms.control",
         social_value != "bracelet" | private_value == "control",
         comparator != "bracelet-bracelet") %>% 
  ggplot(aes(x = day, y = mean_takeup_prop, linetype = name_matched)) +
  geom_line(data = . %>% filter(incentive_treatment == "control-control")) +
  geom_point(data = . %>% filter(incentive_treatment == "control-control")) +
  geom_line(aes(color = incentive_treatment), data = . %>% filter(incentive_treatment != "control-control")) +
  geom_point(aes(color = incentive_treatment), data = . %>% filter(incentive_treatment != "control-control")) +
  # geom_ribbon(aes(group = incentive_treatment, ymin = lb_90, ymax = ub_90), alpha = 0.2) +
  scale_x_continuous(breaks = 1:12, minor_breaks = NULL) +
  facet_grid(phone_owner + dist.pot.group ~ comparator,  labeller = label_both, scales = "free_y")
```

```{r plot-dyn-ate, fig.height=6}
bind_rows(Static = sms_ctrl_est_deworming_takeup_ate %>% 
            filter(incentive_treatment_left != "bracelet-bracelet") %>% 
            select(incentive_treatment_left, phone_owner, dist.pot.group_left, mean_ate, matches("[lu]b_9[05]")),
          Dynamic = dyn_ate %>% 
            filter(incentive_treatment_left != "bracelet-bracelet", 
                   incentive_treatment_right == "control-control",
                   sms.treatment.2_left == "sms.control", sms.treatment.2_right == "sms.control") %>% 
            select(incentive_treatment_left, phone_owner, dist.pot.group_left, mean_ate, matches("[lu]b_9[05]")),
          .id = "model") %>% 
  mutate_at(vars(matches("incentive_treatment")), 
            funs(fct_relevel(factor(.), "control-ink", "calendar-control", "control-bracelet", "bracelet-bracelet"))) %>% 
  mutate(incentive_treatment_left = fct_relabel(incentive_treatment_left, . %>% str_replace( "-?control-?", "") %>% str_to_title())) %>% 
  ggplot(aes(incentive_treatment_left, mean_ate, color = model)) +
  geom_pointrange(aes(ymin = lb_95, ymax = ub_95), position = position_dodge(width = 0.2), size = 0.75) +
  geom_linerange(aes(ymin = lb_90, ymax = ub_90), position = position_dodge(width = 0.2), size = 1.75) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  # geom_text_repel(aes(label = sprintf("%.2f", mean_ate), color = NULL)) +
  geom_text_repel(aes(label = sprintf("%.2f", mean_ate), color = NULL), nudge_x = -0.25, segment.colour = NA, data = . %>% filter(model == "Dynamic")) +
  geom_text_repel(aes(label = sprintf("%.2f", mean_ate), color = NULL), nudge_x = 0.25, segment.colour = NA, data = . %>% filter(model == "Static")) +
  scale_x_discrete("Comparator Incentive Treatment") +
  scale_y_continuous("Average Difference in Deworming Proportion") +
  scale_color_discrete("Model") +
  labs(title = "Incentive Average Treatment Effect", subtitle = "Compared with the control arm", caption = "Points on plot are the mean point estimates.\nThe thick and thin vertical lines show the 90% and 95% posterior probability ranges, respectively.") +
  facet_grid(phone_owner ~ dist.pot.group_left, labeller = label_both) +
  theme(axis.text.x = element_text(angle = 25, hjust = 1))
```

```{r}
summ_dyn_takeup %>% 
  filter(day == 13, 
         sms.treatment.2 == "sms.control",
         social_value != "bracelet" | private_value == "control",
         incentive_treatment == comparator | (comparator == "control-ink" & incentive_treatment == "control-control")) %>% 
  mutate(incentive_treatment = fct_relevel(incentive_treatment, "control-control", "control-ink", "calendar-control", "control-bracelet"),
         incentive_treatment = fct_relabel(incentive_treatment, . %>% str_replace( "-?control-?", "") %>% str_to_title()),
         mean_takeup_prop = 1 - mean_takeup_prop) %>% 
  ggplot(aes(x = incentive_treatment, y = mean_takeup_prop)) +
  geom_pointrange(aes(ymin = 1 - lb_90, ymax = 1 - ub_90)) +
  theme(axis.text.x = element_text(angle = 25, hjust = 1)) +
  scale_y_continuous(limits = c(0, 0.75)) +
  labs(x = "", y = "Posterior Deworming Take-up Probability") +
  facet_grid(phone_owner ~ dist.pot.group, labeller = label_both)
```

```{r, fig.width=10, fig.height=10, eval=FALSE}
summ_dyn_takeup %>% 
  filter(phone_owner,
         social_value != "bracelet" | private_value == "bracelet",
         comparator != "control-bracelet",
         incentive_treatment != "control-control" | sms.treatment.2 == "sms.control",
         day < 13) %>% 
  ggplot(aes(x = day, y = mean_takeup_prop)) +
  geom_line(aes(group = sms.treatment.2), data = . %>% filter(incentive_treatment == "control-control")) +
  # geom_point(aes(group = sms.treatment.2), data = . %>% filter(incentive_treatment == "control-control")) +
  geom_point(aes(group = sms.treatment.2, color = incentive_treatment), data = . %>% filter(incentive_treatment != "control-control")) +
  geom_line(aes(linetype = sms.treatment.2, color = incentive_treatment), data = . %>% filter(incentive_treatment != "control-control")) +
  geom_ribbon(aes(group = sms.treatment.2, ymin = lb_90, ymax = ub_90), alpha = 0.25, data = . %>% filter(incentive_treatment != "control-control")) +
  scale_x_continuous(breaks = 1:12, minor_breaks = NULL) +
  facet_grid(comparator ~ dist.pot.group)
```

### Posterior Simulation

In this section we're carrying out our analysis based on the Bayesian simulated parameters. Here we are estimating the posterior distribution of the _finite sample mean of the probability of deworming take-up_.

$$
\frac{1}{N} \sum_i \Pr[Y_{im}(t') = 1|\theta] - \Pr[Y_{im}(t) = 1|\theta], \forall m
$$
where $\theta$ are the model parameters.

```{r dyn-model-sim-params}
sim_stratum_hazards_wide <- basic_model_2_simple_fit %>% 
  as.data.frame(pars = c("hyper_baseline_hazard", "stratum_hazard_effect")) %>% 
  mutate(iter_id = seq_len(n())) %>% 
  gather(stratum_id, stratum_hazard_effect, starts_with("stratum_hazard_effect")) %>% 
  magrittr::set_names(str_replace(names(.), "hyper_baseline_hazard\\[(\\d+)\\]", "stratum_hazard_day_\\1")) %>%
  mutate_at(vars(num_range("stratum_hazard_day_", 1:12)), funs(. * stratum_hazard_effect)) %>% 
  mutate_at(vars(stratum_id), funs(str_extract(., "\\d+") %>% as.integer())) %>% 
  select(-stratum_hazard_effect)

sim_stratum_hazards <- sim_stratum_hazards_wide %>%
  gather(deworming_day, stratum_hazard, starts_with("stratum_hazard_day")) %>% 
  mutate_at(vars(deworming_day), funs(str_extract(., "\\d+") %>% as.integer())) 

sim_cluster_hazards <- basic_model_2_simple_fit %>% 
  as.data.frame( pars = c("cluster_hazard_effect")) %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(cluster_id, cluster_hazard_effect, starts_with("cluster_hazard_effect")) %>% 
  mutate_at(vars(cluster_id), funs(str_extract(., "\\d+") %>% as.integer())) 

sim_stratum_census_covar_coef <- basic_model_2_simple_fit %>% 
  as.data.frame(pars = c("stratum_census_covar_coef")) %>% 
  mutate(iter_id = seq_len(n())) %>% 
  gather(stratum_id, stratum_census_covar_coef, starts_with("stratum_census_covar_coef")) %>% 
  separate(stratum_id, into = c("var", "stratum_id", "col_id"), remove = TRUE, sep = "\\[|,|\\]", extra = "drop") %>% 
  mutate_at(vars(col_id, stratum_id), funs(str_extract(., "\\d+") %>% as.integer())) %>% 
  mutate(col_id = sprintf("%s_%03d", var, col_id)) %>% # Don't use unite()
  spread(col_id, stratum_census_covar_coef) %>% 
  select(-var)

sim_stratum_treatment_coef <- basic_model_2_simple_fit %>% 
  as.data.frame(pars = c("stratum_beta")) %>% 
  mutate(iter_id = seq_len(n())) %>% 
  gather(stratum_id, stratum_beta, starts_with("stratum_beta")) %>% 
  separate(stratum_id, into = c("var", "stratum_id", "col_id"), remove = TRUE, sep = "\\[|,|\\]", extra = "drop") %>% 
  mutate_at(vars(stratum_id, col_id), funs(str_extract(., "\\d+") %>% as.integer())) %>% 
  mutate(col_id = sprintf("%s_%03d", var, col_id)) %>% # Don't use unite()
  spread(col_id, stratum_beta) %>% 
  select(-var)

sim_stratum_dyn_treatment_coef <- basic_model_2_simple_fit %>% 
  as.data.frame(pars = c("stratum_dynamic_treatment_coef")) %>% 
  mutate(iter_id = seq_len(n())) %>% 
  gather(stratum_id, stratum_dynamic_treatment_coef, starts_with("stratum_dynamic_treatment_coef")) %>% 
  separate(stratum_id, into = c("var", "stratum_id", "col_id"), remove = TRUE, sep = "\\[|,|\\]", extra = "drop") %>% 
  mutate_at(vars(stratum_id, col_id), funs(str_extract(., "\\d+") %>% as.integer())) %>% 
  mutate(col_id = sprintf("%s_%03d", var, col_id)) %>% # Don't use unite()
  spread(col_id, stratum_dynamic_treatment_coef) %>% 
  mutate_at(vars(stratum_id), funs(str_extract(., "\\d+") %>% as.integer())) %>% 
  select(-var)

obs_meta_data <- dyn_stan_data$prepared_analysis_data %>% 
  transmute(stratum_id, cluster_id = new_cluster_id, obs_index, phone_owner, name_matched, census_covar_id) 

iter_cluster_parameters <- obs_meta_data %>% 
  group_by(stratum_id, cluster_id, phone_owner, name_matched) %>% 
  summarize(subgroup_size = n()) %>% 
  ungroup() %>% 
  left_join(sim_stratum_treatment_coef, c("stratum_id")) %>%
  left_join(sim_stratum_dyn_treatment_coef, c("stratum_id", "iter_id")) %>%
  left_join(sim_stratum_census_covar_coef, c("stratum_id", "iter_id")) %>%
  right_join(sim_cluster_hazards, c("cluster_id", "iter_id")) %>% 
  mutate(log_kappa_census_covar = 0,
         subgroup_id = seq_len(nrow(.)))

paropts <- lst(.packages = c("magrittr", "stringr", "tidyverse"),
               .export = c("estimate_deworm_prob", "fast_estimate_deworm_prob", "identify_treatment_id", "estimate_treatment_deworm_prob", "estimate_treatment_deworm_prob_dm",
                           "obs_meta_data", "dyn_stan_data", "sim_stratum_hazards"),
               .verbose = FALSE)

fast_treatments <- tribble(
  ~ private_value, ~ social_value, 
  "control",            "control", 
  "control",            "ink",     
  "calendar",           "control", 
  "control",            "bracelet", 
  "bracelet",           "bracelet" 
) %>% 
  mutate(signal_observed = social_value,
         hh.baseline.sample = FALSE,
         # These are old columns that we're no longer using, but to avoid redundant simulation we set them to a single value
         days_observed = 12, 
         days_sms = 12) %>% 
  expand(nesting_(names(.)), 
         dist.pot.group = c("close", "far"), 
         phone_owner = c(TRUE, FALSE), 
         name_matched = c(TRUE, FALSE),
         sms.treatment.2 = c("sms.control", "reminder.only", "social.info")) %>% 
  filter(sms.treatment.2 == "sms.control" | phone_owner,
         sms.treatment.2 != "reminder.only" | (private_value == "control" & social_value == "control")) %>% 
  mutate(reminder_info_stock = fct_recode(sms.treatment.2, control = "sms.control"))
```

```{r, warning=FALSE}
fast_est_fun <- partial(fast_estimate_deworm_prob, 
                   sim_stratum_hazards = sim_stratum_hazards,
                   treatment_map = dyn_stan_data$treatment_map,
                   treatment_map_dm = dyn_stan_data$treatment_map_design_matrix,
                   all_treat_dyn_id = dyn_stan_data$all_treatment_dyn_id,
                   dyn_treatment_mask_map = dyn_stan_data$dynamic_treatment_mask_map,
                   full_dyn_treatment_map_dm = dyn_stan_data$dynamic_treatment_map)

covar_est_fun <- partial(estimate_deworm_prob, 
                   obs_meta_data = obs_meta_data,
                   sim_stratum_hazards = sim_stratum_hazards,
                   census_covar_dm = dyn_stan_data %$% census_covar_map_dm[census_covar_id, ],
                   treatment_map = dyn_stan_data$treatment_map,
                   treatment_map_dm = dyn_stan_data$treatment_map_design_matrix,
                   dyn_treatment_mask_map = dyn_stan_data$dynamic_treatment_mask_map,
                   full_dyn_treatment_map_dm = dyn_stan_data$dynamic_treatment_map)
```

```{r, eval=FALSE}
xx <- iter_cluster_parameters %>%
  filter(iter_id == 1) %>%
  ddply(.(iter_id), covar_est_fun,
        .parallel = FALSE, .progress = "text", .paropts = paropts,
        treatments_info = fast_treatments[1, ],
        days_treated = 11)
```

```{r, eval=FALSE, warning=FALSE}
xx <- iter_cluster_parameters %>% 
  filter(iter_id == 1) %>% 
  ddply(.(iter_id), fast_est_fun, .parallel = FALSE, .progress = "text", .paropts = paropts,
        treatments_info = fast_treatments %>% filter(sms.treatment.2 == "sms.control"), 
        subgroup_col = c("phone_owner", "name_matched"),
        days_treated = 11) 
```


```{r fast-sim-run, eval=FALSE, warning=FALSE}
fast_sim <- ddply(iter_cluster_parameters, .(iter_id), fast_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
                  treatments_info = fast_treatments %>% 
                    filter(social_value == "control" & sms.treatment.2 == "sms.control"), 
                  subgroup_col = c("phone_owner", "name_matched"),
                  days_treated = 11)

save(fast_sim, file = file.path("data", "fast_sim.RData"))

fast_sim <- ddply(iter_cluster_parameters, .(iter_id), fast_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
                  treatments_info = fast_treatments %>% 
                    filter(social_value != "control" | sms.treatment.2 != "sms.control"), 
                  subgroup_col = c("phone_owner", "name_matched"),
                  days_treated = c(0, 11)) %>% 
  bind_rows(fast_sim)

save(fast_sim, file = file.path("data", "fast_sim.RData"))

# fast_sim <- ddply(iter_cluster_parameters, .(iter_id), fast_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
#                   treatments_info = fast_treatments %>% filter(social_value == "control" & sms.treatment.2 == "sms.control"), 
#                   average_over = "phone_owner",
#                   days_treated = 11) %>% 
#   bind_rows(fast_sim)
# 
# save(fast_sim, file = file.path("data", "fast_sim.RData"))
# 
# fast_sim <- ddply(iter_cluster_parameters, .(iter_id), fast_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
#                   treatments_info = fast_treatments %>% filter(social_value != "control" | sms.treatment.2 != "sms.control"), 
#                   average_over = "phone_owner",
#                   days_treated = c(0, 11)) %>% 
#   bind_rows(fast_sim)
# 
# save(fast_sim, file = file.path("data", "fast_sim.RData"))

# fast_sim <- ddply(iter_cluster_parameters, .(iter_id), fast_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
#                   average_over_name_match_monitored = FALSE,
#                   treatments_info = fast_treatments %>% 
#                     filter(!name_matched & social_value == "control"), 
#                   days_treated = 11) %>% 
#   bind_rows(fast_sim)
# 
# save(fast_sim, file = file.path("data", "fast_sim.RData"))
# 
# fast_sim <- ddply(iter_cluster_parameters, .(iter_id), fast_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
#                   average_over_name_match_monitored = FALSE,
#                   treatments_info = fast_treatments %>% 
#                     filter(!name_matched & social_value != "control"), 
#                   days_treated = c(0, 11)) %>% 
#   bind_rows(fast_sim)
# 
# save(fast_sim, file = file.path("data", "fast_sim.RData"))
```

```{r, eval=FALSE, warning=FALSE}
covar_sim <- ddply(iter_cluster_parameters, .(iter_id), covar_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
                  treatments_info = fast_treatments %>% filter(social_value == "control" & sms.treatment.2 == "sms.control"), days_treated = 11)

save(covar_sim, file = file.path("data", "covar_sim.RData"))

covar_sim <- ddply(iter_cluster_parameters, .(iter_id), covar_est_fun, .parallel = TRUE, .progress = "text", .paropts = paropts,
                  treatments_info = fast_treatments %>% filter(social_value != "control" | sms.treatment.2 != "sms.control"), days_treated = 0:11) %>% 
  bind_rows(covar_sim)

save(covar_sim, file = file.path("data", "covar_sim.RData"))
```

#### Analysis

```{r prep-fast-sim, eval=FALSE}
treatment_col <- c("phone_owner", "name_matched", "dist.pot.group", "incentive_treatment", "sms.treatment.2", "dyn_treat_days")

load(file.path("data", "fast_sim.RData"))

fast_sim %<>%
  filter(days_sms == 12) %>% 
  select(-c(days_sms, days_observed, signal_observed, reminder_info_stock)) %>% 
  unite(incentive_treatment, c("private_value", "social_value"), remove = FALSE, sep = "-") %>% 
  mutate(incentive_treatment = str_replace_all(incentive_treatment, 
                                               c("control-bracelet" = "bracelet social", 
                                                 "bracelet-bracelet" = "bracelet",
                                                 "control-control" = "control", 
                                                 "(-control)|(control-)" = "")) %>% 
           fct_relevel("control", "ink", "calendar", "bracelet social", "bracelet"),
         sms.treatment.2 = fct_relevel(sms.treatment.2, "sms.control", "reminder.only", "social.info"),
         iter_obs_id = seq_len(n())) %>% 
  select_if(~ !all(is.na(.))) 

fast_sim %<>% 
  distinct_(.dots = treatment_col) %>% 
  mutate(fast_treatment_id = seq_len(n())) %>% 
  right_join(fast_sim, by = treatment_col) %>% 
  bind_rows(group_by_at(., vars(-c(deworming_day, prob_deworm, alpha, kappa_dyn_treat, iter_obs_id))) %>% 
              summarize(deworming_day = 13, prob_deworm = sum(prob_deworm)) %>% #, group_size = n()) %>%
              ungroup()) 
  
fast_sim_day13_only <- fast_sim %>% filter(deworming_day == 13) 

quants <- c(2.5, 5, 50, 95, 97.5)

iter_summarizer <- function(.data) {
  .data %>% 
    {
      bind_cols(summarize_at(., vars(prob_deworm, alpha, kappa_dyn_treat), mean), 
            t(quantile(.$prob_deworm, probs = quants / 100, names = FALSE)) %>% 
              tidy() %>% 
              set_colnames(str_c("prob_deworm_quant_", quants)))
    }
}

combine_treatment_group <- function(.data, average_over = NULL) {
  .data %>% 
    plyr::ddply(c(setdiff(treatment_col, average_over), "deworming_day"),
                .progress = "text", 
                .parallel = TRUE, .paropts = lst(.packages = c("broom", "magrittr", "stringr", "tidyverse"), 
                                                 .export = c("iter_summarizer", "quants")),
                .fun = function(.data, quants) {
                  .data %>% 
                    group_by(iter_id) %>% 
                    summarize_at(vars(prob_deworm, alpha, kappa_dyn_treat), 
                                 funs(Hmisc::wtd.mean(., weights = treatment_group_size))) %>% 
                    ungroup() %>%
                    {
                      bind_cols(summarize_at(., vars(prob_deworm, alpha, kappa_dyn_treat), mean), 
                                t(quantile(.$prob_deworm, probs = quants / 100, names = FALSE)) %>% 
                                  tidy() %>% 
                                  set_colnames(str_c("prob_deworm_quant_", quants)))
                    }
                  }, quants = quants)
}

fast_sim_mean_treatment_group <- fast_sim %>%  
  group_by_at(vars(fast_treatment_id, treatment_col, "deworming_day")) %>% 
  do(iter_summarizer(.)) %>%  
  ungroup()

fast_sim_mean_phone_owner_monitored <- fast_sim_mean_treatment_group %>%  
  filter(!name_matched) 

fast_sim_mean_phone_owner <- fast_sim %>% 
  combine_treatment_group("name_matched")

fast_sim_mean_monitored <- fast_sim %>% 
  filter(!name_matched) %>% 
  combine_treatment_group("phone_owner")

fast_sim_mean <- fast_sim %>% 
  combine_treatment_group(c("phone_owner", "name_matched"))

save(fast_sim, fast_sim_day13_only, fast_sim_mean, fast_sim_mean_monitored, fast_sim_mean_phone_owner, fast_sim_mean_phone_owner_monitored, 
     fast_sim_mean_treatment_group, fast_sim, quants, 
     file = file.path("data", "prepared_fast_sim.RData"))
```

```{r, eval=FALSE}
fast_sim %>% 
  distinct_(.dots = c("fast_treatment_id", treatment_col, "treatment_group_size")) %>% 
  filter(dyn_treat_days == 11) %>% 
  select(-dyn_treat_days)
```

```{r}
load(file.path("data", "prepared_fast_sim.RData"))
```


```{r fast-sim-ate}
fast_sim_ate_pairs <- tribble(
  ~incentive_treatment_left,  ~sms.treatment.2_left, ~incentive_treatment_right, ~sms.treatment.2_right,
  
  "ink",                      "sms.control",         "control",                  "sms.control",
  "calendar",                 "sms.control",         "control",                  "sms.control",
  "bracelet social",          "sms.control",         "control",                  "sms.control",
  "bracelet",                 "sms.control",         "control",                  "sms.control",
  
  "control",                  "reminder.only",       "control",                  "sms.control",
  "control",                  "social.info",         "control",                  "sms.control",
  "ink",                      "social.info",         "control",                  "sms.control",
  "calendar",                 "social.info",         "control",                  "sms.control",
  "bracelet social",          "social.info",         "control",                  "sms.control",
  "bracelet",                 "social.info",         "control",                  "sms.control",
  
  "ink",                      "social.info",         "ink",                      "sms.control",
  "calendar",                 "social.info",         "calendar",                 "sms.control",
  "bracelet social",          "social.info",         "bracelet social",          "sms.control",
  "bracelet",                 "social.info",         "bracelet",                 "sms.control",

  "ink",                      "social.info",         "control",                  "social.info",
  "calendar",                 "social.info",         "control",                  "social.info",
  "bracelet social",          "social.info",         "control",                  "social.info",
  "bracelet",                 "social.info",         "control",                  "social.info"
) %>% 
  mutate(monitored_only = sms.treatment.2_left != "sms.control" | sms.treatment.2_right != "sms.control")

dyn_fast_sim_ate_pairs <- tribble(
  ~incentive_treatment_left,  ~sms.treatment.2_left, ~incentive_treatment_right, ~sms.treatment.2_right,
  
  "control",                  "reminder.only",       "control",                  "sms.control",
  "control",                  "social.info",         "control",                  "sms.control",
  "ink",                      "sms.control",         "control",                  "sms.control",
  "bracelet social",          "sms.control",         "control",                  "sms.control",
  "bracelet",                 "sms.control",         "control",                  "sms.control",
  "ink",                      "social.info",         "control",                  "sms.control",
  "calendar",                 "social.info",         "control",                  "sms.control",
  "bracelet social",          "social.info",         "control",                  "sms.control",
  "bracelet",                 "social.info",         "control",                  "sms.control",
  "ink",                      "social.info",         "ink",                      "sms.control",
  "calendar",                 "social.info",         "calendar",                 "sms.control",
  "bracelet social",          "social.info",         "bracelet social",          "sms.control",
  "bracelet",                 "social.info",         "bracelet",                 "sms.control"
) %>% 
  mutate(monitored_only = sms.treatment.2_left != "sms.control" | sms.treatment.2_right != "sms.control")

summarize_ate_diff <- . %>% {
  bind_cols(summarize(., prob_deworm_ate = mean(prob_deworm_diff)), 
            tidy(t(quantile(.$prob_deworm_diff, probs = quants / 100, names = FALSE))) %>% 
              set_colnames(str_c("prob_deworm_diff_quant_", quants)))
}

fast_sim_ate <- fast_sim_ate_pairs %>% 
  rowwise() %>% 
  do(diff_data = inner_join(filter(fast_sim_day13_only,
                                   dyn_treat_days == 11,
                                   incentive_treatment == .$incentive_treatment_left,
                                   sms.treatment.2 == .$sms.treatment.2_left),
                            filter(fast_sim_day13_only, 
                                   dyn_treat_days == 11,
                                   incentive_treatment == .$incentive_treatment_right,
                                   sms.treatment.2 == .$sms.treatment.2_right),
                            c("iter_id", "phone_owner", "name_matched", "dist.pot.group", "dyn_treat_days"),
                            suffix = c("_left", "_right")) %>%
       mutate(prob_deworm_diff = prob_deworm_left - prob_deworm_right)) %>% 
  do(ate_phone_owner = group_by_at(.$diff_data, 
                                   vars(phone_owner, dist.pot.group, 
                                        starts_with("incentive_treatment"), starts_with("sms.treatment.2"), starts_with("dyn_treat_days"))) %>% 
       do(summarize_ate_diff(.)) %>%  
       ungroup(),
     ate_all = group_by_at(.$diff_data, vars(dist.pot.group, 
                                           starts_with("incentive_treatment"), starts_with("sms.treatment.2"), starts_with("dyn_treat_days"))) %>% 
       do(summarize_ate_diff(.)) %>%  
       ungroup()) %>% 
  ungroup()

dyn_fast_sim_ate <- dyn_fast_sim_ate_pairs %>% 
  rowwise() %>% 
  do(diff_data = inner_join(filter(fast_sim,
                                   incentive_treatment == .$incentive_treatment_left,
                                   sms.treatment.2 == .$sms.treatment.2_left),
                            filter(fast_sim, 
                                   incentive_treatment == .$incentive_treatment_right,
                                   sms.treatment.2 == .$sms.treatment.2_right), 
                            c("iter_id", "phone_owner", "name_matched", "dist.pot.group", "deworming_day"), 
                            suffix = c("_left", "_right")) %>% 
       mutate(prob_deworm_diff = prob_deworm_left - prob_deworm_right)) %>% 
  do(ate_phone_owner = group_by_at(.$diff_data, 
                                   vars(phone_owner, dist.pot.group, deworming_day,
                                        starts_with("incentive_treatment"), starts_with("sms.treatment.2"), starts_with("dyn_treat_days"))) %>% 
       do(summarize_ate_diff(.)) %>%  
       ungroup(),
     ate_all = group_by_at(.$diff_data, vars(dist.pot.group, deworming_day, 
                                           starts_with("incentive_treatment"), starts_with("sms.treatment.2"), starts_with("dyn_treat_days"))) %>% 
       do(summarize_ate_diff(.)) %>%  
       ungroup()) %>% 
  ungroup()
```

##### Daily Take-up

In the below plots we look at how the daily probability of take-up responds to shutting down the dynamic component of the duration analysis model in the hope of being able to shut down learning.  

In the first two plots we look at how observation of signals over time might have impacted take-up.

```{r fast-sim-daily-obs-plot, fig.width=12, fig.height=6}
fast_sim_mean_monitored %>%
  filter(deworming_day <= 12, 
         incentive_treatment %in% c("control", "ink", "bracelet", "bracelet social"),
         sms.treatment.2 == "sms.control",
         dyn_treat_days %in% c(0, 11)) %>% 
  mutate(obs_type = ifelse(incentive_treatment == "control", 0, dyn_treat_days) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs"))) %>% 
  ggplot(aes(x = deworming_day)) +
  geom_line(aes(y = prob_deworm, group = str_c(dyn_treat_days, incentive_treatment), linetype = obs_type, color = fct_relabel(incentive_treatment, str_to_title))) +
  geom_ribbon(aes(ymin = no_obs, ymax = full_obs, group = incentive_treatment), 
              alpha = 0.2,
              data = . %>%
                filter(incentive_treatment != "control") %>%
                select(deworming_day, dist.pot.group, incentive_treatment, obs_type, prob_deworm) %>%
                spread(obs_type, prob_deworm)) +
  scale_x_continuous("Deworming Day", breaks = 1:12, minor_breaks = FALSE) +
  scale_linetype_discrete("Days Observing Signal", labels = c("No Observation", "Full Observation")) +
  scale_color_discrete("Incentive/Signal Treatment") +
  facet_wrap(~ dist.pot.group, nrow = 1,  
             labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .))) +
  labs(title = "Daily Mean Probability of Deworming Take-up with Varying Days of Signal Observation", y = "Posterior Mean Probability of Deworming") +
  theme(legend.position = "right")
```

```{r fast-sim-daily-obs-plot-phone-owner, fig.width=12, fig.height=8}
fast_sim_mean_phone_owner_monitored %>%
  filter(deworming_day <= 12, 
         incentive_treatment %in% c("control", "ink", "bracelet"),
         sms.treatment.2 == "sms.control",
         dyn_treat_days %in% c(0, 11)) %>% 
  mutate(obs_type = ifelse(incentive_treatment == "control", 0, dyn_treat_days) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs")),
         phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners")) %>% 
  ggplot(aes(x = deworming_day)) +
  geom_line(aes(y = prob_deworm, group = str_c(dyn_treat_days, incentive_treatment), linetype = obs_type, color = fct_relabel(incentive_treatment, str_to_title))) +
  geom_ribbon(aes(ymin = no_obs, ymax = full_obs, group = incentive_treatment), #fill = fct_relabel(incentive_treatment, str_to_title)), 
              alpha = 0.2,
              data = . %>%
                filter(incentive_treatment != "control") %>%
                select(deworming_day, dist.pot.group, phone_owner, incentive_treatment, obs_type, prob_deworm) %>%
                spread(obs_type, prob_deworm)) +
  scale_x_continuous("Deworming Day", breaks = 1:12, minor_breaks = FALSE) +
  scale_linetype_discrete("Days Observing Signal", labels = c("No Observation", "Full Observation")) +
  scale_color_discrete("Incentive/Signal Treatment") +
  facet_grid(phone_owner ~ dist.pot.group, scales = "free_y",
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)))) +
  labs(title = "Daily Probability of Deworming Take-up with Varying Days of Signal Observation", y = "Posterior Probability of Deworming") +
  theme(legend.position = "bottom")
```

The below plot shows the evolution of the exponential function of the quadratic dynamic component of the model (a value of one means no change).  

Recall that our model of take-up can roughly be presented as

$$
\Pr[Y_{im}(t) = 1| Y_{i,m-1} = 0, \theta] = 1 - \exp\left[-\kappa^\text{static effect}(t)\cdot\kappa^\text{dynamic effect}(t)\cdot\lambda_m\right]
$$
so we can "shutdown" learning/observation by forcing $\kappa^\text{dynamic effect}(t) = 1$. 

```{r fast-sim-daily-dyn-kappa, fig.width=12, fig.height=6}
fast_sim_mean %>%
  filter(deworming_day <= 12, 
         dist.pot.group == "close", # Until we add distance to dynamic kappa
         incentive_treatment %in% c("ink", "bracelet"),
         sms.treatment.2 == "sms.control",
         dyn_treat_days %in% c(0, 11)) %>% 
  mutate(obs_type = ifelse(incentive_treatment == "control", 0, dyn_treat_days) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs")),
         incentive_treatment = fct_relabel(incentive_treatment, str_to_title)) %>% 
  filter(obs_type == "full_obs") %>% 
  ggplot(aes(x = deworming_day)) +
  geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
  geom_line(aes(y = kappa_dyn_treat, 
                group = str_c(dyn_treat_days, incentive_treatment, dist.pot.group), 
                # linetype = dist.pot.group,
                color = incentive_treatment)) +
  scale_x_continuous("Deworming Day", breaks = 1:12, minor_breaks = FALSE) +
  scale_color_discrete("Incentive/Signal Treatment") +
  scale_fill_discrete("Incentive/Signal Treatment") +
  # scale_linetype_discrete("Distance") +
  # facet_wrap (~ dist.pot.group, nrow = 1, labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .))) +
  labs(title = expression(paste("Daily Change in Dynamic Component of ", kappa, " Function")), 
       subtitle = "In response to signal observation only",
       y = expression(paste("Posterior Mean of ", kappa^dyn))) +
  theme(legend.position = "right")
```

```{r fast-sim-daily-dyn-kappa-phone-owner, fig.width=12, fig.height=8}
fast_sim_mean_phone_owner %>%
  filter(deworming_day <= 12, 
         incentive_treatment %in% c("ink", "bracelet"),
         sms.treatment.2 == "sms.control",
         dyn_treat_days %in% c(0, 11)) %>% 
  mutate(obs_type = ifelse(incentive_treatment == "control", 0, dyn_treat_days) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs")),
         phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners"),
         incentive_treatment = fct_relabel(incentive_treatment, str_to_title)) %>% 
  filter(obs_type == "full_obs") %>% 
  ggplot(aes(x = deworming_day)) +
  geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
  geom_line(aes(y = kappa_dyn_treat, 
                group = str_c(dyn_treat_days, incentive_treatment), 
                color = incentive_treatment)) +
                # fill = incentive_treatment), alpha = 0.25, position = "identity") +
  scale_x_continuous("Deworming Day", breaks = 1:12, minor_breaks = FALSE) +
  scale_color_discrete("Incentive/Signal Treatment") +
  scale_fill_discrete("Incentive/Signal Treatment") +
  # coord_cartesian(ylim = c(0.75, 1.5)) +
  facet_grid(phone_owner ~ dist.pot.group, scales = "free_y",
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)))) +
  labs(title = expression(paste("Daily Change in Dynamic Component of ", kappa, " Function")), subtitle = "In response to signal observation only",
       y = expression(paste("Posterior Mean of ", kappa^dyn))) +
  theme(legend.position = "bottom")
```


In the below plot we look at the difference in the probablity (in comparison to the control arm with no SMS treatment) in response to signal observation.

```{r fast-sim-daily-ate-obs-plot, fig.width=12, fig.height=6}
dyn_fast_sim_ate %>% 
  unnest(ate_all) %>%
  filter(deworming_day <= 12,
         incentive_treatment_left %in% c("control", "ink", "bracelet social", "bracelet"), 
         incentive_treatment_right == "control",
         sms.treatment.2_left == "sms.control",
         dyn_treat_days_left %in% c(0, 11)) %>% 
  mutate(obs_type = ifelse(incentive_treatment_left == "control", 0, dyn_treat_days_left) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs"))) %>% 
  ggplot(aes(x = deworming_day)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = alpha("black", 0.5)) +
  geom_line(aes(y = prob_deworm_ate, linetype = obs_type, group = str_c(dyn_treat_days_left, incentive_treatment_left), color = fct_relabel(incentive_treatment_left, str_to_title))) +
  geom_ribbon(aes(ymin = no_obs, ymax = full_obs, group = incentive_treatment_left), alpha = 0.2,
              data = . %>%
                select(deworming_day, dist.pot.group,incentive_treatment_left, prob_deworm_ate, obs_type) %>%
                spread(obs_type, prob_deworm_ate)) +
  scale_x_continuous("Deworming Day", breaks = 1:12, minor_breaks = FALSE) +
  scale_linetype_discrete("Days Observing Signal", labels = c("No Observation", "Full Observation")) +
  scale_color_discrete("Incentive/Signal Treatment") +
  facet_wrap(~ dist.pot.group, nrow = 1,
             labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .))) +
  labs(title = "Daily Treatment Effect with Varying Days of Signal Observation", 
       subtitle = "With no SMS treatment and the control (no SMS) arm as reference", 
       y = "Posterior Mean Difference in Probability of Deworming") +
  theme(legend.position = "right") 
```

```{r fast-sim-daily-ate-obs-plot-phone-owner, fig.width=12, fig.height=8}
dyn_fast_sim_ate %>% 
  unnest(ate_phone_owner) %>%
  filter(deworming_day <= 12,
         incentive_treatment_left %in% c("control", "ink", "bracelet social", "bracelet"), 
         incentive_treatment_right == "control",
         sms.treatment.2_left == "sms.control",
         dyn_treat_days_left %in% c(0, 11)) %>% 
  mutate(obs_type = ifelse(incentive_treatment_left == "control", 0, dyn_treat_days_left) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs")),
         phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners")) %>% 
  ggplot(aes(x = deworming_day)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = alpha("black", 0.5)) +
  geom_line(aes(y = prob_deworm_ate, linetype = obs_type, group = str_c(dyn_treat_days_left, incentive_treatment_left), color = fct_relabel(incentive_treatment_left, str_to_title))) +
  geom_ribbon(aes(ymin = no_obs, ymax = full_obs, group = incentive_treatment_left), alpha = 0.2,
              data = . %>%
                select(deworming_day, dist.pot.group, phone_owner, incentive_treatment_left, prob_deworm_ate, obs_type) %>%
                spread(obs_type, prob_deworm_ate)) +
  scale_x_continuous("Deworming Day", breaks = 1:12, minor_breaks = FALSE) +
  scale_linetype_discrete("Days Observing Signal", labels = c("No Observation", "Full Observation")) +
  scale_color_discrete("Incentive/Signal Treatment") +
  facet_grid(phone_owner ~ dist.pot.group, scales = "free_y",
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)))) +
  labs(title = "Daily Treatment Effect with Varying Days of Signal Observation", 
       subtitle = "With no SMS treatment and the control (no SMS) arm as reference", y = "Posterior Difference in Probability of Deworming") +
  theme(legend.position = "bottom") 
```

In the two below plots we look at how the daily probability of take-up evolves over time in response to SMS and signal observation treatments. As done above, we try to shut down the learning aspect of SMS treatment.

```{r fast-sim-daily-sms-plot, fig.width=12, fig.height=8}
fast_sim_mean_phone_owner_monitored %>%
  filter(deworming_day <= 12, 
         dist.pot.group == "close",
         phone_owner,
         dyn_treat_days %in% c(0, 11)) %>% 
  mutate(obs_type = case_when(incentive_treatment == "control" & sms.treatment.2 == "sms.control" ~ 0, 
                              incentive_treatment == "calendar" & sms.treatment.2 == "sms.control" ~ 0,
                              TRUE ~ dyn_treat_days) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs"))) %>% 
  ggplot(aes(x = deworming_day)) +
  geom_line(aes(y = prob_deworm, group = str_c(dyn_treat_days, sms.treatment.2), linetype = obs_type, color = sms.treatment.2)) +
  geom_ribbon(aes(ymin = no_obs, ymax = full_obs, group = sms.treatment.2),
              alpha = 0.2,
              data = . %>%
                filter(incentive_treatment != "control") %>%
                select(deworming_day, dist.pot.group, phone_owner, incentive_treatment, sms.treatment.2, obs_type, prob_deworm) %>%
                spread(obs_type, prob_deworm)) +
  scale_x_continuous("Deworming Day", breaks = seq(2, 12, 2), minor_breaks = TRUE) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  scale_linetype_discrete("Days Observing Signal", labels = c("No Observation", "Full Observation")) +
  facet_wrap(~ incentive_treatment, 
             labeller = as_labeller(. %>% str_to_title())) +
  labs(title = "Daily Probability of Deworming Take-up with Varying Days of SMS Treatment", y = "Posterior Probability of Deworming") +
  theme(legend.position = "right")
```

The below plot shows the evolution of the exponential function of the quadratic dynamic component of the model (a value of one means no change).  

```{r sim-fast-daily-sms-dyn-kappa, fig.width=12, fig.height=8}
fast_sim_mean_phone_owner %>%
  filter(deworming_day <= 12, 
         phone_owner,
         dyn_treat_days %in% c(0, 11)) %>% 
  mutate(obs_type = case_when(incentive_treatment == "control" & sms.treatment.2 == "sms.control" ~ 0, 
                              incentive_treatment == "calendar" & sms.treatment.2 == "sms.control" ~ 0,
                              TRUE ~ dyn_treat_days) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs"))) %>% 
  filter(obs_type == "full_obs") %>% 
  ggplot(aes(x = deworming_day)) +
  geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
  geom_line(aes(y = kappa_dyn_treat, 
                group = str_c(dyn_treat_days, sms.treatment.2), 
                color = sms.treatment.2)) +
                # fill = sms.treatment.2), alpha = 0.25, position = "identity") +
  scale_x_continuous("Deworming Day", breaks = seq(1, 12, 2), minor_breaks = FALSE) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  # coord_cartesian(ylim = c(0.9)) +
  # facet_grid(incentive_treatment ~ dist.pot.group, scales = "free_y",
  facet_wrap(~ incentive_treatment, ncol = 3, labeller = as_labeller(. %>% str_to_title())) +
  labs(title = expression(paste("Daily Change in Dynamic Component of ", kappa, " Function")), 
       subtitle = "In response to signal observation and SMS treatment.",
       y = expression(paste("Posterior Mean of ", kappa^dyn))) +
  theme(legend.position = "right")
```

```{r fast-sim-daily-ate-sms-plot, fig.width=12, fig.height=8}
dyn_fast_sim_ate %>%
  unnest(ate_phone_owner) %>% 
  filter(deworming_day <= 12,
         phone_owner,
         sms.treatment.2_left != "sms.control" | incentive_treatment_left %in% c("ink", "bracelet social", "bracelet"),
         incentive_treatment_right == "control",
         dyn_treat_days_left %in% c(0, 11)) %>% 
  mutate(obs_type = case_when(incentive_treatment_left == "control" & sms.treatment.2_left == "sms.control" ~ 0, 
                              incentive_treatment_left == "calendar" & sms.treatment.2_left == "sms.control" ~ 0,
                              TRUE ~ dyn_treat_days_left) %>% 
           factor(levels = c(0, 11), labels = c("no_obs", "full_obs"))) %>% 
  ggplot(aes(x = deworming_day)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = alpha("black", 0.5)) +
  geom_line(aes(y = prob_deworm_ate, linetype = obs_type, group = str_c(dyn_treat_days_left, sms.treatment.2_left), color = sms.treatment.2_left)) +
  geom_ribbon(aes(ymin = no_obs, ymax = full_obs, group = sms.treatment.2_left), alpha = 0.2,
              data = . %>%
                select(deworming_day, dist.pot.group, phone_owner, incentive_treatment_left, sms.treatment.2_left, obs_type, prob_deworm_ate) %>%
                spread(obs_type, prob_deworm_ate)) +
  scale_x_continuous("Deworming Day", breaks = seq(2, 12, 2), minor_breaks = TRUE) +
  scale_linetype_discrete("Days Observing Signal", labels = c("No Observation", "Full Observation")) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  facet_grid(incentive_treatment_left ~ dist.pot.group,  #scales = "free_y",
             labeller = labeller(.cols = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)),
                                 .rows = as_labeller(. %>% str_to_title()))) +
  labs(title = "Daily Treatment Effect with Varying Days of SMS Treatment", 
       subtitle = "with the control (no SMS) arm as reference", 
       y = "Posterior Mean Difference in Probability of Deworming") +
  theme(legend.position = "right") 
```

```{r fast-sim-takeup-day-one}
sms_ctrl_day_one_takeup_plot <- fast_sim_mean_phone_owner_monitored %>% 
  filter(deworming_day == 1,
         phone_owner,
         dyn_treat_days == 11,
         sms.treatment.2 == "sms.control") %>%
  ggplot(aes(fct_relabel(incentive_treatment, str_to_title), prob_deworm, color = sms.treatment.2)) +
  geom_pointrange(aes(ymin = prob_deworm_quant_5, ymax = prob_deworm_quant_95), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  coord_flip() +
  facet_wrap(~ dist.pot.group,  
             labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)),
             ncol = 1) +
  labs(title = "Deworming Take-up on Day One", 
       subtitle = "Across all treatments, phone owners only, and with no SMS treatment", 
       x = "Incentive/Signal Treatment", 
       y = "Posterior Probability of Deworming", 
       caption = "Points show the mean while line ranges show the 90% probability interval.") +
  theme(legend.position = "bottom")
```

```{r}
plot(sms_ctrl_day_one_takeup_plot)
```

```{r fast-sim-ate-day-one}
sms_ctrl_takeup <- fast_sim_mean_phone_owner_monitored %>% 
  filter(deworming_day == 1,
         phone_owner,
         dyn_treat_days == 11,
         sms.treatment.2 == "sms.control") 

sms_day_one_ate_plot <- dyn_fast_sim_ate %>%
  unnest(ate_phone_owner) %>% 
  filter(deworming_day == 1,
         phone_owner,
         dyn_treat_days_left == 11,
         dyn_treat_days_right == 11,
         incentive_treatment_left == incentive_treatment_right,
         sms.treatment.2_left != "sms.control",
         sms.treatment.2_right == "sms.control") %>% 
  rename(incentive_treatment = incentive_treatment_left,
         sms.treatment.2 = sms.treatment.2_left,
         prob_deworm = prob_deworm_ate,
         prob_deworm_quant_5 = prob_deworm_diff_quant_5, 
         prob_deworm_quant_95 = prob_deworm_diff_quant_95) %>% 
  bind_rows(ate = ., sms_ctrl = sms_ctrl_takeup, .id = "estimate_type") %>% 
  mutate(sms.treatment.2 = fct_recode(sms.treatment.2, "None" = "sms.control", "Reminders Only" = "reminder.only", "Social Information" = "social.info"),
         incentive_treatment = fct_relabel(incentive_treatment, str_to_title)) %>% 
  ggplot(aes(x = incentive_treatment, y = prob_deworm)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = alpha("black", 0.5)) +
  geom_pointrange(aes(ymin = prob_deworm_quant_5, ymax = prob_deworm_quant_95, color = sms.treatment.2, shape = estimate_type), 
                  position = position_dodge(width = 0.4)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA) +
  scale_color_discrete("SMS Treatment") +
  scale_shape_discrete("Estimate", labels = c("Treatment Effect", "No SMS Take-up Level")) +
  coord_flip() +
  facet_wrap(~ dist.pot.group, scales = "free_y", labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)), ncol = 1, strip.position = "top") +
  labs(title = "Treatment Effect of SMS Treatment on Day One",
       subtitle = "For phone owners only", 
       x = "Signal/Incentive Treatment", y = "") +
  theme(legend.position = "right") 

plot(sms_day_one_ate_plot)
```

##### Overall Take-up

```{r sim-fast-take-up, fig.width=12, fig.height=7}
fast_sim_mean_monitored %>% 
  filter(deworming_day == 13, 
         dyn_treat_days == 11) %>% 
  ggplot(aes(fct_relabel(incentive_treatment, str_to_title), prob_deworm, color = sms.treatment.2)) +
  geom_pointrange(aes(ymin = prob_deworm_quant_2.5, ymax = prob_deworm_quant_97.5), size = 0.5, position = position_dodge(width = 0.5)) +
  geom_linerange(aes(ymin = prob_deworm_quant_5, ymax = prob_deworm_quant_95), size = 1.5, position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm), color = NULL), nudge_x = -1, size = 3, segment.color = NA) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  coord_flip(ylim = c(0, 1)) +
  facet_wrap(~ dist.pot.group,  
             labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .)),
             ncol = 1) +
  labs(title = "Deworming Take-up", 
       subtitle = "Across all treatments", 
       x = "Incentive/Signal Treatment", 
       y = "Posterior Probability of Deworming", 
       caption = "Points on plot are the mean point estimates.\nThe thick and thin vertical lines show the 90% and 95% posterior probability ranges, respectively.") + 
  theme(legend.position = "right")
```

```{r sim-fast-take-up-phone-owner, fig.width=12, fig.height=8}
fast_sim_mean_phone_owner_monitored %>% 
  filter(deworming_day == 13, 
         dyn_treat_days == 11) %>%
  mutate(phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners")) %>% 
  ggplot(aes(fct_relabel(incentive_treatment, str_to_title), prob_deworm, color = sms.treatment.2)) +
  geom_pointrange(aes(ymin = prob_deworm_quant_5, ymax = prob_deworm_quant_95), position = position_dodge(width = 0.5)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  coord_flip(ylim = c(0, 1)) +
  facet_wrap(~ dist.pot.group + phone_owner, scales = "free_y", 
             labeller = labeller(dist.pot.group = . %>% str_to_title() %>% str_c("Distance: ", .)),
             ncol = 1) +
  labs(title = "Deworming Take-up", subtitle = "Across all treatments and subgroups", 
       x = "Incentive/Signal Treatment", y = "Posterior Probability of Deworming", 
       caption = "Points show the mean while line ranges show the 90% probability interval.") +
  theme(legend.position = "bottom")
```


```{r fast-sim-ate-plot, fig.width=12, fig.height=8}
fast_sim_ate %>%
  unnest(ate_all) %>% 
  mutate(ref = if_else(incentive_treatment_right == "control" & sms.treatment.2_right == "sms.control", 
                       "control-sms.control", 
                       if_else(sms.treatment.2_right == "sms.control", "own sms.control", "control-social.info")),
         ref = fct_relevel(ref, "control-sms.control", "own sms.control", "control-social.info")) %>%
  ggplot(aes(fct_relabel(incentive_treatment_left, str_to_title), prob_deworm_ate, color = sms.treatment.2_left, shape = ref)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_pointrange(aes(ymin = prob_deworm_diff_quant_5, ymax = prob_deworm_diff_quant_95), position = position_dodge(width = 0.4)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm_ate), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  scale_shape_discrete("Reference", labels = c("Control, No SMS", "Same Arm, No SMS", "Control, Social Info")) +
  coord_flip() +
  facet_wrap(~ dist.pot.group, ncol = 1, 
             labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .))) +
  labs(title = "Treatment Effect on Deworming Take-up", 
       x = "Incentive/Signal Treatment", 
       y = "Posterior Difference in Probability of Deworming", 
       caption = "Points on plot are the mean point estimates.\nThe thick and thin vertical lines show the 90% and 95% posterior probability ranges, respectively.") + 
  theme(legend.position = "right", legend.direction = "vertical")
```

```{r fast-sim-ate-plot-phone-owner, fig.width=12, fig.height=8}
fast_sim_ate %>%
  unnest(ate_phone_owner) %>% 
  mutate(ref = if_else(incentive_treatment_right == "control" & sms.treatment.2_right == "sms.control", 
                       "control-sms.control", 
                       if_else(sms.treatment.2_right == "sms.control", "own sms.control", "control-social.info")),
         phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners")) %>% 
  ggplot(aes(fct_relabel(incentive_treatment_left, str_to_title), prob_deworm_ate, color = sms.treatment.2_left, shape = ref)) +
  # ggplot(aes(fct_relabel(incentive_treatment_left, str_to_title), prob_deworm_ate, color = sms.treatment.2_left, shape = ref, linetype = obs_type)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_pointrange(aes(ymin = prob_deworm_diff_quant_5, ymax = prob_deworm_diff_quant_95), position = position_dodge(width = 0.4)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm_ate), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  scale_shape_discrete("Reference", labels = c("Control, No SMS", "Control, Social Info", "Same Arm, No SMS")) +
  coord_flip() +
  facet_wrap(~ dist.pot.group + phone_owner, scales = "free_y", ncol = 1,
             labeller = labeller(dist.pot.group = . %>% str_to_title() %>% str_c("Distance: ", .))) +
  labs(title = "Treatment Effect on Deworming Take-up", x = "Incentive/Signal Treatment", y = "Posterior Difference in Probability of Deworming", caption = "Points show the mean while line ranges show the 90% probability interval.") +
  theme(legend.position = "bottom")
```

```{r fast-sim-no-obs-plot, fig.width=12, fig.height=10, warning=FALSE}
bind_rows(observe = fast_sim_ate %>% 
            unnest(ate_all) %>% 
            filter(incentive_treatment_right == "control", sms.treatment.2_right == "sms.control"),
          no_observe = dyn_fast_sim_ate %>% 
            unnest(ate_all) %>% 
            filter(deworming_day == 13, 
                   dyn_treat_days_left == 0, 
                   incentive_treatment_left %in% c("ink", "bracelet", "bracelet social") | sms.treatment.2_left != "sms.control"),
          .id = "obs_type") %>% 
  filter(incentive_treatment_right == "control") %>% 
  mutate(obs_type = fct_relevel(obs_type, "no_observe", "observe")) %>% 
  ggplot(aes(fct_relabel(incentive_treatment_left, str_to_title), prob_deworm_ate, color = sms.treatment.2_left, linetype = obs_type)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_pointrange(aes(ymin = prob_deworm_diff_quant_5, ymax = prob_deworm_diff_quant_95), 
                  position = position_dodge(width = 0.6)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm_ate), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA) +
                  # data = . %>% filter(obs_type == "observe")) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  scale_linetype_manual("", values = c("dashed", "solid"), guide = "none") + #, labels = c("No Observation", "Normal Observation")) +
  coord_flip() +
  facet_wrap(~ dist.pot.group, ncol = 1, strip.position = "right",
             labeller = as_labeller(. %>% str_to_title() %>% str_c("Distance: ", .))) +
  labs(title = "Comparing Treatment Effects With and Without Observation", 
       x = "Incentive/Signal Treatment", 
       y = "Posterior Mean Difference in the Probability of Deworming", 
       caption = "Points show the mean while line ranges show the 90% probability interval.\nDashed lines show treatment effects with no observation.") +
  theme(legend.position = "right")
```

```{r fast-sim-no-obs-plot-phone-owner, fig.width=12, fig.height=10, warning=FALSE}
bind_rows(observe = fast_sim_ate %>% 
            unnest(ate_phone_owner) %>% 
            filter(incentive_treatment_right == "control", sms.treatment.2_right == "sms.control"),
          no_observe = dyn_fast_sim_ate %>% 
            unnest(ate_phone_owner) %>% 
            filter(deworming_day == 13, 
                   dyn_treat_days_left == 0, 
                   incentive_treatment_left %in% c("ink", "bracelet", "bracelet social") | sms.treatment.2_left != "sms.control"),
          .id = "obs_type") %>% 
  mutate(obs_type = fct_relevel(obs_type, "no_observe", "observe"),
         phone_owner = if_else(phone_owner, "Phone Owners", "Non-Phone Owners")) %>% 
  ggplot(aes(fct_relabel(incentive_treatment_left, str_to_title), prob_deworm_ate, color = sms.treatment.2_left, linetype = obs_type)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_pointrange(aes(ymin = prob_deworm_diff_quant_5, ymax = prob_deworm_diff_quant_95), 
                  position = position_dodge(width = 0.6)) +
  geom_text_repel(aes(label = sprintf("%.3f", prob_deworm_ate), color = NULL), nudge_x = -0.5, size = 3, segment.color = NA, 
                  data = . %>% filter(obs_type == "observe")) +
  scale_color_discrete("SMS Treatment", labels = c("None", "Reminders Only", "Social Information")) +
  scale_linetype_manual("", values = c("dashed", "solid")) + #, labels = c("No Observation", "Normal Observation")) +
  # scale_shape_discrete("Reference", labels = c("Control, No SMS", "Control, Social Info", "Same Arm, Social Info")) +
  coord_flip() +
  facet_wrap(~ dist.pot.group + phone_owner, scales = "free_y", ncol = 1, strip.position = "right",
             labeller = labeller(dist.pot.group = . %>% str_to_title() %>% str_c("Distance: ", .))) +
  labs(title = "Comparing Treatment Effects With and Without Observation", 
       x = "Incentive/Signal Treatment", 
       y = "Posterior Difference in Probability of Deworming", 
       caption = "Points show the mean while line ranges show the 90% probability interval.\nDashed lines show treatment effects with no observation.") +
  theme(legend.position = "bottom")
```

# Random Stuff

It's safe to ignore everything in this section.

## Priors

Just some plots to visualize what some prior distributions look like. Not very exciting.

```{r name-match-priors}
name_match_false_pos_alpha <- 1
name_match_false_pos_beta <- 15

ggplot(tibble(x = c(0, 1)), aes(x)) + 
  stat_function(fun = . %>% dbeta(shape1 = name_match_false_pos_alpha, shape2 = name_match_false_pos_beta)) + 
  labs(x = "Probability of False Positive", y = "Density", title = "Prior Distribution for the Name Matching Model") +
  scale_x_continuous(breaks = seq(0, 1, 0.1))
```

```{r scale-prior-plots}
ggplot(tibble(x = c(0, 20)), aes(x)) + 
  stat_function(aes(color = "Cauchy"), fun = . %>% dcauchy(0, 2.5)) + 
  stat_function(aes(color = "Student t(2)"), fun = . %>% dt(2)) + 
  stat_function(aes(color = "Student t(4)"), fun = . %>% dt(4)) + 
  stat_function(aes(color = "Student t(7)"), fun = . %>% dt(7)) + 
  stat_function(aes(color = "N(0, 5)"), fun = . %>% dnorm(0, 5)) + 
  scale_x_continuous(breaks = seq(0, 50, 1))
```