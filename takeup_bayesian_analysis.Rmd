---
title: "TakeUp Bayesian Analysis Notebook"
author:
- Anne Karing^[University of California Berkeley]
- Karim Naguib^[Evidence Action]
output:
  html_notebook:
    fig_align: "center"
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 5
header-includes:
   - \usepackage{bbm}
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r setup, include=FALSE}
library(magrittr)
library(purrr)
library(plyr)
library(dplyr)
library(multidplyr)
library(tibble)
library(tidyr)
library(lubridate)
library(forcats)
library(readr)
library(haven)
library(broom)
library(ggplot2)
library(ggrepel)
library(ggmap)
library(stringr)
library(knitr)
library(modelr)
library(rstan)

library(econometr)

source("takeup_rct_assign_clusters.R")
source("analysis_util.R")

knitr::read_chunk("analysis_util.R", labels = "analysis-util")

options(dplyr.show_progress = FALSE, digits = 4, mc.cores = max(1, parallel::detectCores()))
rstan_options(auto_write = TRUE)
```

```{r load-data, include=FALSE}
load(file.path("data", "analysis.RData"))
```

```{r name-match-priors}
name_match_false_pos_alpha <- 1
name_match_false_pos_beta <- 15

ggplot(tibble(x = c(0, 1)), aes(x)) + 
  stat_function(fun = . %>% dbeta(shape1 = name_match_false_pos_alpha, shape2 = name_match_false_pos_beta)) + 
  labs(x = "Probability of False Positive", y = "Density", title = "Prior Distribution for the Name Matching Model") +
  scale_x_continuous(breaks = seq(0, 1, 0.1))
```

```{r model-data}
stan_data <- analysis.data %>% 
  filter(!hh.baseline.sample, sms.treatment.2 == "sms.control") %>% 
  # filter(monitored, sms.treatment.2 == "sms.control", !hh.baseline.sample) %>% 
  mutate(new_cluster_id = factor(cluster.id) %>% as.integer(),
         name_matched = !true.monitored,
         phone_owner = sms.treatment.2 != "sms.control" | sms.ctrl.subpop == "phone.owner",
         age = if_else(!is.na(age), age, age.census),
         age_squared = age^2,
         missing_covar = is.na(floor)) %>% 
  unite(county_phone_owner_stratum, county, phone_owner, remove = FALSE) %>% 
  mutate(county_phone_owner_stratum = factor(county_phone_owner_stratum),
         stratum = county) %>% 
  mutate_at(vars(county_dist_stratum, county_dist_mon_stratum, county_phone_owner_stratum, county, stratum,
                 gender, school, floor, ethnicity), 
            funs(id = as.integer)) %>% 
  prep_data_arranger() %>% 
  prepare_bayesian_analysis_data(treatment_formula = ~ assigned.treatment * phone_owner,
                                 name_match_false_pos_alpha, 
                                 name_match_false_pos_beta)
```

```{r basic-model-0}
basic_model_0 <- stan_model(file = "takeup_model_0.stan", model_name = "model_0")
basic_model_0_fit <- sampling(basic_model_0, data = stan_data, chains = 1, iter =2, sample_file = file.path("stanfit", "basic_model_0.csv")) #, control = lst(adapt_delta = 0.99, max_treedepth = 15))
# basic_model_0_fit <- sampling(basic_model_0, dat  a = stan_data, chains = 1, iter = 1000) #, control = lst(adapt_delta = 0.99, max_treedepth = 15))

print(basic_model_0_fit, pars = c("cluster_effects", "missing_dewormed_any", "Sigma"), include = FALSE)
```

```{r covar-model-0, eval=FALSE}
covar_model_0 <- stan_model(file = "takeup_covar_model_0.stan", model_name = "covar_model_0")
covar_model_0_fit <- sampling(covar_model_0, data = stan_data, sample_file = file.path("stanfit", "covar_model_0.csv")) #, control = lst(adapt_delta = 0.99, max_treedepth = 15))
```

```{r name-match-model-0, eval=FALSE}
name_match_model_0 <- stan_model(file = "name_matching.stan", model_name = "name_match_model_0")
name_match_model_0_fit <- sampling(name_match_model_0, iter = 2000, data = stan_data, sample_file = file.path("stanfit", "name_match_model_0.csv"), control = lst(adapt_delta = 0.99)) #, max_treedepth = 15))

print(name_match_model_0_fit)
```