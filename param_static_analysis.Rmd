---
title: "TakeUp Parametric Static Model Analysis Notebook"
author:
- Anne Karing^[University of California Berkeley]
- Karim Naguib^[Evidence Action]
output:
  html_notebook:
    fig_align: "center"
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    number_sections: yes
    theme: flatly
    toc: yes
    # toc_float:
    #   collapsed: true
    #   smooth_scroll: false
    toc_depth: 5
header-includes:
   - \usepackage{bbm}
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

```{r param-setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "param_static_analysis-fig/")

library(magrittr)
library(foreach)
library(plyr)
library(lubridate)
library(forcats)
library(haven)
library(broom)
library(tidyverse)
library(ggrepel)
library(ggmap)
library(modelr)

library(rstan)
library(bayesplot)

library(econometr)

source("takeup_rct_assign_clusters.R")
source("analysis_util.R")

knitr::read_chunk("analysis_util.R", labels = "analysis-util")

load(file.path("data", "analysis.RData"))

options(dplyr.show_progress = TRUE, digits = 4) #, mc.cores = max(1, parallel::detectCores()))

theme_set(theme_minimal())
```

```{r param-parallel-setup}
num_cores <- tryCatch({
  yaml::yaml.load_file("../local_config.yaml") %$% cores
}, error = function(err) parallel::detectCores())

cl <- parallel::makeCluster(max(1, num_cores))
doParallel::registerDoParallel(cl)
```

```{r param-model-version}
# fit_version <- "param" 
fit_version <- "param_static_2962857" # Name matched and SMS
# fit_version <- "param_static_2330864" # Name matched and SMS

# global_subgroup <- NULL
global_subgroup <- "name_matched"

wtp_fit_version <- "wtp_multilevel_1"
```

Loading sampled estimates:

```{r load-param-model-fit}
model_fit <- dir("stanfit", pattern = str_interp("model_${fit_version}_\\d+.csv"), full.names = TRUE) %>%
  read_stan_csv()

check_hmc_diagnostics(model_fit)

rhat(model_fit) %>%  summary()

load(file.path("stan_analysis_data", str_interp("model_${fit_version}.RData")))
```


# Analyzing

```{r param-model-prep-data, include=FALSE}
static_treatment_cell_info <- param_stan_data$ate_treatments %>%
  mutate(treatment_size = with(param_stan_data, missing_treatment_sizes + observed_treatment_sizes)) %>% 
  left_join(param_stan_data$treatment_map, "all_treatment_id") %>% 
  select(-ends_with("_id"), all_treatment_id) %>% 
  mutate(treatment_rank = seq_len(n()),
         observed_treatment_size = param_stan_data$observed_treatment_sizes, 
         observed_takeup_prop = param_stan_data$observed_takeup_total / observed_treatment_size) %>% 
  unite(incentive_treatment, str_c(c("private", "social"), "_value"), sep = "-", remove = FALSE) %>% 
  create_incentive_treatment_col()

static_ate_pair_info <- param_stan_data$ate_pairs %>% 
  mutate(pair_rank = seq_len(n())) %>% 
  left_join(static_treatment_cell_info, c("rank_id_left" = "treatment_rank")) %>% 
  left_join(static_treatment_cell_info, c("rank_id_right" = "treatment_rank"), suffix = c("_left", "_right")) %>% 
  mutate(treatment_size = treatment_size_left)

est_deworming_takeup <- model_fit %>% 
  as.data.frame( pars = "est_takeup") %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(treatment_rank, iter_takeup, -iter_id) %>% 
  mutate(treatment_rank = str_extract(treatment_rank, "\\d+") %>% as.integer()) %>% 
  inner_join(static_treatment_cell_info, "treatment_rank") 

est_deworming_takeup_ate <- model_fit %>% 
  as.data.frame(pars = "est_takeup_ate") %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(outcome_id, iter_ate, -iter_id) %>% 
  mutate(pair_rank = str_extract(outcome_id, "\\d+") %>% as.integer()) %>% 
  inner_join(static_ate_pair_info, "pair_rank")
```

```{r param-takeup-levels, include=FALSE}
est_deworming_takeup_phone <- est_deworming_takeup %>% 
  prepare_est_deworming_takeup(subgroups = c(global_subgroup, "phone_owner"))

est_deworming_takeup_dist <- est_deworming_takeup %>% 
  prepare_est_deworming_takeup(subgroups = c(global_subgroup, "dist.pot.group"))

est_deworming_takeup_phone_dist <- est_deworming_takeup %>%
  prepare_est_deworming_takeup(subgroups = c(global_subgroup, "phone_owner", "dist.pot.group"))

est_deworming_takeup_all <- est_deworming_takeup %>% 
  prepare_est_deworming_takeup(subgroups = global_subgroup) 
```

```{r new-param-ate, include=FALSE}
est_deworming_takeup_ate_phone <- est_deworming_takeup_ate %>%
  filter(dist.pot.group_left == dist.pot.group_right) %>% 
  prepare_est_deworming_ate(subgroups = "phone_owner_left")

est_deworming_takeup_ate_dist <- est_deworming_takeup_ate %>% 
  prepare_est_deworming_ate(subgroups = str_c("dist.pot.group", c("_left", "_right")))

est_deworming_takeup_ate_phone_dist <- est_deworming_takeup_ate %>%
  prepare_est_deworming_ate(subgroups = c("phone_owner_left", str_c("dist.pot.group", c("_left", "_right"))))

est_deworming_takeup_ate_all <- est_deworming_takeup_ate %>% 
  filter(dist.pot.group_left == dist.pot.group_right) %>% 
  prepare_est_deworming_ate() 
```

```{r verify-level-sms-difference}
est_deworming_takeup_ate_phone_name_matched <- est_deworming_takeup_ate %>%
  filter(dist.pot.group_left == dist.pot.group_right) %>% 
  prepare_est_deworming_ate(subgroups = c("phone_owner_left", "name_matched_left"))

est_deworming_takeup_ate_dist_name_matched <- est_deworming_takeup_ate %>% 
  prepare_est_deworming_ate(subgroups = c(str_c("dist.pot.group", c("_left", "_right")), "name_matched_left"))

est_deworming_takeup_ate_all_name_matched <- est_deworming_takeup_ate %>%
  filter(dist.pot.group_left == dist.pot.group_right) %>%
  prepare_est_deworming_ate(subgroups = "name_matched_left")
```


```{r}
model_fit %>% 
  tidy(pars = str_c(c("stratum", "cluster"), "_student_df"))
```

## All Combined

### Take-up Levels

```{r param-takeup-level-all, fig.width=12, fig.height=4}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_all,
  takeup_data = est_deworming_takeup,
  combiner = . %>%
    subgroup_combiner("iter_takeup", subgroups = global_subgroup), 
  data_preparer = . %>%
    filter(
      # !name_matched,
      sms.treatment.2 == "control"
      ),
  incentive_treatment_col = "incentive_treatment"
    )
# ) + facet_wrap(~ name_matched, scales = "free") 
```

```{r static_level_smsctrl, fig.height=5, fig.width=8}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_all,
  data_preparer = . %>%
    filter(
      !name_matched,
      sms.treatment.2 == "control",
      incentive_treatment != "Bracelet Social"
      ),
  incentive_treatment_col = "incentive_treatment",
  show_observed = FALSE,
  num_obs = param_stan_data$num_obs
    ) +
  labs(y = "") 

ggsave(filename = "static_level_smsctrl.png", path = "march_2018_plots",
       width = 6.5, height = 3.25)
```


```{r param-takeup-level-all-sms, fig.width=10, fig.height=9}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_all,
  takeup_data = est_deworming_takeup,
  combiner = . %>%
    subgroup_combiner("iter_takeup", subgroups = "sms.treatment.2"), 
  data_preparer = . %>%
    filter(
      !name_matched
      ),
  incentive_treatment_col = "incentive_treatment",
  sms_treatment_col = "sms.treatment.2",
  include_sms_treatment = TRUE
)
```

```{r static_level_all, fig.width=8}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_phone,
  data_preparer = . %>%
    filter(
      phone_owner,
      !name_matched,
      incentive_treatment != "Bracelet Social"
      ),
  incentive_treatment_col = "incentive_treatment",
  sms_treatment_col = "sms.treatment.2",
  include_sms_treatment = TRUE,
  show_observed = FALSE,
  num_obs = param_stan_data$num_obs
    ) +
  labs(y = "", subtitle = "Phone Owners Only") 

ggsave(filename = "static_level_all.png", path = "march_2018_plots",
       width = 7.5, height = 4.25)
```

```{r param-takeup-level-all-smsctrl-only, fig.width=12, fig.height=4}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_all,
  data_preparer = . %>%
    filter(
      !name_matched,
      sms.treatment.2 == "control",
      # incentive_treatment != "Bracelet Social"
      ),
  incentive_treatment_col = "incentive_treatment"
    ) +
  labs(y = "") 
```

### ATE

```{r, fig.width=10, fig.height=8}
est_deworming_takeup_ate_all %>% 
  plot_ate(
    ate_summ_data = .,
    ate_data = est_deworming_takeup_ate,
    combiner = . %>%
      filter(dist.pot.group_left == dist.pot.group_right) %>% 
      subgroup_combiner("iter_ate"), 
    data_preparer = . %>% 
      filter(#incentive_treatment_right %in% c("Control", "Calendar"),
             incentive_treatment_left == incentive_treatment_right,
             sms.treatment.2_right == "No SMS",
             sms.treatment.2_left != "No SMS"),
    incentive_treatment_left_col = "incentive_treatment_left", sms_treatment_col = "sms.treatment.2_left",
    include_sms_treatment = TRUE
  ) + facet_grid(incentive_treatment_right ~ ., scales = "free_y", space = "free_y")
```

```{r param-ate-all, fig.width=10, fig.height=8}
est_deworming_takeup_ate_all %>% 
  plot_ate(
    ate_summ_data = .,
    ate_data = est_deworming_takeup_ate,
    combiner = . %>%
      filter(dist.pot.group_left == dist.pot.group_right) %>% 
      subgroup_combiner("iter_ate"), 
    data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"),
             incentive_treatment_left != incentive_treatment_right | sms.treatment.2_left %in% c("Reminders", "Social Info"),
             sms.treatment.2_right == "No SMS"),
    incentive_treatment_left_col = "incentive_treatment_left", sms_treatment_col = "sms.treatment.2_left",
    include_sms_treatment = TRUE
  ) + facet_grid(incentive_treatment_right ~ ., scales = "free_y", space = "free_y")
```

```{r param-ate-sms-ctrl, fig.width=8, fig.height=4.2}
est_deworming_takeup_ate_all %>% 
  plot_ate(
    ate_summ_data = .,
      data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"),
             # incentive_treatment_left != "Bracelet Social",
             incentive_treatment_left != incentive_treatment_right,
             sms.treatment.2_left == "No SMS",
             sms.treatment.2_left == sms.treatment.2_right),
    incentive_treatment_left_col = "incentive_treatment_left" 
  ) + 
  labs(y = "") +
  facet_grid(incentive_treatment_right ~ ., scales = "free_y", space = "free_y",  
             labeller = labeller(incentive_treatment_right = as_labeller(. %>% str_c("Compared To:\n", .)))) + 
  theme(#panel.background = element_rect(color = "darkgrey"),
        strip.background = element_rect(fill = "lightgrey", color = NA),
        panel.spacing = unit(0.5, "cm"))
```

```{r static_ate_smsctrl, fig.width=8, fig.height=4}
# est_deworming_takeup_ate_all_name_matched %>% # Used this check the different ATE for name_matched and monitored
est_deworming_takeup_ate_all %>%
  filter(incentive_treatment_left != "bracelet social",
         !(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar")) %>%
  plot_ate(
    ate_summ_data = .,
      data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"),
             incentive_treatment_left != incentive_treatment_right,
             sms.treatment.2_left == "control",
             sms.treatment.2_left == sms.treatment.2_right),
    incentive_treatment_left_col = "incentive_treatment_left" 
  ) + 
  labs(y = "")
       # subtitle = "ATE(z)",
       # x = "Incentive/signal (z)") #+ facet_wrap(~ name_matched_left)

ggsave(filename = "static_ate_smsctrl.png", path = "march_2018_plots",
       width = 7.5, height = 5)
```

```{r static_ate_smsctrl-2, fig.width=8, fig.height=4}
# est_deworming_takeup_ate_all_name_matched %>% # Used this check the different ATE for name_matched and monitored
est_deworming_takeup_ate_all %>%
  filter(incentive_treatment_left != "bracelet social",
         incentive_treatment_right == "control" | incentive_treatment_left == "bracelet") %>% 
  plot_ate(
    ate_summ_data = .,
      data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"),
             incentive_treatment_left != incentive_treatment_right,
             sms.treatment.2_left == "control",
             sms.treatment.2_left == sms.treatment.2_right),
    incentive_treatment_left_col = "incentive_treatment_left", 
    incentive_treatment_right_col = "incentive_treatment_right" 
  ) + 
  labs(y = "")
       # subtitle = "ATE(z)",
       # x = "Incentive/signal (z)") #+ facet_wrap(~ name_matched_left)

ggsave(filename = "static_ate_smsctrl_2.png", path = "march_2018_plots",
       width = 7.5, height = 5)
```


```{r static_ate_all, fig.width=8}
# est_deworming_takeup_ate_phone_name_matched %>%
est_deworming_takeup_ate_phone %>%
  mutate(same_incentive = incentive_treatment_left == incentive_treatment_right,
         same_sms = sms.treatment.2_left == sms.treatment.2_right) %>% 
  filter(phone_owner_left, 
         incentive_treatment_left != "bracelet social",
         !same_incentive & same_sms,
         sms.treatment.2_right != "reminder.only",
         !(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar")) %>% 
  plot_ate(
    ate_summ_data = .,
    incentive_treatment_left_col = "incentive_treatment_left",
    sms_treatment_col = "sms.treatment.2_left",
    include_sms_treatment = TRUE,
    num_obs = param_stan_data$num_obs
  ) + 
  labs(y = "", subtitle = "Phone Owners Only") #+ facet_wrap(~ name_matched_left)

ggsave(filename = "static_ate_all.png", path = "march_2018_plots",
       width = 7.5, height = 4.25)
```

```{r static_ate_all-2, fig.width=8}
# est_deworming_takeup_ate_phone_name_matched %>%
est_deworming_takeup_ate_phone %>%
  mutate(same_incentive = incentive_treatment_left == incentive_treatment_right,
         same_sms = sms.treatment.2_left == sms.treatment.2_right) %>% 
  filter(phone_owner_left, 
         incentive_treatment_left != "bracelet social",
         !same_incentive & same_sms,
         sms.treatment.2_right != "reminder.only",
         incentive_treatment_right == "control" | incentive_treatment_left == "bracelet") %>% 
  plot_ate(
    ate_summ_data = .,
    incentive_treatment_left_col = "incentive_treatment_left", 
    # incentive_treatment_right_col = "incentive_treatment_right",
    sms_treatment_col = "sms.treatment.2_left",
    include_sms_treatment = TRUE,
    num_obs = param_stan_data$num_obs
  ) + 
  labs(y = "", subtitle = "Phone Owners Only") #+ facet_wrap(~ name_matched_left)

ggsave(filename = "static_ate_all_2.png", path = "march_2018_plots",
       width = 7.5, height = 4.25)
```

```{r static_ate_signal_effect_sms_diff, fig.width=8, fig.height=4}
est_deworming_takeup_ate %>% 
  filter(incentive_treatment_left %in% c("ink", "calendar", "bracelet"),
         incentive_treatment_right == "control",
         phone_owner_left, phone_owner_right, !name_matched_left,
         dist.pot.group_left == dist.pot.group_right,
         sms.treatment.2_left == sms.treatment.2_right) %>% {
   inner_join(filter(., sms.treatment.2_left == "social.info"),
                filter(., sms.treatment.2_left == "control"),
                c("incentive_treatment_left", "dist.pot.group_left", "phone_owner_left", "treatment_size", "iter_id"),
                suffix = c("_sms", "_nosms"))  
 } %>% 
 mutate(iter_ate = iter_ate_sms - iter_ate_nosms) %>% 
 prepare_est_deworming_ate()  %>% 
 plot_ate(
   ate_summ_data = .,
   incentive_treatment_left_col = "incentive_treatment_left",
   include_sms_treatment = FALSE
 ) + 
 labs(y = "", subtitle = "Estimating difference in social effect going from no SMS treatment to social info treatment.")

ggsave(filename = "static_ate_signal_effect_sms_diff.png", path = "march_2018_plots",
       width = 7.5, height = 3.25)
```




```{r param-ate-with-sms, fig.width=10, fig.height=8}
# est_deworming_takeup_ate_all %>%   mutate(same_incentive = incentive_treatment_left == incentive_treatment_right,
#                                           same_sms = sms.treatment.2_left == sms.treatment.2_right) %>% 
#     select(incentive_treatment_left, sms.treatment.2_left, incentive_treatment_right, sms.treatment.2_right, same_incentive, same_sms) %>% arrange(same_incentive, same_sms) %>% filter(same_incentive | same_sms, sms.treatment.2_right != "reminder.only", incentive_treatment_left != "bracelet social") %>% arrange(incentive_treatment_right) %>%  print(n = 22)
est_deworming_takeup_ate_all %>% 
  mutate(same_incentive = incentive_treatment_left == incentive_treatment_right,
         same_sms = sms.treatment.2_left == sms.treatment.2_right) %>% 
  filter(same_incentive | same_sms, 
         sms.treatment.2_right != "reminder.only") %>% 
         # incentive_treatment_left != "bracelet social") %>%
  plot_ate(
    ate_summ_data = .,
    incentive_treatment_left_col = "incentive_treatment_left",
    include_sms_treatment = TRUE,
    sms_treatment_right = TRUE
  ) + 
  labs(y = "") +
  facet_grid(incentive_treatment_right ~ ., scales = "free_y", space = "free_y", 
             labeller = labeller(incentive_treatment_right = as_labeller(. %>% str_c("Compared To:\n", .)))) 
```

## Split by Distance

### Take-up Levels

```{r param-dyn-takeup-levels-dist, fig.width=10, fig.height=10}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_dist,
  takeup_data = est_deworming_takeup,
  combiner = . %>%
    subgroup_combiner("iter_takeup", "dist.pot.group"),
  data_preparer = . %>%
    filter(!name_matched) %>% 
    mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(., str_to_title))), 
  incentive_treatment_col = "incentive_treatment",
  sms_treatment_col = "sms.treatment.2",
  include_sms_treatment = TRUE
) +
  facet_wrap(~ dist.pot.group, ncol = 1)
```

```{r static_level_smsctrl_dist, fig.width=8, fig.height=7}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_dist,
  data_preparer = . %>%
    filter(
      !name_matched,
      sms.treatment.2 == "control",
      incentive_treatment != "Bracelet Social"
      ) %>% 
    mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(., str_to_title))), 
    incentive_treatment_col = "incentive_treatment", 
    show_observed = FALSE,
    num_obs = param_stan_data$num_obs
    ) +
  labs(y = "", subtitle = "Split by distance") +
  facet_wrap(~ dist.pot.group, ncol = 1) +
  theme(strip.text = element_text(size = 15, face = "bold"))

ggsave(filename = "static_level_smsctrl_dist.png", path = "march_2018_plots",
       width = 7.5, height = 5.5)
```

```{r static_level_all_dist, fig.width=8, fig.height=7}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_phone_dist,
  data_preparer = . %>%
    filter(
      phone_owner,
      !name_matched,
      incentive_treatment != "Bracelet Social"
      ) %>% 
    mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(., str_to_title))), 
    incentive_treatment_col = "incentive_treatment",
    sms_treatment_col = "sms.treatment.2",
    include_sms_treatment = TRUE,
    num_obs = param_stan_data$num_obs
  ) +
  labs(y = "", subtitle = "For phone owners only, split by distance.") +
  facet_wrap(~ dist.pot.group, ncol = 1) +
  theme(strip.text = element_text(size = 15, face = "bold"))

ggsave(filename = "static_level_all_dist.png", path = "march_2018_plots",
       width = 7.5, height = 7)
```

### ATE

```{r param-ate-dist, fig.width=12, fig.height=8}
est_deworming_takeup_ate_dist %>% 
  plot_ate(
    ate_data = est_deworming_takeup_ate,
    combiner = . %>% 
      subgroup_combiner("iter_ate", "dist.pot.group_left"),
    data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"),
             incentive_treatment_left != incentive_treatment_right | sms.treatment.2_left == "Reminders",
             dist.pot.group_left == dist.pot.group_right,
             sms.treatment.2_right == "No SMS") %>% 
      mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(factor(.), str_to_title))), 
    incentive_treatment_left_col = "incentive_treatment_left",
    include_sms_treatment = TRUE
    # by_comparator = "incentive_treatment_right"
  ) +
  facet_grid(incentive_treatment_right ~ dist.pot.group_left, scales = "free_y", space = "free_y")
```

```{r param-ate-dist-sms-ctrl, fig.width=8, fig.height=4.2}
est_deworming_takeup_ate_dist %>% 
  plot_ate(
    ate_summ_data = .,
    data_preparer = . %>% 
    filter(incentive_treatment_right %in% c("Control", "Calendar"),
           incentive_treatment_left != "Bracelet Social",
           incentive_treatment_left != incentive_treatment_right,
           dist.pot.group_left == dist.pot.group_right,
           sms.treatment.2_left == "No SMS",
           sms.treatment.2_left == sms.treatment.2_right) %>% 
      mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(factor(.), str_to_title))), 
    incentive_treatment_left_col = "incentive_treatment_left" 
  ) + 
  labs(y = "") +
  facet_grid(incentive_treatment_right ~ dist.pot.group_left, scales = "free_y", space = "free_y",
             labeller = labeller(incentive_treatment_right = as_labeller(. %>% str_c("Compared To:\n", .)),
                                 dist.pot.group_left = as_labeller(. %>% str_c("Distance: ", .)))) +
  theme(#panel.background = element_rect(color = "darkgrey"),
        legend.position = "bottom",
        strip.background =  element_rect(fill = "lightgrey", color = NA),
        panel.spacing.y = unit(0.5, "cm"))
```

```{r, fig.width=12, fig.height=8}
est_deworming_takeup_ate_dist %>% 
  mutate(same_incentive = incentive_treatment_left == incentive_treatment_right,
         same_sms = sms.treatment.2_left == sms.treatment.2_right) %>% 
  filter(same_incentive | same_sms, 
         sms.treatment.2_right != "reminder.only", 
         incentive_treatment_left != "bracelet social",
         dist.pot.group_left == dist.pot.group_right) %>% 
  plot_ate(
    ate_summ_data = .,
    incentive_treatment_left_col = "incentive_treatment_left",
    include_sms_treatment = TRUE,
    sms_treatment_right = TRUE
  ) + 
  labs(y = "") +
  facet_grid(incentive_treatment_right ~ dist.pot.group_left, scales = "free_y", space = "free_y",
             labeller = labeller(incentive_treatment_right = as_labeller(. %>% str_c("Compared To:\n", .)),
                                 dist.pot.group_left = as_labeller(. %>% str_c("Distance: ", .)))) +
  theme(panel.background = element_rect(color = "lightgrey"),
        legend.position = "bottom",
        strip.text.y = element_text(angle = 0),
        strip.background =  element_rect(color = "lightgrey", fill = "lightgrey"))
```

```{r static_ate_smsctrl_dist, fig.width=8}
est_deworming_takeup_ate_dist %>% 
# est_deworming_takeup_ate_dist_name_matched %>% 
  filter(incentive_treatment_left != "bracelet social",
         !(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar")) %>% 
  plot_ate(
    ate_summ_data = .,
    data_preparer = . %>% 
    filter(incentive_treatment_right %in% c("Control", "Calendar"),
           incentive_treatment_left != incentive_treatment_right,
           dist.pot.group_left == dist.pot.group_right,
           sms.treatment.2_left == "control",
           sms.treatment.2_left == sms.treatment.2_right) %>% 
      mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(factor(.), str_to_title))), 
    incentive_treatment_left_col = "incentive_treatment_left",
    num_obs = param_stan_data$num_obs
  ) + 
  labs(y = "") +
  # facet_grid(name_matched_left ~ dist.pot.group_left)
  facet_wrap(~ dist.pot.group_left, ncol = 1) +
  theme(strip.text = element_text(size = 15, face = "bold"))

ggsave(filename = "static_ate_smsctrl_dist.png", path = "march_2018_plots",
       width = 7.5, height = 5.5)
```

```{r static_ate_smsctrl_dist-2, fig.width=8}
est_deworming_takeup_ate_dist %>% 
  filter(incentive_treatment_left != "bracelet social",
         incentive_treatment_right == "control" | incentive_treatment_left == "bracelet") %>% 
  plot_ate(
    ate_summ_data = .,
    data_preparer = . %>% 
    filter(incentive_treatment_right %in% c("Control", "Calendar"),
           incentive_treatment_left != incentive_treatment_right,
           dist.pot.group_left == dist.pot.group_right,
           sms.treatment.2_left == "control",
           sms.treatment.2_left == sms.treatment.2_right) %>% 
      mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(factor(.), str_to_title))), 
    incentive_treatment_left_col = "incentive_treatment_left",
    incentive_treatment_right_col = "incentive_treatment_right",
    num_obs = param_stan_data$num_obs
  ) + 
  labs(y = "") +
  # facet_grid(name_matched_left ~ dist.pot.group_left)
  facet_wrap(~ dist.pot.group_left, ncol = 1) +
  theme(strip.text = element_text(size = 15, face = "bold"))

ggsave(filename = "static_ate_smsctrl_dist_2.png", path = "march_2018_plots",
       width = 7.5, height = 7)
```

```{r static_ate_all_dist, fig.width=8, fig.height=8}
est_deworming_takeup_ate_phone_dist %>% 
  mutate(same_incentive = incentive_treatment_left == incentive_treatment_right,
         same_sms = sms.treatment.2_left == sms.treatment.2_right) %>% 
  filter(phone_owner_left,
         incentive_treatment_left != "bracelet social",
         !same_incentive & same_sms,
         dist.pot.group_left == dist.pot.group_right,
         !(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar")) %>% 
  # mutate(incentive_treatment_left = if_else(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar", 
                                            # "bracelet social",
                                            # as.character(incentive_treatment_left)) %>% 
           # incentive_treatment_factor()) %>% 
  plot_ate(
    ate_summ_data = .,
    incentive_treatment_left_col = "incentive_treatment_left",
    sms_treatment_col = "sms.treatment.2_left",
    data_preparer = . %>% 
      mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(factor(.), str_to_title))), 
    include_sms_treatment = TRUE,
    sms_treatment_right = FALSE,
    num_obs = param_stan_data$num_obs
  ) + 
  labs(y = "") +
  facet_wrap(~ dist.pot.group_left, ncol = 1) +
  theme(strip.text = element_text(size = 15, face = "bold"))

ggsave(filename = "static_ate_all_dist.png", path = "march_2018_plots",
       width = 9, height = 7.5)
```


```{r static_ate_signal_effect_dist_diff, fig.width=8, fig.height=4}
est_deworming_takeup_ate %>% 
  filter(incentive_treatment_left %in% c("ink", "bracelet", "calendar"),
         incentive_treatment_right == "control" | (incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar"),
         dist.pot.group_left == dist.pot.group_right,
         sms.treatment.2_left == sms.treatment.2_right,
         sms.treatment.2_left == "control") %>% { 
   inner_join(filter(., dist.pot.group_left == "close"), 
              filter(., dist.pot.group_left == "far"),
              by = c("incentive_treatment_left", "incentive_treatment_right", "name_matched_left", "iter_id", "phone_owner_left", "treatment_size"), 
              suffix = c("_close", "_far")) 
 } %>% 
 mutate(iter_ate = iter_ate_close - iter_ate_far) %>% 
 prepare_est_deworming_ate() %>% 
 plot_ate(
   ate_summ_data = .,
   incentive_treatment_left_col = "incentive_treatment_left",
   incentive_treatment_right_col = "incentive_treatment_right",
   include_sms_treatment = FALSE,
   num_obs = param_stan_data$num_obs
 ) + 
 labs(y = "", subtitle = "Estimating difference in social effect on moving from far and close locations.") +
 theme(strip.text = element_text(size = 15, face = "bold"))

ggsave(filename = "static_ate_signal_effect_dist_diff.png", path = "march_2018_plots",
       width = 7.5, height = 5.25)
```

## Split by Phone Ownership

### Take-up Levels

```{r param-dyn-takeup-levels-phone, fig.width=10, fig.height=8}
  plot_dyn_takeup(
    takeup_summ_data = est_deworming_takeup_dyn_phone,
    takeup_data = est_deworming_takeup_dyn %>% 
      filter(dist.pot.group_static == dist.pot.group_dynamic) %>% 
      subgroup_combiner("iter_takeup", "phone_owner_static"),
    data_preparer = . %>% 
      filter(incentive_treatment_static == incentive_treatment_dynamic) %>% 
      # sms.treatment.2_static == sms.treatment.2_dynamic) %>% 
      mutate_at(vars(starts_with("phone_owner_static")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Phone Owners", "Non-Phone Owners"))))) +
  facet_wrap(~ phone_owner_static, ncol = 1)
```

### ATE

```{r param-dyn-ate-phone, fig.width=10, fig.height=8}
est_deworming_takeup_ate_phone %>% 
  plot_dyn_ate(
    ate_data = est_deworming_takeup_ate %>% 
      filter(incentive_treatment_static_left == incentive_treatment_dynamic_left,
             incentive_treatment_static_right == incentive_treatment_dynamic_right,
             dist.pot.group_static_left == dist.pot.group_dynamic_left,
             dist.pot.group_static_right == dist.pot.group_dynamic_right) %>% 
      subgroup_combiner("iter_ate", "phone_owner_static_left"),
    data_preparer = . %>% 
      filter(incentive_treatment_static_left == incentive_treatment_dynamic_left,
             incentive_treatment_static_right == incentive_treatment_dynamic_right) %>% 
      mutate_at(vars(starts_with("phone_owner_static")), 
                funs(factor(., levels = c(FALSE, TRUE), labels = c("Phone Owners", "Non-Phone Owners")))) 
  ) +
  facet_wrap(~ phone_owner_static_left, ncol = 1)
```

```{r param-dyn-sepstatdyn-phone, fig.width=12, fig.height=6} 
est_deworming_takeup_ate_phone %>% 
  plot_dyn_ate(
    ate_data = est_deworming_takeup_ate,
    combiner = . %>% 
      filter(dist.pot.group_static_left == dist.pot.group_dynamic_left,
             dist.pot.group_static_right == dist.pot.group_dynamic_right) %>% 
      subgroup_combiner("iter_ate", c("phone_owner_static_left", "compare_type")),
    data_preparer = . %>% 
      filter(incentive_treatment_static_right != "Control" | incentive_treatment_static_left != incentive_treatment_dynamic_left) %>%
      mutate_at(vars(starts_with("phone_owner_static")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Phone Owners", "Non-Phone Owners")))) %>% 
      mutate(compare_type = if_else(incentive_treatment_static_left == incentive_treatment_dynamic_left, 
                                    "dynamic effect", "static effect") %>% 
               factor() %>% 
               fct_relabel(str_to_title)) 
  )  +
  labs(subtitle = "Separating static and dynamic effects") +
  facet_grid(phone_owner_static_left ~ compare_type) 
```

### Daily Take-up Levels

```{r param-dyn-daily-takeup-phone, fig.width=10, fig.height=8}
est_deworming_day_phone %>% 
  filter(incentive_treatment_static == incentive_treatment_dynamic) %>% 
  mutate_at(vars(starts_with("phone_owner_static")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Phone Owners", "Non-Phone Owners")))) %>% 
  plot_dyn_takeup_daily() +
  facet_wrap(~ phone_owner_static, ncol = 1)
```

## Split by Distance and Phone Ownership

### Take-up Levels

```{r param-dyn-takeup-levels-phone-dist, fig.width=12, fig.height=12}
plot_takeup(
  takeup_summ_data = est_deworming_takeup_phone_dist,
  takeup_data = est_deworming_takeup,
  combiner = . %>% 
    subgroup_combiner("iter_takeup", c("phone_owner", "dist.pot.group", global_subgroup)),
  data_preparer = . %>% 
    filter(sms.treatment.2 == "control") %>%
    mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(., str_to_title))) %>% 
    mutate_at(vars(starts_with("phone_owner")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Non-Phone Owners", "Phone Owners")))),
  incentive_treatment_col = "incentive_treatment",
  show_observed = TRUE,
  include_sms_treatment = FALSE) +
  facet_grid(dist.pot.group + phone_owner ~name_matched, scales = "free")
  # facet_wrap(~ dist.pot.group + phone_owner, ncol = 1)
```

### ATE 

```{r param-dyn-ate-phone-dist, fig.width=10, fig.height=12}
est_deworming_takeup_ate_phone_dist %>%
  plot_ate(
    ate_data = est_deworming_takeup_ate,
    combiner = . %>% 
      subgroup_combiner("iter_ate", c("dist.pot.group_left", "phone_owner_left")),
    data_preparer = . %>% 
      filter(sms.treatment.2_left == "control",
             sms.treatment.2_right == "control") %>% 
      mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(., str_to_title))) %>% 
      mutate_at(vars(starts_with("phone_owner")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Non-Phone Owners", "Phone Owners")))), 
    incentive_treatment_left_col = "incentive_treatment_left", 
    by_comparator = "incentive_treatment_right"
  ) +
  facet_wrap(~ dist.pot.group_left + phone_owner_left, ncol = 1)
```

```{r param-dyn-sepstatdyn-phone-dist, fig.width=12, fig.height=8}
est_deworming_takeup_ate_phone_dist %>% 
  plot_dyn_ate(
    ate_data = est_deworming_takeup_ate,
    combiner = . %>% 
      subgroup_combiner("iter_ate", c("dist.pot.group_static_left", "phone_owner_static_left", "compare_type")),
    data_preparer = . %>% 
      filter(incentive_treatment_static_right != "Control" | incentive_treatment_static_left != incentive_treatment_dynamic_left,
             dist.pot.group_static_left == dist.pot.group_dynamic_left,
             dist.pot.group_static_right == dist.pot.group_dynamic_right) %>% 
      mutate_at(vars(starts_with("dist.pot.group_static")), funs(fct_relabel(., str_to_title))) %>% 
      mutate_at(vars(starts_with("phone_owner_static")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Phone Owners", "Non-Phone Owners")))) %>% 
      mutate(compare_type = if_else(incentive_treatment_static_left == incentive_treatment_dynamic_left, 
                                    "dynamic effect", "static effect") %>% 
           factor() %>% 
           fct_relabel(str_to_title)) 
  )  +
  labs(subtitle = "Separating static and dynamic effects") +
  facet_grid(phone_owner_static_left + dist.pot.group_static_left ~ compare_type) 
```



```{r info-ate-phone-dist, fig.width=12, fig.height=6}
plot_dyn_ate(info_inc_ate_phone, 
             ate_data = info_inc_ate_iter_data_phone,
             data_preparer = . %>% 
               mutate_at(vars(starts_with("phone_owner_static")), 
                         funs(factor(., levels = c(FALSE, TRUE), labels = c("Phone Owners", "Non-Phone Owners"))))) +
  facet_wrap(~ phone_owner_static_left, ncol = 1)

# est_deworming_takeup_ate_phone_dist %>% 
#   plot_dyn_ate(
#     ate_data = est_deworming_takeup_ate,
#     combiner = . %>% 
#       subgroup_combiner("iter_ate", c("phone_owner_static_left", "info_change_type")),
#     data_preparer = . %>% 
#       filter(dist.pot.group_static_left != dist.pot.group_dynamic_left | dist.pot.group_static_right != dist.pot.group_dynamic_right,
#              dist.pot.group_static_right == dist.pot.group_dynamic_right, 
#              dist.pot.group_static_left == dist.pot.group_static_right) %>% 
#       mutate(info_change_type = if_else(dist.pot.group_static_right == "far", "increase", "decrease") %>% 
#                factor() %>% 
#                fct_relabel(str_to_title))
#   ) +
#   facet_grid(phone_owner_static_left ~ info_change_type) 
```

## Qualitative 

### Distance
```{r}
plot_dist_ecdf <- function(.data) {
  .data %>% 
    mutate(
      compare_group = case_when(assigned.treatment == "control" ~ "control",
                                assigned.treatment == "Calendar"~ "private", 
                                TRUE ~ "social")
    ) %>% 
    ggplot(aes(dist.to.pot)) +
    stat_ecdf(aes(linetype = "Control"), geom = "step", pad = FALSE, 
              data = .data %>% 
                filter(assigned.treatment == "Control") %>% 
                bind_rows(private = ., social = ., .id = "compare_group")) +
    stat_ecdf(aes(color = assigned.treatment), geom = "step", pad = FALSE, 
              data = . %>% filter(assigned.treatment != "Control")) +
    geom_vline(xintercept = 1250, linetype = "dotted") +
    geom_rug(color = "black", sides = "b", alpha = 0.05) +
    # geom_rug(aes(color = dist.pot.group), sides = "bottom", alpha = 0.05) +
    scale_color_discrete("Incentive/Signal") +
    # coord_cartesian(x = c(0, 3500), y = c(0, 0.45)) +
    labs(x = "Household Distance to Treatment Location",
         y = "Cumulative Proportion",
         title = "") 
}

plot_dist_data <- analysis.data %>% 
  filter(
    !name_matched,
    !is.na(dewormed.any),
    sms.treatment.2 == "sms.control"
    ) %>% 
  mutate(
    # dist.to.pot = if_else(dewormed.any, dist.to.pot, 4000),
    assigned.treatment = fct_relabel(assigned.treatment, str_to_title)
  ) 

plot_dist_data %>% 
  plot_dist_ecdf() +
  facet_grid(~ compare_group, margins = TRUE) +
  theme(strip.text = element_blank())

plot_dist_data %>% 
  filter(assigned.treatment != "Calendar") %>% 
  plot_dist_ecdf()

plot_dist_data %>% 
  filter(assigned.treatment %in% c("Control", "Calendar")) %>% 
  plot_dist_ecdf()
```


```{r}
analysis.data %>% 
  filter(
    # assigned.treatment == "control",
    !name_matched,
    sms.treatment.2 == "sms.control") %>% 
    # dewormed.any) %>% #pull(dist.to.pot) %>% summary()
  mutate(assigned.treatment = fct_relabel(assigned.treatment, str_to_title),
         dist_bin = cut(dist.to.pot, 
                        breaks = seq(0, 1, 0.01) * max(dist.to.pot), labels = 1:100)
                        # breaks = quantile(dist.to.pot, seq(0, 1, 0.05)), labels = 1:20),
         ) %>%
  # add_count(assigned.treatment) %>% 
  # filter(dewormed.any) %>% 
  group_by(assigned.treatment, dist_bin) %>% 
  summarize(deworm_prop = sum(dewormed.any),
            bin_size = n()) %>% 
  # summarize(deworm_prop = n() / first(n)) %>% 
  group_by(assigned.treatment) %>% 
  arrange(dist_bin) %>% 
  mutate(cumul_deworm_prop = cumsum(deworm_prop / sum(bin_size))) %>% 
  ungroup() %>%
  ggplot(aes(x = dist_bin, y = cumul_deworm_prop, group = assigned.treatment, color = assigned.treatment)) + 
  # ggplot(aes(dist.to.pot, color = assigned.treatment)) + 
  stat_ecdf(geom = "step", pad = FALSE) +
  scale_color_discrete("Incentive/Signal") +
  labs(x = "Household Distance to Treatment Location",
       y = "Cumulative Proportion") #+ facet_wrap(~ assigned.treatment)
```


## Superpopulation

```{r}
sp_est_deworming_takeup <- model_fit %>% 
  as.data.frame( pars = "sp_est_takeup") %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(treatment_rank, iter_takeup, -iter_id) %>% 
  mutate(treatment_rank = str_extract(treatment_rank, "\\d+") %>% as.integer()) %>% 
  inner_join(static_treatment_cell_info, "treatment_rank") 

sp_est_deworming_takeup_all <- sp_est_deworming_takeup %>% 
  prepare_est_deworming_takeup(subgroups = global_subgroup) 

sp_est_deworming_takeup_phone_dist <- sp_est_deworming_takeup %>%
  prepare_est_deworming_takeup(subgroups = c(global_subgroup, "phone_owner", "dist.pot.group"))

sp_est_deworming_takeup_ate <- model_fit %>% 
  as.data.frame(pars = "sp_est_takeup_ate") %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(outcome_id, iter_ate, -iter_id) %>% 
  mutate(pair_rank = str_extract(outcome_id, "\\d+") %>% as.integer()) %>% 
  inner_join(static_ate_pair_info, "pair_rank")

sp_est_deworming_takeup_ate_all <- sp_est_deworming_takeup_ate %>% 
  prepare_est_deworming_ate() 
```

```{r}
stratum_sp_est_deworming_takeup <- model_fit %>% 
  as.data.frame( pars = "stratum_sp_est_takeup") %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(treatment_rank, iter_takeup, -iter_id) %>% 
  separate(treatment_rank, into = c("outcome_type", "stratum_id", "treatment_rank"), sep = "\\[|,|\\]") %>% 
  mutate_at(vars(stratum_id, treatment_rank), as.integer) %>% 
  inner_join(static_treatment_cell_info, "treatment_rank") %>% 
  select(-observed_treatment_size, -observed_takeup_prop) %>% 
  left_join(mutate(param_stan_data$observed_stratum_takeup_prop, stratum_id = as.integer(stratum)), c("all_treatment_id", "stratum_id")) %>% 
  rename(observed_takeup_prop = takeup_prop)

stratum_sp_est_deworming_takeup_all <- stratum_sp_est_deworming_takeup %>% 
  prepare_est_deworming_takeup(subgroup = c(global_subgroup, "stratum"))

stratum_sp_est_deworming_takeup_phone_dist <- stratum_sp_est_deworming_takeup %>%
  prepare_est_deworming_takeup(subgroups = c(global_subgroup, "stratum", "phone_owner", "dist.pot.group"))

stratum_sp_est_deworming_takeup_ate <- model_fit %>% 
  as.data.frame(pars = "stratum_sp_est_takeup_ate") %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(outcome_id, iter_ate, -iter_id) %>% 
  separate(outcome_id, into = c("outcome_type", "stratum_id", "pair_rank"), sep = "\\[|,|\\]") %>% 
  mutate_at(vars(stratum_id, pair_rank), as.integer) %>% 
  inner_join(static_ate_pair_info, "pair_rank")

stratum_sp_est_deworming_takeup_ate_all <- stratum_sp_est_deworming_takeup_ate %>% 
  prepare_est_deworming_ate(subgroup = "stratum_id") %>% 
  left_join(param_stan_data$stratum_map, "stratum_id")
```

```{r}
cluster_sp_est_deworming_takeup <- model_fit %>% 
  as.data.frame( pars = "cluster_sp_est_takeup") %>%
  mutate(iter_id = seq_len(n())) %>% 
  gather(treatment_rank, iter_takeup, -iter_id) %>% 
  separate(treatment_rank, into = c("outcome_type", "cluster_id", "treatment_rank"), sep = "\\[|,|\\]") %>% 
  mutate_at(vars(cluster_id, treatment_rank), as.integer) %>% 
  inner_join(static_treatment_cell_info, "treatment_rank") 

cluster_sp_est_deworming_takeup_all <- cluster_sp_est_deworming_takeup %>% 
  prepare_est_deworming_takeup(subgroup = c(global_subgroup, "cluster_id")) %>% 
  left_join(tibble(stratum_id = param_stan_data$cluster_stratum_ids) %>% 
              mutate(cluster_id = seq_len(n())), 
            "cluster_id")

cluster_sp_est_deworming_takeup_phone_dist <- cluster_sp_est_deworming_takeup %>%
  prepare_est_deworming_takeup(subgroups = c(global_subgroup, "cluster_id", "phone_owner", "dist.pot.group")) %>% 
  left_join(tibble(stratum_id = param_stan_data$cluster_stratum_ids) %>% 
              mutate(cluster_id = seq_len(n())), 
            "cluster_id")

# cluster_sp_est_deworming_takeup_ate <- model_fit %>% 
#   as.data.frame(pars = "cluster_sp_est_takeup_ate") %>%
#   mutate(iter_id = seq_len(n())) %>% 
#   gather(outcome_id, iter_ate, -iter_id) %>% 
#   separate(outcome_id, into = c("outcome_type", "cluster_id", "pair_rank"), sep = "\\[|,|\\]") %>% 
#   mutate_at(vars(cluster_id, pair_rank), as.integer) %>% 
#   inner_join(static_ate_pair_info, "pair_rank")
# 
# cluster_sp_est_deworming_takeup_ate_all <- cluster_sp_est_deworming_takeup_ate %>% 
#   prepare_est_deworming_ate(subgroup = "cluster_id") 
```

### Take-up Levels

```{r sp-takeup-levels, fig.width=10, fig.height=8}
plot_takeup(
  takeup_summ_data = sp_est_deworming_takeup_all,
  incentive_treatment_col = "incentive_treatment",
  data_preparer = . %>% filter(sms.treatment.2 == "control"),
  lower_level_data = stratum_sp_est_deworming_takeup_all, 
  lower_level_color_by = "stratum",
) #+ facet_wrap(~ name_matched, ncol = 1)
```

```{r, fig.width=12, fig.height=12}
plot_takeup(
  takeup_summ_data = sp_est_deworming_takeup_phone_dist,
  data_preparer = . %>% 
    filter(sms.treatment.2 == "control") %>%
    mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(., str_to_title))) %>% 
    mutate_at(vars(starts_with("phone_owner")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Non-Phone Owners", "Phone Owners")))),
  incentive_treatment_col = "incentive_treatment",
  lower_level_data = stratum_sp_est_deworming_takeup_phone_dist, 
  lower_level_color_by = "stratum"
  ) +
  facet_grid(dist.pot.group + phone_owner ~ name_matched, scales = "free")
```

```{r, fig.width=12, fig.height=8, eval=FALSE}
plot_takeup(
  takeup_summ_data = stratum_sp_est_deworming_takeup_all,
  incentive_treatment_col = "incentive_treatment",
  data_preparer = . %>% filter(sms.treatment.2 == "control"),
  lower_level_data = cluster_sp_est_deworming_takeup_all,
  lower_level_shape_size = 1
) + 
  facet_grid(stratum ~ name_matched)
```

```{r, fig.width=12, fig.height=12}
plot_takeup(
  takeup_summ_data = stratum_sp_est_deworming_takeup_phone_dist,
  data_preparer = . %>% 
    filter(sms.treatment.2== "control") %>% 
    mutate_at(vars(starts_with("dist.pot.group")), funs(fct_relabel(., str_to_title))) %>% 
    mutate_at(vars(starts_with("phone_owner")), funs(factor(., levels = c(FALSE, TRUE), labels = c("Non-Phone Owners", "Phone Owners")))),
  incentive_treatment_col = "incentive_treatment",
  lower_level_data = cluster_sp_est_deworming_takeup_phone_dist,
  lower_level_shape_size = 1
  ) +
  facet_grid( dist.pot.group + phone_owner ~ stratum + name_matched)
```

### ATE

```{r, fig.width=10, fig.height=4}
sp_est_deworming_takeup_ate_all %>% 
  filter(incentive_treatment_left != "bracelet social",
         !(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar")) %>% 
  plot_ate(
    ate_summ_data = .,
    # ate_data = sp_est_deworming_takeup_ate,
    # combiner = . %>%
    #   subgroup_combiner("iter_ate"), 
    data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"), 
             sms.treatment.2_left == "control",
             sms.treatment.2_right == "control"),
    incentive_treatment_left_col = "incentive_treatment_left" 
  )
```

# Model Checking

# Checking MCMC

This section takes a look at the validity of our MCMC simulation.

```{r, include=FALSE}
# From http://discourse.mc-stan.org/t/how-can-i-solve-bfmi-low-problem/3018/2
pairs_stan <- function(chain, stan_model, pars) {
  energy <- as.matrix(sapply(get_sampler_params(stan_model, inc_warmup = F), 
                             function(x) x[,"energy__"]))
  pars <- extract(stan_model, pars = pars, permuted = F)
  df <- data.frame(energy[,chain], pars[,chain,])
  names(df)[1] <- "energy"
  GGally::ggpairs(df, title = paste0("Chain", chain), 
                  lower = list(continuous = GGally::wrap("points", alpha = 0.2)))                    
}
```

```{r}
model_fit@model_pars
model_fit %>% print(pars = c("est_takeup_ate"))
model_fit %>% print(pars = c("hyper_beta"))
```

```{r}
model_posterior_array <- as.array(model_fit)
model_np <- nuts_params(model_fit)
model_lp <- log_posterior(model_fit)
```

```{r check-energy}
sample_param <- model_fit %>% get_sampler_params(inc_warmup = FALSE)

sample_param %>% 
  map(~ .x[, "energy__"]) %>% 
  map(~ (sum(diff(.x)^2)/length(.x))/var(.x)) 
```

```{r}
rhat(model_3_fit) %>% summary()
rhat(model_3_fit) %>% discard(~ is_less_than(.x, 1.2) | is.nan(.x)) 
```


```{r, eval=FALSE, fig.width=15}
mcmc_trace(model_3_posterior_array, regex_pars = c("hyper_baseline_dyn_effect\\[[1-3]\\]"), np = model_3_np)
```

```{r, fig.width=15}
mcmc_nuts_divergence(model_np, model_lp)
```

```{r, eval=FALSE}
color_scheme_set("darkgray")
mcmc_parcoord(model_3_posterior_array, np = model_3_np, 
              regex_pars = c("hyper_beta_day1"))
mcmc_parcoord(model_3_posterior_array, np = model_3_np, 
              regex_pars = c("hyper_baseline_dyn_effect"))
mcmc_parcoord(model_3_posterior_array, np = model_3_np, 
              regex_pars = c("strata_beta_day1_raw"))
mcmc_parcoord(model_3_posterior_array, np = model_3_np, 
              regex_pars = c("QR_hyper_treat_beta_dyn_effect"))
mcmc_parcoord(model_3_posterior_array, np = model_3_np, 
              regex_pars = c("cluster_beta_day1"))
```

```{r, fig.width=15}
color_scheme_set("darkgray")
mcmc_pairs(model_3_posterior_array, 
           regex_pars = c(
             "hyper_beta_day1\\[1\\]",
             "strata_beta_day1_raw\\[[1-3]\\,1",
             "strata_beta_day1_tau\\[[1-3]\\]" 
           ),
           transform = lst(
             "strata_beta_day1_tau[1]" = "log", 
             "strata_beta_day1_tau[2]" = "log",
             "strata_beta_day1_tau[3]" = "log",
           ), 
           np = model_3_np)
```

```{r, fig.width=15}
color_scheme_set("darkgray")
mcmc_pairs(model_3_posterior_array, 
           regex_pars = c(
             "strata_beta_day1_raw\\[1,1\\]",
             "strata_baseline_dyn_effect_raw\\[1,1\\]",
             # "QR_strata_beta_dyn_effect\\[1,1\\]",
             "strata_beta_dyn_effect\\[1,1\\]",
             # "QR_cluster_beta_day1\\[1,1\\]",
             "strata_beta_day1_tau\\[1\\]",
             "strata_baseline_dyn_effect_tau\\[1\\]",
             "strata_beta_dyn_effect_tau\\[1\\]",
             # "cluster_beta_day1_tau\\[1\\]",
             "lp__"
           ),
           transform = lst(
             "strata_baseline_dyn_effect_tau[1]" = "log",
             "strata_beta_day1_tau[1]" = "log",
             "strata_beta_dyn_effect_tau[1]" = "log",
             # "cluster_beta_day1_tau[1]" = "log",
           ), 
           np = model_3_np)
```

```{r, eval=FALSE, fig.width=20}
# pairs_stan(1, model_3_fit, c("hyper_beta_day1[1]", "hyper_beta_day1[10]", "lp__"))
# pairs_stan(1, model_3_fit, c("hyper_baseline_dyn_effect[1]", "hyper_baseline_dyn_effect[10]", "lp__"))
# pairs_stan(1, model_3_fit, c("hyper_treat_beta_dyn_effect[1]", "hyper_treat_beta_dyn_effect[10]", "lp__"))
# pairs_stan(1, model_3_fit, c("strata_beta_day1_tau[1]", "strata_beta_day1_tau[10]", "lp__"))
# pairs_stan(1, model_3_fit, c("strata_baseline_dyn_effect_tau[1]", "strata_baseline_dyn_effect_tau[10]", "lp__"))
# pairs_stan(1, model_3_fit, c("strata_beta_dyn_effect_tau[1]", "strata_beta_dyn_effect_tau[10]", "lp__"))
# pairs_stan(1, model_3_fit, c("strata_beta_day1_L_corr_mat_non_phone[1,2]", "strata_beta_day1_L_corr_mat_non_phone[3,1]", "lp__"))
# pairs_stan(1, model_3_fit, c("strata_beta_day1_raw[1,1]", "strata_beta_day1_raw[10,2]", "lp__"))
# pairs_stan(1, model_3_fit, c("strata_baseline_dyn_effect_raw[1,1]", "strata_baseline_dyn_effect_raw[10,2]", "lp__"))
# pairs_stan(1, model_3_fit, c("QR_strata_beta_dyn_effect[1,1]", "QR_strata_beta_dyn_effect[10,2]", "lp__"))
pairs_stan(1, model_3_fit, c("cluster_beta_day1_tau[1]", "cluster_beta_day1_tau[10]", "lp__"))
pairs_stan(1, model_3_fit, c("cluster_beta_day1_tau", "lp__"))
pairs_stan(1, model_3_fit, c("cluster_beta_day1_L_corr_mat[1,2]", "cluster_beta_day1_L_corr_mat[3,1]", "lp__"))
pairs_stan(1, model_3_fit, c("QR_cluster_beta_day1[1,1]", "QR_cluster_beta_day1[10,2]", "lp__"))
# pairs_stan(1, model_3_fit, c("[1]", "[10]", "lp__"))
```

```{r tree-energy-plots}
color_scheme_set("red")
mcmc_nuts_treedepth(model_3_np, model_3_lp)
mcmc_nuts_energy(model_3_np)
```

# WTP

```{r load-wtp-model-fit}
wtp_model_fit <- dir("stanfit", pattern = str_interp("model_${wtp_fit_version}_\\d+.csv"), full.names = TRUE) %>%
  read_stan_csv()

check_hmc_diagnostics(wtp_model_fit)

rhat(wtp_model_fit) %>% summary()
```

```{r}
wtp_model_fit %>% 
  print(pars = c("hyper_mu", "strata_mu_student_df", "strata_mu", "strata_mu_tau", "strata_student_df", "strata_sigma", "prob_prefer_calendar"))
```


