---
title: Optim
output: 
  pdf_document:
    extra_dependencies: ["amsmath", "threeparttable"]
---


```{r, include=FALSE}
knitr::opts_chunk$set(warning = TRUE, message = FALSE, echo = FALSE) 
library(knitr)
library(tidyverse)
library(ggplot2)
library(ompr)
library(ompr.roi)
library(ROI.plugin.glpk)
```

# Problem Setup 

Suppose there are $n$ villages, indexed by $i$, and $m$ points of treatment (PoT) which we index 
by $j$. The social planner's goal is to minimise the number of PoTs required subject to hitting 
$\overline{W}^C = E\left[\sum^n_{i = 1}U(\textit{takeup}^C_{i})\right]$ - the expected social welfare the planner would have achieved by assigning 
every village in the experiment to the control condition. We can reformulate this 
as an integer programme:

$$
\begin{align}
\min \sum_{j = 1}^m  &y_j \\
s.t. \ \ 
\sum_{i = 1}^n U\left(\textit{takeup}_{ij}x_{ij}\right) &\geq \underbrace{E\left[\sum_{i = 1}^n U\left(\textit{takeup}^C_{i}\right)\right]}_{\overline{W}^C} \\
    \sum_{j=1}^{m} x_{ij} &= 1, \forall i \\
    x_{ij} &\leq y_j, \forall i, j  \\
 x_{ij} &\in \{0,1\}, y_j \in\{0,1\}
\end{align}
$$


$x_{ij}$ is an indicator corresponding to village $i$ using point of 
treatment $j$. $y_{j}$ is an indicator corresponding to if PoT $j$ is funded (i.e. 
available for use by villages) by the social planner.  The remaining constraints 
ensure every village is assigned to a funded PoT. 

We set $U(\cdot) = log(\cdot)$ for two reasons: Firstly, to introduce a dislike for 
inequality to the social planner's problem - there's decreasing marginal 
utility to increasing takeup within a village. Secondly, log-utility completely
 dissuades the 
social planner from implementing a ruthless utilitarian allocation that sets takeup to 
0 in sparsely populated locations.



The results presented below introduce a cutoff at 3.5km beyond which we set 
takeup to 0 - i.e. no villager is prepared to walk more than 3.5km to a point of 
treatment. Results 
in the appendix relax this assumption, although in reality past 5km 
the model places virtually no posterior density on positive takeup. We chose 3.5km 
as a compromise between limiting extrapolation and constraints imposed by our 
experimental design - by construction there are no treatment points within 2.5km of 
multiple villages in our data.



### Counterfactual Simulations 

Our structural model decomposes $takeup_{ij}$, the demand for deworming from pairing 
village $i$ with PoT $j$, into a private utility component and reputational return 
from signalling deworming status. Therefore, we fix private utility at the control 
level and explore the effect of counterfactually varying visibility, $\mu_{z}$ ,
on the number of required PoTs.
$$
takeup_{ij} = \underbrace{B(z, d_{ij})}_{\text{private benefit}} + \underbrace{\mu_{z} \Delta\left[ w^*(z, d_{i,j})\right]}_{\text{reputational return}}
$$


```{r, echo=FALSE, fig.align="center", fig.cap="Optimal allocation of points of treatment, $\\mu_{z=\\text{control}}$. Blue triangles indicate funded PoTs; red triangles unused PoTs; black dots denote villages; and line segments a PoT-village pairing"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-full/agg-log-cutoff-b-control-mu-control-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png",
  rel_path = FALSE
)  
```


```{r, echo=FALSE, fig.align="center", fig.cap="Optimal allocation of points of treatment, $\\mu_{z=\\text{bracelet}}$. Blue triangles indicate funded PoTs; red triangles unused PoTs; black dots denote villages; and line segments a PoT-village pairing"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-full/agg-log-cutoff-b-control-mu-bracelet-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png",
  rel_path = FALSE
)  
```



### Structural Policymaker




# Results

## Cutoff at 2.5km - Conventional Structural Model - By County

### Busia 
We see a 4.41% fall in number of PoTs needed.

#### B: Control Mu: Control
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-busia/agg-log-cutoff-b-control-mu-control-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png",
  rel_path = FALSE
)  
```

#### B: Control Mu: Bracelet
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-busia/agg-log-cutoff-b-control-mu-bracelet-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png",
  rel_path = FALSE
 )
```


### Siaya 
We see a 1.67% fall in number of PoTs needed.

#### B: Control Mu: Control
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-siaya/agg-log-cutoff-b-control-mu-control-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png",
  rel_path = FALSE
 )
```

#### B: Control Mu: Bracelet
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-siaya/agg-log-cutoff-b-control-mu-bracelet-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png", 
  rel_path = FALSE
  )
```



### Kakamega

We see a 1.5% reduction in number of PoTs needed.

#### B: Control Mu: Control
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-kakamega/agg-log-cutoff-b-control-mu-control-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png",
  rel_path = FALSE
  )
```

#### B: Control Mu: Bracelet
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-kakamega/agg-log-cutoff-b-control-mu-bracelet-STRUCTURAL_LINEAR_U_SHOCKS-median-optimal-allocation-plot.png", 
  rel_path = FALSE)
```



## Cutoff at 2.5km - Log Mu Rep - Full Experiment + 4 PoTs

#### B: Control Mu: Control
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-full/agg-log-cutoff-b-control-mu-control-STRUCTURAL_LINEAR_U_SHOCKS_LOG_MU_REP-median-optimal-allocation-plot.png",
  rel_path = FALSE
  )
```

#### B: Control Mu: Bracelet
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-full/agg-log-cutoff-b-control-mu-bracelet-STRUCTURAL_LINEAR_U_SHOCKS_LOG_MU_REP-median-optimal-allocation-plot.png", 
  rel_path = FALSE)
```

## Cutoff at 10km - Log Mu Rep - Full Experiment + 4 PoTs

#### B: Control Mu: Control
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-full/agg-log-no-cutoff-b-control-mu-control-STRUCTURAL_LINEAR_U_SHOCKS_LOG_MU_REP-median-optimal-allocation-plot.png",
  rel_path = FALSE
  )
```

#### B: Control Mu: Bracelet
```{r, echo=FALSE, fig.align="center"}
include_graphics(
  "~/projects/takeup/optim/plots/agg-log-full/agg-log-no-cutoff-b-control-mu-bracelet-STRUCTURAL_LINEAR_U_SHOCKS_LOG_MU_REP-median-optimal-allocation-plot.png", 
  rel_path = FALSE)
```
