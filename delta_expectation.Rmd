---
title: Net Reputational Incentive with Shocks 
output: 
  pdf_document:
    number_sections: yes
    fig_caption: yes
    keep_tex: no
    includes:
      in_header: takeup_workingpaper_header.sty
---

```{r setup, include=FALSE}
library(magrittr)
library(tidyverse)
library(latex2exp)
library(ggthemes)
library(cmdstanr)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, cache = FALSE) 

source(file.path("multilvlr", "multilvlr_util.R"))
source("dist_structural_util.R")

ggplot2::theme_set(theme_minimal())

canva_palette_vibrant <- "Primary colors with a vibrant twist"

takeup_version <- 36
```

Previously, we modeled the take-up probability as 
\[ \bar{y}(b,c) = \prob{b - c + \mu\Delta^*(b,c) + V > 0}, \]
where 
\[\Delta^*(b,c) = \expect{V | b,c, y = 1} - \expect{V | b,c, y = 0}.\]
This was relatively simple and can be rewritten as
\[\Delta^*(b,c) = \Delta[v^*(b,c)] = \expect{V | V > v^*(b,c)} - \expect{V | V \leq v^*(b,c)},\]
where $v^*(b,c)$ is implicitly defined as
\[ v^*(b,c) = - b + c - \mu\Delta[v^*(c,d)]. \]

Now consider adding an unobservable shock $U$,
\[ \bar{y}(b,c) = \prob{b - c + \mu\Delta^*(b,c) + V + U > 0}. \]
We define $W = V + U$ and $w^*(b,c)$ is implicitly defined as
\[ w^*(b,c) = - b + c - \mu\Delta[w^*(c,d)], \]
which is no longer the prosocial type cutoff. In calculating $\Delta^*$ individuals must now account for the non-prosocial shocks $U$, such that
\begin{align*}
  \Delta^*(b,c) &= \Delta[w^*(b,c)] \\
           &=\expect{V | b,c, y = 1} - \expect{V | b,c, y = 0} \\ 
           &= \expect{V | W > w^*(b,c)} - \expect{V | W \leq w^*(b,c)} \\
           &= \int_{-\infty}^\infty v \prob{V = v | W > w^*(b,c)}\,\mathrm{d}v - \int_{-\infty}^\infty v \prob{V = v | W \leq w^*(b,c)}\,\mathrm{d}v \\
           &= \int_{-\infty}^\infty \frac{v\prob{W > w^*(b,c) | V = v}\prob{V = v}}{\prob{W > w^*(b,c)}}\,\mathrm{d}v - \int_{-\infty}^\infty \frac{v\prob{W \leq w^*(b,c) | V = v}\prob{V = v}}{\prob{W \leq w^*(b,c)}}\,\mathrm{d}v \\ 
           &= \int_{-\infty}^\infty \frac{v\prob{U > w^*(b,c) - v}\prob{V = v}}{\prob{W > w^*(b,c)}}\,\mathrm{d}v - \int_{-\infty}^\infty \frac{v\prob{U \leq w^*(b,c) - v}\prob{V = v}}{\prob{W \leq w^*(b,c)}}\,\mathrm{d}v \\ 
           &= \int_{-\infty}^\infty \frac{v \left[1 - F_u\left(w^*(b,c) - v\right)\right]f_v(v)}{1 - F_w\left(w^*(b,c)\right)}\,\mathrm{d}v - \int_{-\infty}^\infty\frac{v F_u\left(w^*(b,c) - v\right)f_v(v)}{F_w\left(w^*(b,c)\right)}\,\mathrm{d}v \\ 
           &= \frac{-1}{F_w\left(w^*(b,c)\right)[1 - F_w\left(w^*(b,c)\right)]} \int_{-\infty}^\infty v F_u\left(w^*(b,c) - v\right)f_v(v)\,\mathrm{d}v.
\end{align*}
$f(\cdot)$ and $F(\cdot)$ are the pdf and cdf, respectively, for the subscript random variable (here $U, V,$ and $W$).

To get a sense of what flexibility this affords our model, consider how $\mu\Delta^*$ changes in two different scenarios: first, don't include the shock $u$ but allow $\mu$ to vary, second, hold $\mu$ fixed at 1 and allow the standard deviation of $u$ to vary. From here on I'm assuming that $V \sim N(0,1)$, $U \sim N(0, \sigma_u)$, and they are uncorrelated.

```{r, fig.width=8}
sim_int <- expand.grid(
  w = seq(-2, 2, 0.1),
  u_sd = seq(0.0, 2.0, 0.05),
  mu = seq(0.1, 1, 0.05)
) %>% 
  filter(u_sd == 0 | mu == 1) %>% 
  rowwise() %>% 
  mutate(
    mu_delta = mu * calculate_delta(w, sqrt(1 + u_sd^2), u_sd),
    mu_delta_deriv = mu * calculate_delta_deriv(w, sqrt(1 + u_sd^2), u_sd)
  ) %>% 
  ungroup() %>% 
  pivot_longer(c(mu_delta, mu_delta_deriv), names_to = "delta_type")

sim_int %>% 
  filter(delta_type == "mu_delta") %>%
  ggplot(aes(w, value)) +
  geom_line(
    aes(group = u_sd), 
    data = . %>% 
      filter(mu == 1) %>% 
      mutate(type = r"{Add shocks: Holding $\mu = 1$ and varying $\sigma_u$}")
  ) +
  geom_line(
    aes(group = mu), 
    data = . %>% 
      filter(u_sd == 0) %>% 
      mutate(type = r"{Original model: Holding $\sigma_u = 0$ and varying $\mu$}")
  ) + 
  geom_line(
    aes(group = mu), 
    color = "red",
    data = . %>% 
      filter(u_sd == 0, mu == 1) 
  ) + 
  labs(
    title = latex2exp::TeX(r"{$\mu\Delta\[w^*\]$ with and without shocks.}"),
    x = latex2exp::TeX("$w^*$"),
    y = "",
    caption = latex2exp::TeX(r"{Black lines move down as $\mu$ decreases or $\sigma_u$ increases. Red lines are with $\mu = 1$ and $\sigma_u = 0$.}")
  ) +
  facet_wrap(vars(type), labeller = as_labeller(latex2exp::TeX, default = label_parsed)) +
  NULL
```

# Results

## Treatment Effects

Running a simple model (a non-hierarchical model with a linear cost), we get the following estimates.

```{r load-processed-results}
# load(file.path("temp-data", str_glue("processed_dist_fit{takeup_version}.RData")))
load(file.path("/tigress/kn6838/takeup", str_glue("processed_dist_fit{takeup_version}.RData")))

dist_fit_data %<>% 
  mutate(model_color = c("black", "darkgrey"))
```

```{r, fig.width=8, fig.height=9}
dist_fit_data %>% 
  mutate(est_takeup_te =
    map(est_takeup_te, 
        filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right,
        (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
        assigned_treatment_left != assigned_treatment_right,
        fct_match(assigned_treatment_right, c("control")),
        fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"))) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  mutate(
    assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment_left = str_to_title(assigned_treatment_left)
  ) %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment_left, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("") +
        labs(
          title = "Incentive Average Treatment Effect"
        ) +
        ggforce::facet_col(vars(assigned_dist_group_left), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      plot_estimand_hist(., iter_takeup_te, binwidth = 0.02, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.2)) +
        scale_y_continuous("") +
        facet_grid(cols = vars(assigned_dist_group_left), rows = vars(assigned_treatment_left)) +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  } 
```

```{r, fig.width=8, fig.height=10}
dist_fit_data %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  filter(
    (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
    across(c(assigned_treatment_left, assigned_treatment_right), fct_match, "control"),
    !is.na(mu_assigned_treatment_left),
    fct_match(mu_assigned_treatment_left, "bracelet") | !fct_match(mu_assigned_treatment_right, "calendar"),
    fct_match(mu_assigned_treatment_right, "control"),
  ) %>%
  mutate(
    assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    mu_assigned_treatment_left = str_to_title(mu_assigned_treatment_left),
  ) %>% {
    cowplot::plot_grid(
      plot_estimands(., mu_assigned_treatment_left, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.05)) +
        scale_y_discrete("") +
        labs(
          title = "Signaling Average Treatment Effect",
          subtitle = "Holding private incentive at the control level.") +
        ggforce::facet_col(vars(assigned_dist_group_left), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      plot_estimand_hist(., iter_takeup_te, binwidth = 0.02, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.2)) +
        scale_y_continuous("") +
        facet_grid(cols = vars(assigned_dist_group_left), rows = vars(mu_assigned_treatment_left)) +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  } 
```

```{r, fig.width=8, fig.height=10}
dist_fit_data %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  filter(
    (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
    !is.na(mu_assigned_treatment_left),
    !is.na(mu_assigned_treatment_right),
    across(c(mu_assigned_treatment_left, mu_assigned_treatment_right), fct_match, "control"),
    fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"),
    fct_match(assigned_treatment_right, "control"),
  ) %>%
  mutate(
    assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment_left = str_to_title(assigned_treatment_left),
  ) %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment_left, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.05)) +
        scale_y_discrete("") +
        labs(
          title = "Private Incentive Average Treatment Effect",
          subtitle = "Holding signaling at the control level.") +
        ggforce::facet_col(vars(assigned_dist_group_left), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      plot_estimand_hist(., iter_takeup_te, binwidth = 0.02, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_continuous("") +
        facet_grid(cols = vars(assigned_dist_group_left), rows = vars(assigned_treatment_left)) +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  }
```

## Rates of Change

To calculate the slope of $\bar{y}(b,c)$ with respect to cost,
\begin{align*}
  \frac{\partial \bar{y}(b,c)}{\partial c} = \frac{-f_w(w^*(b,c))}{1 + \mu\Delta'[w^*(b,c)]},
\end{align*}
where
\begin{align*}
\Delta'[w^*(b,c)] = &-\frac{\int_{-\infty}^\infty v f_u(w^*(b,c) - v) f_v(v)\,\mathrm{d}v + f_w(w^*(b,c))\left[1 - 2F_w(w^*(b,c))\right]\Delta[w^*(b,c)]}{F_w(w^*(b,c))\left[1 - F_w(w^*(b,c))\right]} 
\end{align*}

```{r cost-mitig-diff, fig.width=8, fig.height=5.5}
v_lim <- c(-2, 2)

diff_rate_of_change_data <- dist_fit_data %>% 
  select(model, model_name, diff_y_rate_of_change, fit_type) %>% 
  unnest(diff_y_rate_of_change) 

diff_takeup_partial_v_plot <- diff_rate_of_change_data %>%  
  unpack(diff_partial_d) %>% 
  filter(!fct_match(assigned_treatment_left, "control"), fct_match(assigned_treatment_right, "control")) %>% 
  # filter(fit_type == "prior-predict") %>% 
  ggplot(aes(v, per_0.5, group = fit_type)) +
  geom_line(show.legend = FALSE) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9), color = NA, alpha = 0.25, show.legend = FALSE) +
  geom_ribbon(aes(ymin = per_0.25, ymax = per_0.75), color = NA, alpha = 0.25, show.legend = FALSE) +
  scale_y_continuous(breaks = seq(-1, 1, 0.005)) +
  coord_cartesian(xlim = v_lim) +
  labs(
    title = "Rate-of-change of Take-up Compared to Control Level", 
    subtitle = "With respect to distance (meters).",
    x = "w",
    y = TeX(r"{$\frac{\partial E\[Y(z,w)\]}{\partial d} - \frac{\partial E\[Y(control,w)\]}{\partial d}$ Difference}"),
    caption = "Line: posterior median. Dark ribbon: 50% CI. Light ribbon: 80% CI."
 ) + 
  facet_grid(rows = vars(fit_type), cols = vars(assigned_treatment_left), labeller = as_labeller(str_to_title), scales = "free_y") +
  NULL

diff_takeup_partial_v_plot
```

## Levels

```{r, fig.width=8, fig.height=11}
dist_fit_data %>% 
  mutate(est_takeup_level =
    map(est_takeup_level, filter, assigned_treatment == mu_assigned_treatment)) %>%  
  select(model, model_name, est_takeup_level, fit_type) %>% 
  unnest(est_takeup_level) %>%
  mutate(
    assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment = str_to_title(assigned_treatment),
  ) %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("") +
        labs(
          title = "Incentive Take-up Level"
        ) +
        ggforce::facet_col(vars(assigned_dist_group), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      plot_estimand_hist(., iter_prop_takeup, binwidth = 0.02, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_continuous("") +
        facet_grid(cols = vars(assigned_dist_group), rows = vars(assigned_treatment), scales = "free_y") +
        theme(legend.position = "none") +
        coord_cartesian(ylim = c(0, 0.2)) +
        NULL,
      
      ncol = 1
    )
  }
```

```{r, fig.width=8, fig.height=11}
dist_fit_data %>% 
  select(model, model_name, est_takeup_level, fit_type) %>% 
  unnest(est_takeup_level) %>%
  filter(
    fct_match(assigned_treatment, "control"),
    !is.na(mu_assigned_treatment),
  ) %>%
  mutate(
    assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    
    mu_assigned_treatment = str_to_title(mu_assigned_treatment),
  ) %>% {
    cowplot::plot_grid(
      plot_estimands(., mu_assigned_treatment, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("", labels = str_to_title) +
        labs(
          title = "Signaling Level",
          subtitle = "Holding private incentive at the control level."
        ) +
        ggforce::facet_col(vars(assigned_dist_group), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      plot_estimand_hist(., iter_prop_takeup, binwidth = 0.02, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_continuous("") +
        facet_grid(cols = vars(assigned_dist_group), rows = vars(mu_assigned_treatment)) +
        coord_cartesian(ylim = c(0, 0.2)) +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  }
  
```

```{r, fig.width=8, fig.height=11}
dist_fit_data %>% 
  select(model, model_name, est_takeup_level, fit_type) %>% 
  unnest(est_takeup_level) %>%
  filter(
    !is.na(mu_assigned_treatment),
    fct_match(mu_assigned_treatment, "control"),
  ) %>%
  mutate(
    assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    
    assigned_treatment = str_to_title(assigned_treatment)
  ) %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("") +
        labs(
          title = "Private Incentive Level",
          subtitle = "Holding signaling at the control level."
        ) +
        ggforce::facet_col(vars(assigned_dist_group), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      plot_estimand_hist(., iter_prop_takeup, binwidth = 0.02, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_continuous("") +
        facet_grid(cols = vars(assigned_dist_group), rows = vars(assigned_treatment)) +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  }
```

## Model Parameters

```{r}
dist_fit_data %>% 
  select(model, model_name, mu_rep, fit_type) %>% 
  unnest(mu_rep) %>%
  plot_estimand_hist(iter_est, binwidth = 0.02, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
  scale_x_continuous() +
  scale_y_continuous("") +
  labs(
    title = latex2exp::TeX(r"{Signaling $\mu$}"),
    x = ""
  ) +
  facet_wrap(vars(assigned_treatment), labeller = as_labeller(str_to_title)) +
  coord_cartesian(xlim = c(0, 5)) +
  theme(legend.position = "none") +
  NULL
```

```{r}
load(file.path("/tigress/kn6838/takeup", str_glue("dist_prior{takeup_version}.RData")))
dist_prior <- read_rds(dist_fit$STRUCTURAL_LINEAR_U_SHOCKS)

load(file.path("/tigress/kn6838/takeup", str_glue("dist_fit{takeup_version}.RData")))
dist_fit <- read_rds(dist_fit$STRUCTURAL_LINEAR_U_SHOCKS)

all_fit <- lst(
  prior = dist_prior,
  fit = dist_fit
)
```

```{r, fig.height=1.8, fig.width=8}
plot_pos <- position_dodge(width = 0.75)

all_fit %>% 
  map_dfr(~ .x$draws(c("beta_control", "beta_ink_effect", "beta_bracelet_effect", "wtp_value_utility")) %>% 
            posterior::as_draws_df() %>% 
            mutate(iter_id = .draw) %>% 
            pivot_longer(!c(iter_id, .draw, .chain, .iteration), names_to = "param", values_to = "iter_value") %>% 
            nest(iter_data = c(.chain, .iteration, .draw, iter_id, iter_value)), 
          .id = "fit_type") %>% 
  mutate(quant = map(iter_data, quantilize_est, iter_value, quant_probs = c(0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95))) %>% 
  unnest(quant) %>% 
  ggplot(aes(y = param, group = fit_type)) +
  geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = fit_type), alpha = 0.4, size = 3, position = plot_pos) +
  geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = fit_type), fatten = 0, size = 0.4, width = 0.5, position = plot_pos) +
  geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = fit_type), size = 0.4, position = plot_pos) +
  NULL
```

# Beliefs

```{r}
beliefs_results <- read_rds(file.path("data", "stan_analysis_data", "secobeliefs_results.rds"))
```

```{r, fig.width=8, fig.height=8}
pos_dodge <- position_dodge(width = 0.3)

first_plot <- beliefs_results$prob_knows %>% 
  filter(ord == 1) %>% 
  ggplot(aes(y = assigned.treatment, group = dist.pot.group)) +
  geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = dist.pot.group), position = pos_dodge, size = 0.4) +
  geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = dist.pot.group), position = pos_dodge, fatten = 2, size = 0.4, width = 0.2) +
  geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = dist.pot.group), position = pos_dodge, alpha = 0.4, size = 2.5) +
  geom_point(aes(x = per_0.5, color = dist.pot.group), position = pos_dodge, size = 1.8) +
  geom_point(aes(x = per_0.5), position = pos_dodge, color = "white", size = 0.6) +
  scale_color_canva("", labels = str_to_title, palette = canva_palette_vibrant) + 
  labs(
    title = "First Order Beliefs",
    subtitle = "Proportion",
    x = "", y = "") +
  theme(legend.position = "top") +
  NULL

cowplot::plot_grid(
  cowplot::get_legend(first_plot),
  cowplot::plot_grid(
    first_plot +
      theme(
        legend.position = "none"
      ) +
      NULL,
    
    beliefs_results$ate_knows %>% 
      filter(ord == 1, dist.pot.group_left == dist.pot.group_right) %>% 
      ggplot(aes(y = assigned.treatment_left, group = dist.pot.group_left)) +
      geom_vline(xintercept = 0, linetype = "dotted") +
      geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = dist.pot.group_left), position = pos_dodge, size = 0.3) +
      geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = dist.pot.group_left), position = pos_dodge, fatten = 2, size = 0.4, width = 0.2) +
      geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = dist.pot.group_left), position = pos_dodge, alpha = 0.4, size = 2.25) +
      geom_point(aes(x = per_0.5, color = dist.pot.group_left), position = pos_dodge, size = 1.8) +
      geom_point(aes(x = per_0.5), position = pos_dodge, color = "white", size = 0.6) +
      scale_y_discrete(drop = FALSE) +
      scale_color_canva("", labels = str_to_title, palette = canva_palette_vibrant) + 
      labs(
        title = "",
        subtitle = "Treatment Effect",
        x = "", y = "") +
      theme(
        axis.text.y = element_blank(),
        legend.position = "none"
      ) +
      NULL,
    
    beliefs_results$prob_knows %>% 
      filter(ord == 2) %>% 
      ggplot(aes(y = assigned.treatment, group = dist.pot.group)) +
      geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = dist.pot.group), position = pos_dodge, size = 0.4) +
      geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = dist.pot.group), position = pos_dodge, fatten = 2, size = 0.4, width = 0.2) +
      geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = dist.pot.group), position = pos_dodge, alpha = 0.4, size = 2.5) +
      geom_point(aes(x = per_0.5, color = dist.pot.group), position = pos_dodge, size = 1.8) +
      geom_point(aes(x = per_0.5), position = pos_dodge, color = "white", size = 0.6) +
      scale_color_canva("", labels = str_to_title, palette = canva_palette_vibrant) + 
      labs(
        title = "Second Order Beliefs",
        subtitle = "Proportion",
        x = "", y = "") +
      theme(
        legend.position = "none"
      ) +
      NULL,
    
    beliefs_results$ate_knows %>% 
      filter(ord == 2, dist.pot.group_left == dist.pot.group_right) %>% 
      ggplot(aes(y = assigned.treatment_left, group = dist.pot.group_left)) +
      geom_vline(xintercept = 0, linetype = "dotted") +
      geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = dist.pot.group_left), position = pos_dodge, size = 0.3) +
      geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = dist.pot.group_left), position = pos_dodge, fatten = 2, size = 0.4, width = 0.2) +
      geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = dist.pot.group_left), position = pos_dodge, alpha = 0.4, size = 2.25) +
      geom_point(aes(x = per_0.5, color = dist.pot.group_left), position = pos_dodge, size = 1.8) +
      geom_point(aes(x = per_0.5), position = pos_dodge, color = "white", size = 0.6) +
      scale_y_discrete(drop = FALSE) +
      scale_color_canva("", labels = str_to_title, palette = canva_palette_vibrant) + 
      labs(
        title = "",
        subtitle = "Treatment Effect",
        x = "", y = "") +
      theme(
        axis.text.y = element_blank(),
        legend.position = "none"
      ) +
      NULL,
    
    ncol = 2, axis = "b", align = "h" 
  ),
  
  ncol = 1, rel_heights = c(0.1, 1)
)
```

