---
title: "Distance Structural"
output: html_notebook
---

```{r setup}
library(magrittr)
library(tidyverse)
library(HRW)
library(splines2)
library(rstan)
library(loo)
library(bayesplot)
library(latex2exp)

options(mc.cores = 12)
rstan_options(auto_write = TRUE)
```

```{r util-scripts}
source("analysis_util.R")
source(file.path("multilvlr", "multilvlr_util.R"))
source("dist_structural_util.R")
```

```{r load-data}
load(file.path("stan_analysis_data", "dist_fit.RData"))
load(file.path("stan_analysis_data", "dist_cv.RData"))
```

```{r}
plot_takeup <- . %>% 
  map_dfr(extract_sim_level, "sim_takeup_prob", .id = "model", grid_dist = grid_dist) %>% 
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est),
         # model = str_extract(model, "[^_]+$")
         ) %>% 
  unnest(wide_quantiles) %>% {
    ggplot(., aes(grid_dist, mean_est, group = model)) +
      geom_line(aes(color = model), 
                show.legend = FALSE) +
      geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = model), 
                  show.legend = TRUE,
                  alpha = 0.25) +
      # geom_ribbon(aes(ymin = per_0.05, ymax = per_0.95), alpha = 0.25) +
      # geom_point(aes(cluster.dist.to.pot, prop_takeup, color = dist.pot.group),
      geom_point(aes(cluster.dist.to.pot, prop_takeup), inherit.aes = FALSE,
                 data = cluster_analysis_data %>% mutate(assigned_treatment = assigned.treatment)) +
      scale_color_discrete("Model") +
      scale_fill_discrete("Model") +
      labs(
        x = "Distance from PoT [meters]", 
        y = "Take-up", 
        caption = "Points: observed village level proportion of take-up.
                   Grey ribbons: 80% credible intervals."
      ) +
      facet_wrap(vars(assigned_treatment), nrow = 1) +
      theme_minimal() +
      theme(legend.position = "right")
  }
```

```{r, fig.width=16, fig.height=4}
dist_fit[1] %>% 
  plot_takeup()
```

```{r, fig.width=16, fig.height=4}
dist_fit %>% 
  magrittr::extract(
    c(
      # "LINEAR_DIST",
      # "LINEAR_DIST_CE",
      # "QUADRATIC_NONLINEAR_DIST",
      # "QUADRATIC_NONLINEAR_DIST_CE",
      # "CUBIC_NONLINEAR_DIST_CE",
      # "SEMIPARAM_NONLINEAR_DIST_BSPLINE"
      "SEMIPARAM_NONLINEAR_DIST_OSULLIVAN"
      )) %>%
# dist_fit[3:7] %>%
# semiparam_fit %>%
  plot_takeup()
```

```{r, fig.width=8}
dist_fit[c(
  "CUBIC_NONLINEAR_DIST",
  "CUBIC_NONLINEAR_DIST_CE",
  "SEMIPARAM_NONLINEAR_DIST_OSULLIVAN"
  )] %>%
  map_dfr(extract_sim_level, "sim_takeup_prob", .id = "model", grid_dist = grid_dist) %>% 
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est)) %>% 
  unnest(wide_quantiles) %>% 
  ggplot(aes(grid_dist, mean_est, group = assigned_treatment)) +
  geom_line(aes(color = assigned_treatment), 
            show.legend = TRUE) +
  # geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = assigned_treatment), 
  #             show.legend = TRUE,
  #             alpha = 0.25) +
  scale_color_discrete("Assigned Treatment") +
  scale_fill_discrete("Assigned Treatment") +
  labs(
    x = "Distance from PoT [meters]", 
    y = "Take-up", 
    caption = "Points: observed village level proportion of take-up.
               Grey ribbons: 80% credible intervals."
  ) +
  facet_wrap(vars(model), nrow = 1) +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r, fig.width=14, fig.height=4}
semiparam_fit %>%
  map_dfr(extract_obs_fit_level, "obs_takeup_prob", stan_data, .id = "model") %>% 
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est),
         model = str_extract(model, "[^_]+$")) %>% 
  unnest(wide_quantiles) %>% 
  ggplot(aes(assigned_dist, mean_est, group = model)) +
  geom_line(aes(color = model)) +
  # geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9), alpha = 0.25) +
  # geom_ribbon(aes(ymin = per_0.05, ymax = per_0.95), alpha = 0.25) +
  # geom_point(aes(cluster.dist.to.pot, prop_takeup, color = dist.pot.group),
  geom_point(aes(cluster.dist.to.pot, prop_takeup), inherit.aes = FALSE,
             data = cluster_analysis_data %>% mutate(assigned_treatment = assigned.treatment)) +
  labs(
    x = "Distance from PoT [meters]", 
    y = "Take-up", 
    # color = "Assigned Distance Group",
    color = "Model"
    # caption = "Points: observed village level proportion of take-up.
    #            Grey ribbons: 80% and 90% credible intervals."
  ) +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r, fig.width=12, fig.height=4}
dist_fit[c(
  # "LINEAR_DIST", 
  "QUADRATIC_NONLINEAR_DIST"
  # "SEMIPARAM_NONLINEAR_DIST_BSPLINE"
  # "SEMIPARAM_NONLINEAR_DIST_OSULLIVAN"
  )] %>%
  map_dfr(extract_sim_level, "sim_v", .id = "model") %>% 
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est),
         # model = str_extract(model, "[^_]+$")
         ) %>% 
  unnest(wide_quantiles) %>% 
  ggplot(aes(grid_dist, mean_est, group = model)) +
  geom_line(aes(color = model),
              show.legend = FALSE) +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = model), 
              show.legend = FALSE,
              alpha = 0.25) +
  # geom_ribbon(aes(ymin = per_0.05, ymax = per_0.95), alpha = 0.25) +
  geom_rug(aes(cluster.dist.to.pot, prop_takeup), inherit.aes = FALSE,
           alpha = 0.5,
           sides = "b",
           data = cluster_analysis_data %>% mutate(assigned_treatment = assigned.treatment)) +
  scale_color_discrete("Model") +
  scale_fill_discrete("Model") +
  labs(x = "Distance from PoT", 
       y = bquote(~ v^"*"~"(z,d)"), 
       caption = "Points: observed village level proportion of take-up.
                  Grey ribbons: 80% credible intervals.") +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  theme_minimal() +
  theme(legend.position = "top")
```

```{r, fig.width=8, fig.height=12}
dist_fit[[1]] %>% 
  extract_obs_fit_level("cluster_takeup_prob", stan_data = stan_data, cluster_level = TRUE) %>% 
  ggplot(aes(assigned_dist, mean_est, group = assigned_treatment)) +
  geom_line(aes(color = assigned_treatment)) +
  geom_point(aes(cluster.dist.to.pot, prop_takeup), inherit.aes = FALSE,
             data = cluster_analysis_data %>% mutate(assigned_treatment = assigned.treatment)) +
  facet_wrap(vars(assigned_treatment), ncol = 1)
```

```{r, fig.width=12, fig.height=4}
sim_reputation %>%
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est)) %>% 
  unnest(wide_quantiles) %>% 
  ggplot(aes(grid_dist, mean_est)) +
  geom_line() +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9), alpha = 0.25) +
  geom_ribbon(aes(ymin = per_0.05, ymax = per_0.95), alpha = 0.25) +
  geom_rug(aes(cluster.dist.to.pot, prop_takeup, color = dist.pot.group),
           alpha = 0.5,
           sides = "b",
           data = cluster_analysis_data %>% mutate(assigned_treatment = assigned.treatment)) +
  labs(x = "Distance from PoT", y = bquote("r(" ~ v^"*"~"(z,d))"), color = "Assigned Distance Group",
       caption = "Points: observed village level proportion of take-up.
                  Grey ribbons: 80% and 90% credible intervals.") +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  theme_minimal() +
  theme(legend.position = "top")
```

```{r, fig.width=12}
grid_dist_data <- grid_dist2 %>% 
  set_names(levels(monitored_nosms_data$assigned.treatment)) %>% 
  as.tibble() %>% 
  mutate(grid_index = seq(n())) %>% 
  gather(assigned_treatment, grid_dist, -grid_index)

sim_benefit_cost <- dist_fit[[1]] %>% 
  extract_sim_level("sim_benefit_cost", grid_dist_data) %>% 
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est)) %>% 
  unnest(wide_quantiles)

sim_v <- dist_fit[[1]] %>% 
  extract_sim_level("sim_v", grid_dist_data) %>% 
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est)) %>% 
  unnest(wide_quantiles)

sim_takeup_prob <- dist_fit[[1]] %>% 
  extract_sim_level("sim_takeup_prob", grid_dist_data) %>% 
  mutate(wide_quantiles = map(quantiles_est, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est)) %>% 
  unnest(wide_quantiles)

lst(sim_benefit_cost, sim_v) %>% 
  bind_rows(.id = "util_term") %>% 
  ggplot(aes(grid_dist, mean_est, group = util_term)) +
  geom_line(aes(color = util_term)) +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = util_term), alpha = 0.25) +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  NULL

sim_takeup_prob %>% 
  ggplot(aes(grid_dist, mean_est)) +
  geom_line() +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9), alpha = 0.25) +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  NULL
```

```{r}
dist_fit[[1]] %>% 
  extract_obs_fit_level(par = "structural_cluster_benefit_cost", stan_data = stan_data, cluster_level = T) %>% 
  ggplot(aes(assigned_dist, mean_est)) +
  geom_line() +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  NULL
```

```{r}
quant_probs <- c(0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95)

net_benefit <- dist_fit[[1]] %>% 
  extract_obs_fit_level(par = "structural_cluster_benefit_cost", stan_data = stan_data, iter_level = "cluster", quant_probs = quant_probs) 

cluster_effects <- dist_fit[[1]] %>% 
  extract_obs_fit_level(par = "cluster_effects", stan_data = stan_data, iter_level = "cluster", quant_probs = quant_probs) 

v_cutoff <- dist_fit[[1]] %>% 
  extract_obs_fit_level(par = "structural_cluster_obs_v", stan_data = stan_data, iter_level = "cluster", quant_probs = quant_probs) 

takeup_prob <- dist_fit[[1]] %>% 
  extract_obs_fit_level(par = "structural_cluster_takeup_prob", stan_data = stan_data, iter_level = "cluster", mix = TRUE, quant_probs = quant_probs) 

mu_rep <- dist_fit[[1]] %>% 
  extract_obs_fit_level(par = "mu_rep", stan_data = stan_data, iter_level = "treatment", mix = FALSE, quant_probs = quant_probs) %>% 
  select(-assigned_dist) %>% 
  mutate(compare_to = "control") %>% 
  left_join(., select(., assigned_treatment, iter_data), by = c("compare_to" = "assigned_treatment"), suffix = c("", "_compare")) %>% 
  mutate(iter_data = map2(iter_data, iter_data_compare, left_join, by = "iter_id", suffix = c("", "_compare")) %>% 
           map(mutate, iter_est_vs_compare = iter_est - iter_est_compare),
         quantiles_est_vs_compare = map(iter_data, quantilize_est, iter_est_vs_compare, quant_probs = quant_probs)) 

reduced_mu_rep <- mu_rep %>% 
  mutate(iter_data = map(iter_data, arrange, iter_est) %>% 
           map(filter, (row_number() %% 100) == 0))

structural_param <- inner_join(net_benefit, v_cutoff, by = c("obs_index", "assigned_treatment", "assigned_dist"), suffix = c("", "_v_cutoff")) %>% 
  inner_join(cluster_effects, by = c("obs_index", "assigned_treatment", "assigned_dist"), suffix = c("", "_cluster_effects")) %>% 
  inner_join(takeup_prob, by = c("obs_index", "assigned_treatment", "assigned_dist"), suffix = c("", "_takeup_prob")) %>% 
  left_join(mu_rep, by = c("assigned_treatment"), suffix = c("_net_benefit", "_mu_rep")) %>% 
  mutate(
    iter_data = map2(iter_data_net_benefit, iter_data_v_cutoff, inner_join, by = "iter_id", suffix = c("", "_v_cutoff")) %>% 
      map2(iter_data_cluster_effects, inner_join, by = "iter_id", suffix = c("", "_cluster_effects")) %>% 
      map2(iter_data_takeup_prob, inner_join, by = "iter_id", suffix = c("", "_takeup_prob")) %>% 
      map2(iter_data_mu_rep, left_join, by = "iter_id", suffix = c("_net_benefit", "_mu_rep")) %>% 
      map(mutate, 
          iter_est_rep = - iter_est_v_cutoff - iter_est_net_benefit,
          iter_est_super_net_benefit = iter_est_net_benefit - iter_est_cluster_effects),
    mean_est_super_net_benefit = map_dbl(iter_data, ~ mean(.$iter_est_super_net_benefit)),
    quantiles_est_super_net_benefit = map(iter_data, quantilize_est, iter_est_super_net_benefit, quant_probs = quant_probs)
  ) %>% 
  left_join(
    monitored_nosms_data %>% 
      group_by(cluster_id) %>% 
      summarize(prop_takeup = mean(dewormed), 
                se = sqrt(prop_takeup * (1 - prop_takeup) / n()),
                prop_takeup_ub = prop_takeup + se,
                prop_takeup_lb = prop_takeup - se) %>% 
      ungroup(),
    by = c("obs_index" = "cluster_id")
  )
```

```{r, fig.height=4, fig.width=8}
mu_rep %>%
  filter(!fct_match(assigned_treatment, "control")) %>% 
  mutate_at(vars(quantiles_est_vs_compare), 
            ~ map(., mutate, per = str_c("per_", per)) %>% 
              map(spread, per, est)) %>% 
  mutate(assigned_treatment = fct_relabel(assigned_treatment, str_to_title)) %>% 
  ggplot(aes(assigned_treatment)) +
  geom_linerange(aes(ymin = per_0.1, ymax = per_0.9), data = . %>%  unnest(quantiles_est_vs_compare)) +
  geom_crossbar(aes(y = per_0.5, ymin = per_0.25, ymax = per_0.75), width = 0.1, data = . %>%  unnest(quantiles_est_vs_compare)) +
  coord_flip() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  labs(x = "Assigned Treatment (z)",
       y = TeX("Reputational Returns Coefficient Compared to Control ($\\mu_z - \\mu_{control}$)"),
       caption = "Vertical line: median
                  Horizontal line: 80% credible interval
                  Box: 50% credible interval",
       title = "Reputational Returns Cofficients") +
  NULL
```

```{r, fig.width=12, fig.height=6}
structural_param %>% 
  mutate_at(vars(quantiles_est_net_benefit, quantiles_est_super_net_benefit), 
            ~ map(., mutate, per = str_c("per_", per)) %>% 
              map(spread, per, est)) %>% 
  mutate(assigned_treatment = fct_relabel(assigned_treatment, str_to_title)) %>%
  ggplot(aes(assigned_dist)) +
  geom_line(aes(y = mean_est_super_net_benefit), color = "darkgrey") +
  geom_ribbon(aes(ymin = per_0.25, ymax = per_0.75), alpha = 0.25,
                  data = . %>% unnest(quantiles_est_super_net_benefit)) +
  geom_pointrange(aes(y = per_0.5, ymin = per_0.1, ymax = per_0.9), size = 0.5, fatten = 0.5, alpha = 0.75,
                  data = . %>% unnest(quantiles_est_net_benefit)) +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  theme_minimal() +
  labs(
    x = "Assigned Distance",
    y = TeX("Direct Benefit"),
    title = "Direct Benefits",
    caption = "Points: median cluster direct benefit at assigned distance
               Vertical line: cluster direct benefit 50% credible interval
               Line plot: mean cluster direct benefit net cluster effects
               Grey ribbon: cluster direct benefit net cluster effects 50% credible interval"
  ) +
  NULL
```

```{r, fig.width=12}
structural_param %>% 
  unnest(iter_data) %>% 
  mutate(assigned_treatment = fct_relabel(assigned_treatment, str_to_title)) %>%
  ggplot(aes(iter_est_net_benefit, iter_est_v_cutoff)) +
  geom_point(aes(color = iter_est_mu_rep), alpha = 0.05) +
  geom_abline(intercept = 0, slope = -1, linetype = "dotted") +
  scale_color_viridis_c(TeX("Reputational Returns Coefficient ($\mu_z$)")) +
  facet_wrap(vars(assigned_treatment), nrow = 2) +
  theme_minimal() +
  coord_fixed() +
  labs(
    x = "Direct Benefit",
    y = TeX("Procial Type Cutoff ($v^*$)")
  ) +
  NULL
```


```{r, fig.width=10}
structural_param %>% 
  unnest(iter_data) %>% 
  # filter(assigned_treatment == "control") %>% 
  # slice(1:1000) %>% 
  ggplot(aes(iter_est_v_cutoff, iter_est_rep)) +
  # geom_density2d() +
  geom_point(aes(color = iter_est_mu_rep), alpha = 0.05) +
  # geom_contour(aes(z = iter_est_mu_rep)) +
  #              data = . %>% filter(!is.na(iter_est_mu_rep))) +
  # geom_raster(aes(fill = iter_est_mu_rep)) +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  scale_color_viridis_c() +
  # scale_color_distiller(palette = "PiYG") +
  theme_minimal() +
  NULL
```


```{r, fig.width=8}
structural_param %>% 
  unnest(iter_data) %>% 
  ggplot(aes(iter_est_v_cutoff, iter_est_takeup_prob)) +
  geom_point(aes(color = iter_est_mu_rep), alpha = 0.05) +
  # geom_abline(intercept = 0, slope = -1, linetype = "dotted") +
  facet_wrap(vars(assigned_treatment), nrow = 1) +
  theme_minimal() +
  # coord_fixed() +
  NULL
```

```{r, fig.width=16, fig.height=10}
structural_param %>% 
  mutate(quantiles_est_takeup_prob = map(quantiles_est_takeup_prob, mutate, per = str_c("per_", per)) %>% 
           map(spread, per, est)) %>% 
  ggplot(aes(assigned_dist)) +
  # geom_point(aes(y = iter_est_takeup_prob), color = "darkgrey", alpha = 0.025, data = . %>% unnest(iter_data)) +
  geom_crossbar(aes(y = prop_takeup, ymin = prop_takeup_lb, ymax = prop_takeup_ub), color = "darkred", size = 0.5, width = 60) +
  geom_pointrange(aes(y = per_0.5, ymin = per_0.25, ymax = per_0.75), size = 0.5, fatten = 0.75, data = . %>% unnest(quantiles_est_takeup_prob)) +
  scale_color_viridis_c() +
  facet_wrap(vars(assigned_treatment), ncol = 2) +
  theme_minimal() +
  NULL
```

```{r}
tibble(
  v = seq(-5, 5, 0.1),
  # r = Vectorize(reputational_returns_normal)(v)
  r = rep_normal(v)
  
  # r = 0.75 * dnorm(v, mean = -2) + 0.25 * dnorm(v, mean = 2, sd = 2)
  # r = dnorm(v)
) %>% 
  ggplot(aes(v, r)) +
  geom_line() +
  # geom_line(linetype = "dashed", data = . %>% mutate(r = r * 0.75)) +
  NULL
```

```{r}
loo_obj <- dist_fit[1:2] %>% 
  map(extract_log_lik, merge_chains = FALSE) %>% 
  map(~ loo(.x, r_eff = relative_eff(exp(.x)), cores = 2))

#loo_obj %>% walk(print)
  
loo_obj %>% #[c("LINEAR_DIST", "QUADRATIC_NONLINEAR_DIST", "SEMIPARAM_NONLINEAR_DIST_BSPLINE", "SEMIPARAM_NONLINEAR_DIST_OSULLIVAN")] %>% 
  loo_compare()
```

```{r}
dist_kfold %>% kfold_compare(x = .)

# dist_kfold[3:6] %>% 
dist_kfold %>% 
  map(pluck, "pointwise") %>% 
  do.call(rbind, .) %>% 
  t() %>% 
  stacking_weights()
```


