---
title: "TakeUp Analysis Notebook"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    code_folding: hide
    fig_caption: yes
    fig_width: 8
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: no
---

```{r setup, include=FALSE}
library(plyr)
library(dplyr)
library(multidplyr)
library(tibble)
library(tidyr)
library(lubridate)
library(purrr)
library(readr)
library(haven)
library(broom)
library(ggplot2)
library(viridis)
library(ggrepel)
library(ggmap)
library(stringr)
library(knitr)
library(bigmemory)

source("../util.R")
source("takeup_rct_assign_clusters.R")

knitr::opts_chunk$set(cache = TRUE, fig.width = 8, fig.height = 5)

config <- yaml::yaml.load_file("../local_config.yaml")

doParallel::registerDoParallel(cores = config$cores)

wgs.84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
kenya.proj4 <- "+proj=utm +zone=36 +south +ellps=clrk80 +units=m +no_defs"

options(contrasts=c("contr.Treatment", getOption("contrasts")[2])) 
```

```{r load-data}
load("data/takeup_census.RData")
load("data/takeup_at_pot.RData")
load("data/takeup_matched_population.RData")
```

```{r calc-hh2pot-dist}
matched.tu.data.2 %<>%
  left_join(pot.info %>% 
              select(cluster.id, lon.post.rct.update, lat.post.rct.update) %>% 
              set_names(c("cluster.id", "lon", "lat")),
            c("cluster.id.home" = "cluster.id"),
            suffix = c(".hh", ".pot.home")) 

matched.tu.data.2 %<>%
  # filter(!is.na(treatment.spillover), treatment.spillover) %>% 
  filter(!is.na(cluster.spillover), cluster.spillover) %>% 
  left_join(pot.info %>% 
              select(cluster.id, lon.post.rct.update, lat.post.rct.update) %>% 
              set_names(c("cluster.id", "lon", "lat")),
            c("cluster.id.pot" = "cluster.id")) %>%
  rename(lon.pot.dest = lon, lat.pot.dest = lat) %>% 
  filter(!is.na(lon.pot.home), !is.na(lon.pot.dest), !is.na(lat.pot.home), !is.na(lat.pot.dest)) %>% 
  mutate(dist.to.pot.home = gDistance(convert.to.sp(., ~ lon.hh + lat.hh, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      convert.to.sp(., ~ lon.pot.home + lat.pot.home, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      byid = TRUE) %>% diag,
         dist.to.pot.dest = gDistance(convert.to.sp(., ~ lon.hh + lat.hh, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      convert.to.sp(., ~ lon.pot.dest + lat.pot.dest, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      byid = TRUE) %>% diag,
         dist.diff = dist.to.pot.dest - dist.to.pot.home) %>% 
  select(cluster.id.pot, any.matched.KEY.individ, dist.to.pot.home, dist.to.pot.dest, dist.diff, lon.pot.dest, lat.pot.dest) %>% 
  right_join(matched.tu.data.2, c("any.matched.KEY.individ", "cluster.id.pot"))

all.matched.tu.data.2 <- matched.tu.data.2

matched.tu.data.2 %<>% 
  filter(is.na(dist.to.pot.dest) | dist.to.pot.dest <= 20000) 
  # filter((is.na(cluster.spillover) & is.na(treatment.spillover)) | !(cluster.spillover | treatment.spillover) | dist.to.pot.dest <= 20000) 
```


# Take-up

```{r}
last.stratum = "Siaya.far"

calc.strat.interaction.terms <- function(.data) {
 bind_cols(select(.data, KEY.individ, last.stratum.size, total.size, stratum.size), 
           tidy(model.matrix(~ assigned.treatment:stratum - 1, .data))) %>% 
    select(-matches("control\\.stratum")) %>% 
    gather(interact.param, interact.coef, -c(KEY.individ, last.stratum.size, total.size, stratum.size)) %>% 
    separate(interact.param, c("interact.assign", "interact.stratum"), sep = "\\.(?>stratum)") %>% 
    mutate(interact.coef = interact.coef * if_else(interact.stratum == last.stratum, 1/last.stratum.size, 1)) %>% 
    group_by(KEY.individ, interact.assign) %>% 
    do({
      last.stratum.coef <- filter(., interact.stratum == last.stratum) %$% interact.coef 
      
      mutate(., 
             interact.coef = interact.coef - ifelse(interact.stratum == last.stratum, 0, last.stratum.coef * stratum.size))
    }) %>% 
    ungroup %>% 
    mutate(interact.coef = interact.coef * ifelse(interact.stratum == last.stratum, total.size, 1),  
           interact.term.key = paste(interact.assign, interact.stratum, sep = "_") %>% str_replace("^assigned\\.treatment", "")) %>% 
    select(KEY.individ, matches("^interact\\.(term|coef)")) %>% 
    spread(interact.term.key, interact.coef) 
}

xx <- census.data %>% 
  filter(monitored, monitor.consent, is.na(sms.treatment) | sms.treatment == "sms.control") %>% 
  left_join(select(cluster.strat.data, wave, county, cluster.id, dist.pot.group), c("wave", "county", "cluster.id")) %>%  
  mutate(stratum = paste(county, dist.pot.group, sep = ".")) %>% 
  group_by(stratum) %>% 
  mutate(stratum.size = n(),
         last.stratum.size = if_else(first(stratum) == last.stratum, first(stratum.size), as.integer(-1))) %>% 
  ungroup %>%
  mutate(last.stratum.size = max(.$last.stratum.size),
         total.size = n()) %>%   
  left_join(calc.strat.interaction.terms(.), "KEY.individ") 
  
  xx %>% {
    reg.formula <- as.formula(sprintf("dewormed.any ~ stratum - 1 + %s", 
                                      paste(grep("(calendar|ink|bracelet)_(Busia|Siaya|Kakamega)", names(.), value = TRUE), collapse = " + ")))
   
    print(reg.formula) 
    
    lm(reg.formula, data = .) 
  } %>% 
  summary
```

```{r}
calc.strata.stats <- function(.data, .strat.by = c("county", "dist.pot.group"), .interact.ate.with = NULL) {
  .data %>% 
    group_by_(.dots = c(.strat.by, "assigned.treatment")) %>% 
    summarize(stratum.assign.size = n(),
              stratum.mean.dewormed = mean(dewormed.any)) %>%  
    ungroup %>% 
    left_join(filter(., assigned.treatment == "control"), c("county", "dist.pot.group"), suffix = c(".origin", ".control")) %>% 
    set_names(str_replace(names(.), "\\.origin", "")) %>% 
    left_join(filter(., assigned.treatment == "calendar"), c("county", "dist.pot.group"), suffix = c(".origin", ".calendar")) %>% 
    set_names(str_replace(names(.), "\\.origin", "")) %>% 
    mutate(total.size = sum(stratum.assign.size)) %>% 
    group_by_(.dots = .strat.by) %>%
    mutate(stratum.ate = stratum.mean.dewormed - stratum.mean.dewormed.control,
           stratum.ate.calendar = stratum.mean.dewormed - stratum.mean.dewormed.calendar,
           stratum.baseline = first(stratum.mean.dewormed.control),
           stratum.size = stratum.assign.size + stratum.assign.size.control,
           stratum.size.calendar = stratum.assign.size + stratum.assign.size.calendar) %>% 
    group_by_(.dots = c("assigned.treatment", .interact.ate.with)) %>% 
    summarize(ate = weighted.mean(stratum.ate, stratum.size), 
              ate.calendar = weighted.mean(stratum.ate.calendar, stratum.size.calendar), 
              baseline = weighted.mean(stratum.baseline, stratum.size),
              treat.grp.dewormed = weighted.mean(stratum.mean.dewormed, stratum.size)) 
}

neeyman.results <- census.data %>% 
  filter(monitored, monitor.consent, sms.treatment == "sms.control") %>% 
  left_join(select(cluster.strat.data, wave, county, cluster.id, dist.pot.group), c("wave", "county", "cluster.id")) %>%  
  transmute(stratum = paste(county, dist.pot.group, sep = "."),
            county, dist.pot.group, cluster.id, assigned.treatment, sms.treatment, dewormed.any) %>% 
  block.bootstrap(1000, "cluster.id") %>%
  do(calc.strata.stats(., .interact.ate.with = "dist.pot.group")) %>% 
  ungroup %>% 
  select(-baseline) %>% 
  group_by(assigned.treatment, dist.pot.group) %>% 
  summarize_at(vars(starts_with("ate"), treat.grp.dewormed), funs(mean(., na.rm = TRUE), sd(., na.rm = TRUE))) %>% 
  mutate(ci.lower.dewormed = treat.grp.dewormed_mean - 1.64 * treat.grp.dewormed_sd,
         ci.upper.dewormed = treat.grp.dewormed_mean + 1.64 * treat.grp.dewormed_sd,
         ci.lower.ate = ate_mean - 1.64 * ate_sd,
         ci.upper.ate = ate_mean + 1.64 * ate_sd,
         ci.lower.ate.calendar = ate.calendar_mean - 1.64 * ate.calendar_sd,
         ci.upper.ate.calendar = ate.calendar_mean + 1.64 * ate.calendar_sd)
```

```{r}
neeyman.results %>%
  filter(assigned.treatment != "control") %>% 
  ggplot(aes(assigned.treatment, ate_mean, col = dist.pot.group)) +
  geom_hline(yintercept = 0) +
  geom_point() +  #, color = "black") +
  geom_line(aes(group = dist.pot.group)) +
  geom_errorbar(aes(ymin = ci.lower.ate, ymax = ci.upper.ate), width = 0.05) +
  scale_y_continuous("Average Treatment Effect", breaks = seq(-0.1, 0.3, 0.01)) +
  facet_wrap(~ dist.pot.group, scales = "free_y")

neeyman.results %>%
  filter(assigned.treatment != "calendar") %>% 
  ggplot(aes(assigned.treatment, ate.calendar_mean, col = dist.pot.group)) +
  geom_hline(yintercept = 0) +
  geom_point() +  #, color = "black") +
  geom_line(aes(group = dist.pot.group)) +
  geom_errorbar(aes(ymin = ci.lower.ate.calendar, ymax = ci.upper.ate.calendar), width = 0.05) +
  scale_y_continuous("Average Treatment Effect", breaks = seq(-0.1, 0.3, 0.01)) +
  facet_wrap(~ dist.pot.group, scales = "free_y")
```



```{r, fig.align="center", fig.align="center", fig.width=8, fig.height=10}
plot.aggreg.takeup <- function(.data) {
  ggplot(.data, aes(assigned.treatment)) +
    # geom_bar(aes(fill = source.type), color = "black", alpha = 0.5) +
    geom_bar(color = "black", alpha = 0.5) +
    labs(x = "Destination Treatment", y = "") +
    # scale_fill_discrete("", labels = c("Targeted Village/Cluster", "Targeted Cluster/Untargeted Village", "Other")) +
    facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
    theme(legend.position = "bottom")
}

takeup.data %>% 
  plot.aggreg.takeup +
  ggtitle("Aggregate Take-up")
```

## Monitored Only
```{r}
monitored.and.matched.data <- matched.tu.data.2 %>%
  filter(endline.type %in% c("endline", "endline.backup", "reconsent"))  
```

```{r , eval=FALSE}
monitored.and.matched.data %<>%
  left_join(pot.info %>% 
              select(cluster.id, lon.post.rct.update, lat.post.rct.update) %>% 
              set_names(c("cluster.id", "lon", "lat")),
            c("cluster.id.home" = "cluster.id"),
            suffix = c(".hh", ".pot.home")) 

monitored.and.matched.data %<>%
  filter(treatment.spillover) %>% 
  left_join(pot.info %>% 
              select(cluster.id, lon.post.rct.update, lat.post.rct.update) %>% 
              set_names(c("cluster.id", "lon", "lat")),
            c("cluster.id.pot" = "cluster.id")) %>%
  rename(lon.pot.dest = lon, lat.pot.dest = lat) %>% 
  filter(!is.na(lon.pot.home), !is.na(lon.pot.dest), !is.na(lat.pot.home), !is.na(lat.pot.dest)) %>% 
  mutate(dist.to.pot.home = gDistance(convert.to.sp(., ~ lon.hh + lat.hh, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      convert.to.sp(., ~ lon.pot.home + lat.pot.home, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      byid = TRUE) %>% diag,
         dist.to.pot.dest = gDistance(convert.to.sp(., ~ lon.hh + lat.hh, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      convert.to.sp(., ~ lon.pot.dest + lat.pot.dest, wgs.84) %>% 
                                        spTransform(kenya.proj4),
                                      byid = TRUE) %>% diag,
         dist.diff = dist.to.pot.dest - dist.to.pot.home) %>% 
  select(cluster.id.pot, any.matched.KEY.individ, dist.to.pot.home, dist.to.pot.dest, dist.diff, lon.pot.dest, lat.pot.dest) %>% 
  right_join(monitored.and.matched.data, c("any.matched.KEY.individ", "cluster.id.pot"))
```

The "Name Matched" proportion is a good indicator of much enumerators at failing to identify monitored individuals.

```{r drop-far-spillovers, eval=TRUE}
monitored.and.matched.data %<>%
  # filter(!(cluster.spillover | treatment.spillover) | dist.to.pot.dest <= 10000) %>% 
  mutate(match.type = case_when(.$treatment.spillover ~ "Treatment Spillover",
                                .$cluster.spillover ~ "Cluster Spillover",
                                is.na(.$KEY.individ) ~ "Name Matched",
                                TRUE ~ "PoT Matched") %>% 
           factor(levels = c("PoT Matched", "Name Matched", "Cluster Spillover", "Treatment Spillover")))
```

```{r, echo=FALSE, fig.width=8, fig.height=10}
monitored.and.matched.data %>% 
  ggplot() +
  # geom_bar(aes(assigned.treatment.pot, fill = treatment.spillover), color = "black", alpha = 0.5) +
  geom_bar(aes(assigned.treatment.pot, fill = match.type), color = "black", alpha = 0.5) +
  labs(x = "Destination Treatment", y = "") +
  scale_fill_discrete("Treatment Spillover") +
  ggtitle("Monitored Sample Only Take-up") +
  facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
  theme(legend.position = "bottom")
```

```{r, echo=FALSE, fig.width=8, fig.height=10}
monitored.and.matched.data %>% 
  filter(!is.na(assigned.treatment.home)) %>% 
  ggplot() +
  # geom_bar(aes(assigned.treatment.home, fill = treatment.spillover), color = "black", alpha = 0.5) +
  geom_bar(aes(assigned.treatment.home, fill = match.type), color = "black", alpha = 0.5) +
  labs(x = "Home Treatment", y = "") +
  scale_fill_discrete("Treatment Spillover") +
  ggtitle("Monitored Sample Only Take-up") +
  facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
  theme(legend.position = "bottom")
```

### Non SMS Group

Only those who did not receive SMS treatment, dropping spillovers.

```{r, echo=FALSE, fig.width=12}
monitored.and.matched.data %>% 
  filter(!is.na(assigned.treatment.home), sms.treatment == "sms.control", !treatment.spillover) %>% 
  mutate(sms.ctrl.subpop = factor(sms.ctrl.subpop, 
                                  levels = c("phone.owner", "non.phone.owner"), 
                                  labels = c("Phone Owners", "Non Phone Owners"))) %>% 
  ggplot() +
  geom_bar(aes(assigned.treatment.home), color = "black", alpha = 0.5) +
  labs(x = "Home Treatment", y = "") +
  ggtitle("Monitored SMS Control Sample Only Take-up") +
  facet_grid(county.randomization ~ sms.ctrl.subpop + dist.pot.group, scales = "free_y", margins = TRUE) +
  theme(legend.position = "bottom")
```

### SMS

```{r, echo=FALSE}
monitored.and.matched.data %>% 
  filter(!is.na(assigned.treatment.home), sms.treatment != "sms.control" | sms.ctrl.subpop == "phone.owner") %>% 
  ggplot() +
  geom_bar(aes(assigned.treatment.home, fill = sms.treatment), position = "dodge", color = "black", alpha = 0.5) +
  labs(x = "Home Treatment", y = "") +
  scale_fill_discrete("SMS Treatment") +
  ggtitle("Monitored Phone Owner Sample Only Take-up") +
  facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
  theme(legend.position = "bottom")
```

```{r, echo=FALSE}
monitored.and.matched.data %>% 
  filter(!is.na(assigned.treatment.home), sms.treatment == "sms.control") %>% 
  ggplot() +
  geom_bar(aes(assigned.treatment.home, fill = sms.ctrl.subpop), position = "dodge", color = "black", alpha = 0.5) +
  labs(x = "Home Treatment", y = "") +
  scale_fill_discrete("") +
  ggtitle("Monitored SMS Control Sample Only Take-up") +
  facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
  theme(legend.position = "bottom")
```

### Spillovers

```{r, echo=FALSE, fig.width=8, fig.height=10}
monitored.and.matched.data %>% {
    filter(., treatment.spillover) %>% {
        ggplot(.) +
          geom_bar(aes(assigned.treatment.pot, fill = assigned.treatment.home), color = "black", alpha = 0.5) +
          labs(x = "Destination Treatment", y = "", title = "Treatment Spillover Only") +
          scale_fill_discrete("Home Treatment") +
          facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
          theme(legend.position = "bottom")
    } %>% plot
    
    filter(., treatment.spillover) %>% {
        ggplot(.) +
          geom_bar(aes(assigned.treatment.home, fill = assigned.treatment.pot), color = "black", alpha = 0.5) +
          labs(x = "Home Treatment", y = "", title = "Treatment Spillover Only") +
          scale_fill_discrete("Destination Treatment") +
          facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
          theme(legend.position = "bottom")
    } %>% plot
  }
```


```{r, fig.width=10, eval=FALSE}
spillover.dist.data <- monitored.and.matched.data %>% 
  filter(treatment.spillover) %>% 
  distinct(cluster.id.home, cluster.id.pot, .keep_all = TRUE) 

pot.box <- make_bbox(lon.pot.home, lat.pot.home, data = spillover.dist.data)
    
ggmap(get_googlemap(center = home.center,
                                maptype = "terrain",
                                zoom = 10,
                                scale = 2,
                                key = config$google_api_key),
      base_layer = ggplot(aes(x = lon.pot.home, y = lat.pot.home), data = .data)) +
# coord_fixed(xlim = pot.box[c("left", "right")], ylim = pot.box[c("bottom", "top")]) +
  geom_segment(aes(x = lon.pot.home, y = lat.pot.home, xend = lon.pot.dest, yend = lat.pot.dest, color = dist.to.pot.dest/1000), lineend = "round") + #, alpha = 0.25) +
  geom_point(aes(lon.pot.home, lat.pot.home)) +
  geom_point(aes(lon.pot.dest, lat.pot.dest)) +
  scale_color_viridis("Distance to Destination (km)") +
  labs(x = "", y = "") +
  theme(legend.position = "bottom")
# facet_grid(dist.to.pot.dest.quant ~ 1, margins = TRUE)
```


```{r}
monitored.and.matched.data %>% 
  filter(treatment.spillover) %>% 
  mutate(spillover.type = paste(assigned.treatment.home, assigned.treatment.pot, sep = " to ")) %>% {
    # plot(ggplot(.) +
    #        geom_density(aes(dist.to.pot.dest)))
    # 
    # plot(ggplot(.) +
    #        geom_density(aes(dist.to.pot.dest, color = spillover.type)) +
    #        facet_wrap(~ assigned.treatment.home))
    
    plot(ggplot(.) +
           geom_boxplot(aes(assigned.treatment.home, dist.to.pot.dest/1000, color = assigned.treatment.pot)) +
           labs(x = "Home Treatment", y = "Distance to Destination (km)") +
           scale_color_discrete("Destination Treatment"))
           # facet_wrap(~ assigned.treatment.home))
  }
```

### Control ICC

Using data for only those who got dewormed in their "home" cluster:

```{r}
census.data %>% 
  filter(wave == 1, assigned.treatment == "control", endline.type %in% c("endline", "endline.backup", "reconsent")) %>%
  filter(endline.type %in% c("endline", "endline.backup", "reconsent")) %>% 
  left_join(monitored.and.matched.data, # matched.tu.data.2, 
            c("wave", 
              "county", 
              "cluster.id" = "cluster.id.home", 
              "assigned.treatment" = "assigned.treatment.home", 
              "endline.type", 
              "KEY.individ" = "any.matched.KEY.individ")) %>% 
  mutate(dewormed = 1*(!is.na(id.group))) %>% 
  lmer(dewormed ~ (1|cluster.id), data = .) %>% 
  summary
```

Using data for those who got dewormed anywhere:

```{r}
census.data %>% 
  filter(wave == 1, assigned.treatment == "control", endline.type %in% c("endline", "endline.backup", "reconsent")) %>% 
  left_join(monitored.and.matched.data, # matched.tu.data.2, 
              c("KEY.individ" = "any.matched.KEY.individ")) %>% 
  mutate(dewormed = 1*(!is.na(id.group))) %>% 
  lmer(dewormed ~ (1|cluster.id), data = .) %>% 
  summary
```


## All Identified

```{r, echo=FALSE, fig.width=8, fig.height=10}
matched.tu.data.2 %>%
  filter(!is.na(any.matched.KEY.individ)) %>% {
    (ggplot(.) +
      geom_bar(aes(assigned.treatment.pot, fill = treatment.spillover), color = "black", alpha = 0.5) +
      labs(x = "Destination Treatment", y = "") +
      ggtitle("All Identified") +
      scale_fill_discrete("Treatment Spillover") +
      facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
      theme(legend.position = "bottom")) %>% plot
    
    filter(., !is.na(assigned.treatment.home)) %>% {
      ggplot(.) +
        geom_bar(aes(assigned.treatment.home, fill = treatment.spillover), color = "black", alpha = 0.5) +
        labs(x = "Home Treatment", y = "") +
        ggtitle("All Identified") +
        scale_fill_discrete("Treatment Spillover") +
        facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
        theme(legend.position = "bottom") 
      } %>% plot
  }
```

### Spillovers

```{r, echo=FALSE, fig.width=8, fig.height=10}
matched.tu.data.2 %>%
  filter(!is.na(any.matched.KEY.individ)) %>% {
    filter(., treatment.spillover) %>% {
        ggplot(.) +
          geom_bar(aes(assigned.treatment.pot, fill = assigned.treatment.home), color = "black", alpha = 0.5) +
          labs(x = "", y = "", title = "Destination Treatment (Treatment Spillover Only)") +
          scale_fill_discrete("Home Treatment") +
          facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
          theme(legend.position = "bottom")
    } %>% plot
    
    filter(., treatment.spillover) %>% {
        ggplot(.) +
          geom_bar(aes(assigned.treatment.home, fill = assigned.treatment.pot), color = "black", alpha = 0.5) +
          labs(x = "Home Treatment", y = "", title = "Treatment Spillover Only") +
          scale_fill_discrete("Destination Treatment") +
          facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
          theme(legend.position = "bottom")
    } %>% plot
    
    # filter(., treatment.spillover) %>% {
    #   ggplot(.) +
    #     geom_point(aes(assigned.treatment.pot, assigned.treatment.home), position = "jitter", alpha = 0.5)
    # } %>% plot
  }
```

