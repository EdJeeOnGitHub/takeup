---
title: "Tables"
output: 
  pdf_document:
    keep_tex: yes
header-includes:
    - \usepackage{booktabs}
    - \usepackage{longtable}
    - \usepackage{array}
    - \usepackage{multirow}
    - \usepackage{wrapfig}
    - \usepackage{float}
    - \usepackage{colortbl}
    - \usepackage{pdflscape}
    - \usepackage{tabu}
    - \usepackage{threeparttable}
    - \usepackage{threeparttablex}
    - \usepackage[normalem]{ulem}
    - \usepackage[utf8]{inputenc}
    - \usepackage{makecell}
    - \usepackage{xcolor}
params:
    fit_version: 71
    input_path: data/stan_analysis_data
    output_path: temp-data 
    models: STRUCTURAL_LINEAR_U_SHOCKS
---



```{r, "startup", include=FALSE}
library(tidyverse)
library(broom)
library(knitr)
library(kableExtra)
library(ggthemes)
library(fixest)
library(magrittr)

if (interactive()) {
    params = lst(
        fit_version = 71,
        input_path = "data/stan_analysis_data",
        output_path = "temp-data",
        models = "STRUCTURAL_LINEAR_U_SHOCKS"
    )
    source(file.path("rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
    source(file.path("analysis_util.R"))
    source(file.path( "dist_structural_util.R"))
    source(file.path("multilvlr", "multilvlr_util.R"))
} else {
    source(file.path("rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
    source(file.path("analysis_util.R"))
    source(file.path( "dist_structural_util.R"))
    source(file.path("multilvlr", "multilvlr_util.R"))
    # source(file.path("..", "rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
    # source(file.path("..", "analysis_util.R"))
    # source(file.path("..", "dist_structural_util.R"))
}

options(
    dplyr.show_progress = FALSE, 
    digits = 4, 
    knitr.kable.NA = '')

knitr::opts_chunk$set(
    echo = FALSE, 
    cache = TRUE, 
    warnings = FALSE,
    warning = FALSE,
    cache.path = "takeup-table-cache/", fig.path = "takeup-table-fig-cache/", fig.align = "center")
```




```{r, "load_analysis_data"}

fit_version = params$fit_version

treat_levels_c = c("control", "ink", "calendar", "bracelet")
treat_levels = c("ink", "calendar", "bracelet")
dist_levels = c("close", "far")

quant_probs <- c(0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95, 0.99)

output_basepath = file.path(
  params$output_path,
  str_glue("output_dist_fit{params$fit_version}")
)


canva_palette_vibrant <- "Primary colors with a vibrant twist"

theme_set(theme_minimal() +
            theme(legend.position = "bottom"))

wgs.84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
kenya.proj4 <- "+proj=utm +zone=36 +south +ellps=clrk80 +units=m +no_defs"
if (interactive()) {
    rct.schools.data <- read_rds(file.path("data", "takeup_rct_schools.rds"))
    rct.cluster.selection <- read_rds(file.path("data", "rct_cluster_selection_2.0.rds"))
    cluster.strat.data <- read_rds(file.path("data", "takeup_processed_cluster_strat.rds"))
    load(file.path("data", "takeup_village_pot_dist.RData"))
    load(file.path("data", "analysis.RData"))
} else {
    rct.schools.data <- read_rds(file.path("data", "takeup_rct_schools.rds"))
    rct.cluster.selection <- read_rds(file.path("data", "rct_cluster_selection_2.0.rds"))
    cluster.strat.data <- read_rds(file.path("data", "takeup_processed_cluster_strat.rds"))
    load(file.path("data", "takeup_village_pot_dist.RData"))
    load(file.path("data", "analysis.RData"))
    # rct.schools.data <- read_rds(file.path("..", "data", "takeup_rct_schools.rds"))
    # rct.cluster.selection <- read_rds(file.path("..", "data", "rct_cluster_selection_2.0.rds"))
    # cluster.strat.data <- read_rds(file.path("..", "data", "takeup_processed_cluster_strat.rds"))
    # load(file.path("..", "data", "takeup_village_pot_dist.RData"))
    # load(file.path("..", "data", "analysis.RData"))
}


standardize <- as_mapper(~ (.) / sd(.))
unstandardize <- function(standardized, original) standardized * sd(original)

nosms_data <- analysis.data %>% 
  filter(sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

monitored_nosms_data <- analysis.data %>% 
  filter(mon_status == "monitored", sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

analysis_data <- monitored_nosms_data

```


```{r}

## Fit Loading
if (interactive()) {
    load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))
} else {
    load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))
    # load(file.path("..", "temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))
}

dist_fit_data %<>%
  left_join(tribble(
    ~ fit_type,        ~ model_color,
      "fit",           "black", 
      "prior-predict", "darkgrey",
  ), by = "fit_type") %>%
  filter(fct_match(fit_type, "fit"), fct_match(model, c("STRUCTURAL_LINEAR_U_SHOCKS", "REDUCED_FORM_NO_RESTRICT")))

delta <- function(v, ...) dnorm(v, ...) / ((pnorm(v, ...) * pnorm(v, ..., lower.tail = FALSE)))

belief_data = dist_fit_data %>%
  filter(fct_match(fit_type, "fit"), fct_match(model, c("STRUCTURAL_LINEAR_U_SHOCKS"))) %>%
  pull(beliefs_results) %>%
  first() 


cols_we_want = c(
    "est_takeup_level",
    "beliefs_results",
    "wtp_results",
    "est_takeup_te",
    "est_takeup_dist_te"
)
```


## Sample Info
```{r, sample_table}


stan_data = (dist_fit_data %>%
  filter(fct_match(model_type, "structural")) %>%
  select(stan_data) %>%
  pull())[[1]]



```




```{r}
#| balance-setup

# TODO: Do test within distance groups and overall
balance_variables = c(
"Pupil.Teacher.Ratio",
"Pupil.Classroom.Ratio",
"Pupil.Toilet.Ratio",
"Total.Number.of.Classrooms",
"Total.Enrolment", 
"GOK.TSC.Male",
"GOK.TSC.Female",
"Non.Teaching.Staff.Male",
"Non.Teaching.Staff.Female",
"cluster.dist.to.pot"
)

indiv_balance_vars = c(
  "female", 
  "phone_owner",
  "age"
)

rct_school_df = rct.schools.data %>% 
    as_tibble()


analysis_school_data = left_join(
    analysis_data,
    rct_school_df %>% mutate(cluster.id = as.numeric(cluster.id)) ,
    by = "cluster.id"
)


analysis_school_data = analysis_school_data %>%
mutate(
    treat_dist = paste0(
    "treat: ", 
    assigned.treatment,
    ", dist: ", dist.pot.group
    ) %>% factor()
)  %>%
mutate(
  female = fct_match(gender, "female")
)



indiv_balance_fit = analysis_school_data %>%
feols(
    data = ., 
    .[indiv_balance_vars] ~ 0 + treat_dist
    ) 

# Probably a better way to get the schools in the sample
school_treat_df = analysis_school_data %>%
  filter(!is.na(assigned.treatment)) %>%
  select(any_of(colnames(rct_school_df)), treat_dist, cluster.dist.to.pot) %>%
  unique()

school_balance_fit = school_treat_df %>%
  feols(
    data = ., 
    .[balance_variables] ~ 0 + treat_dist
  )


balance_fits = c(
  indiv_balance_fit,
  school_balance_fit
)


balance_tidy_df = balance_fits %>%
    map_dfr(tidy, .id = "lhs") %>%
    mutate(
        lhs = str_remove(lhs, "lhs: ")
    ) %>%
    select(
        lhs, term, estimate, std.error
    )   %>%
    mutate(
      lhs = str_replace_all(lhs, "\\.", " ") %>% str_to_title()
    )


# Number of dist groups x treatment
n_variables = 8
# matrix R for test 
hyp_matrix = cbind(
  matrix(-1, nrow = n_variables - 1, ncol = 1 ), 
  diag(x = 1, nrow = n_variables - 1, ncol = n_variables)[, 1:(n_variables - 1)]
)

zero_matrix = matrix(0, nrow = 3, ncol = n_variables - 1) 
part_hyp_matrix = zero_matrix
for (i in 1:3) {
  part_hyp_matrix[i, 2*i] = 1
}

hyp_matrix_close = cbind(
  matrix(-1, nrow = 3, ncol = 1), 
  part_hyp_matrix
)

hyp_matrix_far = cbind(
  matrix(0, nrow = 3, ncol = 1),
  matrix(-1, nrow = 3, ncol = 1), 
  part_hyp_matrix[, 1:(ncol(part_hyp_matrix) - 1)]
)




joint_signif_fstats = map_dbl(
  balance_fits,
  ~car::linearHypothesis(.x, hyp_matrix)$"Pr(>Chisq)"[2]
) %>% round(4)

close_joint_signif_fstats = map_dbl(
  balance_fits,
  ~car::linearHypothesis(.x, hyp_matrix_close)$"Pr(>Chisq)"[2]
)

far_joint_signif_fstats = map_dbl(
  balance_fits,
  ~car::linearHypothesis(.x, hyp_matrix_far)$"Pr(>Chisq)"[2]
)

col_order = c(
  "lhs", 
  paste0(treat_levels_c, "_close"),
  "close_joint_p",
  paste0(treat_levels_c, "_far"),
  "far_joint_p",
  "joint_p"
)

create_balance_input = function(tidy_df, col_order, digits = 3) {
bal_input_df = tidy_df %>%
    mutate(
    estimate = round(estimate, digits),
    std.error = round(std.error, digits)
    ) %>%
    mutate(
    estim_std = linebreak(paste0(estimate, "\n", str_glue("({std.error})")), align = "c") 
    )  %>%
    mutate(lhs_treat = str_extract(term, "(?<=disttreat: ).*(?=\\,)")) %>%
    mutate(lhs_dist = str_extract(term, "(?<=dist: ).*$")) %>%
    select(lhs, lhs_treat, lhs_dist, estim_std) %>%
    mutate(
    lhs_treat = factor(lhs_treat, treat_levels_c) %>% fct_rev(), 
    lhs_dist = factor(lhs_dist, dist_levels) %>% fct_rev()
    ) %>%
    pivot_wider(
    names_from = c(lhs_treat, lhs_dist),
    values_from = estim_std, 
    )    %>%
    select(
    any_of(col_order)
    )  %>%
    mutate(
        lhs = str_to_title(lhs),
        lhs = str_replace_all(lhs, "_", " ")
    )
return(bal_input_df)
}


N_beliefs_obs_df = analysis_school_data[stan_data$beliefs_obs_index, ] %>%
  group_by(
    treat_dist
  ) %>%
  summarise(
    N_indiv = n_distinct(KEY.individ),
    N_pot = n_distinct(cluster.id)
  )  




stratum_map = analysis.data %>% 
  mutate(stratum = county) %>%
  mutate(stratum_id = as.integer(stratum)) %>% 
  distinct(stratum_id, stratum)

incentive_choice_data <- analysis.data %>%
  filter(!is.na(gift_choice) & gift_choice != "neither",
          assigned.treatment == "control",
          sms.treatment.2 == "sms.control") %>%
  # select(county, cluster.id, gift_choice, phone_owner) %>%
  mutate(offer = 0,
          response = "keep")

incentive_choice_data <- wtp.data %>%
  semi_join(analysis.data, "cluster.id") %>% # Make sure we have the same clusters
  filter(!is.na(first_choice)) %>%
  transmute(county, cluster.id,
            gift_choice = first_choice,
            offer = price,
            response = second_choice) %>%
  bind_rows(incentive_choice_data) %>%
  left_join(stratum_map, c("county" = "stratum")) %>%
  mutate(gift_choice = 2 * (gift_choice == "calendar") - 1,
          response = 2 * (response == "switch") - 1) 


N_wtp_obs_df = analysis_school_data %>%
  filter(KEY.individ %in% incentive_choice_data$KEY.individ) %>%
  filter(!is.na(KEY.individ)) %>%
  group_by(
    treat_dist
  ) %>%
  summarise(
    N_indiv = n_distinct(KEY.individ),
    N_pot = n_distinct(cluster.id)
  )  %>%
  mutate(type = "WTP")




N_by_treat_dist_df = analysis_school_data %>%
  group_by(
    treat_dist
  ) %>%
  summarise(
    N_indiv = n_distinct(KEY.individ),
    N_pot = n_distinct(cluster.id)
  )  %>% 
  mutate(type = "takeup") %>%
  bind_rows(
    N_beliefs_obs_df %>% mutate(type = "beliefs"), 
    N_wtp_obs_df
  ) %>%
  mutate(
    treatment = str_extract(treat_dist, "(?<=treat: ).*(?=\\,)"), 
    distance = str_extract(treat_dist, "(?<=dist: ).*$")
  ) %>%
  select(-treat_dist)  %>%
  pivot_longer(
    cols = c(N_indiv, N_pot), names_to = "lhs"
  ) %>%
  pivot_wider(
    names_from = c(treatment, distance),
    values_from = value
  ) 







wide_indiv_bal_df = create_balance_input(
    balance_tidy_df, 
    col_order = col_order, 
    digits = 3
)  %>%
  mutate(
    close_joint_p = close_joint_signif_fstats,
    far_joint_p = far_joint_signif_fstats,
    joint_p = joint_signif_fstats
  ) %>%
  select(all_of(col_order))  %>%
  bind_rows(
    N_by_treat_dist_df %>%
      mutate(
        lhs = str_replace_all(lhs, "_", " ") %>% 
          str_to_title()
      ) %>%
      mutate(across(where(is.numeric), as.character)) %>%
      mutate(across(where(is.numeric), replace_na, "-")) 
  ) %>%
  select(-type) %>%
  mutate(across(where(is.character), ~if_else(.x == "", "-", .x))) %>%
  mutate(across(where(is.character), replace_na, "-")) %>%
  mutate(
    lhs = case_when(
      lhs == "N Indiv" ~ "N Individuals", 
      lhs == "N Pot" ~ "N Points of Treatment",
      lhs == "Cluster Dist To Pot" ~ "Cluster Distance to PoT",
      TRUE ~ lhs
    )
  )




```





## Balance

```{r, results="asis"}
#| balance-table,
#| dependson="balance-setup"

# TODO: add tests for imbalance
treat_colnames = str_to_title(treat_levels_c)
wide_indiv_bal_df %>% 
knitr::kable(
    format = "latex",
    escape = FALSE, 
    col.names = c("", treat_colnames, "F-test $p$-value", treat_colnames, "F-test $p$-value", "Joint F-test $p$-value"), 
    booktabs = TRUE, 
    caption = "Balance Table", 
    align = "lccccccccccc"
) %>%
kable_styling(
    latex_options = c("scale_down")
) %>%
add_header_above(c("", "Close" = 5, "Far" = 5, "")) %>%
footnote(general = "Insert footnote here.") %>%
  pack_rows(
    index = c(
      "Individual-level Covariates" = 3, 
      "Point of Treatment Covariates" = 10, 
      "Takeup Sample" = 2,
      "Belief Sample" = 2,
      "WTP Sample" = 2
    ), 
    # latex_gap_space = latex_group_gap_space, 
    hline_after = TRUE, 
    # hline_before = TRUE,
    bold = TRUE
  ) 

```


WTP obs in "stan_data" is 998 but when I count indivs I get 458. Think it's a 
coding error.

```{r, sample_n, results="asis"}

sample_meta_df = N_by_treat_dist_df %>%
  gather(variable, value, -type, -lhs) %>%
  group_by(
    type, lhs
  ) %>%
  summarise(
    n = sum(value, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  spread(lhs, n) %>%
  mutate(
    sample = case_when(
      type == "beliefs" ~ "Beliefs", 
      type == "takeup" ~ "Takeup", 
      type == "WTP" ~ "WTP"
    )
  ) %>%
  select(-type) %>%
  select(sample, everything())



sample_meta_tbl = sample_meta_df %>%
    kbl(
        booktabs = TRUE, 
        format = "latex", 
        caption = "Sample Size Across Experiments", 
        align = "lcc",
        col.names = c("Experiment", "N Individuals", "N PoTs")
    )  %>%
    kable_styling()
sample_meta_tbl

```



```{r, res_table}



incentive_te = dist_fit_data %>%
  mutate(
    est_takeup_te =
      map_if(est_takeup_te, fct_match(model_type, "structural"),
             filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right) %>%
        map(filter,
            (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
            assigned_treatment_left != assigned_treatment_right,
            fct_match(assigned_treatment_right, c("control")),
            fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar")),
    model_color = canva_pal(canva_palette_vibrant)(n())
  ) %>% 
  select(model, model_type, model_name, est_takeup_te, fit_type, model_color) %>% 
  mutate(
    est_takeup_te = map(
      est_takeup_te,
      mutate,
      assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
        fct_relabel(str_to_title) %>% 
        fct_relevel("Combined"),
      assigned_treatment_left = str_to_title(assigned_treatment_left)
    )) %>%
    unnest(est_takeup_te)  %>%
    select( 
      model_type,
      assigned_treatment = assigned_treatment_left, 
      assigned_dist = assigned_dist_group_left,
      mean_est, 
      per_0.05, 
      per_0.95
    )



signalling_te = dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  select(model, model_type, model_name, est_takeup_te, fit_type) %>% 
  mutate(
    est_takeup_te = map(
      est_takeup_te,
      filter,
      (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
      across(c(assigned_treatment_left, assigned_treatment_right), fct_match, "control"),
      !is.na(mu_assigned_treatment_left),
      fct_match(mu_assigned_treatment_left, "bracelet") | !fct_match(mu_assigned_treatment_right, "calendar"),
      fct_match(mu_assigned_treatment_right, "control"),
    ) %>% 
      map(
        mutate,
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        mu_assigned_treatment_left = str_to_title(mu_assigned_treatment_left),
      ),
    model_color = canva_pal(canva_palette_vibrant)(n())) %>%
    unnest(est_takeup_te)  %>%
    select(
      assigned_treatment = mu_assigned_treatment_left, 
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est,
      per_0.05,
      per_0.95
    )




private_te = dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  select(model, model_type, model_name, est_takeup_te, fit_type) %>% 
  mutate(
    est_takeup_te = map(
      est_takeup_te,
      filter,
      (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
      !is.na(mu_assigned_treatment_left),
      !is.na(mu_assigned_treatment_right),
      across(c(mu_assigned_treatment_left, mu_assigned_treatment_right), fct_match, "control"),
      fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"),
      fct_match(assigned_treatment_right, "control"),
    ) %>% 
      map(
        mutate,
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = str_to_title(assigned_treatment_left),
      ),
    model_color = canva_pal(canva_palette_vibrant)(n())) %>%
    unnest(est_takeup_te) %>%
    select(
      assigned_treatment = assigned_treatment_left,
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est, 
      per_0.05, 
      per_0.95
    )

## Differences Between Bracelet and Calendar
incentive_bracelet_calendar_diff_df = dist_fit_data %>%
  filter(
    fct_match(fit_type, "fit"), 
    # fct_match(model, "STRUCTURAL_LINEAR_U_SHOCKS")
    ) %>%
    select(fit_type, model_type, est_takeup_te_diff) %>%
    unnest(est_takeup_te_diff) %>%
    filter(
      (assigned_dist_group_left == assigned_dist_group_right) | (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)), # same dist group
      model_type == "reduced form" | (model_type == "structural" & (mu_assigned_treatment_left == assigned_treatment_left)), # same mu and B
      model_type == "reduced form" | (model_type == "structural" & (mu_assigned_treatment_right == assigned_treatment_right)), # same mu and B
      fct_match(assigned_treatment_right, "calendar"), 
      fct_match(assigned_treatment_left, "bracelet")
    )  %>%
    mutate(
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = str_to_title(assigned_treatment_left),
      ) %>%
    select(
      assigned_treatment = assigned_treatment_left,
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est, 
      per_0.05, 
      per_0.95
    ) %>%
    mutate(
      assigned_treatment = "\\textit{Bracelet - Calendar}"
    )

signal_bracelet_calendar_diff_df = dist_fit_data %>%
  select(model_type, fit_type, est_takeup_te) %>%
  filter(model_type == "structural") %>%
  unnest(est_takeup_te)  %>%
  filter(
    (assigned_dist_group_left == assigned_dist_group_right) | (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)), # same dist group
    (assigned_treatment_left == assigned_treatment_right), # same B on LHS and RHS
    (mu_assigned_treatment_left == "bracelet" & mu_assigned_treatment_right == "calendar"), 
    assigned_treatment_left == "control" 
) %>%
    mutate(
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = str_to_title(assigned_treatment_left),
      ) %>%
    select(
      assigned_treatment = assigned_treatment_left,
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est, 
      per_0.05, 
      per_0.95
    ) %>%
    mutate(
      assigned_treatment = "\\textit{Bracelet - Calendar}"
    )


te_df = bind_rows(
  incentive_te %>% mutate(estimand = "incentive"),
  incentive_bracelet_calendar_diff_df %>% mutate(estimand = "incentive"),
  private_te %>% mutate(estimand = "private"),
  signalling_te %>% mutate(estimand = "signal"),
  signal_bracelet_calendar_diff_df %>% mutate(estimand = "signal"),
)

rf_te_input_df = te_df %>%
  filter(model_type == "reduced form") %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  mutate(
    estim_value = linebreak(
      paste0(mean_est, "\n", "(", per_0.05, ", ", per_0.95, ")"), 
      align = "c"
      )
  ) %>%
  select(
    model_type, 
    assigned_treatment, 
    assigned_dist, 
    estim_value, 
    estimand
  ) %>%
  pivot_wider(
    names_from = assigned_dist, 
    values_from = estim_value
  )  %>%
  rename(
    rf_Close = Close, 
    rf_Far = Far, 
    rf_Combined = Combined
  )

structural_te_input_df = te_df %>%
  filter(model_type == "structural") %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  mutate(
    estim_value = linebreak(
      paste0(mean_est, "\n", "(", per_0.05, ", ", per_0.95, ")"), 
      align = "c"
      )
  ) %>%
  select(
    model_type, 
    assigned_treatment, 
    assigned_dist, 
    estim_value, 
    estimand
  ) %>%
  pivot_wider(
    id_cols = c(assigned_treatment, estimand),
    names_from = assigned_dist, 
    values_from = estim_value
  )  %>%
  mutate(across(
    c(Close, Far), 
    ~if_else(
      estimand == "private", 
      NA_character_, 
      .x
    )
  ))


te_input_df = left_join(
  structural_te_input_df,
  rf_te_input_df,
  by = c("estimand", "assigned_treatment")
)  %>%
  select(-model_type) %>%
  select(
    Estimand = estimand, 
    Treatment = assigned_treatment, 
    everything()
  ) %>%
  mutate(across(c(contains("rf_"), Close, Far), replace_na, "-")) %>%
  mutate(Estimand = factor(Estimand, levels = c("incentive", "signal", "private", ""))) %>%
  arrange(Estimand)



latex_group_gap_space = "2em"

te_kbl_df = te_input_df %>%
  mutate(
    Estimand = if_else(
      Treatment == "Ink", 
      Estimand, 
      factor("")
    )
  ) %>%
  select(-Estimand) %>%
  kbl(
    col.names = c(
      # "Estimand", 
      # "Treatment", 
      "",
      paste0("(", 1:6, ")")
    ), 
    format = "latex", 
    booktabs = TRUE, 
    escape = FALSE, 
    align = "lcccccc", 
    caption = "Results"
  ) %>%
  kable_styling(
    latex_options = c("scale_down")
  ) %>%
  add_header_above(
    c(" ", 
      "Close", 
      "Far", 
      "Combined", 
      "Close", 
      "Far",
      "Combined"), 
    line = FALSE
  ) %>%
  add_header_above(
    c(
      " " = 1,
      "Structural" = 3, 
      "Reduced Form" = 3
      )
  ) %>%
  pack_rows(
    index = c(
      "Overall" = 4, 
      "Signalling" = 4, 
      "Private" = 3
    ), 
    # latex_gap_space = latex_group_gap_space, 
    hline_after = TRUE, 
    # hline_before = TRUE,
    bold = TRUE
  ) %>%
  add_indent(c(4, 8)) %>%
  footnote(
    escape = FALSE,
    threeparttable = TRUE,
    general = 
        str_glue(
            "Point estimates represent posterior means, 90\\\\% percent credibility intervals are shown in parentheses.
            'Overall' indicates the total treatment effect; 'Signalling' and 'Private' use the structural model to 
            isolate the effect of reputational returns and the private utility derived from each treatment. 
            \\\\textit{{Bracelet - Calendar}} shows the posterior difference in takeup across bracelet and calendar conditions.
            Structural estimates use all three samples: {stan_data$num_obs} individuals' deworming status; {stan_data$num_beliefs_obs} individual's elicited first-order beliefs; and 
            data from {stan_data$num_wtp_obs} individual's Willingness-To-Pay choices.
            "
        ) 
  )


te_kbl_df %>%
  save_kable(
    file.path(
      params$output_path,
      "te-table.tex"
    )
  )

```


```{r, results="asis"}
x = 2 + 5
te_kbl_df 

```



```{r, eval = FALSE}

load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}.RData")))

colnames(dist_fit_data)
dist_fit_data %>%
  select(fit_type, model_type, est_takeup_te_diff) %>%
  unnest() %>%
  colnames()

dist_fit_data %>%
  filter(model_type == "structural") %>%
  mutate(across(where(is_list), map_if, ~ is_tibble(.x) && has_name(.x, "iter_data"), ~ NULL))



# we hate RData
dist_fit_full = new.env()
load(file.path("temp-date", str_interp("processed_dist_fit${fit_version}.RData")), envir = dist_fit_full)
    

with_env = function(f, e = parent.frame()) {
    stopifnot(is.function(f))
    environment(f) = e
    f
}

clean_micro = function(){
    site <- c(attanasio_indicator, augsberg_indicator,banerjee_indicator, crepon_indicator)-1
    consumerdurables <- c(attanasio_consumerdurables, augsberg_consumerdurables,banerjee_consumerdurables, crepon_consumerdurables)
    treatment <- c(attanasio_treatment, augsberg_treatment,banerjee_treatment, crepon_treatment)
    priorbiz <- c(attanasio_existingbusiness, augsberg_existingbusiness, banerjee_existingbusiness, crepon_existingbusiness)
    # Now we have to standardise any variables which are in local currency units to USD PPP per fortnight in 2009 dollars


    expanded_standardiser_USD_PPP_per_fortnight <- c(
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[1],length(attanasio_indicator)),
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[2],length(augsberg_indicator)),
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[3],length(banerjee_indicator)),
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[4],length(crepon_indicator)))

    consumerdurables <- consumerdurables*expanded_standardiser_USD_PPP_per_fortnight

    # bind everything into a data frame
    data <- data.frame(site, consumerdurables, treatment, priorbiz)

    site_df = 
        tibble(
            site_id = map_dbl(
                list(attanasio_indicator, 
                    augsberg_indicator,
                    banerjee_indicator, 
                    crepon_indicator), 
                ~unique(.x - 1)), 
            study_name = c("attanasio", "augsberg", "banerjee", "crepon")
        )
    # We gotta remove the NA values
    data <- data[complete.cases(data),] %>%
        as_tibble() %>%
        left_join(., site_df, by = c("site" = "site_id"))
    return(data)
}


consumer_durable_data = with_env(clean_micro, microcredit_env)()


```



```{r}
#| beliefs


belief_data = dist_fit_data %>%
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  pull(beliefs_results) %>%
  first() 

belief_close_far_input_df = belief_data$ate_knows %>%
  filter(assigned_treatment_left != "control") %>%
  filter(assigned_treatment_right == "control") %>%
  mutate(assigned_treatment_left = fct_drop(assigned_treatment_left))  %>%
  filter(assigned_dist_group_right == assigned_dist_group_left) %>%
  mutate(treatment = fct_relabel(assigned_treatment_left, str_to_title))  %>%
  select(
    treatment, 
    distance = assigned_dist_group_right, 
    estimate = per_0.5, 
    conf.low = per_0.05, 
    conf.high = per_0.95, 
    order = ord
  )


#### Belief ATEs combined ####
belief_data_control = belief_data$prob_knows %>%
    filter(assigned_treatment == "control")  %>%
    select(assigned_treatment, assigned_dist_group, iter_data, ord) %>%
    unnest(iter_data)

combined_belief_ate = belief_data$prob_knows %>%
    filter(assigned_treatment != "control") %>%
    select(assigned_treatment, iter_data, ord) %>%
    unnest(iter_data) %>%
    rename(assigned_treatment_left = assigned_treatment) %>%
    left_join(
        belief_data_control %>% 
            rename(assigned_treatment_right = assigned_treatment) %>%
            select(iter_est_right = iter_est, iter_id, ord, assigned_treatment_right),
        by = c("iter_id", "ord")
    ) %>%
    mutate(
        iter_est_te = iter_est - iter_est_right
    )  %>%
    select(-.chain, -.iteration, -.draw) %>%
    nest(iter_data = c(iter_id, iter_est_te, iter_est, iter_est_right)) %>%
    mutate(
        mean_est = map_dbl(iter_data, ~mean(.x$iter_est_te)), 
        quants = map(iter_data, quantilize_est, iter_est_te, quant_probs = quant_probs, na.rm = TRUE)
    )  %>%
    unnest(quants) %>%
    mutate(assigned_dist_group_left = "Combined", assigned_dist_group_right = "Combined") %>%
    mutate(
        assigned_treatment_left = fct_drop(assigned_treatment_left), 
        assigned_treatment_right = fct_drop(assigned_treatment_right)
    )  %>%
    mutate(treatment = fct_relabel(assigned_treatment_left, str_to_title))  %>%
    select( 
      treatment = treatment, 
      distance = assigned_dist_group_right, 
      estimate = per_0.5, 
      conf.low = per_0.05,
      conf.high = per_0.95,
      order = ord
    )


belief_input_df = bind_rows(
  belief_close_far_input_df,
  combined_belief_ate
) %>% 
  mutate(distance = str_to_title(distance))

wide_belief_input_df = belief_input_df %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  mutate(
    estim_value = linebreak(
      paste0(estimate, "\n", "(", conf.low, ", ", conf.high, ")"), 
      align = "c"
      )
  ) %>%
  select(treatment, distance, order, estim_value) %>%
  pivot_wider(
    names_from = c(distance, order), 
    values_from = estim_value
  ) %>%
  select( 
    treatment, 
    contains("_1"), 
    contains("_2")
  )


wide_belief_input_df %>%
  kbl(
    col.names = c(
      # "Estimand", 
      # "Treatment", 
      "",
      paste0("(", 1:6, ")")
    ), 
    format = "latex", 
    booktabs = TRUE, 
    escape = FALSE, 
    align = "lcccccc", 
    caption = "Beliefs Results"
  ) %>%
  kable_styling(
    latex_options = c("scale_down")
  ) %>%
  add_header_above(
    c(" ", 
      "Close", 
      "Far", 
      "Combined", 
      "Close", 
      "Far", 
      "Combined"
      ), 
    line = FALSE
  )  %>%
  add_header_above(
    c(
      " " = 1,
      "First-Order Beliefs" = 3, 
      "Second-Order Beliefs" = 3
      )
  ) %>%
  footnote(
    escape = FALSE,
    threeparttable = TRUE,
    general = 
        str_glue(
            "Point estimates represent posterior means, 90\\\\% percent credibility intervals are shown in parentheses.
            {stan_data$num_beliefs_obs} individual's elicited first-order beliefs.
            "
        ) 
  )


```



```{r}
#| disagg-beliefs


cv = function(alpha){
  qnorm(1 - (alpha/2))
}

disagg_base_belief_data = analysis_data %>%
  mutate(assigned_treatment = assigned.treatment, assigned_dist_group = dist.pot.group) %>%
  nest_join(
    endline.know.table.data %>% 
      filter(fct_match(know.table.type, "table.A")),
    by = "KEY.individ", 
    name = "knowledge_data"
  ) %>% 
  mutate(
    map_dfr(knowledge_data, ~ {
      tibble(
        obs_know_person = sum(.x$num.recognized),
        obs_know_person_prop = mean(.x$num.recognized),
        knows_other_dewormed = sum(fct_match(.x$dewormed, c("yes", "no")), na.rm = TRUE),
        knows_other_dewormed_yes = sum(fct_match(.x$dewormed, "yes"), na.rm = TRUE),
        knows_other_dewormed_no = sum(fct_match(.x$dewormed, "no"), na.rm = TRUE),
        thinks_other_knows = sum(fct_match(.x$second.order, c("yes", "no")), na.rm = TRUE),
        thinks_other_knows_yes = sum(fct_match(.x$second.order, "yes"), na.rm = TRUE),
        thinks_other_knows_no = sum(fct_match(.x$second.order, "no"), na.rm = TRUE),
      )
    }
  )) %>%
    filter(obs_know_person > 0)  %>%
    select(KEY.individ, contains("know"), assigned.treatment, dist.pot.group, assigned_dist_group) %>%
    mutate(
        doesnt_know_other_dewormed = obs_know_person - knows_other_dewormed, 
        doesnt_think_other_knows = obs_know_person - thinks_other_knows
    ) %>% 
    select(KEY.individ, 
           assigned.treatment,
           assigned_dist_group,
           obs_know_person,
           knows_other_dewormed_yes,
           knows_other_dewormed_no,
           doesnt_know_other_dewormed, 
           thinks_other_knows_yes, 
           thinks_other_knows_no, 
           doesnt_think_other_knows
           ) %>%
    gather(variable, value, 
        knows_other_dewormed_yes:doesnt_think_other_knows)   %>%
    mutate(knowledge_type = case_when(
        str_detect(variable, "_yes") ~ "yes",
        str_detect(variable, "_no") ~ "no",
        str_detect(variable, "doesnt") ~ "doesn't know"
    )) %>%
    mutate(belief_type = if_else(str_detect(variable, "think"), "2ord", "1ord")) %>%
    mutate(prop = value/obs_know_person) 

close_far_disagg_belief = disagg_base_belief_data  %>%
    group_by(assigned.treatment, assigned_dist_group, knowledge_type, belief_type)  %>%
    summarise(
        mean_est = mean(prop), 
        std.error = sd(prop)/sqrt(n()),
        per_0.5 = mean(prop), 
        per_0.05 = per_0.5 - cv(0.05)*std.error, 
        per_0.95 = per_0.5 + cv(0.05)*std.error,
        per_0.1 =  per_0.5 - cv(0.1)*std.error,
        per_0.9 =  per_0.5 + cv(0.1)*std.error,
        per_0.25 =  per_0.5 - cv(0.5)*std.error,
        per_0.75 =  per_0.5 + cv(0.5)*std.error
    ) %>%
    mutate(
      knowledge_type = factor(knowledge_type, levels = c("yes", "no", "doesn't know")), 
      knowledge_type = fct_relabel(knowledge_type, str_to_title) %>% fct_rev
    ) %>%
    mutate(
      assigned.treatment = factor(assigned.treatment, 
                                  levels = c("bracelet",
                                             "calendar", 
                                             "ink",
                                             "control")) %>%
                          fct_relabel(str_to_title) %>%
                          fct_rev
    )


combined_disagg_belief = disagg_base_belief_data  %>%
    group_by(assigned.treatment, knowledge_type, belief_type)  %>%
    summarise(
        mean_est = mean(prop), 
        std.error = sd(prop)/sqrt(n()),
        per_0.5 = mean(prop), 
        per_0.05 = per_0.5 - cv(0.05)*std.error, 
        per_0.95 = per_0.5 + cv(0.05)*std.error,
        per_0.1 =  per_0.5 - cv(0.1)*std.error,
        per_0.9 =  per_0.5 + cv(0.1)*std.error,
        per_0.25 =  per_0.5 - cv(0.5)*std.error,
        per_0.75 =  per_0.5 + cv(0.5)*std.error
    ) %>%
    mutate(
      knowledge_type = factor(knowledge_type, levels = c("yes", "no", "doesn't know")), 
      knowledge_type = fct_relabel(knowledge_type, str_to_title) %>% fct_rev
    ) %>%
    mutate(
      assigned.treatment = factor(assigned.treatment, 
                                  levels = c("bracelet",
                                             "calendar", 
                                             "ink",
                                             "control")) %>%
                          fct_relabel(str_to_title) %>%
                          fct_rev
    ) %>%
    mutate(
      assigned_dist_group = "Combined"
    )


comp_belief_data = bind_rows(
  close_far_disagg_belief,
  combined_disagg_belief
)




```


```{r}


wide_disagg_belief_input_df = comp_belief_data %>%
  select(
    treatment = assigned.treatment, 
    distance = assigned_dist_group, 
    knowledge_type,
    mean_est, 
    per_0.05, 
    per_0.95, 
    ord = belief_type
  )  %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  mutate(
    estim_value = linebreak(
      paste0(mean_est, "\n", "(", per_0.05, ", ", per_0.95, ")"), 
      align = "c"
      )
  ) %>%
  select( 
    treatment,
    distance, 
    knowledge_type, 
    ord, 
    estim_value
  ) %>%
  mutate(ord = factor(ord, levels = c("1ord", "2ord"))) %>%
  pivot_wider(
    names_from = c(ord, distance), 
    values_from = estim_value
  ) %>%
  select(
    treatment, knowledge_type, 
    contains("1ord"), 
    contains("2ord")
  )



wide_disagg_belief_input_df %>%
  ungroup() %>%
  select(-treatment) %>%
  kbl(
    col.names = c(
      # "Estimand", 
      # "Treatment", 
      "Knowledge",
      paste0("(", 1:6, ")")
    ), 
    # format = "latex", 
    booktabs = TRUE, 
    escape = FALSE, 
    align = "lcccccc", 
    caption = "Beliefs Results"
  ) %>%
  kable_styling(
    latex_options = c("scale_down")
  ) %>%
  add_header_above(
    c(" ", 
      "Close", 
      "Far", 
      "Combined", 
      "Close", 
      "Far", 
      "Combined"
      ), 
    line = FALSE
  )  %>%
  add_header_above(
    c(
      " " = 1,
      "First-Order Beliefs" = 3, 
      "Second-Order Beliefs" = 3
      )
  ) %>%
  group_rows(
    index = c(
      "Control" = 3,
      "Ink" = 3,
      "Calendar" = 3,
      "Bracelet" = 3
    ), 
    hline_after = TRUE,
    hline_before = TRUE
  ) %>%
  footnote(
    escape = FALSE,
    threeparttable = TRUE,
    general = 
        str_glue(
            "Point estimates represent posterior means, 90\\\\% percent credibility intervals are shown in parentheses.
            {stan_data$num_beliefs_obs} individual's elicited first-order beliefs.
            "
        ) 
  )





```
