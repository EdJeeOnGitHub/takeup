---
title: "Tables"
output: 
  pdf_document:
    keep_tex: yes
header-includes:
    - \usepackage{booktabs}
    - \usepackage{longtable}
    - \usepackage{array}
    - \usepackage{multirow}
    - \usepackage{wrapfig}
    - \usepackage{float}
    - \usepackage{colortbl}
    - \usepackage{pdflscape}
    - \usepackage{tabu}
    - \usepackage{threeparttable}
    - \usepackage{threeparttablex}
    - \usepackage[normalem]{ulem}
    - \usepackage[utf8]{inputenc}
    - \usepackage{makecell}
    - \usepackage{xcolor}
params:
    fit_version: 71
    input_path: data/stan_analysis_data
    output_path: temp-data 
    models: STRUCTURAL_LINEAR_U_SHOCKS
---



```{r, "startup", include=FALSE}
library(tidyverse)
library(broom)
library(knitr)
library(kableExtra)
library(ggthemes)
library(fixest)

if (interactive()) {
    params = lst(
        fit_version = 71,
        input_path = "data/stan_analysis_data",
        output_path = "temp-data",
        models = "STRUCTURAL_LINEAR_U_SHOCKS"
    )
    source(file.path("rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
    source(file.path("analysis_util.R"))
    source(file.path( "dist_structural_util.R"))
    source(file.path("multilvlr", "multilvlr_util.R"))
} else {
    source(file.path("rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
    source(file.path("analysis_util.R"))
    source(file.path( "dist_structural_util.R"))
    source(file.path("multilvlr", "multilvlr_util.R"))
    # source(file.path("..", "rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
    # source(file.path("..", "analysis_util.R"))
    # source(file.path("..", "dist_structural_util.R"))
}

options(
    dplyr.show_progress = FALSE, 
    digits = 4, 
    knitr.kable.NA = '')

knitr::opts_chunk$set(
    echo = FALSE, 
    cache = TRUE, 
    cache.path = "takeup-cache/", fig.path = "takeup-fig-cache/", fig.align = "center")
```




```{r, "load_analysis_data"}

fit_version = params$fit_version

treat_levels_c = c("control", "ink", "calendar", "bracelet")
treat_levels = c("ink", "calendar", "bracelet")
dist_levels = c("close", "far")

quant_probs <- c(0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95, 0.99)

output_basepath = file.path(
  params$output_path,
  str_glue("output_dist_fit{params$fit_version}")
)


canva_palette_vibrant <- "Primary colors with a vibrant twist"

theme_set(theme_minimal() +
            theme(legend.position = "bottom"))

wgs.84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
kenya.proj4 <- "+proj=utm +zone=36 +south +ellps=clrk80 +units=m +no_defs"
if (interactive()) {
    rct.schools.data <- read_rds(file.path("data", "takeup_rct_schools.rds"))
    rct.cluster.selection <- read_rds(file.path("data", "rct_cluster_selection_2.0.rds"))
    cluster.strat.data <- read_rds(file.path("data", "takeup_processed_cluster_strat.rds"))
    load(file.path("data", "takeup_village_pot_dist.RData"))
    load(file.path("data", "analysis.RData"))
} else {
    rct.schools.data <- read_rds(file.path("data", "takeup_rct_schools.rds"))
    rct.cluster.selection <- read_rds(file.path("data", "rct_cluster_selection_2.0.rds"))
    cluster.strat.data <- read_rds(file.path("data", "takeup_processed_cluster_strat.rds"))
    load(file.path("data", "takeup_village_pot_dist.RData"))
    load(file.path("data", "analysis.RData"))
    # rct.schools.data <- read_rds(file.path("..", "data", "takeup_rct_schools.rds"))
    # rct.cluster.selection <- read_rds(file.path("..", "data", "rct_cluster_selection_2.0.rds"))
    # cluster.strat.data <- read_rds(file.path("..", "data", "takeup_processed_cluster_strat.rds"))
    # load(file.path("..", "data", "takeup_village_pot_dist.RData"))
    # load(file.path("..", "data", "analysis.RData"))
}


standardize <- as_mapper(~ (.) / sd(.))
unstandardize <- function(standardized, original) standardized * sd(original)

nosms_data <- analysis.data %>% 
  filter(sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

monitored_nosms_data <- analysis.data %>% 
  filter(mon_status == "monitored", sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

analysis_data <- monitored_nosms_data

```





```{r}

balance_variables = c(
"age",
"ethnicity",
"phone_owner", 
"Pupil.Teacher.Ratio",
"Pupil.Classroom.Ratio",
"Pupil.Toilet.Ratio",
"Total.Number.of.Classrooms",
"Total.Toilets",
"Total.Boys",
"Total.Girls",
"Total.Enrolment", 
"GOK.TSC.Male",
"GOK.TSC.Female",
"Non.Teaching.Staff.Male",
"Non.Teaching.Staff.Female",
"Local.Authority.Male",
"Local.Authority.Female",
"phone",
"gender"
)

rct_school_df = rct.schools.data %>% 
    as_tibble()


analysis_school_data = left_join(
    analysis_data,
    rct_school_df %>% mutate(cluster.id = as.numeric(cluster.id)) ,
    by = "cluster.id"
)







analysis_school_data = analysis_school_data %>%
mutate(
    treat_dist = paste0(
    "treat: ", 
    assigned.treatment,
    ", dist: ", dist.pot.group
    ) %>% factor()
)  %>%
mutate(
female = fct_match(gender, "female")
)

indiv_balance_vars = c(
    "female",
    "age",
    "phone_owner"
)


indiv_balance_fit = analysis_school_data %>%
feols(
    data = ., 
    .[indiv_balance_vars] ~ 0 + treat_dist
    ) 


col_order = c(
"lhs", 
paste0(treat_levels_c, "_close"),
paste0(treat_levels_c, "_far")
)

indiv_balance_tidy_df = indiv_balance_fit %>%
    map_dfr(tidy, .id = "lhs") %>%
    mutate(
        lhs = str_remove(lhs, "lhs: ")
    ) %>%
    select(
        lhs, term, estimate, std.error
    )  


create_balance_input = function(tidy_df, col_order, digits = 3) {
bal_input_df = tidy_df %>%
    mutate(
    estimate = round(estimate, digits),
    std.error = round(std.error, digits)
    ) %>%
    mutate(
    estim_std = linebreak(paste0(estimate, "\n", str_glue("({std.error})"))) 
    )  %>%
    mutate(lhs_treat = str_extract(term, "(?<=disttreat: ).*(?=\\,)")) %>%
    mutate(lhs_dist = str_extract(term, "(?<=dist: ).*$")) %>%
    select(lhs, lhs_treat, lhs_dist, estim_std) %>%
    mutate(
    lhs_treat = factor(lhs_treat, treat_levels_c) %>% fct_rev(), 
    lhs_dist = factor(lhs_dist, dist_levels) %>% fct_rev()
    ) %>%
    pivot_wider(
    names_from = c(lhs_treat, lhs_dist),
    values_from = estim_std, 
    )    %>%
    select(
    all_of(col_order)
    )  %>%
    mutate(
        lhs = str_to_title(lhs),
        lhs = str_replace_all(lhs, "_", " ")
    )
return(bal_input_df)
}


wide_indiv_bal_df = create_balance_input(
    indiv_balance_tidy_df, 
    col_order = col_order, 
    digits = 3
) 

```


## Balance

```{r, results="asis"}
# TODO: add tests for imbalance
wide_indiv_bal_df %>% 
knitr::kable(
    format = "latex",
    escape = FALSE, 
    col.names = c("", rep(str_to_title(treat_levels_c), 2)), 
    booktabs = TRUE, 
    caption = "Balance Table: Individual Characteristics"
) %>%
kable_styling() %>%
add_header_above(c("", "Close" = 4, "Far" = 4 )) %>%
footnote(general = "Insert footnote here.")

```


```{r}

## Fit Loading
if (interactive()) {
    load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))
} else {
    load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))
    # load(file.path("..", "temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))
}

dist_fit_data %<>%
  left_join(tribble(
    ~ fit_type,        ~ model_color,
      "fit",           "black", 
      "prior-predict", "darkgrey",
  ), by = "fit_type") %>%
  filter(fct_match(fit_type, "fit"), fct_match(model, c("STRUCTURAL_LINEAR_U_SHOCKS", "REDUCED_FORM_NO_RESTRICT")))

delta <- function(v, ...) dnorm(v, ...) / ((pnorm(v, ...) * pnorm(v, ..., lower.tail = FALSE)))

belief_data = dist_fit_data %>%
  filter(fct_match(fit_type, "fit"), fct_match(model, c("STRUCTURAL_LINEAR_U_SHOCKS"))) %>%
  pull(beliefs_results) %>%
  first() 


cols_we_want = c(
    "est_takeup_level",
    "beliefs_results",
    "wtp_results",
    "est_takeup_te",
    "est_takeup_dist_te"
)
```


## Sample Info
```{r, sample_table}


analysis_meta_df = analysis_data %>%
    summarise(
        n_indiv = n_distinct(KEY.individ), 
        n_pots = n_distinct(cluster.id)
    )

wtp_stan_data <- analysis.data %>% 
  mutate(stratum = county) %>% 
  prepare_bayes_wtp_data(
    wtp.data,
    
    preference_value_diff = seq(-100, 100, 10), 
    num_preference_value_diff = length(preference_value_diff), 
    
    wtp_utility_df = 3,
    tau_mu_wtp_diff = 100,
    mu_wtp_df_student_t = 7,
    tau_sigma_wtp_diff = 50,
    sigma_wtp_df_student_t = 2.5
  )

wtp_meta_df = tibble(
    n_indiv = wtp_stan_data$num_wtp_obs, 
    n_pots = n_distinct(wtp.data$cluster.id)
)

belief_stan_data = 
    endline.know.table.data %>% 
      filter(fct_match(know.table.type, "table.A")) 

belief_meta_df = belief_stan_data %>%
    summarise(
        n_indiv = n_distinct(KEY.individ), 
        n_pots = n_distinct(cluster.id)
    )

sample_meta_df = bind_rows(
    analysis_meta_df %>% mutate(sample = "Takeup"),
    wtp_meta_df %>% mutate(sample = "WTP"),
    belief_meta_df %>% mutate(sample = "Beliefs")
) %>%
    select(sample, everything())

sample_meta_tbl = sample_meta_df %>%
    kbl(
        booktabs = TRUE, 
        format = "latex", 
        caption = "Sample Size Across Experiments", 
        align = "lcc",
        col.names = c("Experiment", "N Individuals", "N PoTs")
    )  %>%
    kable_styling()

```


```{r, sample_n, results="asis"}

sample_meta_tbl

```



```{r, res_table}



incentive_te = dist_fit_data %>%
  mutate(
    est_takeup_te =
      map_if(est_takeup_te, fct_match(model_type, "structural"),
             filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right) %>%
        map(filter,
            (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
            assigned_treatment_left != assigned_treatment_right,
            fct_match(assigned_treatment_right, c("control")),
            fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar")),
    model_color = canva_pal(canva_palette_vibrant)(n())
  ) %>% 
  select(model, model_type, model_name, est_takeup_te, fit_type, model_color) %>% 
  mutate(
    est_takeup_te = map(
      est_takeup_te,
      mutate,
      assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
        fct_relabel(str_to_title) %>% 
        fct_relevel("Combined"),
      assigned_treatment_left = str_to_title(assigned_treatment_left)
    )) %>%
    unnest(est_takeup_te)  %>%
    select( 
      model_type,
      assigned_treatment = assigned_treatment_left, 
      assigned_dist = assigned_dist_group_left,
      mean_est, 
      per_0.05, 
      per_0.95
    )



signalling_te = dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  select(model, model_type, model_name, est_takeup_te, fit_type) %>% 
  mutate(
    est_takeup_te = map(
      est_takeup_te,
      filter,
      (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
      across(c(assigned_treatment_left, assigned_treatment_right), fct_match, "control"),
      !is.na(mu_assigned_treatment_left),
      fct_match(mu_assigned_treatment_left, "bracelet") | !fct_match(mu_assigned_treatment_right, "calendar"),
      fct_match(mu_assigned_treatment_right, "control"),
    ) %>% 
      map(
        mutate,
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        mu_assigned_treatment_left = str_to_title(mu_assigned_treatment_left),
      ),
    model_color = canva_pal(canva_palette_vibrant)(n())) %>%
    unnest(est_takeup_te)  %>%
    select(
      assigned_treatment = mu_assigned_treatment_left, 
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est,
      per_0.05,
      per_0.95
    )




private_te = dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  select(model, model_type, model_name, est_takeup_te, fit_type) %>% 
  mutate(
    est_takeup_te = map(
      est_takeup_te,
      filter,
      (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
      !is.na(mu_assigned_treatment_left),
      !is.na(mu_assigned_treatment_right),
      across(c(mu_assigned_treatment_left, mu_assigned_treatment_right), fct_match, "control"),
      fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"),
      fct_match(assigned_treatment_right, "control"),
    ) %>% 
      map(
        mutate,
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = str_to_title(assigned_treatment_left),
      ),
    model_color = canva_pal(canva_palette_vibrant)(n())) %>%
    unnest(est_takeup_te) %>%
    select(
      assigned_treatment = assigned_treatment_left,
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est, 
      per_0.05, 
      per_0.95
    )

## Differences Between Bracelet and Calendar
incentive_bracelet_calendar_diff_df = dist_fit_data %>%
  filter(
    fct_match(fit_type, "fit"), 
    # fct_match(model, "STRUCTURAL_LINEAR_U_SHOCKS")
    ) %>%
    select(fit_type, model_type, est_takeup_te_diff) %>%
    unnest(est_takeup_te_diff) %>%
    filter(
      (assigned_dist_group_left == assigned_dist_group_right) | (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)), # same dist group
      model_type == "reduced form" | (model_type == "structural" & (mu_assigned_treatment_left == assigned_treatment_left)), # same mu and B
      model_type == "reduced form" | (model_type == "structural" & (mu_assigned_treatment_right == assigned_treatment_right)), # same mu and B
      fct_match(assigned_treatment_right, "calendar"), 
      fct_match(assigned_treatment_left, "bracelet")
    )  %>%
    mutate(
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = str_to_title(assigned_treatment_left),
      ) %>%
    select(
      assigned_treatment = assigned_treatment_left,
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est, 
      per_0.05, 
      per_0.95
    ) %>%
    mutate(
      assigned_treatment = "\\textit{Bracelet - Calendar}"
    )

signal_bracelet_calendar_diff_df = dist_fit_data %>%
  select(model_type, fit_type, est_takeup_te) %>%
  filter(model_type == "structural") %>%
  unnest(est_takeup_te)  %>%
  filter(
    (assigned_dist_group_left == assigned_dist_group_right) | (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)), # same dist group
    (assigned_treatment_left == assigned_treatment_right), # same B on LHS and RHS
    (mu_assigned_treatment_left == "bracelet" & mu_assigned_treatment_right == "calendar"), 
    assigned_treatment_left == "control" 
) %>%
    mutate(
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = str_to_title(assigned_treatment_left),
      ) %>%
    select(
      assigned_treatment = assigned_treatment_left,
      assigned_dist = assigned_dist_group_left, 
      model_type,
      mean_est, 
      per_0.05, 
      per_0.95
    ) %>%
    mutate(
      assigned_treatment = "\\textit{Bracelet - Calendar}"
    )


te_df = bind_rows(
  incentive_te %>% mutate(estimand = "incentive"),
  incentive_bracelet_calendar_diff_df %>% mutate(estimand = "incentive"),
  private_te %>% mutate(estimand = "private"),
  signalling_te %>% mutate(estimand = "signal"),
  signal_bracelet_calendar_diff_df %>% mutate(estimand = "signal"),
)

rf_te_input_df = te_df %>%
  filter(model_type == "reduced form") %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  mutate(
    estim_value = linebreak(
      paste0(mean_est, "\n", "(", per_0.05, ", ", per_0.95, ")"), 
      align = "c"
      )
  ) %>%
  select(
    model_type, 
    assigned_treatment, 
    assigned_dist, 
    estim_value, 
    estimand
  ) %>%
  pivot_wider(
    names_from = assigned_dist, 
    values_from = estim_value
  )  %>%
  rename(
    rf_Close = Close, 
    rf_Far = Far, 
    rf_Combined = Combined
  )

structural_te_input_df = te_df %>%
  filter(model_type == "structural") %>%
  mutate(across(where(is.numeric), round, 3)) %>%
  mutate(
    estim_value = linebreak(
      paste0(mean_est, "\n", "(", per_0.05, ", ", per_0.95, ")"), 
      align = "c"
      )
  ) %>%
  select(
    model_type, 
    assigned_treatment, 
    assigned_dist, 
    estim_value, 
    estimand
  ) %>%
  pivot_wider(
    id_cols = c(assigned_treatment, estimand),
    names_from = assigned_dist, 
    values_from = estim_value
  )  %>%
  mutate(across(
    c(Close, Far), 
    ~if_else(
      estimand == "private", 
      NA_character_, 
      .x
    )
  ))


te_input_df = left_join(
  structural_te_input_df,
  rf_te_input_df,
  by = c("estimand", "assigned_treatment")
)  %>%
  select(-model_type) %>%
  select(
    Estimand = estimand, 
    Treatment = assigned_treatment, 
    everything()
  ) %>%
  mutate(across(c(contains("rf_"), Close, Far), replace_na, "-")) %>%
  mutate(Estimand = factor(Estimand, levels = c("incentive", "signal", "private", ""))) %>%
  arrange(Estimand)



latex_group_gap_space = "2em"

te_kbl_df = te_input_df %>%
  mutate(
    Estimand = if_else(
      Treatment == "Ink", 
      Estimand, 
      factor("")
    )
  ) %>%
  select(-Estimand) %>%
  kbl(
    col.names = c(
      # "Estimand", 
      # "Treatment", 
      "",
      paste0("(", 1:6, ")")
    ), 
    format = "latex", 
    booktabs = TRUE, 
    escape = FALSE, 
    align = "lcccccc", 
    caption = "Results"
  ) %>%
  kable_styling(
    latex_options = c("scale_down")
  ) %>%
  add_header_above(
    c(" ", 
      "Close", 
      "Far", 
      "Combined", 
      "Close", 
      "Far",
      "Combined"), 
    line = FALSE
  ) %>%
  add_header_above(
    c(
      " " = 1,
      "Structural" = 3, 
      "Reduced Form" = 3
      )
  ) %>%
  pack_rows(
    index = c(
      "Overall" = 4, 
      "Signalling" = 4, 
      "Private" = 3
    ), 
    # latex_gap_space = latex_group_gap_space, 
    hline_after = TRUE, 
    # hline_before = TRUE,
    bold = TRUE
  ) %>%
  add_indent(c(4, 8)) %>%
  footnote(
    escape = FALSE,
    threeparttable = TRUE,
    general = 
        str_glue(
            "Point estimates represent posterior means, 90\\\\% percent credibility intervals are shown in parantheses.
            'Overall' indicates the total treatment effect; 'Signalling' and 'Private' use the structural model to 
            isolate the effect of reputational returns and the private utility derived from each treatment. 
            \\\\textit{{Bracelet - Calendar}} shows the posterior difference in takeup across bracelet and calendar conditions.
            Structural estimates use all three samples: 9,805 individuals' deworming status; 998 individual's elicited first-order beliefs; and 
            data from 1,627 individual's Willingness-To-Pay choices.
            "
        ) 
  )


te_kbl_df %>%
  save_kable(
    file.path(
      params$output_path,
      "te-table.tex"
    )
  )

```


```{r, results="asis"}
x = 2 + 5
te_kbl_df 

```




```{r}

load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}.RData")))

colnames(dist_fit_data)
dist_fit_data %>%
  select(fit_type, model_type, est_takeup_te_diff) %>%
  unnest() %>%
  colnames()

dist_fit_data %>%
  filter(model_type == "structural") %>%
  mutate(across(where(is_list), map_if, ~ is_tibble(.x) && has_name(.x, "iter_data"), ~ NULL))



# we hate RData
dist_fit_full = new.env()
load(file.path("temp-date", str_interp("processed_dist_fit${fit_version}.RData")), envir = dist_fit_full)
    

with_env = function(f, e = parent.frame()) {
    stopifnot(is.function(f))
    environment(f) = e
    f
}

clean_micro = function(){
    site <- c(attanasio_indicator, augsberg_indicator,banerjee_indicator, crepon_indicator)-1
    consumerdurables <- c(attanasio_consumerdurables, augsberg_consumerdurables,banerjee_consumerdurables, crepon_consumerdurables)
    treatment <- c(attanasio_treatment, augsberg_treatment,banerjee_treatment, crepon_treatment)
    priorbiz <- c(attanasio_existingbusiness, augsberg_existingbusiness, banerjee_existingbusiness, crepon_existingbusiness)
    # Now we have to standardise any variables which are in local currency units to USD PPP per fortnight in 2009 dollars


    expanded_standardiser_USD_PPP_per_fortnight <- c(
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[1],length(attanasio_indicator)),
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[2],length(augsberg_indicator)),
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[3],length(banerjee_indicator)),
                                                    rep(the_consumerdurables_standardiser_USD_PPP_per_fortnight[4],length(crepon_indicator)))

    consumerdurables <- consumerdurables*expanded_standardiser_USD_PPP_per_fortnight

    # bind everything into a data frame
    data <- data.frame(site, consumerdurables, treatment, priorbiz)

    site_df = 
        tibble(
            site_id = map_dbl(
                list(attanasio_indicator, 
                    augsberg_indicator,
                    banerjee_indicator, 
                    crepon_indicator), 
                ~unique(.x - 1)), 
            study_name = c("attanasio", "augsberg", "banerjee", "crepon")
        )
    # We gotta remove the NA values
    data <- data[complete.cases(data),] %>%
        as_tibble() %>%
        left_join(., site_df, by = c("site" = "site_id"))
    return(data)
}


consumer_durable_data = with_env(clean_micro, microcredit_env)()


```