---
title: "Social Signaling and Prosocial Behavior"
subtitle: "Experimental Evidence in Community Deworming in Kenya"
author: "Anne Karing (Princeton) and Karim Naguib"
date: "12/10/2020"
output: 
  pdf_document
params:
  fit_version: 71
  input_path: data/stan_analysis_data
  output_path: temp-data
  models: STRUCTURAL_LINEAR_U_SHOCKS
---

```{r takeup-present-setup, include=FALSE}
library(magrittr)
library(tidyverse)
library(broom)
library(ggrepel)
library(ggmap)
library(ggstance)
library(gridExtra)
library(cowplot)
library(sf)
library(knitr)
library(modelr)
library(car)
library(rstan)
library(latex2exp)
library(ggthemes)

library(econometr)


if (interactive()) {
  params = lst(
    fit_version = 71,
    input_path = "data/stan_analysis_data",
    output_path = "temp-data", 
    models = "STRUCTURAL_LINEAR_U_SHOCKS"
  )
}

source(file.path("rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
source(file.path("analysis_util.R"))
source(file.path("dist_structural_util.R"))
source(file.path("multilvlr", "multilvlr_util.R"))

knitr::read_chunk(file.path("analysis_util.R"), labels = "analysis-util")

# knit_hooks$set(document = function(x) {sub('\\usepackage[]{color}', '\\usepackage[table,dvipsnames]{xcolor}', x, fixed = TRUE)})

# read_chunk(purl(file.path("..", "takeup_analysis2.Rmd")))

# read_chunk(purl(file.path("..", "takeup_bayesian_analysis.Rmd")))

options(dplyr.show_progress = FALSE, digits = 4, knitr.kable.NA = '')

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warnings = FALSE, cache = TRUE, cache.path = "takeup-figure-cache/", fig.path = "takeup-fig/", fig.align = "center")

fit_version <- params$fit_version

regular_plot <- knit_hooks$get("plot")

# Custom knitr hook to add notes to the plot
knit_hooks$set(plot = function(x, options) {
  paste("\n\n\\begin{figure}\n",
        "\\includegraphics[width=\\maxwidth]{",
        opts_knit$get("base.url"), paste(x, collapse = "."),
        "}\n",
        "\\caption{", options$fig.cap, "}\n",
        "\\textit{Note:} {\\footnotesize ", options$fig.note,"}",
        "\n\\end{figure}\n\n",
        sep = '')
})
```




```{r, plot_setup_stuff}


default_top_levels = c("Bracelet", "Combined")

# 66 ed fit
# 60 Karim fit
# 62 also Karim fit


model_fit_by = if_else(fit_version %in% c(60, 62), "Karim", "Ed")


models_we_want = c(
  params$models
)


quant_probs <- c(0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95, 0.99)


output_basepath = str_glue("temp-data/output_dist_fit{fit_version}")
dir.create(output_basepath, showWarnings = FALSE)
canva_palette_vibrant <- "Primary colors with a vibrant twist"

theme_set(theme_minimal() +
            theme(legend.position = "bottom"))

wgs.84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
kenya.proj4 <- "+proj=utm +zone=36 +south +ellps=clrk80 +units=m +no_defs"

rct.schools.data <- read_rds(file.path("data", "takeup_rct_schools.rds"))
rct.cluster.selection <- read_rds(file.path("data", "rct_cluster_selection_2.0.rds"))
cluster.strat.data <- read_rds(file.path("data", "takeup_processed_cluster_strat.rds"))

load(file.path("data", "takeup_village_pot_dist.RData"))

load(file.path("data", "analysis.RData"))

standardize <- as_mapper(~ (.) / sd(.))
unstandardize <- function(standardized, original) standardized * sd(original)

nosms_data <- analysis.data %>% 
  filter(sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

monitored_nosms_data <- analysis.data %>% 
  filter(mon_status == "monitored", sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

analysis_data <- monitored_nosms_data

```


## Fit Loading
```{r, fit_loading}
load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))


dist_fit_data %<>%
  left_join(tribble(
    ~ fit_type,        ~ model_color,
      "fit",           "black", 
      "prior-predict", "darkgrey",
  ), by = "fit_type")


rf_analysis_data <- dist_fit_data %>% 
  filter(
    fct_match(model_type, "reduced form"),
    fct_match(fit_type, "fit"),
  ) %$% 
  stan_data[[1]]$analysis_data 
delta <- function(v, ...) dnorm(v, ...) / ((pnorm(v, ...) * pnorm(v, ..., lower.tail = FALSE)))

stan_data = (dist_fit_data %>%
  filter(fct_match(model_type, "structural")) %>%
  select(stan_data) %>%
  pull())[[1]]


```


```{r}

theme_set(theme_minimal() +
            theme(legend.position = "bottom"))

```


#### Delta Expectation ####

```{r, delta_expectation, fig.cap="This is a plot caption", fig.note="Ededed"}
2+1
sim_int <- expand.grid(
  w = seq(-2, 2, 0.1),
  u_sd = seq(0.0, 2.0, 0.05),
  mu = seq(0.1, 1, 0.05)
) %>% 
  filter(u_sd == 0 | mu == 1) %>% 
  rowwise() %>% 
  mutate(
    mu_delta = mu * calculate_delta(w, sqrt(1 + u_sd^2), u_sd),
    mu_delta_deriv = mu * calculate_delta_deriv(w, sqrt(1 + u_sd^2), u_sd)
  ) %>% 
  ungroup() %>% 
  pivot_longer(c(mu_delta, mu_delta_deriv), names_to = "delta_type")


sim_ints_u_we_want = unique(sim_int$u_sd)[seq(from = 3, to = length(unique(sim_int$u_sd)) - 3, length.out = 3)]

text_df = tibble(
  w = c(-1.5, 0, 1.5), 
  text = c("Respectable Acts", "Modal Acts", "Admirable Acts")
) %>% 
  mutate(
    value = calculate_delta(w, sqrt(1 + sim_ints_u_we_want[2]^2), sim_ints_u_we_want[2])
  )

sigma_text_df = sim_int %>%
      filter(w == -2) %>%
      filter(u_sd %in% c(0.5, 1, 1.5)) %>%
      filter(
        delta_type == "mu_delta"
      )


sim_int %>% 
  filter(delta_type == "mu_delta") %>%
  filter(mu == 1)  %>%
  mutate(
    alpha = case_when(
      u_sd  == 1 ~ 1, 
      u_sd %in% sigma_text_df$u_sd ~ 0.3, 
      TRUE ~ 0 
      )
  )  %>%
  ggplot(aes(w, value, alpha = alpha)) +
  geom_line(
    aes(group = u_sd)
  ) +
  geom_text(
    inherit.aes = FALSE,
    data = text_df, 
    aes(
      x = w, 
      y = value*1.1, 
      label = text)
  ) +
  annotate(
    "text", 
    x = c(2, 2, 2), 
    y = sigma_text_df$value*0.95, 
    label = c(
      TeX("$\\sigma_u = 0.5$"),
      TeX("$\\sigma_u = 1$"),
      TeX("$\\sigma_u = 1.5$")
    ),
    alpha = 0.6,
  hjust=0.5, size = 4, parse = TRUE,
  vjust = 1
  ) +
  labs(
    x = latex2exp::TeX("$w^*$"),
    y = latex2exp::TeX(r"{$\mu\Delta\[w^*\]$}"),
    caption = latex2exp::TeX(r"{Black lines move down and flatten as $\sigma_u$ increases}")
  ) +
  guides(alpha = "none") +
  theme_minimal() +
  NULL
1+3
```


#### Distance Randomisation ####
```{r, dist-plot, fig.cap = "Distance to Treatment Location (meters)", fig.note = "Cluster centers calculated as the centroid location of all households in cluster. Density estimates use all 9,805 individuals observed in takeup sample."}
analysis_data %>%  
  mutate(assigned.treatment = fct_relabel(assigned.treatment, str_to_title)) %>% 
  ggplot(aes(dist.to.pot)) +
  geom_density(aes(color = dist.pot.group, linetype = "Household")) +
  geom_density(aes(color = dist.pot.group, linetype = "Cluster Center"),
               data = mutate(village.centers, assigned.treatment = fct_relabel(assigned.treatment, str_to_title))) +
  geom_vline(xintercept = c(1250), linetype = "dashed") +
  labs(y = "Density") +
  scale_x_continuous("Distance to Treatment Location (meters)", breaks = seq(0, 10000, 2500/4)) +
  scale_color_discrete("Cluster Distance Assignment", labels = c("Close", "Far")) +
  scale_linetype_discrete("Distance From") +
  facet_wrap(~ assigned.treatment) +
  theme_minimal() +
  theme(legend.position = "bottom")

```



#### Incentive ATEs ####


```{r}

grab_incentive_ate = function(data, model_type_to_plot, nested_data = est_takeup_te) {

  subset_data = data %>%
    filter(
      (fct_match(model_type, model_type_to_plot))
    ) %>% 
    mutate(
      {{ nested_data }} :=
        map_if({{ nested_data }}, fct_match(model_type, "structural"),
              filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right) %>%
          map(filter,
              (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
              assigned_treatment_left != assigned_treatment_right,
              fct_match(assigned_treatment_right, c("control")),
              fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"))
    )  %>%
    select(model, model_name, {{ nested_data }}, fit_type, model_color) %>% 
    mutate(
      {{ nested_data }} := map(
        {{ nested_data }},
        mutate,
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = fct_rev(factor(str_to_title(assigned_treatment_left)))
      )
    ) 
    return(subset_data)
}

```


```{r}

reduced_incentive_level_plot_df = dist_fit_data %>%
    filter(
      (fct_match(model_type, "reduced form"))
    )  %>%
    mutate(est_takeup_level = map_if(est_takeup_level,
        fct_match(fit_type, "prior-predict"), 
        ~mutate(.x, 
          across(
            c(contains("per"), mean_est),
            ~if_else(
              !(fct_match(assigned_treatment,  "bracelet") & is.na(assigned_dist_group)),
              NA_real_,
              .x 
            )
          )
        )
      )
    ) %>%
    mutate(
      est_takeup_level = map(
        est_takeup_level,
        mutate,
        assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment = fct_rev(factor(str_to_title(assigned_treatment), 
                                    levels = c("Bracelet",
                                                "Calendar",
                                                "Ink",
                                                "Control")))
        )
        )
        
```

```{r}
#| incentive-levels,
#| fig.cap="Incentive Takeup Levels, Reduced Form Model",
#| fig.note="Line range: 90\\% credible interval. 
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval. 
#|  Point: mean. Reduced form model estimated using Bayesian probit model with 9,805 observations."


reduced_incentive_level_plot = reduced_incentive_level_plot_df %>%
  plot_estimands(.,est_takeup_level, assigned_treatment, results_group = fit_type) +
    scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
    scale_y_discrete("") +
    # labs(
    #   # title = "Incentive Average Treatment Effect",
    # ) +
    ggforce::facet_col(vars(assigned_dist_group), 
                space = "free",
                scales = "free_y") +
    NULL  +
    guides(colour = "none") +
    theme_minimal() +
    theme(legend.position = "bottom")
reduced_incentive_level_plot +
  labs(caption = "")

ggsave(
  plot = reduced_incentive_level_plot,
  filename = file.path(
    output_basepath,
    "reduced-incentive-level-plot.png"
  ),
  width = 7.5,
  height = 5,
  dpi = 500
)

```



```{r, reduced_incentive_ate_df, eval=TRUE}

reduced_incentive_ate_plot_df = dist_fit_data %>%
  grab_incentive_ate(., model_type_to_plot = "reduced form") 

```

```{r}
#| incentive_ate,
#| fig.cap = "Incentive Average Treatment Effect, Reduced Form Model",
#| fig.note = "Line range: 90\\% credible interval.
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval.
#|  Thick vertical line: median. Point: mean."

reduced_incentive_ate_plot = reduced_incentive_ate_plot_df %>%
  plot_estimands(., 
                 est_takeup_te, 
                 assigned_treatment_left, 
                 results_group = fit_type, 
                 single_prior_predict = TRUE, 
                 top_levels = default_top_levels) +
    scale_x_continuous("", breaks = seq(-0.2, 0.2, 0.05)) +
    scale_y_discrete("") +
    labs(
      # title = "Incentive Average Treatment Effect"
    ) +
    ggforce::facet_col(vars(assigned_dist_group_left), 
                space = "free",
                scales = "free_y") +
    NULL  +
    guides(colour = "none") +
    theme_minimal()

reduced_incentive_ate_plot +
  labs(caption = "")

ggsave(
  plot = reduced_incentive_ate_plot,
  filename = file.path(
    output_basepath,
    "reduced-incentive-ate-plot.png"
  ),
  width = 7.5,
  height = 5,
  dpi = 500
)

```


```{r}
#| signalling-ate,
#| fig.cap="Signalling Average Treatment Effect, Structural Model",
#| fig.note = "Line range: 90\\% credible interval.
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval.
#|  Thick vertical line: median. Point: mean. Signalling effect calculated using
#|  structural model incorporating willingness-to-pay, beliefs, and takeup data." 

default_ate_limits = c(-0.15, 0.15)

structural_incentive_ate_plot = dist_fit_data %>%
  grab_incentive_ate(., model_type_to_plot = "structural") %>%
  filter(model == "STRUCTURAL_LINEAR_U_SHOCKS") %>%
  plot_estimands(., 
                 est_takeup_te, 
                 assigned_treatment_left, 
                 results_group = fit_type, 
                 single_prior_predict = TRUE, 
                 top_levels = default_top_levels) +
    scale_x_continuous(
      "", 
      breaks = seq(-0.2, 0.2, 0.05), 
      limits = default_ate_limits) +
    scale_y_discrete("") +
    labs(
      # title = "Incentive Average Treatment Effect"
    ) +
    ggforce::facet_col(vars(assigned_dist_group_left), 
                space = "free",
                scales = "free_y") +
    NULL  +
    guides(colour = "none") +
    theme_minimal()

structural_incentive_ate_plot +
  labs(caption = "")

ggsave(
  plot = structural_incentive_ate_plot,
  filename = file.path(
    output_basepath,
    "structural-incentive-ate-plot.png"
  ),
  width = 7.5,
  height = 5.0,
  dpi = 500
)
```



```{r}


wtp_results <- read_rds(file.path("data", "stan_analysis_data", "wtp_model_fit_results.rds")) 
wtp_prior_results <- read_rds(file.path("data", "stan_analysis_data", "wtp_model_prior_results.rds"))
```

```{r wtp-post}
#| wtp-post,
#| fig.cap="Willingness-To-Pay Estimates",
#| fig.note = "Line range: 90\\% credible interval.
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval.
#|  Thick vertical line: median. Point: mean. Preferences estimated using 998 individuals
#|  with a Bayesian multinomial discrete choice model using a Probit likelihood."



joint_wtp_results <- dist_fit_data %>%
  filter(fct_match(fit_type, "fit") & fct_match(model_type, "structural") & fct_match(model, "STRUCTURAL_LINEAR_U_SHOCKS")) %>%
  pull(wtp_results) %>%
  first()

plot_wtp_results <- function(draws) {
  cowplot::plot_grid(
    filter(draws, fct_match(variable, "prob_prefer_calendar")) %>% 
      left_join(tibble(index = 1:21, val_diff = -seq(-100, 100, 10)), by = "index") %>% 
      ggplot(aes(x = val_diff)) +
      geom_line(aes(y = per_0.5, color = fit_type), show.legend = FALSE) +
      geom_point(aes(y = per_0.5, color = fit_type), size = 1, show.legend = FALSE) +
      geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = fit_type), alpha = 0.4, show.legend = FALSE) +
      scale_x_continuous("Added Value [KSh]", breaks = seq(-100, 100, 10)) + #, labels = scales::label_number(suffix = " KSh")) +
      scale_color_manual("", values = c("joint" = "black", "alone" = "red"), aesthetics = c("color", "fill")) +
      theme_minimal() +
      labs(
        title = "Probability of Choosing Calendars Over Bracelets",
        y = "" 
      ) +
      ylim(0, 1) +
      NULL,
    
    # filter(draws, fct_match(variable, "strata_wtp_mu")) %>%
    filter(draws, fct_match(variable, "hyper_wtp_mu")) %>%
      mutate(across(c(starts_with("per_"), mean_est), multiply_by, 100)) %>%
      # ggplot(aes(y = str_c(variable, index))) +
      ggplot(aes(y = str_c(fit_type))) +
      geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = fit_type), alpha = 0.4, size = 3, show.legend = FALSE) +
      geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = fit_type), fatten = 2, size = 0.4, width = 0.2, show.legend = FALSE) +
      geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = fit_type), size = 0.4, show.legend = FALSE) +
      geom_point(aes(x = mean_est, color = fit_type), size = 2, show.legend = FALSE) +
      geom_point(aes(x = mean_est, color = fit_type), color = "white", size = 0.8, show.legend = FALSE) +
      scale_color_manual("", values = c("joint" = "black", "alone" = "red"), aesthetics = c("color", "fill")) +
      scale_x_continuous(limits = c(-100, 100), breaks = seq(-100, 100, 10)) +
      # coord_cartesian(xlim = c(-55, 55)) +
      theme_minimal() +
      theme(axis.text.y = element_blank()) +
      labs(
        title = "Difference in Valuation of Calendars and Bracelets",
        # subtitle = "For Each County",
        x = "KSh",
        y = "",
        # caption = "Line range: 90% credible interval. Outer box: 80% credible interval. Inner box: 50% credible interval.
        #            Thick vertical line: median. Point: mean."
      ) +
      # xlim(-100, 100) +
      NULL
      ,
    
    ncol = 1 , rel_heights = c(1, 0.6)
  )
}

joint_wtp_results %>% 
  mutate(fit_type = "joint") %>% 
  plot_wtp_results() 

```
