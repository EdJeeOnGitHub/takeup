---
title: "Social Signaling and Prosocial Behavior"
subtitle: "Experimental Evidence in Community Deworming in Kenya"
author: "Anne Karing (Princeton) and Karim Naguib"
date: "12/10/2020"
output: 
  pdf_document:
    keep_tex: yes
params:
  rf_fit_version: 75
  fit_version: 71
  input_path: data/stan_analysis_data
  output_path: temp-data
  models: STRUCTURAL_LINEAR_U_SHOCKS
---

```{r takeup-present-setup, include=FALSE}
library(magrittr)
library(tidyverse)
library(broom)
library(ggrepel)
library(ggmap)
library(ggstance)
library(gridExtra)
library(cowplot)
library(sf)
library(knitr)
library(modelr)
library(car)
library(rstan)
library(latex2exp)
library(ggthemes)

library(econometr)


if (interactive()) {
  params = lst(
    fit_version = 71,
    rf_fit_version = 75,
    input_path = "data/stan_analysis_data",
    output_path = "temp-data", 
    models = "STRUCTURAL_LINEAR_U_SHOCKS"
  )
}

source(file.path("rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
source(file.path("analysis_util.R"))
source(file.path("dist_structural_util.R"))
source(file.path("multilvlr", "multilvlr_util.R"))

knitr::read_chunk(
  file.path("analysis_util.R"), 
  labels = "analysis-util"
)

options(dplyr.show_progress = FALSE, digits = 4, knitr.kable.NA = '')

knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warnings = FALSE, 
  warning = FALSE, 
  cache = TRUE, 
  cache.path = "takeup-figure-cache/", 
  fig.path = "takeup-fig/", 
  fig.align = "center"
  )

fit_version <- params$fit_version

regular_plot <- knit_hooks$get("plot")

# Custom knitr hook to add notes to the plot
knit_hooks$set(plot = function(x, options) {
  paste("\n\n\\begin{figure}\n",
        "\\includegraphics[width=\\maxwidth]{",
        opts_knit$get("base.url"), paste(x, collapse = "."),
        "}\n",
        "\\caption{", options$fig.cap, "}\n",
        "\\textit{Note:} {\\footnotesize ", options$fig.note,"}",
        "\n\\end{figure}\n\n",
        sep = '')
})
```




```{r, plot_setup_stuff}


default_top_levels = c("Bracelet", "Combined")

# 66 ed fit
# 60 Karim fit
# 62 also Karim fit


model_fit_by = if_else(fit_version %in% c(60, 62), "Karim", "Ed")


models_we_want = c(
  params$models
)


quant_probs <- c(0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95, 0.99)


output_basepath = str_glue("temp-data/output_dist_fit{fit_version}")
dir.create(output_basepath, showWarnings = FALSE)
canva_palette_vibrant <- "Primary colors with a vibrant twist"

theme_set(theme_minimal() +
            theme(legend.position = "bottom"))

wgs.84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
kenya.proj4 <- "+proj=utm +zone=36 +south +ellps=clrk80 +units=m +no_defs"

rct.schools.data <- read_rds(file.path("data", "takeup_rct_schools.rds"))
rct.cluster.selection <- read_rds(file.path("data", "rct_cluster_selection_2.0.rds"))
cluster.strat.data <- read_rds(file.path("data", "takeup_processed_cluster_strat.rds"))

load(file.path("data", "takeup_village_pot_dist.RData"))

load(file.path("data", "analysis.RData"))

standardize <- as_mapper(~ (.) / sd(.))
unstandardize <- function(standardized, original) standardized * sd(original)

nosms_data <- analysis.data %>% 
  filter(sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

monitored_nosms_data <- analysis.data %>% 
  filter(mon_status == "monitored", sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

analysis_data <- monitored_nosms_data

```


## Fit Loading
```{r, fit_loading}
load(file.path("temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))

if (params$fit_version != params$rf_fit_version) {
  # Only load structural
  dist_fit_data = dist_fit_data %>%
    filter(model %in% c("STRUCTURAL_LINEAR_U_SHOCKS"))

  rf_env = new.env()

  with_env = function(f, e = parent.frame()) {
      stopifnot(is.function(f))
      environment(f) = e
      f
  }

  load_rf_function = function(){
      load(file.path("temp-data", str_interp("processed_dist_fit${params$rf_fit_version}_lite.RData")))
      return(dist_fit_data)
  }


  rf_fit_data = with_env(load_rf_function, rf_env)() %>%
    filter(model %in% c("REDUCED_FORM_NO_RESTRICT"))

  dist_fit_data = bind_rows(
    rf_fit_data, 
    dist_fit_data
  )

}

dist_fit_data %<>%
  left_join(tribble(
    ~ fit_type,        ~ model_color,
      "fit",           "black", 
      "prior-predict", "darkgrey",
  ), by = "fit_type") 

dist_fit_data = dist_fit_data %>%
  filter(model %in% c("REDUCED_FORM_NO_RESTRICT", "STRUCTURAL_LINEAR_U_SHOCKS"))



rf_analysis_data <- dist_fit_data %>% 
  filter(
    fct_match(model_type, "reduced form"),
    fct_match(fit_type, "fit"),
  ) %$% 
  stan_data[[1]]$analysis_data 
delta <- function(v, ...) dnorm(v, ...) / ((pnorm(v, ...) * pnorm(v, ..., lower.tail = FALSE)))

stan_data = (dist_fit_data %>%
  filter(fct_match(model_type, "structural")) %>%
  select(stan_data) %>%
  pull())[[1]]


```


```{r, cache=FALSE}

theme_set(theme_minimal() +
            theme(legend.position = "bottom"))

```


#### Delta Expectation ####

```{r}
#| delta-expectation,
#| fig.cap="Net reputational return, $\\mu\\Delta[w^*]$, as a function of cutoff type, $w^*$",
#| fig.note="This plot shows how expected reputational return, $\\mu\\Delta[w^*]$ 
#|  varies as cutoff type, $w^*$, changes. As $\\sigma_u$ increases, the 
#|  reputational return falls as it becomes harder to infer someone's type based 
#|  off actions." 

sim_int <- expand.grid(
  w = seq(-2, 2, 0.1),
  u_sd = seq(0.0, 2.0, 0.05),
  mu = seq(0.1, 1, 0.05)
) %>% 
  filter(u_sd == 0 | mu == 1) %>% 
  rowwise() %>% 
  mutate(
    mu_delta = mu * calculate_delta(w, sqrt(1 + u_sd^2), u_sd),
    mu_delta_deriv = mu * calculate_delta_deriv(w, sqrt(1 + u_sd^2), u_sd)
  ) %>% 
  ungroup() %>% 
  pivot_longer(c(mu_delta, mu_delta_deriv), names_to = "delta_type")


sim_ints_u_we_want = unique(sim_int$u_sd)[seq(from = 3, to = length(unique(sim_int$u_sd)) - 3, length.out = 3)]

text_df = tibble(
  w = c(-1.5, 0, 1.5), 
  text = c("Respectable Acts", "Modal Acts", "Admirable Acts")
) %>% 
  mutate(
    value = calculate_delta(w, sqrt(1 + sim_ints_u_we_want[2]^2), sim_ints_u_we_want[2])
  )

sigma_text_df = sim_int %>%
      filter(w == -2) %>%
      filter(u_sd %in% c(0.5, 1, 1.5)) %>%
      filter(
        delta_type == "mu_delta"
      )


sim_int %>% 
  filter(delta_type == "mu_delta") %>%
  filter(mu == 1)  %>%
  mutate(
    alpha = case_when(
      u_sd  == 1 ~ 1, 
      u_sd %in% sigma_text_df$u_sd ~ 0.3, 
      TRUE ~ 0 
      )
  )  %>%
  ggplot(aes(w, value, alpha = alpha)) +
  geom_line(
    aes(group = u_sd)
  ) +
  geom_text(
    inherit.aes = FALSE,
    data = text_df, 
    aes(
      x = w, 
      y = value*1.1, 
      label = text)
  ) +
  annotate(
    "text", 
    x = c(2, 2, 2), 
    y = sigma_text_df$value*0.95, 
    label = c(
      TeX("$\\sigma_u = 0.5$"),
      TeX("$\\sigma_u = 1$"),
      TeX("$\\sigma_u = 1.5$")
    ),
    alpha = 0.6,
  hjust=0.5, size = 4, parse = TRUE,
  vjust = 1
  ) +
  labs(
    x = latex2exp::TeX("$w^*$"),
    y = latex2exp::TeX(r"{$\mu\Delta\[w^*\]$}")
  ) +
  guides(alpha = "none") +
  theme_minimal() +
  NULL
1+3
```




#### Reported Social Perception ####
```{r}
#| reported-social-perception,
#|  fig.cap="Reported social perception of some observable activities.",
#|  fig.note="This plot shows the praise and stigma associated with various activities 
#|  including deworming."


# colnames(baseline.data)


# baseline.data %>%
#   summarise(
#     n_distinct(KEY)
#   )

# baseline.data %>%
#   select(matches("^(praise|stigma)_[^_]+$"), KEY) %>%
#   gather(key = key, value = response, -KEY)  %>%
#   separate(key, c("praise.stigma", "topic"), "_") %>% 
#   separate(topic, c("topic", "question.group"), -2) %>% 
#   filter(!is.na(response)) %>%
#   group_by(topic, praise.stigma) %>%
#   summarise(
#     n_keys = n_distinct(KEY), 
#     frac = n_keys/1770
#   )



# baseline.data %>%
#   colnames()

# baseline.data %>%
#   select(matches("^(praise|stigma)_[^_]+$"), KEY) %>%
#   gather(key = key, value = response, -KEY)  %>%
#   separate(key, c("praise.stigma", "topic"), "_") %>% 
#   separate(topic, c("topic", "question.group"), -2) %>% 
#   filter(!is.na(response)) %>%
#   group_by(KEY) %>%
#   summarise(
#     n_praise = n_distinct(praise.stigma), 
#     n_topics = n_distinct(topic), 
#     n_response = n_distinct(response)
#   ) %>%
#   ungroup() %>%
#   count(n_topics)




# baseline.data %>%
#   select(matches("^(praise|stigma)_[^_]+$"), KEY) %>%
#   gather(key = key, value = response, -KEY)  %>%
#   separate(key, c("praise.stigma", "topic"), "_") %>% 
#   separate(topic, c("topic", "question.group"), -2) %>% 
#   filter(!is.na(response))  %>%
#   select(topic) %>%
#   unique()




social_perception_data = baseline.data %>% 
  select(matches("^(praise|stigma)_[^_]+$")) %>% 
  gather(key = key, value = response) %>% 
  separate(key, c("praise.stigma", "topic"), "_") %>% 
  separate(topic, c("topic", "question.group"), -2) %>% 
  filter(!is.na(response))  %>%
  count(praise.stigma, topic, response) %>% 
  group_by(praise.stigma, topic) %>% 
  mutate(n = n/sum(n)) %>%
  mutate_at(vars(praise.stigma, response), ~ fct_relabel(factor(.), str_to_title)) %>% 
  mutate(topic = fct_recode(factor(topic), 
                            "Wearing/not wearing nice clothes to church" = "clothe",
                            "Use Latrine/open defecation" = "defecat",
                            "Deworming/not deworming during MDA" = "dewor",
                            "Immunize/not immunize children" = "immuniz")) 




baseline.data %>% 
  select(matches("^(praise|stigma)_[^_]+$")) %>% 
  gather(key = key, value = response) %>% 
  separate(key, c("praise.stigma", "topic"), "_") %>% 
  separate(topic, c("topic", "question.group"), -2) %>% 
  filter(!is.na(response))  %>%
  count(praise.stigma, topic, response) %>% 
  group_by(praise.stigma, topic) %>% 
  mutate(n = n/sum(n)) %>%
  mutate_at(vars(praise.stigma, response), ~ fct_relabel(factor(.), str_to_title)) %>% 
  mutate(topic = fct_recode(factor(topic), 
                            "Wearing/not wearing nice clothes to church" = "clothe",
                            "Use Latrine/open defecation" = "defecat",
                            "Deworming/not deworming during MDA" = "dewor",
                            "Immunize/not immunize children" = "immuniz")) %>% 
  ggplot(aes(response, fill = fct_rev(response))) +
  geom_col(aes(y = n), alpha = 0.5) +
  labs(y = "Share of Respondents", x = "") +
  scale_y_continuous(breaks = seq(0.25, 1, 0.25)) +
  coord_flip() +
  facet_grid(topic ~ praise.stigma, labeller = label_wrap_gen(width = 20)) +
  theme_bw() +
  theme(legend.position = "bottom",
      strip.text.y = element_text(angle = 0), 
      strip.background = element_rect(colour = NA), 
      panel.border = element_blank()) +
  guides(fill = "none") +
  scale_fill_grey(start = 0.2, end = 0.5)

```

#### Distance Randomisation ####
```{r}
#| dist-plot,
#| fig.cap="Distance to Treatment Location (meters)",
#| fig.note="This graph shows a density plot of distance to the assigned point of
#|  treatment from each cluster centroid and household location. Clusters assigned to 
#|  the close condition have greater density <1.25km whilst those assigned to the 
#|  far condition place greater density >1.25km. 
#|  Density estimates use all 9,805 surveyed individuals in the takeup sample."




analysis_data %>%  
  mutate(assigned.treatment = fct_relabel(assigned.treatment, str_to_title)) %>% 
  ggplot(aes(dist.to.pot)) +
  geom_density(aes(
    color = dist.pot.group
    # fill = dist.pot.group,
    ),
               data = mutate(village.centers, assigned.treatment = fct_relabel(assigned.treatment, str_to_title))) +
  geom_vline(xintercept = c(1250), linetype = "dashed") +
  labs(y = "Density", ) +
  scale_x_continuous("Distance to Treatment Location (meters)", breaks = seq(0, 10000, 2500/4)) +
  scale_color_discrete("Cluster Distance Assignment", labels = c("Close", "Far")) +
  facet_wrap(~ assigned.treatment) +
  theme_minimal() +
  theme(legend.position = "bottom")

```


```{r}
#| dist-hist,
#| fig.cap="Distance to Treatment Location (meters)",
#| fig.note="This graph shows a histogram plot of distance to the assigned point of
#|  treatment from each cluster centroid and household location. Clusters assigned to 
#|  the close condition have greater density <1.25km whilst those assigned to the 
#|  far condition place greater density >1.25km. 
#|  Density estimates use all 9,805 surveyed individuals in the takeup sample."

analysis_data %>%  
  mutate(assigned.treatment = fct_relabel(assigned.treatment, str_to_title)) %>% 
  ggplot(aes(dist.to.pot)) +
  geom_histogram(
    
    color = "black",
    aes(
    # color = dist.pot.group, 
    fill = dist.pot.group),
               data = mutate(village.centers, assigned.treatment = fct_relabel(assigned.treatment, str_to_title))) +
  geom_vline(xintercept = c(1250), linetype = "dashed") +
  labs(y = "Count") +
  scale_x_continuous("Distance to Treatment Location (meters)", breaks = seq(0, 10000, 2500/4)) +
  scale_fill_discrete("Cluster Distance Assignment", labels = c("Close", "Far")) +
  facet_wrap(~ assigned.treatment) +
  theme_minimal() +
  theme(legend.position = "bottom")


```

#### Belief Facet Plots ####

```{r}
#| fob-belief-facet,
#|  fig.cap="First Order Belief Levels and Average Treatment Effects",
#|  fig.note="This plot shows first estimates using the first order beliefs 
#|   binomial model. Total sample size: 999 observations at the individual level."

plot_1ord_beliefs_est <- function(beliefs_results, 
                             top_title = NULL, 
                             width = 0.3, 
                             crossbar_width = 0.2) {
  pos_dodge <- position_dodge(width = width)

  first_plot <- beliefs_results$prob_knows %>% 
    filter(ord == 1) %>% 
    ggplot(aes(y = assigned_treatment, group = assigned_dist_group)) +
    geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = assigned_dist_group), position = pos_dodge, size = 0.4) +
    geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = assigned_dist_group), position = pos_dodge, fatten = 2, size = 0.4, width = crossbar_width) +
    geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = assigned_dist_group), position = pos_dodge, alpha = 0.4, size = 2.5) +
    geom_point(aes(x = per_0.5, color = assigned_dist_group), position = pos_dodge, size = 1.8) +
    geom_point(aes(x = per_0.5), position = pos_dodge, color = "white", size = 0.6) +
    scale_color_canva("", labels = str_to_title, palette = canva_palette_vibrant) + 
    scale_y_discrete("", labels = str_to_title) +
    labs(
      title = "",
      subtitle = "Proportion",
      x = "") +
    labs(x = "Proportion (%)") +
    scale_x_continuous(
      labels = scales::label_percent(suffix = "")
    )  +
    theme(legend.position = "top") +
    NULL
  
  cowplot::plot_grid(
    if (!is_null(top_title)) { 
      cowplot::ggdraw() +
        cowplot::draw_label(top_title, size = 20, fontface = "italic")
    },
    
    cowplot::plot_grid(
      first_plot +
        theme(
          legend.position = "none"
        ) +
        NULL,
      
      beliefs_results$ate_knows %>% 
        filter(ord == 1, assigned_dist_group_left == assigned_dist_group_right) %>% 
        ggplot(aes(y = assigned_treatment_left, group = assigned_dist_group_left)) +
        geom_vline(xintercept = 0, linetype = "dotted") +
        geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = assigned_dist_group_left), position = pos_dodge, size = 0.3) +
        geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = assigned_dist_group_left), position = pos_dodge, fatten = 2, size = 0.4, width = crossbar_width) +
        geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = assigned_dist_group_left), position = pos_dodge, alpha = 0.4, size = 2.25) +
        geom_point(aes(x = per_0.5, color = assigned_dist_group_left), position = pos_dodge, size = 1.8) +
        geom_point(aes(x = per_0.5), position = pos_dodge, color = "white", size = 0.6) +
        scale_y_discrete(drop = FALSE) +
        scale_color_canva("", labels = str_to_title, palette = canva_palette_vibrant) + 
        labs(
          title = "",
          subtitle = "Treatment Effect",
          x = "", y = "") +
    labs(x = "Proportion (%)") +
    scale_x_continuous(
      labels = scales::label_percent(suffix = "")
    )  +
        theme(
          axis.text.y = element_blank(),
          legend.position = "none"
        ) +
        NULL,
        ncol = 2, axis = "b", align = "h" 
    ),
    
    cowplot::get_legend(first_plot),
    ncol = 1, rel_heights = c(if (!is_null(top_title)) 0.1 else 0, 1, 0.08)
  )
}

dist_fit_data %>%
  filter(fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_LINEAR_U_SHOCKS")) %>%
  pull(beliefs_results) %>%
  first() %>%
# beliefs_results %>%
  plot_1ord_beliefs_est( )
```


#### Beliefs Plots ####
```{r}
#| belief-1ord-ate,
#|  fig.cap="First Order Belief Average Treatment Effects",
#|  fig.note="This plot shows first estimates using the first order beliefs 
#|   binomial model. Total sample size: 999 observations at the individual level."

belief_data = dist_fit_data %>%
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  pull(beliefs_results) %>%
  first() 

#### Separate Beliefs ####
belief_te_1ord = belief_data$ate_knows %>%
  filter(assigned_treatment_left != "control") %>%
  mutate(assigned_treatment_left = fct_drop(assigned_treatment_left)) %>%
  mutate(assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title)) %>%
  plot_single_beliefs_est(
    width = 0.7, 
    order = 1,
    crossbar_width = 0.4) +
  labs(
    title = "", 
    x = "Proportion (%)"
    ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  ) +
  theme_minimal() + 
  theme(legend.position = "bottom") + 
    NULL

belief_te_1ord

ggsave(
  plot = belief_te_1ord + labs(subtitle = "Treatment Effects"),
  file.path(
    output_basepath, 
    str_glue("belief-te-1ord-plots.pdf")), 
    width = 8, height = 6, dpi = 500)
```


```{r}
#| belief-2ord-ate,
#|  fig.cap="Second Order Belief Average Treatment Effects",
#|  fig.note="This plot shows first estimates using the second order beliefs 
#|   binomial model. Total sample size: 999 observations at the individual level."

belief_te_2ord = belief_data$ate_knows %>%
  filter(assigned_treatment_left != "control") %>%
  mutate(assigned_treatment_left = fct_drop(assigned_treatment_left)) %>%
  mutate(assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title)) %>%
  plot_single_beliefs_est(
    width = 0.7, 
    order = 2,
    crossbar_width = 0.4) +
    labs(title = "", subtitle = "",
    x = "Proportion (%)"
    ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  ) +
  theme_minimal() + 
  theme(legend.position = "bottom") + 
    NULL

belief_te_2ord

ggsave(
  plot = belief_te_2ord + labs(subtitle = "Trteatment Effects"),
  file.path(output_basepath, str_glue("belief-te-2ord-plots.png")), width = 7.5, height = 5.0, dpi = 500)
```


```{r}
#| belief-1ord-prop,
#|  fig.cap="First Order Belief Levels",
#|  fig.note="This plot shows first estimates using the first order beliefs 
#|   binomial model. Total sample size: 999 observations at the individual level."

## Props

belief_1ord_prop_p = belief_data$prob_knows %>%
    mutate(assigned_treatment = fct_drop(assigned_treatment))  %>%
    mutate(assigned_treatment_left = assigned_treatment, assigned_treatment_right = assigned_treatment) %>%
    mutate(assigned_dist_group_left = assigned_dist_group, assigned_dist_group_right = assigned_dist_group) %>%
    mutate(assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title)) %>%
  plot_single_beliefs_est(
    width = 0.7, 
    order = 1,
    crossbar_width = 0.4, 
    vline = FALSE) +
  theme_minimal() + 
  theme(legend.position = "bottom") + 
  labs(
    x = "Proportion (%)"
  ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  )  +
    NULL

belief_1ord_prop_p +
  labs(
    title = "", 
    subtitle = ""
    ) 

ggsave(
  plot = belief_1ord_prop_p + labs(title = "First Order Beliefs", subtitle = "Proportion"),
  file.path(output_basepath, str_glue("belief-prop-1ord-plots.png")), width = 7.5, height = 5.0, dpi = 500)

```




```{r}
#| belief-2ord-prop,
#|  fig.cap="Second Order Belief Levels",
#|  fig.note="This plot shows first estimates using the second order beliefs 
#|   binomial model. Total sample size: 999 observations at the individual level."

belief_2ord_prop_p = belief_data$prob_knows %>%
    mutate(assigned_treatment = fct_drop(assigned_treatment)) %>%
    mutate(assigned_treatment_left = assigned_treatment, assigned_treatment_right = assigned_treatment) %>%
    mutate(assigned_dist_group_left = assigned_dist_group, assigned_dist_group_right = assigned_dist_group) %>%
    mutate(assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title)) %>%
    plot_single_beliefs_est(
    width = 0.7, 
    order = 2,
    crossbar_width = 0.4, 
    vline = FALSE) +
    labs(subtitle = "Proportion") +
  labs(
    x = "Proportion (%)"
  ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  )  +
  theme_minimal() + 
  theme(legend.position = "bottom") + 
    NULL

belief_2ord_prop_p + labs(title = "", subtitle = "")

ggsave(
  plot = belief_2ord_prop_p,
  file.path(output_basepath, str_glue("belief-prop-2ord-plots.png")), width = 7.5, height = 5.0, dpi = 500)
```

#### Belief ATEs combined ####
```{r}
#| belief-1ord-prop-combined,
#|  fig.cap="First Order Belief Levels - Combined",
#|  fig.note="This plot shows estimates using the first order beliefs 
#|   binomial model. Estimates are combined across the close and far condition. 
#|   Total sample size: 999 observations at the individual level."



belief_data_control = belief_data$prob_knows %>%
    filter(assigned_treatment == "control")  %>%
    select(assigned_treatment, assigned_dist_group, iter_data, ord) %>%
    unnest(iter_data)

combined_belief_ate = belief_data$prob_knows %>%
    filter(assigned_treatment != "control") %>%
    select(assigned_treatment, iter_data, ord) %>%
    unnest(iter_data) %>%
    rename(assigned_treatment_left = assigned_treatment) %>%
    left_join(
        belief_data_control %>% 
            rename(assigned_treatment_right = assigned_treatment) %>%
            select(iter_est_right = iter_est, iter_id, ord, assigned_treatment_right),
        by = c("iter_id", "ord")
    ) %>%
    mutate(
        iter_est_te = iter_est - iter_est_right
    )  %>%
    select(-.chain, -.iteration, -.draw) %>%
    nest(iter_data = c(iter_id, iter_est_te, iter_est, iter_est_right)) %>%
    mutate(
        mean_est = map_dbl(iter_data, ~mean(.x$iter_est_te)), 
        quants = map(iter_data, quantilize_est, iter_est_te, quant_probs = quant_probs, na.rm = TRUE)
    )  %>%
    unnest(quants) %>%
    mutate(assigned_dist_group_left = "Combined", assigned_dist_group_right = "Combined") %>%
    mutate(
        assigned_treatment_left = fct_drop(assigned_treatment_left), 
        assigned_treatment_right = fct_drop(assigned_treatment_right)
    )  %>%
    mutate(assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title)) 
combined_belief_prop = belief_data$prob_knows %>%
    select(assigned_treatment, iter_data, ord) %>%
    unnest(iter_data) %>%
    rename(assigned_treatment_left = assigned_treatment) %>%
    select(-.chain, -.iteration, -.draw) %>%
    nest(iter_data = c(iter_id, iter_est)) %>%
    mutate(
        mean_est = map_dbl(iter_data, ~mean(.x$iter_est)), 
        quants = map(iter_data, quantilize_est, iter_est, quant_probs = quant_probs, na.rm = TRUE)
    )  %>%
   unnest(quants) %>%
    mutate(assigned_dist_group_left = "Combined", assigned_dist_group_right = "Combined") %>%
    mutate(
        assigned_treatment_right = fct_drop(assigned_treatment_left)
    )  %>%
    mutate(assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title))

combined_1ord_prop_p = combined_belief_prop %>%
  plot_single_beliefs_est(
    width = 0.7, 
    order = 1,
    crossbar_width = 0.4, 
    vline = FALSE) +
    labs(subtitle = "Proportion") +
    guides(colour = "none") +
  theme_minimal() + 
  theme(legend.position = "bottom") + 
  labs(
    x = "Proportion (%)"
  ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  )  +
    NULL 

combined_1ord_prop_p +
  labs(
    title = "", 
    subtitle = ""
  )

ggsave(
  plot = combined_1ord_prop_p,
    file.path(output_basepath, str_glue("combined-prop-fob.pdf")), 
    width = 7.5, 
    height = 5.0, 
    dpi = 500
    )
```


```{r}
#| belief-2ord-prop-combined,
#|  fig.cap="Second Order Belief Levels - Combined",
#|  fig.note="This plot shows estimates using the second order beliefs 
#|   binomial model. Estimates are combined across the close and far condition. 
#|   Total sample size: 999 observations at the individual level."

combined_belief_2ord_prop_p = combined_belief_prop %>%
  plot_single_beliefs_est(
    width = 0.7, 
    order = 2,
    crossbar_width = 0.4, 
    vline = FALSE) +
    labs(subtitle = "Proportion") +
  theme_minimal() + 
  theme(legend.position = "bottom") + 
    guides(colour = "none") +
  labs(
    x = "Proportion (%)"
  ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  )  +
    NULL

combined_belief_2ord_prop_p +
  labs(title = "", subtitle = "")

ggsave(
  plot = combined_belief_2ord_prop_p,
    file.path(output_basepath, str_glue("combined-prop-sob.pdf")), 
    width = 7.5, 
    height = 5.0, 
    dpi = 500
    )

```


```{r}
#| belief-1ord-ate-combined,
#|  fig.cap="First Order Belief Average Treatment Effects - Combined",
#|  fig.note="This plot shows estimates using the first order beliefs 
#|   binomial model. Estimates are combined across the close and far condition. 
#|   Total sample size: 999 observations at the individual level."

combined_belief_1ord_ate_p = combined_belief_ate %>%
    plot_single_beliefs_est(order = 1)  +
    labs(subtitle = "Treatment Effects") +
  theme_minimal() + 
  labs(
    x = "Proportion (%)"
  ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  )  +
  theme(legend.position = "bottom") + 
    guides(colour = "none") 

combined_belief_1ord_ate_p +
  labs(title = "", subtitle = "")

ggsave(
    plot = combined_belief_1ord_ate_p,
    file.path(output_basepath, str_glue("combined-ate-fob.pdf")), 
    width = 7.5, 
    height = 5.0, 
    dpi = 500
    )

```

```{r}
#| belief-2ord-ate-combined,
#|  fig.cap="Second Order Belief Average Treatment Effects - Combined",
#|  fig.note="This plot shows estimates using the second order beliefs 
#|   binomial model. Estimates are combined across the close and far condition. 
#|   Total sample size: 999 observations at the individual level."

combined_belief_2ord_ate_p = combined_belief_ate %>%
    plot_single_beliefs_est(order = 2)  +
    labs(subtitle = "Treatment Effects") +
  theme_minimal() + 
  labs(
    x = "Proportion (%)"
  ) +
  scale_x_continuous(
    labels = scales::label_percent(suffix = "")
  )  +
  theme(legend.position = "bottom") + 
    guides(colour = "none")

combined_belief_2ord_ate_p + labs(title = "", subtitle = "")

ggsave(
  plot = combined_belief_2ord_ate_p,
    file.path(output_basepath, str_glue("combined-ate-sob.pdf")), 
    width = 7.5, 
    height = 5.0, 
    dpi = 500
    )
```

#### Incentive ATEs ####


```{r}

grab_incentive_ate = function(data, model_type_to_plot, nested_data = est_takeup_te) {

  subset_data = data %>%
    filter(
      (fct_match(model_type, model_type_to_plot))
    ) %>% 
    mutate(
      {{ nested_data }} :=
        map_if({{ nested_data }}, fct_match(model_type, "structural"),
              filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right) %>%
          map(filter,
              (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
              assigned_treatment_left != assigned_treatment_right,
              fct_match(assigned_treatment_right, c("control")),
              fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"))
    )  %>%
    select(model, model_name, {{ nested_data }}, fit_type, model_color) %>% 
    mutate(
      {{ nested_data }} := map(
        {{ nested_data }},
        mutate,
        assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment_left = fct_rev(factor(str_to_title(assigned_treatment_left)))
      )
    ) 
    return(subset_data)
}

```


```{r}

reduced_incentive_level_plot_df = dist_fit_data %>%
    filter(
      (fct_match(model_type, "reduced form"))
    )  %>%
    mutate(est_takeup_level = map_if(est_takeup_level,
        fct_match(fit_type, "prior-predict"), 
        ~mutate(.x, 
          across(
            c(contains("per"), mean_est),
            ~if_else(
              !(fct_match(assigned_treatment,  "bracelet") & is.na(assigned_dist_group)),
              NA_real_,
              .x 
            )
          )
        )
      )
    ) %>%
    mutate(
      est_takeup_level = map(
        est_takeup_level,
        mutate,
        assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
          fct_relabel(str_to_title) %>% 
          fct_relevel("Combined"),
        assigned_treatment = fct_rev(factor(str_to_title(assigned_treatment), 
                                    levels = c("Bracelet",
                                                "Calendar",
                                                "Ink",
                                                "Control")))
        )
        )
        
```

```{r}
#| incentive-levels,
#| fig.cap="Incentive Takeup Levels, Reduced Form Model",
#| fig.note="This plot shows the level of takeup in each treatment condition by 
#|  distance, estimated using a Bayesian probit ('reduced form') model. The prior 
#|  predictive distribution is overlaid at the top of the plot, which shows the 
#|  predicted treatment effects before conditioning on the data. The prior is 
#|  centered at 50\\% takeup and the 90\\% credible interval covers almost the entire
#|  unit interval. The plot shows that deworming takeup is higher in the close condition
#|  and that the bracelet has the highest level amongst the offered treatments.
#|  Line range: 90\\% credible interval. 
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval. 
#|  Point: mean. 9,805 observations from the individual takeup sample used for estimates."


reduced_incentive_level_plot = reduced_incentive_level_plot_df %>%
  plot_estimands(.,est_takeup_level, assigned_treatment, results_group = fit_type) +
    scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
    scale_y_discrete("") +
    # labs(
    #   # title = "Incentive Average Treatment Effect",
    # ) +
    ggforce::facet_col(vars(assigned_dist_group), 
                space = "free",
                scales = "free_y") +
    NULL  +
    guides(colour = "none") +
    theme_minimal() +
    theme(legend.position = "bottom")
reduced_incentive_level_plot +
  labs(caption = "")

ggsave(
  plot = reduced_incentive_level_plot,
  filename = file.path(
    output_basepath,
    "reduced-incentive-level-plot.png"
  ),
  width = 7.5,
  height = 5,
  dpi = 500
)

```



```{r, reduced_incentive_ate_df, eval=TRUE}

reduced_incentive_ate_plot_df = dist_fit_data %>%
  grab_incentive_ate(., model_type_to_plot = "reduced form") 

```

```{r}
#| incentive_ate,
#| fig.cap = "Incentive Average Treatment Effect, Reduced Form Model",
#| fig.note = "Line range: 90\\% credible interval.
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval.
#|  Thick vertical line: median. Point: mean."

reduced_incentive_ate_plot = reduced_incentive_ate_plot_df %>%
  plot_estimands(., 
                 est_takeup_te, 
                 assigned_treatment_left, 
                 results_group = fit_type, 
                 single_prior_predict = TRUE, 
                 top_levels = default_top_levels) +
    scale_x_continuous("", breaks = seq(-0.2, 0.2, 0.05)) +
    scale_y_discrete("") +
    labs(
      # title = "Incentive Average Treatment Effect"
    ) +
    ggforce::facet_col(vars(assigned_dist_group_left), 
                space = "free",
                scales = "free_y") +
    NULL  +
    guides(colour = "none") +
    theme_minimal()

reduced_incentive_ate_plot +
  labs(caption = "")

ggsave(
  plot = reduced_incentive_ate_plot,
  filename = file.path(
    output_basepath,
    "reduced-incentive-ate-plot.png"
  ),
  width = 7.5,
  height = 5,
  dpi = 500
)

```


```{r}
#| signalling-ate,
#| fig.cap="Signalling Average Treatment Effect, Structural Model",
#| fig.note = "This plot shows the average signalling treatment effect estimated
#|  using the structural model. The prior predictive distribution is overlaid at 
#|  the top of the plot, which shows the 
#|  predicted signalling treatment effects before conditioning on the data. The prior is 
#|  centered at a treatment effect of approximately 0. The plot shows that the signalling effect 
#|  is greatest for the ink and bracelet treatments and largest in the far condition.
#|  Line range: 90\\% credible interval.
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval.
#|  Thick vertical line: median. Point: mean. Signalling effect calculated using
#|  structural model incorporating willingness-to-pay, beliefs, and takeup data." 


grab_signalling_ate = function(data, model_type_to_plot, models_we_want) {
  data = data %>% 
    filter(
      (fct_match(model_type, model_type_to_plot) & fct_match(model, models_we_want) )  
    ) %>% 
    select(model, model_name, est_takeup_te, fit_type, model_color) %>% 
    mutate(
      est_takeup_te = map(
        est_takeup_te,
        filter,
        (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
        across(c(assigned_treatment_left, assigned_treatment_right), fct_match, "control"),
        !is.na(mu_assigned_treatment_left),
        fct_match(mu_assigned_treatment_left, "bracelet") | !fct_match(mu_assigned_treatment_right, "calendar"),
        fct_match(mu_assigned_treatment_right, "control"),
      ) %>% 
        map(
          mutate,
          assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
            fct_relabel(str_to_title) %>% 
            fct_relevel("Combined"),
          mu_assigned_treatment_left = fct_rev(factor(str_to_title(mu_assigned_treatment_left))),
        )
    ) 
  return(data)

}

default_ate_limits = c(-0.15, 0.15)

structural_signalling_ate_plot = dist_fit_data %>%
  grab_signalling_ate(., "structural", models_we_want) 

structural_signalling_ate_plot


structural_signalling_ate_plot = dist_fit_data %>%
  grab_signalling_ate(., "structural", models_we_want) %>%
      plot_estimands(., 
                     est_takeup_te, 
                     mu_assigned_treatment_left, 
                     results_group = fit_type,
                     single_prior_predict = TRUE, 
                     top_levels = default_top_levels) +
        scale_x_continuous("", breaks = seq(-0.2, 0.2, 0.05), 
          limits = default_ate_limits
        ) +
        scale_y_discrete("") +
        labs(
          # title = "Signaling Average Treatment Effect",
          # subtitle = str_glue("Holding private incentive at the control level.")
          ) +
        ggforce::facet_col(vars(assigned_dist_group_left), 
                   space = "free",
                   scales = "free_y") +
        guides(colour = "none") +
        NULL
structural_signalling_ate_plot +
  theme_minimal() +
  labs(caption = "")
ggsave(
  plot = structural_signalling_ate_plot,
  filename = file.path(
    output_basepath,
    "structural-signaling-ate-plot.png"
  ),
  width = 7.5,
  height = 5.0,
  dpi = 500
)



```


```{r}
#| incentive-ate,
#| fig.cap="Incentive Average Treatment Effect, Structural Model",
#| fig.note = "This plot shows the average treatment effect estimated
#|  using the structural model. The prior predictive distribution is overlaid at 
#|  the top of the plot, which shows the 
#|  predicted treatment effects before conditioning on the data. The prior is 
#|  centered at a treatment effect of 0 and the 90\\% credible interval covers the 
#|  interval $[-0.125,0.125]$. The plot shows that the treatment effect is greatest
#|  for the bracelet treatment and estimated treatment effects are larger for the 
#|  bracelet at close than far.
#|  Line range: 90\\% credible interval.
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval.
#|  Thick vertical line: median. Point: mean. Treatment effect calculated using
#|  structural model incorporating willingness-to-pay, beliefs, and takeup data." 
default_ate_limits = c(-0.15, 0.15)


structural_incentive_ate_plot = dist_fit_data %>%
  grab_incentive_ate(., model_type_to_plot = "structural") %>%
  filter(model == "STRUCTURAL_LINEAR_U_SHOCKS") %>%
  plot_estimands(., 
                 est_takeup_te, 
                 assigned_treatment_left, 
                 results_group = fit_type, 
                 single_prior_predict = TRUE, 
                 top_levels = default_top_levels) +
    scale_x_continuous(
      "", 
      breaks = seq(-0.2, 0.2, 0.05), 
      limits = default_ate_limits) +
    scale_y_discrete("") +
    labs(
      # title = "Incentive Average Treatment Effect"
    ) +
    ggforce::facet_col(vars(assigned_dist_group_left), 
                space = "free",
                scales = "free_y") +
    NULL  +
    guides(colour = "none") +
    theme_minimal()

structural_incentive_ate_plot +
  labs(caption = "")

ggsave(
  plot = structural_incentive_ate_plot,
  filename = file.path(
    output_basepath,
    "structural-incentive-ate-plot.png"
  ),
  width = 7.5,
  height = 5.0,
  dpi = 500
)

```


```{r}
#| load-wtp


wtp_results <- read_rds(file.path("data", "stan_analysis_data", "wtp_model_fit_results.rds")) 
wtp_prior_results <- read_rds(file.path("data", "stan_analysis_data", "wtp_model_prior_results.rds"))
```

```{r wtp-post}
#| wtp-post,
#| fig.cap="Willingness-To-Pay Estimates",
#| fig.note = "Calendar valued at 47.2KSh more than Bracelet with a 90\\% credibility 
#|  interval of $[41.2, 52.8]$.
#|  Line range: 90\\% credible interval.
#|  Outer box: 80\\% credible interval. Inner box: 50\\% credible interval.
#|  Thick vertical line: median. Point: mean.  Preferences estimated using 998 individuals
#|  with a Bayesian multinomial discrete choice model using a Probit likelihood."



joint_wtp_results <- dist_fit_data %>%
  filter(fct_match(fit_type, "fit") & fct_match(model_type, "structural") & fct_match(model, "STRUCTURAL_LINEAR_U_SHOCKS")) %>%
  pull(wtp_results) %>%
  first()

plot_wtp_results <- function(draws) {
  cowplot::plot_grid(


    filter(draws, fct_match(variable, "prob_prefer_calendar")) %>% 
      left_join(tibble(index = 1:21, val_diff = -seq(-100, 100, 10)), by = "index") %>% 
      ggplot(aes(x = val_diff)) +
      geom_line(aes(y = per_0.5, color = fit_type), show.legend = FALSE) +
      geom_point(aes(y = per_0.5, color = fit_type), size = 1, show.legend = FALSE) +
      geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = fit_type), alpha = 0.4, show.legend = FALSE) +
      scale_x_continuous("Added Value [KSh]", breaks = seq(-100, 100, 10)) + #, labels = scales::label_number(suffix = " KSh")) +
      scale_color_manual("", values = c("joint" = "black", "alone" = "red"), aesthetics = c("color", "fill")) +
      theme_minimal() +
      labs(
        title = "Probability of Choosing Calendars Over Bracelets",
        y = "" 
      ) +
      ylim(0, 1) +
      NULL,
    
    # filter(draws, fct_match(variable, "strata_wtp_mu")) %>%
    filter(draws, fct_match(variable, "hyper_wtp_mu")) %>%
      mutate(across(c(starts_with("per_"), mean_est), multiply_by, 100)) %>%
      # ggplot(aes(y = str_c(variable, index))) +
      ggplot(aes(y = str_c(fit_type))) +
      geom_linerange(aes(xmin = per_0.25, xmax = per_0.75, color = fit_type), alpha = 0.4, size = 3, show.legend = FALSE) +
      geom_crossbar(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = fit_type), fatten = 2, size = 0.4, width = 0.2, show.legend = FALSE) +
      geom_linerange(aes(xmin = per_0.05, xmax = per_0.95, color = fit_type), size = 0.4, show.legend = FALSE) +
      geom_point(aes(x = mean_est, color = fit_type), size = 2, show.legend = FALSE) +
      geom_point(aes(x = mean_est, color = fit_type), color = "white", size = 0.8, show.legend = FALSE) +
      scale_color_manual("", values = c("joint" = "black", "alone" = "red"), aesthetics = c("color", "fill")) +
      scale_x_continuous(limits = c(-100, 100), breaks = seq(-100, 100, 10)) +
      # coord_cartesian(xlim = c(-55, 55)) +
      theme_minimal() +
      theme(axis.text.y = element_blank()) +
      labs(
        title = "Difference in Valuation of Calendars and Bracelets",
        # subtitle = "For Each County",
        x = "KSh",
        y = "",
        # caption = "Line range: 90% credible interval. Outer box: 80% credible interval. Inner box: 50% credible interval.
        #            Thick vertical line: median. Point: mean."
      ) +
      # xlim(-100, 100) +
      NULL
      ,
    
    ncol = 1 , rel_heights = c(1, 0.6)
  )
}

joint_wtp_results %>%
  mutate(fit_type = "joint") %>%
    filter(., fct_match(variable, "prob_prefer_calendar")) %>% 
      left_join(tibble(index = 1:21, val_diff = -seq(-100, 100, 10)), by = "index") %>% 
      ggplot(aes(x = val_diff)) +
      geom_line(aes(y = per_0.5, color = fit_type), show.legend = FALSE) +
      geom_point(aes(y = per_0.5, color = fit_type), size = 1, show.legend = FALSE) +
      geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = fit_type), alpha = 0.4, show.legend = FALSE) +
      scale_x_continuous("Added Value [KSh]", breaks = seq(-100, 100, 10)) + #, labels = scales::label_number(suffix = " KSh")) +
      scale_color_manual("", values = c("joint" = "black", "alone" = "red"), aesthetics = c("color", "fill")) +
      theme_minimal() +
      labs(
        title = "Probability of Choosing Calendars Over Bracelets",
        y = "" 
      ) +
      ylim(0, 1) +
      NULL

# joint_wtp_results %>% 
#   mutate(fit_type = "joint") %>% 
#   plot_wtp_results() 

joint_wtp_results %>%
    filter(., fct_match(variable, "hyper_wtp_mu")) %>%
      mutate(across(c(starts_with("per_"), mean_est), multiply_by, 100)) %>%
      select( 
        valuation_diff_estimate = per_0.5,
        conf.low = per_0.05, 
        conf.high = per_0.95
      )


```



#### Distance Prob Plots ####


```{r}
#| structural-dist-prop-plot,
#| fig.cap="Structural Model Estimates of Take-up Probability by Distance", 
#| fig.note="This plot shows estimated take-up probability across bracelet and 
#|  control over distance. Take-up probability is calculated using the structural 
#|  model's estimates of $w^*$ in each cluster and taking the complement of the Gaussian CDF 
#|  evalutaed at $w^*$. The sample consists of TODO. Outer ribbon: 90\\% credibility interval,
#|  inner ribbon: 50\\% credibility interval."
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_LINEAR_U_SHOCKS")) %>% #, "STRUCTURAL_LINEAR_U_SHOCKS_NO_SUBMODELS"))) %>%
  transmute(
    model_name,
    cluster_takeup_prop = map(cluster_takeup_prop, ~ mutate(.x, roc_distance = roc_distance / 1000)),
    obs_cluster_takeup_level,
  ) %>% 
  unnest(cluster_takeup_prop) %>%
  select(assigned_treatment)


dist_prob_plot <- dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_LINEAR_U_SHOCKS")) %>% #, "STRUCTURAL_LINEAR_U_SHOCKS_NO_SUBMODELS"))) %>%
  transmute(
    model_name,
    cluster_takeup_prop = map(cluster_takeup_prop, ~ mutate(.x, roc_distance = roc_distance / 1000)),
    obs_cluster_takeup_level,
  ) %>% 
  mutate(cluster_takeup_prop = map(
    cluster_takeup_prop, 
    filter, 
    assigned_treatment %in% c("control", "bracelet")
    ),
    obs_cluster_takeup_level = map(
      obs_cluster_takeup_level,
      filter, 
      assigned_treatment %in% c("control", "bracelet")
    )
    ) %>%
  ggplot(aes(roc_distance)) +
  geom_line(aes(y = per_0.5, color = assigned_treatment), data = . %>%  unnest(cluster_takeup_prop)) +
  geom_ribbon(aes(ymin = per_0.25, ymax = per_0.75, fill = assigned_treatment), alpha = 0.3, data = . %>%  unnest(cluster_takeup_prop)) +
  geom_ribbon(aes(ymin = per_0.05, ymax = per_0.95, fill = assigned_treatment), alpha = 0.3, data = . %>%  unnest(cluster_takeup_prop)) +
  geom_rug(
    aes(dist, color = assigned_treatment),
    alpha = 0.5,
    data = rf_analysis_data %>%
      distinct(cluster_id, assigned.treatment, dist = cluster.dist.to.pot / 1000) %>% 
      rename(assigned_treatment = assigned.treatment)  %>%
      filter(assigned_treatment %in% c("control", "bracelet"))
  ) +
  labs(
    x = "Distance to Treatment (d) [km]", y = latex2exp::TeX("Take-up Probability, $1 - F_w(w^*(z,d))$") ,
    # caption = "Line: Median. Outer ribbon: 80% credible interval. Inner ribbon: 50% credible interval." 
  ) +
  coord_cartesian(xlim = c(0, 2.5), ylim = c(0, 0.55)) +
  NULL

dist_prob_plot +
  # geom_linerange(aes(assigned_dist_obs / 1000, ymin = per_0.1, ymax = per_0.9, color = assigned_treatment), data = . %>% unnest(obs_cluster_takeup_level)) +
  geom_point(aes(assigned_dist_obs / 1000, y = obs_prop_takeup, colour = assigned_treatment), size = 0.5, show.legend = FALSE, data = . %>% unnest(obs_cluster_takeup_level)) +
  scale_color_discrete("", labels = str_to_title, aesthetics = c("color", "fill")) +
  # facet_wrap(vars(assigned_treatment), labeller = labeller(assigned_treatment = str_to_title)) +
  # facet_grid(rows = vars(assigned_treatment), cols = vars(model_name), labeller = labeller(.default = str_to_title)) +
  theme(legend.position = "bottom") +
  NULL

```