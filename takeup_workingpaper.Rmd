---
title: |
    | Social Signaling and Prosocial Behavior
    | Experimental Evidence in Community Deworming in Kenya^[This study was funded by the Children's Investment Fund Foundation and implemented by Evidence Action. We thank Guillaume Kroll, the study's project manager; Arthur Baker, our research assistant; Doris Njomo and Rosemary Musuva for their qualitative research input during the study's pilot; Carol Nekesa and her implementation and data collection team; Ned Augenblick, Edward Miguel and Stefano DellaVigna for their research advice; Supreet Kaur, Dmitry Taubinsky, Seema Jayachandran, Nancy Qian and seminar participants at Berkeley, Northwestern Rookiefest, Oxford CSAE Conference 2018 and PacDev 2018 for helpful discussions and feedback; and Karen Levy and Grace Hollister for their advice and support. We received Internal Review Board clearance from the Kenya Medical Research Institute and the University of California Berkeley. The study pre-analysis plan was registered with the American Economic Association registry (<https://www.socialscienceregistry.org/trials/1643/history/17782>).]
date: "January 2020"
subtitle: "Please find the latest version of the paper [here](https://drive.google.com/file/d/164wP0_dqOFfKvUenHVixlY3Js7oFPFhg/view)"
author:
- Anne Karing^[Princeton University, `akaring@princeton.edu`.]
- Karim Naguib^[`karim.a.naguib@gmail.com`.]
output: 
  pdf_document:
    number_sections: yes
    fig_caption: yes
    keep_tex: no
    pandoc_args: "commonrmd.yaml"
    includes:
      in_header: takeup_workingpaper_header.sty
abstract: "Can social image concerns motivate adults to internalize health externalities? In collaboration with the Kenyan Government, we implement a new community program that offers free deworming treatment to 200,000 adults and emphasizes the public good aspect of deworming. Importantly, we randomize the introduction of two types of social signals in the form of colorful bracelets and ink applied to the thumb. The bracelets and ink allow adults to signal that they contributed to protecting their community from worms. Further, we exogenously vary the travel distance to treatment locations. To separate reputational utility from private consumption utility and social learning/salience, we combine experimental identification with a structural model's non-experimental identification. We find that (1) bracelets as signals increase deworming take-up by roughly 13 percent, net the private consumption and learning/salience effects; (2) there is no detectable effect for the ink signal, which we attribute to its private disutility which outweighs any reputational utility from signaling; (3) adults are highly sensitive to distance but signaling treatments see little change; (4) the rate-of-change in take-up in response to increased distance is negligibly small compared against the control.  Detailed survey data on first and second-order beliefs shed light on the underlying mechanism: signals reduce information asymmetries, and adults are more likely to think that others have information about their deworming decision."
nocite: |
  @R
urlcolor: blue
bibliography: /home/karim/Documents/library.bib
---

<!-- abstract: "Can social image concerns motivate adults to internalize health externalities? In collaboration with the Kenyan Government, we implement a new community program that offers free deworming treatment to 200,000 adults and emphasizes the public good aspect of deworming. Importantly, we randomize the introduction of two types of social signals in the form of colorful bracelets and ink applied to the thumb. The bracelets and ink allow adults to signal that they contributed to protecting their community from worms. To separate social signaling preferences from reminder and learning effects, we offer free text messages to a random subset of adults. Further, we exogenously vary the travel distance to treatment locations. We find that (1) bracelets as signals increase deworming take-up by 24 percent, outperforming a material incentive; (2) the effects are not due to pure reminder or learning effects; (3) there is no detectable effect for the ink signal, which we attribute to its lower visibility; (4) adults are highly sensitive to distance and both signaling treatments have a larger impact on take-up at far distances. The latter finding is consistent with the theoretical prediction that signaling returns increase as signals become more informative. Detailed survey data on first and second-order beliefs shed light on the underlying mechanism: signals reduce information asymmetries, and adults are more likely to think that others have information about their deworming decision." -->

\newpage

```{r workingpaper-setup, include=FALSE}
library(plyr)
library(magrittr)
library(lubridate)
library(forcats)
library(broom)
library(ggrepel)
library(ggmap)
library(ggstance)
library(gridExtra)
library(cowplot)
library(rgeos)
library(sp)
library(rgdal)
library(knitr)
library(modelr)
library(car)
library(rstan)
library(tidyverse)
library(latex2exp)

library(econometr)

source(file.path("rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
source("analysis_util.R")

knitr::read_chunk("analysis_util.R", labels = "analysis-util")

knit_hooks$set(document = function(x) {sub('\\usepackage[]{color}', '\\usepackage[table,dvipsnames]{xcolor}', x, fixed = TRUE)})

read_chunk(purl("takeup_analysis2.Rmd")) 

# read_chunk(purl("takeup_bayesian_analysis.Rmd")) 

options(dplyr.show_progress = FALSE, digits = 4, knitr.kable.NA = '')

opts_chunk$set(echo = FALSE, warning = FALSE, 
               cache = TRUE, cache.path = "takeup_workingpaper-cache/", 
               fig.path = "takeup_workingpaper-fig/", fig.align = "center")
```

```{r proj4}
wgs.84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
kenya.proj4 <- "+proj=utm +zone=36 +south +ellps=clrk80 +units=m +no_defs"
```

```{r model-versions}
static_fit_version <- "param_static_2962857" # Name matched and SMS
dyn_fit_version <- "param_dynamic_2330870" # Strata level only with cluster RE
```

```{r ggplot-theme, cache=FALSE}
theme_set(theme_minimal() +
            theme(legend.position = "bottom",
                  panel.border = element_rect(colour = "darkgrey", fill = NA))) 
```

```{r load-experiment-design-data}
rct.schools.data <- read_rds(file.path("data", "takeup_rct_schools.rds"))
rct.cluster.selection <- read_rds(file.path("data", "rct_cluster_selection_2.0.rds"))
cluster.strat.data <- read_rds(file.path("data", "takeup_processed_cluster_strat.rds"))

load(file.path("data", "takeup_village_pot_dist.RData"))
```

```{r load-analysis-data}
load(file.path("data", "analysis.RData"))
```

```{r load-processed-dist-fit, cache=TRUE}
load(file.path("temp-data", "processed_dist_fit27.RData"))

dist_fit_data %<>% 
  left_join(distinct(., model) %>% 
              mutate(model_color = RColorBrewer::brewer.pal(n(), "Dark2")),
            by = "model") %>% 
  bind_rows(
    filter(., fct_match(model, c("STACKED", "STRUCTURAL_STACKED"))) %>% 
      mutate(fit_type = factor("prior-predict")) %>% 
      mutate_at(vars(starts_with("est_takeup")), map, mutate_at, vars(starts_with("per_"), mean_est), ~ per_0.5) # Add fake prior-predict so plots align/dodge properly
  )

dist_fit_data %<>% 
  select(fit_type, model, model_name, model_type, model_color, starts_with("stacking_weight"), contains("elpd"), starts_with("est"), contains("y_rate_of_change")) %>% 
  mutate_if(~ is.list(.x), map_if, ~ !is_empty(.x), ~ select(.x, -one_of("iter_data")))

plot_estimands <- function(.data, y, include_prior_predict = FALSE) {
  plot_pos <- position_dodgev(height = 0.8)
  
  ggplot_obj <- if (include_prior_predict) {
    ggplot(.data, aes(x = per_0.5, y = {{ y }}, group = model)) +
      ggstance::geom_linerangeh(aes(xmin = per_0.05, xmax = per_0.95, group = model), alpha = 0.15, fatten = 3, size = 10, position = plot_pos, data = . %>% filter(fct_match(fit_type, "prior-predict"))) +
      ggstance::geom_linerangeh(aes(xmin = per_0.05, xmax = per_0.9, group = model), alpha = 0.1, fatten = 3, size = 6, position = plot_pos, data = . %>% filter(fct_match(fit_type, "prior-predict"))) +
      ggstance::geom_linerangeh(aes(xmin = per_0.05, xmax = per_0.5, group = model), alpha = 0.1, fatten = 3, size = 4, position = plot_pos, data = . %>% filter(fct_match(fit_type, "prior-predict"))) +
      NULL
  } else {
    ggplot(.data, aes(x = per_0.5, y = {{ y }}, group = model)) 
  }
  
  ggplot_obj +
    ggstance::geom_linerangeh(aes(xmin = per_0.25, xmax = per_0.75, color = model), alpha = 0.4, size = 3, position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) +
    ggstance::geom_crossbarh(aes(x = per_0.5, xmin = per_0.1, xmax = per_0.9, color = model), fatten = 0, size = 0.4, width = 0.5, position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) +
    ggstance::geom_linerangeh(aes(xmin = per_0.05, xmax = per_0.95, color = model), size = 0.4, position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) + 
    
    # ggstance::geom_crossbarh(aes(xmin = per_0.25, xmax = per_0.75, color = model), size = 0.7, alpha = 0.05, width = 0.25, position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) +
    # ggstance::geom_crossbarh(aes(xmin = per_0.1, xmax = per_0.9, color = model), size = 0.7,  width = 0.4, position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) +
    # ggstance::geom_linerangeh(aes(xmin = per_0.05, xmax = per_0.95, color = model), size = 0.7, fatten = 3, size = 0.8, position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) +
    geom_point(aes(x = mean_est, color = model), position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) +
    geom_point(aes(x = mean_est), color = "white", size = 0.75, position = plot_pos, data = . %>% filter(fct_match(fit_type, "fit"))) +
    geom_vline(xintercept = 0, linetype = "dotted") +
    scale_color_manual("Model", 
                       values = select(dist_fit_data, model, model_color) %>% deframe(), 
                       labels = dist_fit_data %>% select(model, model_name) %>% deframe(), aesthetics = c("color", "fill")) + 
    labs(
      caption = #"Dotted line range: 98% credible interval. 
                "Line range: 90% credible interval. 
                 Outer box: 80% credible interval. Inner box: 50% credible interval. 
                 Thick vertical line: median. Point: mean."
      
    ) +
    theme(legend.position = "top", legend.direction = "vertical") +
    guides(color = guide_legend(ncol = 3)) +
    NULL
}
```

```{r estimands, cache=FALSE}
bracelet_vs_control_ate_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "bracelet"), 
                        fct_match(assigned_treatment_right, "control"), 
                        mu_assigned_treatment_left == assigned_treatment_left, 
                        mu_assigned_treatment_right == assigned_treatment_right, 
                        is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
                        prob = 0.8) 

bracelet_vs_calendar_close_ate_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "bracelet"), 
                        fct_match(assigned_treatment_right, "calendar"), 
                        mu_assigned_treatment_left == assigned_treatment_left, 
                        mu_assigned_treatment_right == assigned_treatment_right, 
                        fct_match(assigned_dist_group_left, "close"), fct_match(assigned_dist_group_right, "close"),
                        prob = 0.8) 

bracelet_vs_calendar_far_ate_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "bracelet"), 
                        fct_match(assigned_treatment_right, "calendar"), 
                        mu_assigned_treatment_left == assigned_treatment_left, 
                        mu_assigned_treatment_right == assigned_treatment_right, 
                        fct_match(assigned_dist_group_left, "far"), fct_match(assigned_dist_group_right, "far"),
                        prob = 0.8) 

bracelet_vs_control_struct_ate_ci <- 
  str_credible_interval(dist_fit_data, "STRUCTURAL_STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "control"), 
                        fct_match(assigned_treatment_right, "control"), 
                        fct_match(mu_assigned_treatment_left, "bracelet"),
                        fct_match(mu_assigned_treatment_right, "control"),
                        is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
                        prob = 0.8) 

calendar_vs_control_ate_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "calendar"), 
                        fct_match(assigned_treatment_right, "control"), 
                        mu_assigned_treatment_left == assigned_treatment_left, 
                        mu_assigned_treatment_right == assigned_treatment_right, 
                        is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
                        prob = 0.8) 

calendar_vs_control_struct_ate_ci <- 
  str_credible_interval(dist_fit_data, "STRUCTURAL_STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "control"), 
                        fct_match(assigned_treatment_right, "control"), 
                        fct_match(mu_assigned_treatment_left, "calendar"),
                        fct_match(mu_assigned_treatment_right, "control"),
                        is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
                        prob = 0.8) 


ink_vs_control_ate_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "ink"), 
                        fct_match(assigned_treatment_right, "control"), 
                        mu_assigned_treatment_left == assigned_treatment_left, 
                        mu_assigned_treatment_right == assigned_treatment_right, 
                        is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
                        prob = 0.8) 

ink_vs_control_struct_ate_ci <- 
  str_credible_interval(dist_fit_data, "STRUCTURAL_STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "control"), 
                        fct_match(assigned_treatment_right, "control"), 
                        fct_match(mu_assigned_treatment_left, "ink"),
                        fct_match(mu_assigned_treatment_right, "control"),
                        is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
                        prob = 0.8) 

bracelet_vs_control_ate_mean <-
  str_mean(dist_fit_data, "STACKED", est_takeup_te, 
           fct_match(assigned_treatment_left, "bracelet"), 
           fct_match(assigned_treatment_right, "control"), 
           mu_assigned_treatment_left == assigned_treatment_left, 
           mu_assigned_treatment_right == assigned_treatment_right, 
           is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
           round_by = NA)

bracelet_vs_calendar_ate_mean <-
  str_mean(dist_fit_data, "STACKED", est_takeup_te, 
           fct_match(assigned_treatment_left, "bracelet"), 
           fct_match(assigned_treatment_right, "calendar"), 
           mu_assigned_treatment_left == assigned_treatment_left, 
           mu_assigned_treatment_right == assigned_treatment_right, 
           is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
           round_by = NA)

control_level_mean <-
  str_mean(dist_fit_data, "STACKED", est_takeup_level, 
           fct_match(assigned_treatment, "control"), 
           mu_assigned_treatment == assigned_treatment, 
           is.na(assigned_dist_group),
           round_by = NA)

control_close_level_mean <-
  str_mean(dist_fit_data, "STACKED", est_takeup_level, 
           fct_match(assigned_treatment, "control"), 
           mu_assigned_treatment == assigned_treatment, 
           fct_match(assigned_dist_group, "close"),
           round_by = NA)

bracelet_vs_calendar_ate_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "bracelet"), 
                        fct_match(assigned_treatment_right, "calendar"), 
                        mu_assigned_treatment_left == assigned_treatment_left, 
                        mu_assigned_treatment_right == assigned_treatment_right, 
                        is.na(assigned_dist_group_left), is.na(assigned_dist_group_right),
                        prob = 0.8) 

control_close_level_mean <-
  str_mean(dist_fit_data, "STACKED", est_takeup_level, 
           fct_match(assigned_treatment, "control"), 
           mu_assigned_treatment == assigned_treatment, 
           fct_match(assigned_dist_group, "close"),
           round_by = NA)

control_distance_diff_mean <- 
  str_mean(dist_fit_data, "STACKED", est_takeup_te, 
           fct_match(assigned_treatment_left, "control"), 
           fct_match(assigned_treatment_right, "control"),
           fct_match(assigned_dist_group_left, "far"),
           fct_match(assigned_dist_group_right, "close"),
           round_by = NA)
           

control_distance_diff_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_te, 
                        fct_match(assigned_treatment_left, "control"), 
                        fct_match(assigned_treatment_right, "control"),
                        fct_match(assigned_dist_group_left, "far"),
                        fct_match(assigned_dist_group_right, "close"),
                        prob = 0.8) 

bracelet_distance_diff_diff_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_dist_te, 
                        fct_match(assigned_treatment_left, "bracelet"), 
                        fct_match(assigned_treatment_right, "control"), 
                        prob = 0.8) 

ink_distance_diff_diff_ci <- 
  str_credible_interval(dist_fit_data, "STACKED", est_takeup_dist_te, 
                        fct_match(assigned_treatment_left, "ink"), 
                        fct_match(assigned_treatment_right, "control"), 
                        prob = 0.8) 

bracelet_distance_diff_diff_per_0.25 <- 
  str_percentile(dist_fit_data, "STACKED", est_takeup_dist_te, 
                 fct_match(assigned_treatment_left, "bracelet"), 
                 fct_match(assigned_treatment_right, "control"), 
                 per = 0.25) 

ink_distance_diff_diff_per_0.25 <- 
  str_percentile(dist_fit_data, "STACKED", est_takeup_dist_te, 
                 fct_match(assigned_treatment_left, "ink"), 
                 fct_match(assigned_treatment_right, "control"), 
                 per = 0.25) 
```

# Introduction

<!-- Motivation and research question -->
Externalities play an important role in many health behaviors. Prominent examples are deworming, smoking, open defecation and vaccination. Individuals frequently undervalue the social costs and benefits of their actions and under-invest in public goods like deworming. There is an extensive theoretical literature on the role of social signaling and image concerns [@Bernheim1994; @Benabou2006;@Benabou2012a]. Recent field experiments show that social image concerns affect important behaviors, such as consumption, the decision to vote, and student effort [@Dellavigna2017; @Bursztyn2017a; @Bursztyn2015]. However, empirical evidence from field settings in low-income countries is scarce. Developing countries are a particularly important context, since formal enforcement mechanisms are often missing to produce efficient contributions to public goods and signaling incentives could be an inexpensive substitute.^[For example, the United States and Germany have laws that require children to be immunized in order to attend daycare. There is an extensive literature showing the effectiveness of material and financial incentives in encouraging positive health behaviors [@Thornton2008; @Banerjee2010;@Sato2015] However, governments often raise concerns about the scalability and financial sustainability of these incentives.] We chose community deworming, as an empirical setting, to manipulate social signaling concerns. Deworming is a public good for which most of its benefits accrue through reduced disease transmission [@Miguel2004]. Worm infections in adults present a large disease burden as they lead to continuous reinfections among children [@Anderson2013;@Anderson2014;@Truscott2014;@Njenga2011]. In this paper, we ask two questions: Can social signals increase adults' willingness to take up deworming treatment? To what extent do differences in peer take-up affect the reputational returns of signals? 

<!-- Experimental design and identification -->
We answer these questions by implementing a large-scale field experiment that is closely tied to Bénabou and Tirole's theory of social signaling [-@Benabou2006;-@Benabou2012a]. In collaboration with the Kenyan Government, we launch a new community deworming program where health volunteers offer free deworming treatment to over 200,000 adults at central locations (instead of through a traditional door-to-door campaign) over a period of 12 days. We inform adults, prior to the program, about the health benefits of deworming with an explicit emphasis on the public good aspect of treatment. Our main experimental manipulations are (i) to increase the observability of deworming decisions and (ii) to vary the distance that adults have to travel to receive treatment. 

Specifically, we introduce two social signals in the form of a colorful bracelet and ink applied to adults' thumbs, both of which are given to adults upon coming for deworming treatment. As a third treatment, we introduce a private material incentive in the form of a one-page wall calendar that allows us to hold constant the consumption value of the bracelet. We randomize 144 treatment locations and their surrounding communities into the ink, bracelet and calendar treatments or a control group where no incentive is given. 

In addition, we randomly assign the distance communities must cover in order to reach their closest treatment location allowing us to exogenous vary the cost of deworming. Communities are assigned to be either _close_ (less than 1.25 kilometers) or _far_ (between 1.25 and 2.5 kilometers) in terms of distance to deworming treatment. This cost manipulation is critical to our approach in learning about how signaling responds to changes in cost; reputational returns change as an action is perceived as more or less difficult to do.

Our goal is to estimate the treatment effect of social signaling. The experiment identifies the combined effect of social signaling, salience and social learning effects. To separately identify the extent to which deworming decisions are driven by a desire to signal, we use two approaches. First, we use the calendar treatment arm to eliminate the private consumption value from the bracelets' effect. Second, we use a structural model reflecting the theoretical model's data generating process, permitting us to estimate counterfactuals not possible to observe in the experiment, namely holding constant private consumption utility while manipulating the ability to signal. 

<!-- Talk about SMS if the model is added back -->
<!-- The cluster randomization identifies the combined effect of social signaling, salience and social learning effects. To separately identify the extent to which deworming decisions are driven by a desire to signal, we offer free text messages to a small random subset of adults in each of the study communities. The text messages (a) remind individuals of the availability of deworming and (b) provide information about the share of adults that have come for deworming in their community. Lastly, to exogenously vary the cost of deworming, we randomly assign communities to close (less than 1.25 kilometers) or far (between 1.25 and 2.5 kilometers) walking distances to treatment locations. The distance randomization allows us to exogenously shift the level of deworming take-up at community level.  -->

<!-- Summary of results / Data collected -->
We monitor deworming decision of 38,000 adults at the points of treatment, avoiding the reliance on self-reported data on take-up. In addition, we collect detailed survey data on adults' knowledge about deworming, social norm concerns, and first- and second-order beliefs to speak to the mechanisms underlying social signaling. We show that bracelets as signals increased the visibility of deworming decisions, compared to the ink and calendar treatments, and reduced perceived information asymmetries. Adults were significantly more likely to think that others had knowledge about their own deworming decision. The survey data further reveals that adults have a limited understanding of the externalities from deworming, and think of it as "the right thing to do" for a person that looks after their own health. 

For our analysis we build three models to investigate different aspects of the data generating process. To estimate these models we use hierarchical Bayesian statistical models. One of the models is a reduced-form model that uses the experimental intervention to identify treatment effects and the two other models are parametric models that rely on structural assumptions to identify unobservable counterfactuals. Our Bayesian statistical analysis allows for the flexible construction of statistical models accounting for the complexity of the experiment in terms of the population studied (stratification) and experimental treatment; it allows us to conduct a large number of comparisons over the four experiments, using regularization; it allows us to more efficiently learn from the data using partial pooling; and finally it allows us to efficiently average treatment effects over the three statistical models used [@Imbens2015;@Gelman2013a;@stan;@Yao2018].^[Reduced form OLS regression analysis plots are included in Appendix A for comparison.]

<!-- TODO summarize results -->

Averaging the three models' estimation, we find that bracelets have the strongest effect on deworming take-up, with 80% credible interval of `r bracelet_vs_control_ate_ci` percentage points increase, and in terms of (posterior) averages, a `r round(bracelet_vs_control_ate_mean/control_level_mean, 3) * 100` percent change. When compared against the calendar treatment we still see social effect of `r bracelet_vs_calendar_ate_ci` percentage points, a `r round(bracelet_vs_calendar_ate_mean/control_level_mean, 3) * 100` percent increase. For the second signaling treatment, ink, we found no detectable effect: our analysis did not yield an informative credible interval. Averaging over the two structural models, we find that the pure social signaling treatment effect of bracelets, compared to the control arm, is `r bracelet_vs_control_struct_ate_ci` percentage points, and for the ink treatment `r ink_vs_control_struct_ate_ci` percentage points. Ink does have a similar social signaling effect to bracelets, however, it appears to be cancelled out by its private disutility. Calendars are found to have a `r calendar_vs_control_ate_ci` percentage points effect combining all models, and `r calendar_vs_control_struct_ate_ci` percentage points social signaling effect. Both the disutility of ink and the signaling effect of calendars were unexpected. With respect to the effect of signals in response to increasing costs, we do not find that any of the treatments have a significantly different rate-of-change from the control arm, over the observed cost range of the experiment.

<!-- We then build a static and dynamic hierarchical Bayesian model to impute the counterfactuals necessary to estimate the partial effect of social signaling on deworming take-up decisions. Our Bayesian analysis allowed for the flexible construction of statistical models accounting for the complexity of the experiment in terms of the population studied and experimental treatment.[^why-bayes] This allowed us to manage the large number of treatment comparisons, using regularization, while allowing us to efficiently learn from the data using partial pooling [@Imbens2015;@Gelman2013a;@stan].^[Reduced form OLS regression analysis plots are included in Appendix A for comparison.] In the static model, we show that bracelets as signals meaningfully increase individuals' probability to deworm, and that these effects persist when also providing text message reminders and information about others' take-up decisions. Bracelets increase deworming take-up by 8.4 percentage points, a 24 percent increase compared to the control group. We find no detectable effect for the ink incentive, which we attribute to the lower visibility of ink and its strong association with voting in Kenya. Our experiment took place shortly before the presidential election in Kenya, which might have created suspicion among adults. The calendar incentive increased take-up only marginally by 2.7 percentage points. Its effect on take-up is one-third of that of bracelets, despite adults preferring the calendar as consumption item. Building a dynamic model, we explicitly account for potential salience and social learning effects that were introduced as individuals could observe other people's deworming decision. Same as in the static model with the text message treatment, we find no evidence that visibility of actions, through ink or bracelets, affected take-up decisions through reminders or social learning. Lastly, our distance treatment shows that adults are highly sensitive to increases in cost. An increase in the mean walking distance by 1 kilometer leads to a decline in take-up from 44 to 28 percent in the control group. We find that both signals have a larger impact on take-up at far distances, which is consistent with a model of social signaling where returns to signaling increase as signals are more informative about individuals' types.   -->

<!-- [^why-bayes]: These are, -->

<!--     (i) The population studied: treatment was stratified over counties and clustered over villages, and household sampling was stratified over phone-ownership. -->
<!--     (ii) The experimental treatments: four village level incentivization/signaling treatment arms, two village level distance assignment arms, and three individual level SMS treatment arms. -->

<!-- Contribution -->
Our work contributes to the literature of social signaling in four ways. First, we provide direct evidence of the effectiveness of making actions observable through a low-cost signal. Recent empirical studies have highlighted the potential negative effects of visibility like in the case of student effort [@Bursztyn2015] and career ambitions [@Bursztyn2017a]. This study shows how social image concerns can be leveraged to increase public goods. Even in the absence of an understanding of externalities, social signals can increase the direct benefits of deworming - as individuals care to be perceived as doing the ``right thing'' - and as a result by acting in their own best interest, they internalize the interests of others (namely reduce the reinfection risk of children whose health is most affected by worms). 

Second, this study makes a contribution by exogenously varying distance and with that deworming take-up at the community level. Such is in most settings impossible and allows us to investigate the relationship between equilibrium take-up levels, the informativeness of signals and subsequent differences in the impact of signals on individuals' decision to deworm. By generating large exogenous differences in take-up levels, we show that signals have much larger effects at far distances and can undo the negative demand response observed in the control group. We observe no such effect for the material incentive. This result has the potential to inform policy decisions about optimal treatment locations: as reputational returns are higher at far compared to close distances, increasing individuals' willingness to walk, optimal treatment locations can be set up further apart and with the same number of locations larger geographic areas can be covered.  
<!-- Think about this more later in terms of optimal Pigouvian tax, B&T paper; also this claim may need to be substantiated further  -->

Third, we show that the type of signal offered can drastically influence its effectiveness. To our knowledge, this is the first study that simultaneously tests two different signals. Our findings suggest that differences in the perceived salience of signals can translate into large differences in their effectiveness to influence behavior. While ink is a known, well-established signal in Kenya - commonly used for voting - our study highlights that such familiarity does not imply it is transferable as signal to another domain. 

Fourth, this paper is one of two papers (in addition to @Karing2018) that provides the first evidence on social signaling in health, and therefore contributes to a large literature on incentives to increase the use of health services and public goods in low-income settings [@Thornton2008; @Banerjee2010;@Ashraf2012;@Sato2015]. Complementing Karing's [-@Karing2018] findings, our paper demonstrates the potential effectiveness of social signals in an environment with low take-up levels and where a new technology is introduced.^[In our study, take-up of deworming treatment is 36 percent in the control group, compared to 73 percent take-up of vaccine four in the control groups of Karing's study.] 

Lastly, this is one of few studies that directly compares the effect of a material to a social incentive. In line with @Ashraf2012, we show that social signals can outperform a more costly material incentive. Moving beyond existing evidence, our experimental design sheds light on the underlying mechanism and provides convincing evidence for social signaling concerns. 


<!-- Clean this up to fit new sections -->
The remainder of this paper is organized as follows. In Section \ref{empirical-setting}, we describe the setting of the intervention. In Section \ref{theoretical-framework}, we present the structural model to describe individual decision-making in the presence of observability of actions.  In Section \ref{experimental-design}, we describe the experimental design to identify social signaling concerns. Section \ref{descriptive-statistics}, provides descriptive statistics from the experiment. In Section \ref{empirical-models}, we present the empirical Bayesian model. In Section \ref{results} we discuss the results and section \ref{conclusion} concludes.

# Empirical Setting

Intestinal worms are a development burden to children and adults in many developing countries. According to the World Health Organization approximately 1.5 billion people are infected with soil-transmitted helminths worldwide.^[World Health Organization, Fact Sheet Soil-transmitted helminth infections, September 2017 http://www.who.int/mediacentre/factsheets/fs366/en/.] While mild infections are asymptomatic, more severe infections lead to abdominal pain, iron-deficiency, anemia, malnutrition, and stunting. Epidemiologists postulate that it might be feasible to eliminate worms using mass drug administration covering the entire population, including children and adults. While significant progress has been made in deworming children through school-based deworming programs, the remaining infectious reservoir among adult populations fosters reinfection. An important empirical question is therefore, how high take-up of deworming treatment among adults can be achieved cost-effectively and within a short time. 

```{r praise-stigma-plot, fig.width=8, fig.height=3, fig.cap="Reported social perception of some observable activities."}
baseline.data %>% 
  select(matches("^(praise|stigma)_[^_]+$")) %>% 
  gather(key = key, value = response) %>% 
  separate(key, c("praise.stigma", "topic"), "_") %>% 
  separate(topic, c("topic", "question.group"), -2) %>% 
  filter(!is.na(response)) %>% 
  count(praise.stigma, topic, response) %>% 
  group_by(praise.stigma, topic) %>% 
  mutate(n = n/sum(n)) %>% 
  ungroup %>%
  mutate_at(vars(praise.stigma, response), funs(fct_relabel(factor(.), str_to_title))) %>% 
  mutate(topic = fct_recode(factor(topic), 
                            "Wearing/not wearing nice clothes to church" = "clothe",
                            "Use Latrine/open defecation" = "defecat",
                            "Deworming/not deworming during MDA" = "dewor",
                            "Immunize/not immunize children" = "immuniz")) %>% 
  ggplot(aes(response)) +
  geom_col(aes(y = n), alpha = 0.5) +
  labs(y = "Proportion", x = "") +
  scale_y_continuous(breaks = seq(0.25, 1, 0.25)) +
  coord_flip() +
  facet_grid(topic ~ praise.stigma, labeller = label_wrap_gen(width = 20)) +
  theme_bw() +
  theme(legend.position = "bottom",
      strip.text.y = element_text(angle = 0), 
      strip.background = element_rect(colour = NA), 
      panel.border = element_blank()) 
```

Community deworming and the context of Western Kenya provide an empirically relevant and suitable setting to study prosocial behavior and the potential of social signaling. Firstly, deworming is a public good. Most of its benefits come through reduced disease transmission to others, while private health benefits are low for many individuals. Secondly, deworming is an established health technology in Kenya. In 2009 the Government of Kenya launched a National School-Based Deworming Programme (NSBDP) through which between 2012 and 2017 over 5 million children got dewormed. Trained teachers administered deworming tablets to all enrolled and non-enrolled children aged 2-14 years in all primary schools in areas endemic to parasitic worms, including our study area. Most likely as a results of that, 78 percent of adults in our baseline survey sample know about deworming treatment and 61 percent are aware that treatment should be taken regularly, every three to twelve months. When asked who is at risk of worm infections, 94 percent of adults answer children and 67 percent answer that adults are at risk too. Only 4 percent say that deworming treatment is for sick people only. Third, there is a strong prescriptive norm around deworming. 95 percent of adults at baseline say they would praise someone who would come for free deworming treatment, while 69 percent said they would look down on a person who did not come. Figure \ref{fig:praise-stigma-plot} shows that image concerns for deworming are comparable to those for open defecation and child immunization. Individuals consider deworming as the "right thing to do" to protect one's health and not spread worms, while those who do not deworm are considered as careless and ignorant. While there could be concerns about adults' interpreting others' decision to deworm as a sign of them having worms or "being dirty" (i.e. revealing negative health characteristic) the baseline data suggests that this is not the case. Instead, deworming is seen as a preventative health behavior for everyone to take, regardless of whether someone believes to have worms or is feeling healthy. However, adults have a limited understanding of externalities. Less than half (41 percent) of adults know that worms can spread between people.^[When asked if a person sick with worms can spread works to others, only 31 percent answered yes, 56 percent said know and 13 percent were uncertain. When asked if "If you have worms, does that affect your neighbors? or relatives? health?" 27 percent and "If your neighbors or relatives have worms, does that affect your health?" 25 percent answered yes. Only 18 percent answered yes to all three questions, had full externality knowledge. 41 percent answered yes to one of the three questions, had partial understanding of externalities.] Lastly, adults under-invest in deworming despite treatment being readily available at a low cost.^[Adults can purchase deworming treatment at pharmacies and clinics for a price of about 50-200 Kenyan shillings (\$0.50-2)] While 68 percent of adults at baseline report to have taken treatment before, only 38 percent say they dewormed in the past 12 month. Adults in endemic areas are advised to deworm every 6 to 12 months but there is currently no formal program that provides free treatment to adults. In collaboration with the Kenyan Government, we implemented a new community deworming program that offered free deworming treatment to over 200,000 adults in Western Kenya. The program was implemented across three counties, Busia, Siaya and Kakamega, where soil-transmitted helminths are endemic. We implemented the program and experiment in two waves: wave one of deworming was implemented from early to mid-October  in Busia and Siaya County, and wave two was implemented from late October until early November in Kakamega County. In both waves, deworming started on a Monday and was offered for twelve consecutive days, each day from 8am until 5pm. 

# Theoretical Framework 

We adapt Bénabou and Tirole's [-@Benabou2006;-@Benabou2012a] framework of prosocial behavior and social signaling to generate predictions and lay out testable assumptions that inform our experimental design. In this framework, individual $i$ decides to take a prosocial action $y_i \in \{0,1\}$ and values the inference that others will make about her type, based on her observed action:

\begin{align}
U(y_i;v_i,x,\lambda) =  B(y_i;v_i) - C(y_i) + x\lambda E_{-i}(v|y_i) \label{equ:signal1}
\end{align}

In our context, $y_i$ is the decision to deworm or not deworm. Individuals differ in their intrinsic motivation $v_i$, which is their valuation to contribute to deworming or more generally the community's health. $v_i$ is drawn from the type distribution $G(v)$ which is assumed to be public knowledge. $v_i$ is known to individual $i$ but not observable to others. $B(y_i;v_i)$ denotes the private benefit of deworming, which is a function of $i$'s choice $y_i$ and $i$'s type. Deworming treatment is offered for free but adults have to incur a cost $C(y_i)$ of walking to a treatment location.^[We omit from the model $e\bar{a}$, that is, the utility that individuals derive from the externality benefits of deworming. Its inclusion does not affect predictions.]

Ignoring the third term of the model, we have a simple maximization problem where individual $i$ chooses to deworm or not, by maximizing $U(y_i;v_i) = B(y_i;v_i) - C(y_i)$. Assuming that $B(y_i;v_i)$ is increasing and concave, and $C(y_i)$ is weakly convex, there is a unique function that maps for each individual $i$ her type $v_i$ to her optimal action: $y_i^{*} =y(v_i)$. Without loss of generality, assume that $\frac{\partial B(y_i;v_i)}{\partial v_i} > 0$, such that higher types receive greater utility from deworming.^[Formally $y > y^{'}$ if $v > v^{'}$, $\forall v, v^{'}$.] 

The key part of the model is the third term, the reputational benefits and costs associated with the expectations that others, indexed by $-i$, will form about $i$'s type as actions become visible. Let $x \in [0,1]$ denote the probability that others observe $i$'s choice. The parameter $\lambda$ measures how much individual $i$ cares about the expectations that others form about her. Following the literature, I assume that $\lambda\geq 0$ given that deworming is socially desirable. In equilibrium, different types choose different actions, leading others to form expectations about $i$'s type conditional on the action observed, that is, $E_{-i}(v| y_i = 0)$ or $E_{-i}(v| y_i = 1)$. Importantly, the expectations of others enter directly into $i$'s utility as expressed in equation \ref{equ:signal1}. Following the logic of Bénabou and Tirole [-@Benabou2006;-@Benabou2012a] there exists a unique set of actions under visibility such that each individual chooses an action, given the equilibrium actions of all other individuals. This equilibrium is characterized by the cut-off type $v^*$ (who is indifferent between choosing the optimal $y_i^{*}=0$ without visibility and deviating to $y_i^{*}=1$) and the reputational returns which solve the fixed-point equation:

\begin{align}
U(y_i^{*}=1) - U(y_i^{*}=0) = \underbrace{B(y_i^{*}=1;v^*) - C(y_i^{*}=1)}_{\text{Difference in direct benefits}} + \underbrace{x\lambda \Delta(v^*)}_{\text{Reputational returns }} = 0  \label{equ:signal2}
\end{align}

where^[To make the link between types and actions more transparent, note that $\expect{v| y_i^{*}=1} - \expect{v|y_i^{*}=0} = \expect{v| v \geq v^*} - \expect{v| v < v^*}$.]  \[\Delta(v^*)= \underbrace{\expect{v| y^{*}_{i} =1} - \expect{v|y_i^{*} =0}}_{\text{Difference in the average type based on \bf{observed} \rm actions}}.\] 
Given our previous assumption $\frac{\partial B(y_i;v_i)}{\partial v_i} > 0$, in equilibrium individuals with higher types will be more likely to take-up deworming treatment than those with lower types.^[It is relatively straight-forward: Suppose, for the sake of contradiction, that there exists an equilibrium in which the action taken by $v, v^{'}$ with $v > v^{'}$ is $a < a^{'}$. By definition the third term concerning other people's inferences, given actions, is the same for all types v. Consequently, if a lower type $v$ prefers to take the action $y^{'}$ instead of $y$, then it must be that a higher type must also prefer the action. That contradicts the initial supposition that they higher type prefers $y$ to $y^{'}$.]

\noindent \bf{Prediction 1.} \rm \it{If it is socially desirable to deworm and individuals care about their reputation (i.e., $\expect{v|y_i=1} > \expect{v|y_i=0}$ and $\lambda >0$), deworming take-up will be higher when individuals can signal their participation. The greater the visibility of actions ($x$), the larger the increase in take-up.} \rm \\

\begin{itemize}
\renewcommand\labelitemi{*}
\item \bf{Assumption and mechanism: }\rm \it{Signals increase the visibility of deworming decisions and reduce (perceived) information asymmetries.}\rm \\
\end{itemize} 

\noindent The framework further provides insights into how changes in cost affect equilibrium take-up. Following Bénabou and Tirole [-@Benabou2012a], we assume that the type distribution $G(v)$ has finite support $V \equiv [v_{\text{max}},v_{\text{min}} ]$ and a continuously differentiable density $g(v) > 0$. For simplicity, define the equilibrium take-up level of deworming treatment as a function of the cost $c$ as $y(c) = 1-G(v^*(c))$, with its derivative $\frac{d y(c)}{d c} = -g(v^*) \frac{\partial v^*}{\partial c}$. Further, we assume that cost enter individuals' utility function linearly and that the type distribution is unimodal.^[If the type distribution is uniform, reputational returns will be constant, such that a change in $c$ has the same effect on take-up as in the no visibility case.] In the absence of visibility ($x=0$), a one unit increase in $c$ will reduce take-up by $g(v^*)$. As actions become visible (asssume $x=1$), there is an indirect effect ($\sim$ _social multiplier_) of cost on take-up through reputational returns: 

\begin{align}
\frac{\partial v^*}{\partial c} = \frac{1}{1 + r^{'}(v^*)} \label{eq:social-mult-theory}
\end{align}

where $r^{'}(v^*) = x\lambda\Delta'(v^*)$ is the change in reputational returns, caused by a shift in the cut-off type $v^*$ through the change in cost. Reputational returns change as signals become more or less informative, that is, the difference between $\expect{v|v \geq v^*}$ and $\expect{v|v < v^*}$ increases or decreases:

* If $r^{'}(v^*) <0$ i.e., $\frac{\partial \expect{v|v \geq v^*}}{\partial v^*} < \frac{\partial \expect{v|v <v^*}}{\partial v^*}$ the effect of an increase in cost on take-up will be amplified by a decrease in reputational returns, as signals become less informative. This is the case if take-up of deworming is high (``everyone but the worst people do it'') and increases in $c$ lower the pressure on those that do not deworm as the share of non-dewormers increases. 
* If $r^{'}(v^*) >0$ i.e., $\frac{\partial \expect{v|v \geq v^*}}{\partial v^*} > \frac{\partial \expect{v|v <v^*}}{\partial v^*}$ the effect of an increase in cost will be mitigated by an increase in reputational returns, as signals become more informative. This is the case if take-up of deworming is low and increases in $c$ increase the praise for those individuals that deworm.^[For there to be a unique equilibrium, we follow @Benabou2012a assuming that $1 + \lambda r^{'}(v_r^{*}) > 0$, which holds for $\lambda$ not too large.] 

\noindent \bf{Prediction 2. }\rm \it{Changes in the cost of deworming (by causing changes in the take-up level of deworming treatment) lead to increases (decreases) in reputational returns, increasing (decreasing) the effect of signals and the share of individuals taking up deworming treatment.} \\


\noindent \bf{Alternative Mechanisms.} \rm There are two main confounds to identifying social signaling effects:  

1. Signals, in addition to their visibility, might also have a consumption value. Hence, observed changes in deworming take-up might not be due to reputational returns but due to individuals privately valuing the signal.
2. We so far assumed that individuals simultaneously make a decision to deworm and have perfect information about the benefits of deworming. In our experiment, deworming treatment was offered for twelve days.^[The intention was to minimize excuses individuals could make for not taking up treatment and increase the informativeness of signals.] Individuals could therefore observe others' actions before making their own decision and be influenced by: 
    * _Salience effects:_ As signals increase the salience of others' deworming decisions, individuals might be reminded of deworming. 
    * _Social learning:_ If adults have inaccurate beliefs about others' deworming take-up, observing others could cause them to update their beliefs about aggregate take-up and the benefits of deworming.

# Experimental Design 

\begin{figure}
  \centering
  \begin{tikzpicture}[node distance=1cm, auto,]
    
    \node[county] (kakamega) at (-5, -2) {Kakamega County};
    \node[county] (siaya) at (0, -2) {Siaya County};
    \node[county] (busia) at (5, -2) {Busia County};
    
    \node[punkt] (close) at (-2, -4) {Close}
      edge[greypil] (kakamega)
      edge[greypil] (busia)
      edge[pil] (siaya);
    \node[punkt] (far) at (2, -4) {Far}
      edge[greypil] (kakamega)
      edge[greypil] (busia)
      edge[pil] (siaya);
      
    \node[punkt] (control) at (-6, -6) {Control}
      edge[pil] (close)
      edge[pil] (far);
    \node[punkt] (ink) at (-2, -6) {Ink}
      edge[pil] (close)
      edge[pil] (far);
    \node[punkt] (calendar) at (2, -6) {Calendar}
      edge[pil] (close)
      edge[pil] (far);
    \node[punkt] (bracelet) at (6, -6) {Bracelet}
      edge[pil] (close)
      edge[pil] (far);
      
    \node[triangle, below=of ink] (village1) {}
      edge[pil] (ink);
    \node[triangle, left=0.25cm of village1] (village2) {}
      edge[pil] (ink);
    \node[triangle, right=0.75cm of village1] (village3) {}
      edge[pil] (ink);
      
    \node[triangle, below=of control] (village1-control) {}
      edge[pil] (control);
    \node[triangle, left=0.25cm of village1-control] (village2-control) {}
      edge[pil] (control);
    \node[triangle, right=0.75cm of village1-control] (village3-control) {}
      edge[pil] (control);
      
    \node[triangle, below=of calendar] (village1-calendar) {}
      edge[pil] (calendar);
    \node[triangle, left=0.25cm of village1-calendar] (village2-calendar) {}
      edge[pil] (calendar);
    \node[triangle, right=0.75cm of village1-calendar] (village3-calendar) {}
      edge[pil] (calendar);
      
    \node[triangle, below=of bracelet] (village1-bracelet) {}
      edge[pil] (bracelet);
    \node[triangle, left=0.25cm of village1-bracelet] (village2-bracelet) {}
      edge[pil] (bracelet);
    \node[triangle, right=0.75cm of village1-bracelet] (village3-bracelet) {}
      edge[pil] (bracelet);
      
     \path (village1) -- node[auto=false,font=\bf]{\ldots} (village3); 
     \path (village1-control) -- node[auto=false,font=\bf]{\ldots} (village3-control); 
     \path (village1-calendar) -- node[auto=false,font=\bf]{\ldots} (village3-calendar); 
     \path (village1-bracelet) -- node[auto=false,font=\bf]{\ldots} (village3-bracelet); 
     
    \node[popcircle, below=1.5cm of village2-control, label={below:{\footnotesize\bf{SMS Control}}}] (non-phone-sms-control-control) {}
      edge[pil] (village1-control);
    \node[popcircle, below=3.5cm of village3-control, label={[text depth=-2ex,text width=4cm,rotate=-35]right:{\footnotesize\bf{SMS Control}}}] (phone-sms-control-control-1) {}
      edge[pil] (village1-control);
    \node[popcircle, right=0.25cm of phone-sms-control-control-1, label={[text depth=-2ex,text width=4cm,rotate=-35]right:{\footnotesize\bf{Reminders Only}}}] (phone-sms-control-control-2) {}
      edge[pil] (village1-control);
    \node[popcircle, right=0.25cm of phone-sms-control-control-2, label={[text depth=-2ex,text width=4cm,rotate=-35]right:{\footnotesize\bf{Social Info}}}] (phone-sms-control-control-3) {}
      edge[pil] (village1-control);
     
    \node[popcircle, below=1.5cm of village2, label={below:{\footnotesize\bf{SMS Control}}}] (non-phone-sms-control) {}
      edge[pil] (village1);
    \node[popcircle, below=3.5cm of village3, label={[text depth=-2ex,text width=4cm,rotate=-35]right:{\footnotesize\bf{SMS Control}}}] (phone-sms-control-1) {}
      edge[pil] (village1);
    \node[popcircle, right=0.25cm of phone-sms-control-1, label={[text depth=-2ex,text width=4cm,rotate=-35]right:{\footnotesize\bf{Social Info}}}] (phone-sms-control-2) {}
      edge[pil] (village1);
     
    \begin{pgfonlayer}{background}
      \coordinate (strata top right) at (8, -1.1);
      \coordinate (strata bottom left) at (-8, -2.9);
      
      \node[expgroup={strata bottom left}{strata top right}, label={[yshift=0.5cm,xshift=6cm]below:{\bf Strata} (Counties)}] (stratabox) {};
      %% \node[rotate=-30, anchor=south] at (stratabox.east) {};
      
      \coordinate (villages top right) at (8, -7.1);
      \coordinate (villages bottom left) at (-8, -8.5);
      
      \node[expgroup={villages bottom left}{villages top right}, label={[yshift=0.5cm, xshift=6cm]below:{\bf Clusters} (Villages)}] (villagesbox) {};
      
      %%\node[rotate=-30, anchor=south] at (villagesbox.east) {{\bf Clusters}}; 
      
      \coordinate (non-phone top right) at (8, -9);
      \coordinate (non-phone bottom left) at (-8, -10.52);
      
      \node[expgroup={non-phone bottom left}{non-phone top right}, label={[yshift=0.5cm, xshift=6cm]below:{\bf Non Phone Owners}}] (non-phonebox) {};
      
      %%\node[rotate=-30, anchor=south] at (non-phonebox.east) {{\bf Non Phone Owners}}; 
      
      \coordinate (phone top right) at (8, -11);
      \coordinate (phone bottom left) at (-8, -13.3);
      
      \node[expgroup={phone bottom left}{phone top right}, label={[yshift=0.5cm, xshift=6cm]below:{\bf Phone Owners}}] {};
    \end{pgfonlayer}
  \end{tikzpicture}
  \label{fig:exp-design-diagram}
  \caption{Experiment Design: grey boxes identity the types of population units over which treatment was assigned. The study was stratified over counties (ellipses) and clustered over villages (triangles). Boxes identify cluster (village) level treatments while circles identify individual level treatments.}
\end{figure}

The first part of this section introduces the different experimental treatments and discusses the identification of signaling preferences. Next, we describe the selection and randomization of treatment points and communities. We then provide an overview of the different data collected and the relevant outcomes. 

## Treatments 

To create visibility in actions, we experimentally introduce two signals - in the form of a bracelet and ink applied to adults' thumbs. The bracelet and ink create an opportunity for adults to publicly signal that they took deworming treatment. Figure \ref{fig:exp-design-diagram} displays the experimental design which we discuss in the following.

### Social Signals: Ink and Bracelet {-} 

```{r bracelet-img, fig.cap="Note: In Swahili it says on the bracelet \"Treat worms improve the health of your community\"."}
knitr::include_graphics(file.path("images", "signal_bracelet.png"))
```

We introduce two different types of signals to increase the visibility of deworming decisions $x$: a green silicone bracelet (Figure \ref{fig:bracelet-img}) and green ink that is applied to a person's thumb. Bracelets and ink were randomized at the cluster level: at 39 treatment locations individuals received a bracelet when coming for deworming and at 36 locations they received ink. The color green was chosen as it is not associated with any political parties and was liked by most individuals during piloting. We test two different signals since it was unclear upfront which one could be more effective.[^signals]

[^signals]: Ink and bracelets vary as signals across important dimensions:

    * Ink is known for its use during elections. Individuals get their thumb inked after they cast their vote to avoid double voting. Bracelets are not commonly worn among adults in Kenya.
    * Ink has zero or negative consumption utility if individuals perceive it as messy or distrust it due to its link to voting. Bracelets could provide positive consumption value but cannot cause disutility since it is a voluntary signal.
    * Bracelets have a high visibility as they are worn around the wrist. Ink's visibility is lower as it is applied to the thumb and only lasts for about 3 days to 2 weeks (on the skin/on the nail). 
    * The cost of ink is close to zero while a bracelets cost \$0.20. Our research partner, a non-profit, had a strong interest in testing ink.
  
### Material Incentive: Calendar {-} 

```{r calendar-img, fig.cap="Note: The calendar made no reference to deworming to minimize its social signaling value."}
knitr::include_graphics(file.path("images", "calendar.png"))
```

To control for the consumption value $z$ of the bracelet, we introduced a material incentive in the form of a simple one-page wall calendar (Figure \ref{fig:calendar-img}). At 35 treatment locations individuals received the calendar when coming for deworming. The cost of the calendar is 50 Kenyan Shillings (50 Cents). Wall calendars are popular in Kenya as people use them to decorate the walls of their homes and often have many calendars for the same year put up. Due to its durability and visibility inside the home, the calendar would also act as a self-signal to individuals, reminding them of their participation in deworming. 34 treatment locations were randomized into a control arm where no incentives were provided. Signal/incentives were randomized at the cluster level for them to be informative about actions as opposed to adults' preferences for different incentives.  

### Cost of Deworming: Close and Far {-} 

```{r act-dist, fig.width=8, fig.cap="Distribution of actual distance from targeted villages and their assigned treatment location."}
analysis.data %>%  
  mutate(assigned.treatment = fct_relabel(assigned.treatment, str_to_title)) %>% 
  ggplot(aes(dist.to.pot)) +
  geom_density(aes(color = dist.pot.group, linetype = "Household")) +
  geom_density(aes(color = dist.pot.group, linetype = "Cluster Center"),
               data = mutate(village.centers, assigned.treatment = fct_relabel(assigned.treatment, str_to_title))) +
  geom_vline(xintercept = c(1250), linetype = "dashed") +
  labs(y = "Density", 
       caption = "Cluster centers were calculated as the centroid location of all households in cluster.") +
  scale_x_continuous("Distance to Treatment Location (meters)", breaks = seq(0, 10000, 2500/4)) +
  scale_color_discrete("Cluster Distance Assignment", labels = c("Close", "Far")) +
  scale_linetype_discrete("Distance From") +
  facet_wrap(~ assigned.treatment)
```

```{r dist-to-pot, echo=FALSE, fig.width=6, fig.height=3, fig.cap="Distance to Treatment Locations"}
verify.vill.pot.dist %>% 
  select(dist.to.own.pot, closest.other) %>% 
  gather(dist.type, dist) %>% {
  ggplot(.) +
    geom_histogram(aes(dist, fill = dist.type), binwidth = 2500/4, boundary = 0, alpha = 0.5, color = alpha("black", 0.5), position = "dodge") + 
    scale_x_continuous("", breaks = seq(0, 10000, 2500/4)) + 
    scale_y_continuous("Number of Clusters", breaks = seq(0, 100, 5)) +
    scale_fill_discrete("Distance", labels = c("To Closest Other Treatment Location", "To Assigned Treatment Location")) 
}
```


We vary the cost of deworming and with that the marginal person by varying the distance that individuals have to walk to treatment locations. We randomly assigned communities to either a "close" (0-1.25 kilometers) or "far" (1.25-2. kilometers) deworming location. Due to small changes in the actual location of treatment and the dispersion of households within targeted areas, actual distances to points of treatments were distributed as shown in Figure \ref{fig:act-dist}. While there does appear to be some slight overlap between close and far clusters (i.e. non-compliance with assigned treatment), this does not affect the intention-to-treat analysis. Table 1 shows that individuals from far communities had to travel more than twice the distance to treatment locations compared to individuals from close communities: the randomization shifted the mean distance from 0.84 kilometers to 1.86 kilometers. Figure \ref{fig:dist-to-pot} shows the distribution of targeted communities' distances (in meters) to their own treatment locations and to the closest other treatment locations. The distance to the assigned treatment location was for all clusters, except for two, shorter than the distance to the closest other treatment location. 

<!-- ### Reminder and Social Info Text Messages {-}  -->

<!-- We introduced a separate treatment at the individual level to hold constant salience and learning effects, and isolate the effect of social signaling. We recruited a random sample of adults in each signal/incentive treatment and the control group to receive text messages with reminders and information about aggregate take-up in their community. The text messages included two statements: "Free deworming now at [Central Location]." (=Reminder) "[No/few/almost half/half/more than half/almost all/all] of your village came, that is X in 10 adults." (=Social Info). We recruited 30 individuals per cluster in the control arm and 25 individuals per cluster in the signal/incentive treatments. In the control arm, we divided the sample into two groups of 15: one group received reminder messages only, and a second group received reminders and social information. In the signal/incentive treatments, individuals always received both. The text message sample was drawn from the population of phone owners, from which we also drew a comparison sample, that did not receive any text messages and also no recruitment visit. The majority of adults (65 percent to 80 percent) in our study sample own a phone. Text messages were sent the day before the deworming program started and after that every other day (on the second, fourth, sixth, eight and tenth deworming day). The first text message, on the day before treatment started, only included the Reminder message in the Social Info treatment since deworming had not yet started. The recruitment for treatment took place one to three weeks before the start of the deworming program. 387 adults were recruited for the reminder treatment in the control group and 2,637 adults across all signal/incentive and control groups for the Social Info treatment.   -->

<!-- ### SMS Airtime Reward {-}  -->

<!-- To verify that adults were reading the text messages, we offered an airtime reward of 50 Kenyan Shillings (50 US Cents) to a random subset of adults conditional on texting back and confirming the receipt of the text message.^[We only implemented the reward scheme during the second wave of deworming treatment. The reason being, we only decided to add the treatment shortly before we started deworming in wave one communities and had to wait for ethical approval for this added component before we could implement it.] In each control group cluster four adults were randomly selected (two from Reminder and two from Social Info treatment) and in each signal/incentive treatment cluster two adults got selected. The following reward text message was sent to adults on day 2 and 6 of deworming treatment: "Thank you for signing up for this text message from Evidence Action. To receive your 50Ksh airtime reward, message [1234] to [XXX]. The text is free." We sent a reminder text message to adults that had not taken up the reward two days after the original reward text was sent^["Thank you for signing up for text messages from Evidence Action. Don't forget to reclaim your 50Ksh airtime. Message [1234] to [XXX] to receive the reward. The text is free."]. The reminder messages were sent on day 4 (for reward messages sent on day 2) and on day 8 (for reward messages sent on day 6). The SMS airtime reward treatment gives us a lower bound for information take-up for our text message treatment. -->

## Information Campaign Prior to Deworming

```{r sensitization-img, fig.width=8, out.width="5.5in", fig.cap="Note: Community Health Volunteers informed all households in study communities one week prior to the start of the deworming treatment about the social benefits of deworming, when and where free deworming treatment will be available and if applicable what type of incentive will be given to adults when coming for treatment."}
knitr::include_graphics(file.path("images", "sensitization.png"))
```


One week before the launch of the community deworming program Community Health Volunteers (CHVs) together with field researchers visited _each_ of the selected 144 communities to inform adults about the upcoming program.^[Deworming treatment started on a Monday. The information campaign ended on the Friday before the program started to not avoid ``nudging'' adults too close to treatment.] CHVs are trusted community members who are known for their involvement in health campaigns and are part of the school-based deworming program in Kenya. Figure \ref{fig:sensitization-img} shows the information script that CHVs used. The objective was to send a strong message (i) that regular deworming, even in the absence of symptoms, is not only important for children but also for adults and (ii) that deworming is a public good. CHVs further informed community members that ink, calendars and bracelets would be given when coming for deworming, and distributed flyers (see Appendix, Figure 24-26) that displayed the incentives. The objective was to create common knowledge about the meaning of the signals/incentives among community members before the start of the program. 

## Site Selection and Randomization

```{r all-clusters-map, message=FALSE, fig.width=6, fig.height=6, fig.cap="Map of Initial Cluster Selection. Black crosses (+) indicate the selected treatment locations, while the grey regions indicate the nonoverlapped catchment circles from which we selected village(s) to target."}
ggplot.clusters(rct.cluster.selection, include.cluster.ids = FALSE, source = "stamen", maptype = "toner") 
```

We randomly selected 158 clusters in the three study counties, of which 144 were used in the study.^[We only intended to use 150 clusters, and only included eight extra clusters as fallback clusters. For various practical reasons, implementation was only possible in 144 clusters.] Each cluster was defined as a treatment location and targeted community pair. We used the location of primary schools as proxies to (i) identify acceptable locations to set up our treatment locations and (ii) to find villages to target with our informational campaign and data collection. We relied on the high geographic density of primary schools in the study counties to select both treatment locations and targeted communities.^[Geographic coordinates for primary schools were retrieved from the Kenya Open Data Portal (http://www.opendata.go.ke/).] To select our clusters from the pool of a total of 1,451 primary schools in our study area, we used an acceptance-rejection method whereby we randomly picked schools, checked their acceptability based on their overlap with already selected clusters, and if accepted added them to our selected sample. This process was repeated until we had selected the requisite number of clusters. If no acceptable schools remained before completion, the whole process was restarted. Each cluster, centered on its treatment location, had a 2.5 kilometer radius catchment circle and 3-4 kilometer radius buffer circle. A cluster was considered acceptable if its buffer circle did not leave any of the already selected clusters' non-overlapping catchment circles smaller than an a pre-specified size. Figure \ref{fig:all-clusters-map} shows the final cluster selection. After all clusters were selected, we randomly assigned^[Randomization was stratified within counties.] each cluster to be either a _close_ or _far_ cluster. We then selected for each cluster, from its non-overlapping catchment circle and according to its assigned distance treatment, a primary school as an anchor for us to locate its targeted community.^[For further details on the cluster selection algorithm refer to the study's pre-analysis plan.] Clusters were then randomly assigned, stratified over counties and distance treatment, to the different signal/incentive treatments: control, ink, calendar and bracelet. To finalize the cluster selection process, we surveyed the treatment location and target community anchor schools. For the treatment locations we confirmed that treatment would be feasible there and identified alternative treatment locations, close to the selected schools, as potential backups. For the anchor schools, we identified all the communities near them and randomly selected one community to target.^[In some cases because the initial village was too small, we added a second village.] 

## Data and Outcomes

Our analysis uses several data sources, including administrative data on deworming take-up and survey data that was collected before and after the intervention. 

(1) _Census data:_ We conducted a census of all adults (18 years age or older) residing in the 144 selected communities: surveyors visited each household, captured their geographic coordinates, and collected basic information of each household member that would allow us to follow-up with individuals and to stratify over relevant characteristics (e.g., phone ownership). In total we listed 38,019 adults. Using the census lists we randomly sampled individuals to be surveyed at base- and/or endline and to be part of the text messaging intervention. The sampling of individuals who did not receive any text messages was stratified over phone ownership. 
(2) _Baseline survey data:_ From each of the 144 communities we randomly sampled 15 households and from each household one adult was randomly picked to respond to the baseline survey. We surveyed 4,823 adults about their knowledge about private and social benefits, prior experience and beliefs about deworming take-up and social norms. We reported outcomes under in Section 2. The baseline survey and census were implemented in August and September 2016, eight to five weeks before the start of the deworming program.
(3) _Point of treatment administrative data:_ For all individuals listed in the census, we monitored the decision to take-up deworming treatment directly at the point of treatment. This allowed us to avoid using self-reported data and work with a large sample of 38,019 adults. While CHVs distributed the deworming drugs and incentives, field researchers recorded personal information on electronic devices.   
(4) _Endline survey data:_ We surveyed 5,664 adults to verify the correct implementation of all treatments (i.e. information visits by CHVs, receipt and understanding of signals/incentives and text messages), the visibility of signals/incentives, first and second order beliefs and to conduct a separate choice experiment to elicit preferences for calendar and bracelets. The survey was conducted three days to two weeks after the end of the deworming program and the sample included 4,436 respondents that were not part of the text message intervention, and 223 and 1,005 adults who had received the Reminder and Social Info treatment respectively. 

Our main outcomes are deworming take-up and beliefs about individual and aggregate level take-up. In our analysis we work with two different samples to estimate the effect of treatments on deworming take-up: i) individuals whose deworming take-up was directly monitored at the point of treatment (N = 12,827) and ii) individuals who were not monitored (N = 25,192). For individuals whose deworming take-up was monitored at the point of treatment personal information was uploaded on tablets so that surveyors could directly verify their attendance. For the larger non-monitored sample of individuals, surveyors manually recorded identifying information at the point of treatment which we matched (through an algorithm) with the census data. We were conservative in the acceptance of names matches, such that deworming levels for the non-monitored sample are significantly lower. When reporting deworming take-up levels we therefore only use data from the smaller, randomly drawn monitored sample. When estimating treatment effects we use the full sample of monitored and non-monitored individuals (N=38,017). In the analysis of beliefs we work with the (base- and) endline survey data. 

## Compliance with Implementation Protocol

```{r know-about-mda, warning=FALSE, fig.width=8, fig.height=6.5, fig.cap="Knowledge of RCT intervention."}
know.mda.cat.plot <- tribble(~ col.name,      ~ label,
        "know_deworm",    "Know about community-based MDA?",
        "treat_begin",    "Know when MDA starts?",
        "treat_end",      "Know when MDA ends?",
        "days_available", "Know length of MDA?",
        "find_out",       "From whom or how did you learn about the MDA?",
        "chv_visit",      "Did a CHV visit you to tell you about MDA?") %>% 
  multi.know.bel.cat.plot(.baseline.data = NULL, .census.data = NULL) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) 

day1.wave1 <- as_date("2016-10-03")
day12.wave1 <- day1.wave1 + days(11)
day1.wave2 <- as_date("2016-10-24")
day12.wave2 <- day1.wave2 + days(11)

wave.dates <- tribble(~ wave, ~ begin.end, ~ day,
                      1,      "begin",     day1.wave1,
                      1,      "end",       day12.wave1,
                      2,      "begin",     day1.wave2,
                      2,      "end",       day12.wave2)

mda.dates.dist.plot <- endline.data %>% 
  select(wave, treat_begin, treat_end, treat_begin_date, treat_end_date) %>% 
  gather(key = begin.end, value = day, -c(treat_begin, treat_end, wave)) %>% 
  mutate(begin.end = if_else(begin.end == "treat_begin_date", "begin", "end")) %>% 
  filter((treat_begin == "knows" & begin.end == "begin") | (treat_end == "knows" & begin.end == "end")) %>% 
  ggplot(aes(day)) +
  geom_histogram(aes(fill = begin.end), alpha = 0.75,  binwidth = 2, position = "identity") +
  geom_vline(aes(xintercept = as.numeric(day)), linetype = "dotted", data = wave.dates) +
  # scale_x_date(breaks = c(day1.wave1, day12.wave1, day1.wave2, day12.wave2)) + 
  scale_x_date("", date_breaks = "4 weeks", date_minor_breaks = "1 week", limits = c(as_date("2016-09-05"), as_date("2016-11-28"))) +
  scale_y_continuous("") +
  scale_fill_discrete("", labels = c("Begin Date", "End Date")) +
  facet_wrap(~ wave, scales = "free_x", labeller = as_labeller(. %>% sprintf("Wave %s", .))) +
  labs(title = "When did the MDA begin and end?", caption = "Dotted vertical lines identify correct MDA start and end days.") +
  theme(legend.position = "right")

grid.arrange(know.mda.cat.plot, mda.dates.dist.plot, layout_matrix = as.matrix(c(1, 1, 1, 2, 2)))
```

Figure \ref{fig:know-about-mda} shows how well adults were informed about the deworming program. At endline (2-14 days after the end of treatment), 89 percent of individuals knew that deworming treatment was offered to adults in their community. 74 percent reported to have received an information visit from a CHV before the start of the program. 69 percent of adults were able to recall the number of days that treatment was offered. Almost all individuals that came for deworming treatment, reported that they had received the assigned signal/incentive at the point of treatment (95 percent for ink, 97 percent for bracelet and 95 percent for calendar). All adults who were recruited for the text message treatment, consented to receiving the messages (confirm this, some did not have phone?). 82 percent of endline respondents that had been assigned to the text message treatment reported to have received messages. When asked about the content of the messages, 98 percent said that the message was a reminder for deworming and 47 percent said that the messages told them about how many people had dewormed. The average number of reported messages received was 4, with 75 percent of people reporting to have received between 3 and 6 text messages. It is possible that individuals do not precisely recall the number of messages received, given that the endline survey took place 2-14 days after deworming treatment had ended.

# Descriptive Statistics 

In this section we will present descriptive statistics pertinent to implementation of the community deworming program and its outcomes. 

### Study sample {-}

Table \ref{tab:cluster-stats} shows the total number of clusters by treatment arm and county as well as the number of adults that were surveyed during the census. Across 144 cluster, we surveyed 39,301 individuals who formed the sampling frame for different surveys and text messaging intervention. 
<!-- useless sentence and should definitely move table to appendix later. useful only if we describe different sample, where this is super sample and then there is monitored, monitored consent and endline sample -->

```{r cluster-stats}
cluster.stats <- census.data %>%
  filter(!is.na(cluster.id)) %>%
  left_join(select(cluster.strat.data, cluster.id, dist.pot.group), "cluster.id") %>% 
  arrange(county) 

calc.cluster.stats <- . %>% 
  count(county, assigned.treatment) %>% 
  ungroup %>% 
  spread(assigned.treatment, n) %>% { 
    total <- select(., -county) %>% mutate_all(as.integer) %>% rowSums 
    mutate(., all = total) 
  }

clusters.stats <- cluster.stats %>% 
  distinct(cluster.id, .keep_all = TRUE) %>% 
  calc.cluster.stats %>%
  set_names(str_to_title(names(.))) 

individ.stats <- cluster.stats %>% 
  calc.cluster.stats %>% 
  set_names(str_to_title(names(.))) 
```

\begin{table}
\centering
\caption{Number of clusters and individuals in targeted communities, by county and treatment arm.}\label{tab:cluster-stats}
\begin{tabular}{l*{10}{c}}
\toprule
       & \multicolumn{5}{c}{Clusters} & \multicolumn{5}{c}{Individuals} \\ \\
County & Control & Ink & Calendar & Bracelet & All & Control & Ink & Calendar & Bracelet & All \\
\cmidrule(r){2-6} \cmidrule(r){7-11}

```{r cluster-stats-tab, results="asis"}
clusters.stats %>%
  left_join(individ.stats, "County", suffix = c(".clusters", ".individuals")) %>% 
  plyr::a_ply(1, function(row) sprintf("%s %s \\\\\n", 
                                 row$County,
                                 paste(sprintf(" & %s", prettyNum(as.integer(row[, -1]), big.mark = ",")), collapse = "")) %>% 
          cat)
  
```
\bottomrule
\end{tabular}
\end{table}

Figure \ref{fig:general-desc-stats} shows socio-economic characteristics of individuals in the census, base- and endline survey. The mean age is 35 and 40 years respectively. Over half of respondents have not completed primary education and a large share (80$\%$) live in houses with floors made of earth. Both is indicative of low-income status, yet 65$\%$ to 80$\%$ of respondents report to have a mobile phone across the different surveys. 

```{r general-desc-stats, fig.width=8, fig.height=6, warning=FALSE, fig.cap="Study population summary statistics"}
gen.stats.plot <- tribble(~ col.name,       ~ label,
        "gender",         "Gender",
        "ethnicity2",      "Ethnicity",
        "school",         "Schooling",
        "floor",          "Home floor construction",
        "have_phone",     "Own mobile phone?") %>%
  multi.know.bel.cat.plot(.census.data = census.data %>% mutate(gender = factor(gender, levels = 1:2, labels = c("Male", "Female"))),
                          preprocess.fun = . %>% mutate(response = fct_relevel(response, rev(levels(baseline.data$school)))),
                          na.rm = TRUE)

age.density.plot <- list(Census = mutate(census.data, age = age.census), 
                         Baseline = baseline.data, 
                         Endline = endline.data) %>% 
  map_df(~ select(., age), .id = "survey.type") %>% 
  mutate(survey.type = factor(survey.type, levels = c("Census", "Baseline", "Endline"))) %>% 
  ggplot(aes(survey.type, age, color = survey.type)) +
  geom_boxplot() +
  coord_flip() +
  scale_y_continuous("Age Box Plot", breaks = seq(15, 100, 5)) +
  labs(x = "") +
  theme(legend.position = "none")

grid.arrange(gen.stats.plot, age.density.plot, layout_matrix = as.matrix(c(1, 1, 1, 1, 2)))
```

<!--Gender decomposition -->

### Knowledge, beliefs and perceptions of deworming {-}

Figure \ref{fig:know-believe-categorical-responses} presents individuals' responses to base- and endline questions about worms and deworming treatment. The majority of respondents knew about deworming treatment (78$\%$). However, less than one third of adults had knowledge of the negative externalities of worm infection. Comparing reported knowledge and beliefs of baseline and endline surveyed individuals, the most significant change is in people's understanding of who is at risk of worm infections. More people are reporting after the intervention the belief that everyone is at risk of worm infection. 
<!-- TOOK OUT since people are both less likely to answer yes and no to this question, as if they were less open to answering the question after deworming took place "Surprisingly, there seems to be a decrease in the understanding that individuals can infection one another. -->

```{r know-believe-categorical-responses, warning=FALSE, fig.width=8, fig.height=10, fig.cap="Knowledge and beliefs baseline and endline survey responses."}
tribble(~ col.name,      ~ label,
        "who_worms",     "Who is at risk of worms?",
        "effect_worms",  "What are the effects of worms?",
        "spread_worms",  "Can an infected person spread worms to other?",
        "how_spread",    "How are worms spread?",
        "stop_worms",    "How to stop worms?",
        "when_treat",    "When should people get dewormed?",
        "worms_affect",  "If infected, can you affect others' health?",
        "neighbours_worms_affect", "Can neighbors or relatives worm infection affect your health?") %>% 
  multi.know.bel.cat.plot() +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) 
```

Since our study's main research questions focus on social influence in deworming decisions, we tried to elicit individuals' perceptions and beliefs of others' deworming choices. Figure \ref{fig:response-other-deworm} shows individuals reporting that their own deworming decisions would not be influenced by others' decisions, as well as having a strong _intention_ to getting dewormed.

```{r response-other-deworm, warning=FALSE, fig.width=8, fig.height=2.5, fig.cap="Reported response to others' deworming choices."}
tribble(~ col.name,      ~ label,
        "few_deworm",     "Deworm if less than half of others deworm?",
        "many_deworm",    "Deworm if more than half of others deworm?",
        "more_less",      "Would you be more likely to deworm if few/many others get dewormed?") %>% 
  multi.know.bel.cat.plot(.endline.data = NULL) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) 
```

In addition, as shown in Figure \ref{fig:baseline-deworming-beliefs}, people predicted similar deworming among peers. As we will see below, most people overestimated their own and others' deworming take-up. Finally, when individuals were asked about how others would respond to the use of indelible ink as a signal of deworming treatment, they predicted a positive effect, contrary to what we actually observed.

```{r survey-of-10-beliefs, ref.label="survey-of-10-beliefs", warning=FALSE}
```

```{r survey-of-10-beliefs-boxplot, ref.label="survey-of-10-beliefs-boxplot", warning=FALSE}
```

```{r baseline-deworming-beliefs, warning=FALSE, fig.width=8, fig.height=5, fig.cap="Baseline beliefs/predictions about others' deworming choices."}
other.predict.deworm.plot <- tribble(~ col.name,              ~ label,
                                     "dworm_proportion",      "How many people will come to get dewormed?",
                                     "ink_more_less",         "Will the ink signal increase/decrease deworming take-up?") %>% 
  multi.know.bel.cat.plot(.endline.data = NULL,
                          preprocess.fun = . %>% 
                            mutate(response = fct_relevel(response,
                                                          "Few", "Nearly Half", "Half", "More Than Half", "Many", "All", "Less", "Same", "More", "Prefer Not Say", "Don't Know"))) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  labs(title = "Peer deworming predictions")

survey.takeup.beliefs.10 <- list(Baseline = baseline.data, Endline = endline.data) %>% 
  compact %>% 
  map_df(select, one_of("dworm_rate", "ink_dworm_rate"), .id = "survey.type") %>% 
  gather(key = incentive, value = value, -survey.type) %>% 
  mutate(incentive = if_else(incentive == "dworm_rate", "None", "Ink")) %>% 
  ggplot(aes(value)) +
  geom_freqpoly(aes(y = ..density.., color = survey.type, linetype = incentive), binwidth = 1) +
  scale_x_continuous("Reported Rate", breaks = 0:10) +
  scale_y_continuous("Density") +
  scale_color_discrete("") +
  scale_linetype_manual("Signal", values = c("dashed", "solid")) +
  theme(legend.position = "bottom") +
  labs(title = "How many out of 10 will come for deworming?")

survey.takeup.beliefs.10.boxplot <- list(Baseline = baseline.data, Endline = endline.data) %>% 
  compact %>% 
  map_df(select, one_of("dworm_rate", "ink_dworm_rate"), .id = "survey.type") %>% 
  gather(key = incentive, value = value, -survey.type) %>% 
  mutate(incentive = if_else(incentive == "dworm_rate", "None", "Ink")) %>% 
  ggplot(aes(survey.type)) +
  geom_boxplot(aes(y = value, color = survey.type, linetype = incentive), position = position_dodge(width = 1.1)) +
  scale_y_continuous("Reported Rate", breaks = 0:10) +
  scale_color_discrete("") +
  scale_x_discrete("") +
  coord_flip() +
  scale_linetype_manual("Signal", values = c("dotdash", "solid")) +
  theme(legend.position = "bottom", axis.text.y = element_blank(), axis.ticks.y = element_blank()) 

survey.takeup.beliefs.10.boxplot <- survey.takeup.beliefs.10.boxplot + theme(legend.position = "none")
survey.takeup.beliefs.10 <- survey.takeup.beliefs.10 + theme(legend.position = "right")

grid.arrange(other.predict.deworm.plot, survey.takeup.beliefs.10, survey.takeup.beliefs.10.boxplot, 
             layout_matrix = rbind(c(1, 1, 1, 1), c(2, 2, 3, 3)))

```

### Prior experience with deworming {-}

Figure \ref{fig:dewormed-history} presents individuals' reported experience with deworming, prior to the intervention. The majority of respondents said that children in their families had been previously dewormed, and the most common location for treatment for family members had been during the annual school-based deworming program. We also see that almost two third of adults had been previously dewormed. However, more than half of those reporting prior treatment, were treated over two years ago. Furthermore, most adults reported getting dewormed at a hospital/clinic or to have purchased medication.

```{r dewormed-history, fig.width=8, fig.height=9, fig.cap="Deworming history."}
ever.dewormed.plot <- baseline.data %>% 
  select(treated, family_treated) %>% 
  gather(key = who.treated) %>% 
  mutate(who.treated = if_else(who.treated == "treated", "Self", "Family")) %>% 
  count(who.treated, value) %>% 
  group_by(who.treated) %>% 
  mutate(n = n/sum(n)) %>%
  ungroup %>%
  mutate(value = fct_recode(factor(value), "Don't Know" = "DK") %>% 
             fct_relabel(str_to_title) %>% 
             fct_reorder(n)) %>%
  ggplot(aes(value)) +
  geom_col(aes(y = n), alpha = 0.5) +
  coord_flip() +
  facet_grid(who.treated ~ .) +
  labs(title = "Ever been dewormed before?", x = "", y = "Proportion") +
  theme(strip.text.y = element_text(angle = 0)) 

who.was.dewormed.plot <- baseline.data %>% 
  select(family_treated, who_treated) %>% 
  filter(family_treated == "yes") %>% 
  mutate(who_treated = fct_relabel(factor(who_treated), str_to_title)) %>% 
  ggplot(aes(who_treated)) +
  geom_bar(aes(y = ..count../sum(..count..)), alpha = 0.5) +
  coord_flip() +
  labs(title = "Who in family got dewormed?", x = "", y = "Proportion") +
  theme(strip.text.y = element_text(angle = 0)) 

when.dewormed.plot <- baseline.data %>% 
  transmute(treated, 
            treated_when = fct_relabel(factor(treated_when), str_to_title)) %>% 
  filter(treated == "yes") %>%
  ggplot(aes(treated_when)) +
  geom_bar(aes(y = ..count../sum(..count..)), alpha = 0.5) +
  coord_flip() +
  labs(title = "When did you last get dewormed?", x = "", y = "Proportion")

where.treated.plot <- baseline.data %>% 
  select(treated, family_treated, treated_where, where_family_treated) %>% 
  gather(key = who.treated, value = value, -c(treated, family_treated)) %>% 
  mutate(who.treated = if_else(who.treated == "treated_where", "Self", "Family")) %>% 
  filter((who.treated == "Self" & treated == "yes") | (who.treated == "Family" & family_treated == "yes")) %>% 
  count(who.treated, value) %>% 
  group_by(who.treated) %>% 
  mutate(n = n/sum(n)) %>% 
  ungroup %>% 
  mutate(value = fct_recode(value, "Don't Know" = "DK") %>% 
           fct_relabel(str_to_title) %>% 
           fct_relabel(function(.label) str_replace_all(.label, "Mda", "MDA")) %>% 
           fct_reorder(n)) %>%
  ggplot(aes(value)) +
  geom_col(aes(y = n), alpha = 0.5) +
  coord_flip() +
  facet_grid(who.treated ~ .) +
  labs(title = "Where did you last get dewormed?", x = "", y = "Proportion") +
  theme(strip.text.y = element_text(angle = 0)) 

grid.arrange(ever.dewormed.plot, who.was.dewormed.plot, when.dewormed.plot, where.treated.plot, 
             layout_matrix = as.matrix(c(1, 1, 2, 3, 3, 4, 4)))
```

### Preferences for incentives {-}

<!-- Revealed Preferences for Incentives AND STATED --> 

In order to distinguish between the private and social motivation of incentives, we asked endline respondents for their preferences for the calendar and bracelet incentives, and separately conducted a [willingness-to-pay survey](#willingness-to-pay-survey-sample) in the control arm. The identification challenge for us is to separate

a) _private valuation_, individuals like the bracelets for their consumption value, and 
<!--I think in B&T intrinsic value is used to refer to the value assigned to deworming, a calendar or bracelet item would have extrinsic value because calendar can be used for dates etc. and bracelet can be worn on wrist -- both are goods to use-->
b) _social valuation_, individuals are influenced by bracelets in their deworming decision because they want to broadcast that their deworming or because they are reminded or learn about deworming by observing others' decisions.

Figure \ref{fig:gift-plots} reports which incentive (bracelet or calendar) individuals preferred as a gift during the endline survey. Calendars are typically preferred by all except for those already dewormed. Similarly, in the willingness-to-pay survey, we find that the majority (72 $\%$) of individuals preferred calendars to bracelets. This provides evidence that individuals assign a higher private value to calendars and that by comparing deworming treatment take-up across calendar and bracelet arms we are able to isolate the social component. 
<!-- weak, needs to be rewritten but hopefully okay for CIFF, really would need model at beginning -->

```{r reported-gift-pref-deworm, ref.label="reported-gift-pref-deworm"}
```

```{r other-incentive-plot, ref.label="other-incentive-plot"}
```

```{r gift-plots, fig.height=4, fig.width=8, fig.cap="Reported calendar/bracelet preferences, split by experiment arm and respondents' deworming take-up."}
plot(reported.gift.pref.dewormed.plot)
# grid.arrange(reported.gift.pref.dewormed.plot, other.have.incentive.plot, 
#              layout_matrix = as.matrix(c(1, 1, 2, 2, 2)))
```

```{r reported-gift-pref-deworm, ref.label="reported-gift-pref-deworm"}
```


### Distance to treatment location {-} 

As described in the [Experiment Design](#experiment-design) section, communities were randomly assigned to be either located _close_ or _far_ from the treatment locations. The distance assignment is key for us to estimate individuals' response to changes in treatment (travel) cost and quantify the utility from social signaling. Due to small changes in the actual location of treatment and the dispersion of households within targeted areas, actual distances to points of treatments were distributed as shown in Figure \ref{fig:act-dist}. While there does appear to be some slight overlap between _close_ and _far_ clusters (i.e. non-compliance with assigned treatment), this does not affect the intention-to-treat analysis carried out in this report.


We can see in Table \ref{tab:mean-assigned-dist} that individuals from _far_ communities had to travel more than twice the distance to treatment locations compared to individuals from _close_ communities. 
<!-- TODO Elaborate on point that "treatment cost" assignment was successful. Sadly, though least difference for bracelets... -->

```{r mean-assigned-dist, warning=FALSE}
analysis.data %>%  
  # anti_join(outlier.clusters, c("sms.treatment", "cluster.id")) %>% 
  mutate(assigned.treatment = fct_relabel(assigned.treatment, str_to_title)) %>% {
    bind_rows(group_by(., assigned.treatment, dist.pot.group) %>%
                summarize(mean.dist = mean(dist.to.pot)) %>%
                ungroup,
              group_by(., dist.pot.group) %>% 
                summarize(mean.dist = mean(dist.to.pot), assigned.treatment = "(All)") %>% 
                ungroup)
  } %>% 
  spread(dist.pot.group, mean.dist) %>% 
  mutate(mean.dist.diff = far - close) %>% 
  kable(col.names = c("Arm", "Close", "Far", "Mean Difference"), 
        caption = "Mean Distance to Treatment Location (meters)",
        format = "latex", align = "lccc", booktabs = TRUE, longtable = FALSE, format.args = list(big.mark = ",")) 
```


### Absolute deworming treatment take-up {-}

By the end of the intervention, we had recorded the deworming treatment of approximately 97,000 individuals. Figure \ref{fig:absolute-takeup} shows how much absolute take-up there was, split by assigned incentive treatment, assigned distance to treatment location, and county. While the pattern of take-up is similar to what we will find in our formal analysis, we are not making any causal interpretations based on these findings. The aim of this study is to learn about impact on the _proportion_ of take-up in targeted communities, and therefore an analysis based on absolute figures would be misleading as we do not have information of what communities all treated individuals are from.


```{r absolute-takeup, fig.height=6, fig.cap="Absolute Deworming Take-up"}
plot.aggreg.takeup <- function(.data) {
  ggplot(.data, aes(assigned.treatment)) +
    geom_bar(alpha = 0.5, color = alpha("black", 0.5)) +
    labs(x = "Treatment", y = "Number of Individuals Dewormed (x 100)", caption = "Note: range on Y axis varies between counties.") +
    facet_grid(county.randomization ~ dist.pot.group, scales = "free_y", margins = TRUE) +
    scale_y_continuous(labels = . %>% divide_by(100)) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

takeup.data %>% 
  mutate_at(vars(dist.pot.group, assigned.treatment), funs(factor(.) %>% fct_relabel(str_to_title))) %>% 
  plot.aggreg.takeup 
```

# Empirical Models

## Deworming Take-Up Models

In order to answer our research questions we will take a multipronged approach. We will build and use different causal models to query different aspects of the mechanism of social signaling. First, we will use a reduced form model that relies on the experiment's randomized intervention to identify the causal quantities of interest. We will use this model to estimate straight forward estimands such as the average treatment effect of signals/incentives on deworming take-up, and how it varies at different assigned distances to deworming locations. We will compare bracelets and ink incentives with calendar incentives to separate the social effect (combining social signaling with salience and social learning) from the the private consumption effect. 

Second, we will construct and fit two parametric models mirroring the theoretical framework laid out in Section \ref{theoretical-framework}. Such models permit us to explicitly model such latent variables as the private benefit of deworming and incentives, the reputational returns to signaling, and the salience/social learning effect of signals. We can repeat any estimation done with the reduced form model, but we can also estimate counterfactuals in response to manipulations difficult or impossible to conduct in an experimental setting, such as holding private benefits fixed at the control level while allowing signaling at the level of bracelets or ink. To effectively communicate our identification strategy and the assumptions it relies on, we will use graphical models to elucidate the causal relationships and the independencies between the models' variables [@Pearl2009]. These structural models will allow us to investigate how an increase in cost can be mitigated/amplified by changes in reputational returns.

For all models, we will restrict the causal claims coming out of out analysis to experimentally identified comparisons between the treatment arms. This means while we will adopt structural parametric models based on a social signaling theoretical framework, we will not look directly at the the parameters of these models, only the comparison of their predicted observable outcomes. For example, while our model will include parameters representing the visibility and value of reputation, $\mu = x \lambda$, we will not make any interpretations based on their magnitude or how they differ between treatments. Instead we will only be interested how observable take-up, $Y$, would respond to experimental and non-experimental interventions, mediated by the hypothesized mechanisms represented by these parameters. This also means we are not interested in testing hypotheses such as $\mu = 0$ versus $\mu > 0$. Our aim is to learn about the degree to which social signaling influences take-up not whether if social signaling exists. 

Before listing the estimands we will be analyzing, we need to describe the notation used. These are the variables we will be using:

* $Z \in \mathcal{Z} = \{\textrm{control, calendar, bracelet, ink}\}$, the incentive/signal treatment assignment.
* $G \in \mathcal{G} = \{\textrm{close, far}\}$, the distance to deworming treatment assignment.
* $D \in \mathbb{R}^{+}$, the actual distance to deworming treatment in meters.
* $Y \in \{0,1\}$, the deworming treatment take-up outcome.
* $\overline{Y} \in \mathbb{Z}^{+}$, is the number of dewormed households in a village. 
* $\overline{B} \in \mathbb{R}$, is the latent village-level private consumption benefit. 

We will reserve uppercase letters for random variables and lowercase letters for fixed values. Potential outcomes will be expressed as $Y(z)$, indicating the outcome of $Z$ in response to the intervention $z$.  Subscripts $i, j$, and $k$ will be used to denote membership in households, villages, and clusters, respectively. In addition to the fixed value version of the above random variables ($z, g, d, y, \bar{y}$), we also have some others constants: 
* $n_j$, the number of households in village $j$.
* $N = \sum_j n_j$, the total number of households in the study.

In all of the above mentioned models, we will interested in estimating the follow intention-to-treatment estimands:

* The treatment effect of bracelets, ink, and calendars compared against the control arm. 
    - Leaving the distance to treatment as assigned. 
    \begin{equation}
    \begin{aligned}
      \fsexpect{Y(\textrm{bracelet})} - \fsexpect{Y(\textrm{control})} \\
      \fsexpect{Y(\textrm{ink})} - \fsexpect{Y(\textrm{control})}  \\
      \fsexpect{Y(\textrm{calendar})} - \fsexpect{Y(\textrm{control})}. 
    \end{aligned}
    \end{equation}
    - Holding fixed the distance at _close_ and _far_. 
    \begin{equation}
    \begin{aligned}
      \fsexpect{Y(\textrm{bracelet},\textrm{close})} &- \fsexpect{Y(\textrm{control},\textrm{close})} \\
      \fsexpect{Y(\textrm{bracelet},\textrm{far})} &- \fsexpect{Y(\textrm{control},\textrm{far})} \\
      \fsexpect{Y(\textrm{ink},\textrm{close})} &- \fsexpect{Y(\textrm{control},\textrm{close})} \\
      \fsexpect{Y(\textrm{ink},\textrm{far})} &- \fsexpect{Y(\textrm{control},\textrm{far})} \\
      \fsexpect{Y(\textrm{calendar},\textrm{close})} &- \fsexpect{Y(\textrm{control},\textrm{close})} \\
      \fsexpect{Y(\textrm{calendar},\textrm{far})} &- \fsexpect{Y(\textrm{control},\textrm{far})}.
    \end{aligned}
    \end{equation}
* The treatment effect of bracelets and ink compared against the calendar arm. 
    - Leaving the distance to treatment as assigned.
    \begin{equation}
    \begin{aligned}
      \fsexpect{Y(\textrm{bracelet})} - \fsexpect{Y(\textrm{calendar})} \\
      \fsexpect{Y(\textrm{ink})} - \fsexpect{Y(\textrm{calendar})}.  
    \end{aligned}
    \end{equation}
    - Holding fixed the distance at _close_ and _far_. 
    \begin{equation}
    \begin{aligned}
      \fsexpect{Y(\textrm{bracelet},\textrm{close})} &- \fsexpect{Y(\textrm{calendar},\textrm{close})} \\
      \fsexpect{Y(\textrm{bracelet},\textrm{far})} &- \fsexpect{Y(\textrm{calendar},\textrm{far})} \\
      \fsexpect{Y(\textrm{ink},\textrm{close})} &- \fsexpect{Y(\textrm{calendar},\textrm{close})} \\
      \fsexpect{Y(\textrm{ink},\textrm{far})} &- \fsexpect{Y(\textrm{calendar},\textrm{far})}. 
    \end{aligned} 
    \end{equation}
    
<!-- * The difference in the treatment effect of assigned distance to treatment, comparing bracelet, ink, and calendar with control: -->
<!--     \begin{equation} -->
<!--     \begin{aligned} -->
<!--       \left(\fsexpect{Y(\textrm{bracelet},\textrm{far})} - \fsexpect{Y(\textrm{bracelet},\textrm{close})}\right) &- \left(\fsexpect{Y(\textrm{control},\textrm{far})} - \fsexpect{Y(\textrm{control},\textrm{close})}\right) \\  -->
<!--       \left(\fsexpect{Y(\textrm{ink},\textrm{far})} - \fsexpect{Y(\textrm{ink},\textrm{close})}\right) &- \left(\fsexpect{Y(\textrm{control},\textrm{far})} - \fsexpect{Y(\textrm{control},\textrm{close})}\right) \\  -->
<!--       \left(\fsexpect{Y(\textrm{calendar},\textrm{far})} - \fsexpect{Y(\textrm{calendar},\textrm{close})}\right) &- \left(\fsexpect{Y(\textrm{control},\textrm{far})} - \fsexpect{Y(\textrm{control},\textrm{close})}\right).   -->
<!--     \end{aligned} -->
<!--     \end{equation} -->

We will use the $\hat{E}$ notation to indicate the finite sample mean, such that 
\[ \fsexpect{Y(z,g)} = \frac{1}{N} \sum_j \tilde{\bar{Y}}_j(z,g) \]
where
\begin{align}
\tilde{\bar{Y}}_j(z,g) =
  \begin{cases} 
    \bar{y}_j & \text{if } Z_j = z \wedge G_j = g  \\
    n_j \prob{Y_j(z,g) = 1} & \text{otherwise.}
  \end{cases} \label{eq:finite-sample-mean} 
\end{align}

If we use $\theta$ to generically represent the statistical parameters of our models, $\bf{X}$ as the matrix of all observed data $(z,g,y)$, and $\prob{\theta|\bf{X}}$ as the posterior distribution of $\theta$, we can write the posterior probability of any estimand as
\[ \expect*{\fsexpect{Y(z,g)}} = \int_\theta \frac{1}{N} \sum_j \tilde{\bar{Y}}(z,g;\theta_j) \prob{\theta|\bf{X}}\,\mathrm{d}\theta. \]
$\tilde{\bar{Y}}(z,g;\theta_j)$ is the parametric version of equation \eqref{eq:finite-sample-mean}. Since we will be relying on Markov Chain Monte Carlo (MCMC) simulations [@stan] for out statistical inference we actually compute this posterior mean^[To calculate credibility intervals, we need to determine the quantiles needed from the $S$ simulations.] as
\[ \expect*{\fsexpect{Y(z,g)}} \approx \frac{1}{S} \frac{1}{N} \sum_s \sum_j \tilde{\bar{Y}}_{js}(z,g), \]
where $s \in \{1,\ldots,S\}$ is the simulation index,
\begin{align}
\tilde{\bar{Y}}_{js}(z,g) =
  \begin{cases} 
    \bar{y}_j & \text{if } Z_j = z \wedge G_j = g  \\
    \sum_{i=1}^{n_j} Y^{*}(z,g;\theta_{js}) & \text{otherwise},
  \end{cases} \label{eq:mcmc-finite-sample-mean} 
\end{align}
and $Y^{*}(z,g;\theta_{js})$ is drawn from the probability distribution $\prob{Y(z,g) = y | \theta_{js}}$.

For the structural models we will exploit our fine grained control over the mechanisms governing take-up to compute the reputational treatment effect of bracelets, ink, and calendar. 

  - Leaving the distance treatment as assigned
    \begin{equation}
    \begin{aligned}
      \fsexpect{Y(\textrm{bracelet},\overline{B}(\textrm{control}))} - \fsexpect{Y(\textrm{control})} \\
      \fsexpect{Y(\textrm{ink},\overline{B}(\textrm{control}))} - \fsexpect{Y(\textrm{control})} \\
      \fsexpect{Y(\textrm{calendar},\overline{B}(\textrm{control}))} - \fsexpect{Y(\textrm{control})}. 
    \end{aligned} \label{eq:struct-estimand-1}
    \end{equation}
  - Holding fixed the distance at _close_ and _far_ 
    \begin{equation}
    \begin{aligned}
      \fsexpect{Y(\textrm{bracelet},\overline{B}(\textrm{control,close}))} &- \fsexpect{Y(\textrm{control, close})} \\
      \fsexpect{Y(\textrm{bracelet},\overline{B}(\textrm{control,far}))} &- \fsexpect{Y(\textrm{control, far})} \\
      \fsexpect{Y(\textrm{ink},\overline{B}(\textrm{control, close}))} &- \fsexpect{Y(\textrm{control, close})} \\
      \fsexpect{Y(\textrm{ink},\overline{B}(\textrm{control, far}))} &- \fsexpect{Y(\textrm{control, far})} \\
      \fsexpect{Y(\textrm{calendar},\overline{B}(\textrm{control, close}))} &- \fsexpect{Y(\textrm{control, close})} \\
      \fsexpect{Y(\textrm{calendar},\overline{B}(\textrm{control, far}))} &- \fsexpect{Y(\textrm{control, far})}. 
    \end{aligned} \label{eq:struct-estimand-2}
    \end{equation}
    
In addition, we will estimate equation \eqref{eq:social-mult-theory}, the _social multiplier_, except in response to a change in cost, $\overline{C}$,
\[ \frac{\partial V^*}{\partial \overline{C}} = - \frac{\partial V^*}{\partial \overline{B}} = \frac{1}{1 + r'(V^*)}, \]
as well as the multiplier effect on take-up
\[ \frac{\expect{Y}}{\partial \overline{C}} = \frac{\partial \expect{Y}}{\partial V^*} \frac{\partial V^*}{\partial \overline{C}} = - \frac{g(V^*)}{1 + r'(V^*)}, \]
<!-- \[ \frac{\expect{Y}}{\partial \overline{C}} = \frac{\partial \expect{Y}}{\partial V^*} \frac{\partial V^*}{\partial \overline{C}} = - \frac{\phi(V^*; \sigma^\textrm{struct})}{1 + r'(V^*)}, \] -->
where $g$ is the probability density function of the distribution of prosocial types, $V$. In order for us to be able to compare the change in $V^*$ or $\expect{Y}$ we need to hold fixed the value $C$ (or $\overline{B}$) such that the result $V^*$ is the same: we want to compare the effect of social signaling in response to change in cost/benefit from the same initial takeup-level or $V^*$. If we define $V^{*-1}(z,v)$ as function returning the level of $\overline{C}$ that would produce the cutoff $v$ when incentive/signal treatment is $z$. Thus,
\begin{equation} 
\frac{\partial V^*}{\partial \overline{C}}\Biggr|_{\substack{\overline{C}=V^{*-1}(z,v)}}\text{ and } \frac{\expect{Y}}{\partial \overline{C}}\Biggr|_{\substack{\overline{C}=V^{*-1}(z,v)}}, \label{eq:partials-at-value} 
\end{equation}
and to understand the causal effect of signals we will estimate the differences
\begin{equation}
\begin{aligned} 
\frac{\partial V^*}{\partial \overline{C}}\Biggr|_{\substack{\overline{C}=V^{*-1}(z,v)}} &- \frac{\partial V^*}{\partial \overline{C}}\Biggr|_{\substack{\overline{C}=V^{*-1}(\textrm{control},v)}} \\
\frac{\expect{Y}}{\partial \overline{C}}\Biggr|_{\substack{\overline{C}=V^{*-1}(z,v)}} &- \frac{\expect{Y}}{\partial \overline{C}}\Biggr|_{\substack{\overline{C}=V^{*-1}(\textrm{control},v)}},
\end{aligned} \label{eq:partials-diff}
\end{equation}
where $z \in \{\textrm{bracelet, ink, calendar}\}$ and $v$ will be simulated representing a range from low to high levels of take-up.

### Reduced Form Model

The primary task in describing the reduced form models is laying the statistical structure of these models; the causal structural is trivially derived from the experimental design. Therefore, we need to explain how the term $\prob{Y(z,g)}$ in \eqref{eq:finite-sample-mean} is estimated.

The reduced form model parameterizes the treatment effect of incentive/signal treatment and distance treatment, using a probit model, as 
<!-- \begin{align} -->
<!--   \prob{Y_j(z,g) = y} &= \prob{Y_j = y|Z = z, G = g, \boldsymbol{\beta}_j} \nonumber \\ -->
<!--   &= \Phi\left(\beta_{0j} + \sum_{\zeta \in \mathcal{Z}}\sum_{\gamma\in\mathcal{G}} \beta_{1j}(\zeta)\cdot\mathbbm{1}(z = \zeta) +  \beta_{2j}(\gamma)\cdot\mathbbm{1}(g = \gamma) + \beta_{3j}(\zeta,\gamma) \cdot\mathbbm{1}(z = \zeta \wedge g = \gamma)\right) \label{eq:P-Y-reduced} -->
<!-- \end{align} -->
\begin{align}
  \prob{Y_j(z,g) = y} &= \prob{Y_j = y|Z = z, G = g, \boldsymbol{\beta}_j} \nonumber \\
  &= \Phi\left(\beta_{0j} + \beta_{1j}(z) + \beta_{2j}(g) + \beta_{3j}(z,g)\right) \label{eq:P-Y-reduced}
\end{align}
where we use the notation $\beta_{1j}(z)$ to indicate the linear parameter for $z$ and similarly $\beta_{3j}(z,g)$ to indicate the linear interaction parameter for $z$ and $g$.[^discrete-param] $\Phi(\cdot)$ is the standard normal cumulative density function. The linear parameters are modeled as 
\begin{equation}
\begin{aligned}
\boldsymbol{\beta}_j &\sim \mathtt{Normal}\left(\boldsymbol{\beta}_{k[j]}, \mathsf{diag}(\boldsymbol{\sigma}^\textrm{village})\right) \\
\boldsymbol{\beta}_k &\sim \mathtt{Normal}\left(\boldsymbol{\beta}, \mathsf{diag}(\boldsymbol{\sigma}^\textrm{county})\right) \\
\boldsymbol{\beta}_j &\sim \mathtt{Normal}\left(\boldsymbol{\beta}_{k[j]}, \mathsf{diag}(\boldsymbol{\sigma}^\textrm{village})\right) \\
\boldsymbol{\beta}_k &\sim \mathtt{Normal}\left(\boldsymbol{\beta}, \mathsf{diag}(\boldsymbol{\sigma}^\textrm{county})\right) \\
\beta(\textrm{control}) &\sim \mathtt{Normal}\left(0, \tau(\textrm{control})\right) \\
\beta(\textrm{ink}) &\sim \mathtt{Normal}\left(0, \tau(\textrm{ink})\right) \\
\beta(\textrm{calendar}) &\sim \mathtt{HalfNormal}\left(0, \tau(\textrm{calendar})\right) \\
\beta(\textrm{bracelet}) &\sim \mathtt{HalfNormal}\left(0, \tau(\textrm{bracelet})\right) \\
\boldsymbol{\sigma}^\textrm{village} &\sim \mathtt{HalfNormal}\left(\bf{0}, \mathsf{diag}(\boldsymbol{\tau^\textrm{village}})\right) \\
\boldsymbol{\sigma}^\textrm{county} &\sim \mathtt{HalfNormal}\left(\bf{0}, \mathsf{diag}(\boldsymbol{\tau^\textrm{county}})\right).
\end{aligned} \label{eq:hier-beta-model}
\end{equation}

From equation \eqref{eq:P-Y-reduced} we can interpret the causal function of $Y$ to be
\[y \leftarrow f_y(z,g;\boldsymbol{\beta}_j,u_y) = \mathbbm{1}(\beta_{0j} + \beta_{1j}(z) + \beta_{2j}(g) + \beta_{3j}(z,g) + u_y > 0),\]
with $U_y \sim \mathtt{Normal}(0, 1)$. Figure \ref{dag:reduced} show the simple causal structure of this model.

\begin{figure}
\centering
\begin{tikzpicture}
  [
    node distance=2cm,
    line width=1.25,
    every label/.append style={font=\Large},
    observed/.style={circle,fill=black,inner sep=0pt,minimum size=3mm},
    latent/.style={circle,draw=black,inner sep=0pt,minimum size=3mm},
    latent-edge/.style={->,dashed},
    place/.style={circle,draw=blue!50,fill=blue!20,thick,
    inner sep=0pt,minimum size=6mm},
    transition/.style={rectangle,draw=black!50,fill=black!20,thick,
    inner sep=0pt,minimum size=4mm}
  ]

\node[observed] (Y) [label=right:$Y$] {};
\node[latent] (U_Y) [label=above:$U_y$,above=of Y] {}
  edge[latent-edge,->] (Y);
\node[observed] (G) [label=left:$G$,left=of Y] {}
  edge[->] (Y);
\node[observed] (Z) [label=left:$Z$,above=of G] {}
  edge[->] (Y);
\end{tikzpicture}
\caption{DAG for discrete distance treatment effect reduced form model.}
\label{dag:reduced}
\end{figure}

We use the notation $k[j]$ to denote the county that village $j$ belongs to. The function $\mathsf{diag}(v)$ constructs a diagonal matrix using its vector argument $v$. We use $\mathtt{HalfNormal}$ to represent a normal distribution restricted to be positive. 

The hyperparameters $\boldsymbol{\tau}, \boldsymbol{\tau}^\textrm{village}$, and $\boldsymbol{\tau}^\textrm{county}$ define our priors. We set these to: $\tau(\textrm{control}) = 5, \tau(\textrm{ink}) = \tau(\textrm{bracelet}) = \tau(\textrm{calendar}) = 1$, $\boldsymbol{\tau}^\textrm{village} = \frac{1}{4} \boldsymbol{\iota}_4$, and $\boldsymbol{\tau}^\textrm{county} = \frac{1}{4} \boldsymbol{\iota}_4$.^[$\boldsymbol{\iota}_n$ is a $n$-vector of ones.]   

We can write the posterior probability of these parameters as
\[\prob{\theta|\bf{X}} \propto \underbrace{\prod_i \prob{Y = y_i|\theta_{j[i]},Z = z_j, G = g_j}}_\text{likelihood}\underbrace{\prod_j \prob{\theta_j} \prod_k \prob{\theta_k}}_\text{prior}.\]

<!-- The second reduced form model parameterizes the continuous effect of distance to deworming treatment, so we have  -->
<!-- \[P(Y_j(z,d)) = P(Y_j|Z = z, D = d, \boldsymbol{\beta}_j) = \mathsf{logit}^{-1}\left(\beta_{0j} + \beta_{1j}\cdot z + f(z,d;\nu)\right),\] -->
<!-- where $f(z,d;\nu)$ is the continuous distance effect function, potentially varying by incentive/signal treatment, $z$. We will a _penalized spline regression model_ so that  -->
<!-- \[ f(z,d;\nu) = \sum_{\zeta\in\mathcal{Z}} \mathbbm{1}(z = \zeta) \left[\nu_0(z)\cdot d + \sum_{q=1}^Q \nu_{1q}(z)\cdot w_q(d)\right].  \] -->
<!-- $\nu_0(\cdot)$ is linear effect, varying by $z$, while $\nu_{1q}(\cdot)$ are the spline coefficients and $w_q(d)$ are the O'Sullivan spline basis functions. We set $Q = 102$ to produce smooth functions while relying on the Bayesian model's priors for regularization of unneeded parameters [@Jaro;@Kharratzadeh2017]. The spline coefficients are modeled as -->
<!-- \begin{align*} -->
<!-- \boldsymbol{\nu_0} &\sim \mathtt{Normal}(\bf{0},\boldsymbol{\iota}_4) \\ -->
<!-- \nu_{1q}(\zeta) &\sim \mathtt{Normal}(0, \sigma^\textrm{spline}),\forall 1 \leq q \leq Q, \zeta \in \mathcal{Z} \\ -->
<!-- \sigma^\textrm{spline} &\sim \mathtt{HalfNormal}(0, 1). -->
<!-- \end{align*} -->

<!-- \begin{figure} -->
<!-- \centering -->
<!-- \begin{tikzpicture} -->
<!--   [ -->
<!--     node distance=2cm, -->
<!--     line width=1.25, -->
<!--     every label/.append style={font=\Large}, -->
<!--     observed/.style={circle,fill=black,inner sep=0pt,minimum size=3mm}, -->
<!--     latent/.style={circle,draw=black,inner sep=0pt,minimum size=3mm}, -->
<!--     latent-edge/.style={->,dashed}, -->
<!--     place/.style={circle,draw=blue!50,fill=blue!20,thick, -->
<!--     inner sep=0pt,minimum size=6mm}, -->
<!--     transition/.style={rectangle,draw=black!50,fill=black!20,thick, -->
<!--     inner sep=0pt,minimum size=4mm} -->
<!--   ] -->

<!-- \node[observed] (Y) [label=right:$Y$] {}; -->
<!-- \node[latent] (U_Y) [label=right:$U_Y$,above=of Y] {} -->
<!--   edge[latent-edge,->] (Y); -->
<!-- \node[observed] (D) [label=above:$D$,left=of Y] {} -->
<!--   edge[->] (Y); -->
<!-- \node[latent] (U_D) [label=right:$U_D$,below=of D] {} -->
<!--   edge[latent-edge,->] (D); -->
<!-- \node[observed] (G) [label=left:$G$,left=of D] {} -->
<!--   edge[->] (Y); -->
<!-- \node[observed] (Z) [label=left:$Z$,above=of D] {} -->
<!--   edge[->] (Y); -->
<!-- \end{tikzpicture} -->
<!-- \caption{DAG for continuous distance treatment effect reduced form model.} -->
<!-- \end{figure} -->

[^discrete-param]: Since we include an intercept parameter, we restrict (omit) the following parameters: $\beta_{1j}(\textrm{control}) = 0$, $\beta_{2j}(\textrm{close}) = 0$, and $\beta_{3j}(\textrm{control,close}) = 0$.

### Structural Model

#### Distance {-}

For the structural model we will model the continuous effect of distance to deworming treatment; for us to be able to generate counterfactuals with respect to assigned distance we need to model how the assignment to _close_ and _far_ distances generates real continuous distances. We model this as
\begin{align}
\prob{D(g) = d) = P(D = g | G = g, \boldsymbol{\rho}, \boldsymbol{\pi}, \boldsymbol{\eta}} = \sum_m^M \rho_m \frac{\phi(d; \pi_m(g), \eta_m(g))}{1 - \Phi(d; \pi_m(g), \eta_m(g))}. \label{eq:P-D-struct}
\end{align}
For each distance assignment, $G$, the continuous distance, $D$, has a finite mixture positive normal distribution (truncated at zero). $\phi(\cdot;\pi,\eta)$ is the probability density function and $\Phi(\cdot;\pi,\eta)$ is the cumulative density function, for the $\mathtt{Normal}(\pi,\eta)$ distribution. $M$ (we set equal to 2) is the number of mixtures and $\boldsymbol{\rho}(g)$ is an $M$-simplex.
For the parameters in equation \eqref{eq:P-D-struct} we set the priors, for every $g \in \mathcal{G}$,
\begin{align*}
  \boldsymbol{\rho(g)} &\sim \mathtt{Dirichlet}(\boldsymbol{\iota}_M) \\
  \pi_m(g) &\sim \mathtt{HalfNormal}(0, 1), \forall 1 < m < M \\
  \eta_m(g) &\sim \mathtt{HalfNormal}(0, 1), \forall 1 < m < M,  
\end{align*}
and $\pi_m(\textrm{close}) \leq \pi_m(\textrm{far})$, for all $1 < m < M$. This corresponds to the causal function
\begin{equation} 
  d \leftarrow f_D(g; \boldsymbol{\pi}_m, u_D) = \pi_m(g) + u_D, \label{eq:D-causal}
\end{equation}
where $u_D \sim \mathtt{HalfNormal}(0, \eta_m(g))$.

#### Causal Structure {-}

The structural model is based on the theoretical framework laid out in section \ref{theoretical-framework}. To correspond to that framework, we need to introduce two latent variables representing the private consumption utility of incentives and the reputational utility of signaling. 

For private consumption utility we introduce the variable $\overline{B}$ to represent the village-level private utility. We consider two structural functions for this variable, one includes only the private benefit of incentives and the cost of traveling to the deworming point-of-treatment, while the other adds a social learning and salience cost. We model social learning and salience as a "cost" function black-box; we assume that since distance reduces observed peer take-up this results in lower salience and learning, without explicitly modeling the different underlying mechanisms. 
\begin{align} 
  \bar{b} &\leftarrow f_{\overline{B}}(z, d; \boldsymbol{\beta}_j, \boldsymbol{\delta}) = \beta_{0j} + \beta_{1j}(z) - c(d;\boldsymbol{\delta}), \label{eq:Bbar-causal} \\
  \bar{b} &\leftarrow f_{\overline{B}}(z, d; \boldsymbol{\beta}_j, \boldsymbol{\delta}) = \beta_{0j} + \beta_{1j}(z) - c(d;\boldsymbol{\delta}) - l(z,d;\boldsymbol{\psi},\boldsymbol{\mu}), \label{eq:Bbar-causal-salience}
\end{align}
where $c(d;\boldsymbol{\delta})$ and $l(z,d;\boldsymbol{\psi},\boldsymbol{\mu})$ are convex cost functions. We separately model the household private consumption utility as
\begin{equation}
  b \leftarrow f_B(\bar{b}; u_b) = \bar{b} + u_b. \label{eq:B-causal}
\end{equation}
The $\boldsymbol{\beta}$ parameters are modeled as in section \ref{reduced-form-model} with the additional restriction on $\beta(\textrm{calendar})$ and $\beta(\textrm{bracelet})$ to be positive; these incentives are voluntary to use/wear and therefore they are not likely to have a negative effect on utility---unlike the ink signal.

We separate the village level private consumption utility from the overall household utility because we model reputational utility as dependent on the community's private utility; households calculate the reputational returns to signaling based on level of consumption utility shared by the group they are signaling to. We assume any private shocks, $U_b$, to consumption utility are unobservable to other households in the community and does not figure into the reputational utility calculation. 

The second latent variable in the structural model will be $R$ representing the reputational utility of signaling. We will model this as
\begin{align}
 r \leftarrow f_R(z,\bar{b}; \boldsymbol{\mu},u_r) = \mu(z)\cdot\Delta[v^*(z,\bar{b})] + u_r, \label{eq:R-causal}
\end{align}
where $u_r$ is latent reputational shock and
\begin{equation}
\begin{aligned}
v^*(z,\bar{b}) &= - \bar{b} - \mu(z)\Delta[v^*(z,\bar{b})] \\ 
\Delta[v^*(z,\bar{b})] &= \expect{V | V > v^*(z,\bar{b})} - \expect{V | V < v^*(z,\bar{b})}. 
\end{aligned} \label{eq:V-equil}
\end{equation}
Equation \eqref{eq:R-causal} corresponds to the the reputational returns term in \eqref{equ:signal2} where we use $\mu(z) = x(z)\lambda$ since we cannot separate the observability effect of the signal, $x(z)$, from the value placed on reputation, $\lambda$.

Finally, we model the decision to take-up deworming treatment as 
\begin{equation}
y \leftarrow f_Y(b,r;v,u_y) = \mathbbm{1}(b + r + v + u_y > 0), \label{eq:Y-causal}
\end{equation}
where $v$ is the unobservable prosocial type and $u_y$ are other unmodeled shocks. 

Figure \ref{dag:struct} presents the causal structure corresponding to equations \eqref{eq:D-causal}, \eqref{eq:Bbar-causal}, \eqref{eq:B-causal}, \eqref{eq:R-causal}, and \eqref{eq:Y-causal}. We represent latent variables using hollow nodes and observed variables using solid nodes. We combine the $U_b, U_r, U_y$, and $V$ latent background variables using the variable $U$ since we make no claims about their independence from each other.

\begin{figure}
\centering
\begin{tikzpicture}
  [
    node distance=2cm,
    line width=1.25,
    every label/.append style={font=\Large},
    observed/.style={circle,fill=black,inner sep=0pt,minimum size=3mm},
    latent/.style={circle,draw=black,inner sep=0pt,minimum size=3mm},
    latent-edge/.style={->,dashed},
    place/.style={circle,draw=blue!50,fill=blue!20,thick,
    inner sep=0pt,minimum size=6mm},
    transition/.style={rectangle,draw=black!50,fill=black!20,thick,
    inner sep=0pt,minimum size=4mm}
  ]

\node[observed] (Y) [label=above:$Y$] {};
\node[latent] (B) [label=right:$B$,below=of Y] {}
  edge[->] (Y);
\node[latent] (R) [label=above:$R$,left=of Y] {}
  edge[->] (Y);
\node[latent] (Bbar) [label=below:$\overline{B}$,left=of B] {}
  edge[->] (B)
  edge[->] (R);
\node[observed] (Z) [label=left:$Z$,left=of R] {}
  edge[->] (R)
  edge[->] (Bbar);
\node[observed] (D) [label=above:$D$,left=of Bbar] {}
  edge[->] (Bbar);
\node[observed] (G) [label=left:$G$,left=of D] {}
  edge[->] (D);
\node[latent] (U_D) [label=right:$U_D$,below=of D] {}
  edge[latent-edge,->] (D);
\node[latent] (U) [label=right:$U$,right=of Y] {}
  edge[latent-edge,->] (B)
  edge[latent-edge,->,bend right=45] (R)
  edge[latent-edge,->] (Y);
\end{tikzpicture}
\caption{DAG for the structural social signaling model.}
\label{dag:struct}
\end{figure}

To work out how we will be able to identify the estimands in equations \eqref{eq:struct-estimand-1} and \eqref{eq:struct-estimand-2} from statistical model's conditional probabilities, we follow the approach used by @Pearl2009. Consider the counterfactual quantity $P[Y(z,\overline{B}(z',g)) = y]$: the probability of $Y = y$ under the intervention $Z = z$ and $\overline{B} = \overline{B}(z',g)$. In other words, for the private consumption utility the incentive/signal assignment is held at $z'$ and the distance assignment at $g$, while the reputational utility is determined by the incentive/signal assignment $z$, possibly different from $z'$.
\begin{align}
&\prob{Y(z,\overline{B}(z',g)) = y} = \prob{Y(z,\overline{B}(z',D(g))) = y}  \label{eq:add-D} \\
                                 &= \int_d \prob*{Y(z,\overline{B}(z',d)) | D(g) = d} \cdot \prob*{D(g) = d}\,\mathrm{d}d \\ 
                                 &= \int_d \prob*{Y(z,\overline{B}(z',d)) | D(g) = d, G = g} \cdot \prob*{D(g) = d | G = g}\,\mathrm{d}d \\ 
                                 &= \int_d \prob*{Y(z,\overline{B}(z',d)) | D = d, G = g} \cdot \prob*{D = d | G = g}\,\mathrm{d}d \\ 
                                 &= \int_d \prob*{Y(z,\overline{B}(z',d)) | D = d} \cdot \prob*{D = d | G = g}\,\mathrm{d}d \\ 
                                 &= \int_{\bar{b}} \int_d \prob*{Y(z,\bar{b}) | \overline{B}(z',d) = \bar{b}, D = d}\cdot\prob*{\overline{B}(z',d) = \bar{b}}\cdot \prob*{D = d | G = g}\,\mathrm{d}d\,\mathrm{d}\bar{b} \\
                                 &= \int_{\bar{b}} \int_d \prob*{Y(z,\bar{b}) | \overline{B}(z',g) = \bar{b},D = d,Z = z'}\cdot\prob*{\overline{B}(z',d) = \bar{b} | Z = z', D = d}\cdot\prob*{D = d | G = g}\,\mathrm{d}d\,\mathrm{d}\bar{b} \\
                                 &= \int_{\bar{b}} \int_d \prob*{Y(z,\bar{b}) | \overline{B} = \bar{b},D = d,Z = z'}\cdot\prob*{\overline{B} = \bar{b} | Z = z', D = d}\cdot\prob*{D = d | G = g}\,\mathrm{d}d\,\mathrm{d}\bar{b} \\
                                 &= \int_{\bar{b}} \int_d \prob*{Y(z) | \overline{B} = \bar{b},D = d,Z = z'}\cdot\prob*{\overline{B} = \bar{b} | Z = z', D = d}\cdot\prob*{D = d | G = g}\,\mathrm{d}d\,\mathrm{d}\bar{b} \\
                                 &= \int_{\bar{b}} \int_d \prob*{Y(z) | \overline{B} = \bar{b},D = d,Z = z}\cdot\prob*{\overline{B} = \bar{b} | Z = z', D = d}\cdot\prob*{D = d | G = g}\,\mathrm{d}d\,\mathrm{d}\bar{b} \\
                                 &= \int_{\bar{b}} \int_d \prob*{Y | \overline{B} = \bar{b},D = d,Z = z}\cdot\prob*{\overline{B} = \bar{b} | Z = z', D = d}\cdot\prob*{D = d | G = g}\,\mathrm{d}d\,\mathrm{d}\bar{b}. \label{eq:struct-cond-prob}
\end{align}
This results in an equation with no causal terms (potential outcomes) but only conditional probabilities that are calculated by the statistical model. 

#### Statistical Model {-}

So far we have restricted ourselves to the causal structural model. Now we turn to the statistical model used to calculate our estimands. We have already defined the statistical model for distance determined by $G$. Now, we defined the probability
\begin{align*}
  \prob{Y(z,d) = y | \boldsymbol{\beta},\boldsymbol{\delta},\boldsymbol{\mu},\sigma^\textrm{struct}} &= \prob{Y = y | Z = z, D = d; \boldsymbol{\beta},\boldsymbol{\delta},\boldsymbol{\mu},\sigma^\textrm{struct}} \\ 
  &= \Phi\left(f_B(z,d; \boldsymbol{\beta},\boldsymbol{\delta}) + f_R(z,f_B(z,d; \boldsymbol{\beta},\boldsymbol{\delta});\boldsymbol{\mu}); 0, \sigma^\textrm{struct}\right),  
\end{align*}
where  $U = U_B + U_R + U_Y + V \sim \mathtt{Normal}(0, \sigma^\textrm{struct})$. We normalize the distribution of the prosocial type of households, $V$, to have a standard normal distribution. For the other background variables we model their standard deviation as
\begin{align*}
  U_{B,R,Y} = U_B + U_R + U_Y &\sim \mathtt{Normal}(0, \sigma_{B,R,Y}) \\
  \sigma_{B,R,Y} &\sim \mathtt{HalfNormal}(0, 1).
\end{align*}
We model the correlation between $V$ and $U_{B,R,Y}$ and the their variance-covariance matrix as
\begin{align*}
  \Omega^\textrm{struct} &\sim \mathtt{LKJCorr}(2) \\
  \sigma_{V,B,R,Y} &= \begin{pmatrix} 1 \\ \sigma_{B,R,Y}\end{pmatrix} \\
  \Sigma^\textrm{struct} &= \mathsf{diag}(\sigma_{V,B,R,Y})\Omega^\textrm{struct}\mathsf{diag}(\sigma_{V,B,R,Y}).
\end{align*}
From $\Sigma^\textrm{struct}$ we can easily calculate $\sigma^\textrm{struct}$. 

For $\boldsymbol{\beta}$ we use the same hierarchical model as in equations \eqref{eq:hier-beta-model}. For the cost function we will use a quadratic cost function
\begin{align*}
  c(d;\boldsymbol{\delta}) &= \delta_1\cdot d + \delta_2\cdot d^2, 
\end{align*}
with
\[ \delta_1,\delta_2 \sim \mathtt{HalfNormal}(0, 1), \]
restricted to be positive, and for the salience and social learning cost function we will also use a quadratic function
\begin{align*}
  l(z,d;\boldsymbol{\mu},\boldsymbol{\psi}) &= \mu(z)\cdot(\psi_1\cdot d + \psi_2\cdot d^2), 
\end{align*} 
with
\[ \psi_1,\psi_2 \sim \mathtt{HalfNormal}(0, 1). \]
As for the reputational returns coefficient, $\mu$, we restrict it to be positive
\[\mu(z) \sim \mathtt{HalfNormal}(0, 1),~\forall z \in \mathcal{Z}\]
and
\[\mu(\textrm{bracelet}),\mu(\textrm{ink}),\mu(\textrm{calendar}) > \mu(\textrm{control}),\]
since all incentives might have some signaling power which cannot be less than the control arm.

Statistical inference is carried out in two stages. First, given a draw of $\boldsymbol{\beta}$ and $\delta$, $\overline{B}$ is evaluated conditional on observed treatment assignment and distance to deworming treatment. Second, we plug this into the algebraic equation solver available in the statistical modeling software, Stan [@stan], to solve equation \refeq{eq:V-equil}, resulting in $V^*$. Since we model $V$ as normally distributed we make use of the closed form solutions for the expectations:
\begin{align*}
\expect{V|V>v^*} = \frac{\phi(v^*)}{1 - \Phi(v^*)} \text{ and } \expect{V|V<v^*} = - \frac{\phi(v^*)}{\Phi(v^*)}. 
\end{align*}
So,
\[
\Delta(v^*) = \frac{\phi(v^*)}{(1 - \Phi(v^*))\Phi(v^*)}. 
\]

Now that we have described the statistical model for distance and take-up, we can also provide the posterior probability function for all the model's parameters, $\theta$, 
\[\prob{\theta|\bf{X}} \propto \underbrace{\prod_i \prob{Y = y_i|Z = z_j, D = d_j;\theta_{j[i]}}\prod_j\prob{D = d_j|G = g_j;\theta_{j[i]}}}_\text{likelihood}\underbrace{\prod_j \prob{\theta_j} \prod_k \prob{\theta_k}}_\text{prior}.\]

Finally, we need to explain how we will use the MCMC simulation to compute the estimand in equation \eqref{eq:struct-cond-prob}.

\begin{align*}
\expect*{\fsexpect*{Y(z,\overline{B}(z',g))}} &\approx \frac{1}{S}\frac{1}{N}\sum_s\sum_j \tilde{\bar{Y}}_{js}\left(z,z',g,\tilde{\bar{B}}_{js}\left(z',\tilde{D}_{js}(g)\right)\right) 
\end{align*}
<!-- \begin{align*} -->
<!-- \expect*{\fsexpect*{Y(z,\overline{B}(z',g))}} &\approx \frac{1}{S}\frac{1}{N}\sum_s\sum_j \tilde{\bar{Y}}_j\left(z,z',g,\tilde{\bar{B}}_j\left(z',\tilde{D}_j(g;\theta_{js});\theta_{js}\right);\theta_{js}\right)  -->
<!-- \end{align*} -->
where
\begin{align*}
\tilde{\bar{Y}}_{js}(z,z',g,\bar{b}) &= 
\begin{cases}
  \bar{y}_j & \text{if }Z_j = z = z' \wedge G_j = g \\ 
  \sum_{i=1}^{n_j} Y^*(z,\bar{b};\theta_{js}) & \text{otherwise}
\end{cases} \\
\\
\tilde{B}_{js}(z,d) &= B^*(z,d;\theta_{js}) \\
\\
\tilde{D}_j(g) &=  
  \begin{cases} 
    d_j & \text{if } G_j = g  \\
    D^*(g;\theta_{js}) & \text{otherwise.}
  \end{cases} 
\end{align*}
$D^*$ is a simulation draw, given $\theta_{js}$, from the probability defined in equation \eqref{eq:P-D-struct}, $B^*$ is a simulation draw defined by $f_{\overline{B}}(z,d;\boldsymbol{\beta}_{js},\boldsymbol{\delta}_{js})$, and $Y^*$ is a simulation draw from the probability distribution $\Phi\left(\bar{b} + f_R(z,\bar{b};\boldsymbol{\mu}_s); 0, \sigma_s^\textrm{struct}\right)$.

<!-- ## Static Model -->

<!-- ### Likelihood Model -->

<!-- This is the model's likelihood, the data generating process for observed outcomes: -->

<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \Pr[Y_i = 1 | \mathbf{Z}_i, \mathbf{X}_i, \theta_{j[i]}] &= g^{-1}(\eta_i | \theta_{j[i]}) \\ -->
<!-- \eta_i &=  f(\mathbf{Z}_i, \mathbf{X}_i | \theta_{j[i]})    -->
<!-- \end{aligned} -->
<!-- $$ -->

<!-- where  -->

<!-- * $g$ is a binary link function (e.g., logit or probit link functions). -->
<!-- * $f$ is a linear function of $\mathbf{Z}$ and $\mathbf{X}$.^[I'm writing it this way so I don't have to write the whole linear model with treatment indicators, covariates and, their interactions. I can specify it separately, it would just distract from the overall model here.]  -->
<!-- * $\theta_j = (\alpha_j, \beta_j)'$, where $\alpha_j$ and $\beta_j$ are the model parameters for the village-level intercept and the village-level vector of slope coefficients, respectively. -->

<!-- ### Parameters Model -->

<!-- This section describe the hierarchical model for parameters. Distribution that have $\mathtt{Multi}$ prefix are multivariate distributions and distributions with $\mathtt{Half}$ prefix are restricted to have non-negative values.  -->

<!-- The vector of village-level parameters has the following multivariate distribution: -->

<!-- $$ -->
<!-- \forall j: \theta_j \sim \mathtt{MultiStudentT}(\nu^\text{village}, \theta_{k[j]}, \Sigma_{k[j]}^\text{village}) -->
<!-- $$ -->
<!-- while the county-level parameters have the following distribution -->
<!-- $$ -->
<!-- \forall k: \theta_k \sim \mathtt{MultiStudentT}(\nu^\text{county}, \theta^o, \Sigma^\text{county}) -->
<!-- $$ -->
<!-- where $\theta^o = (\alpha^o, \beta^o)$ are the hyperparameters of the linear model: -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \alpha^o &\sim \mathtt{Normal}(0, 5) \\ -->
<!-- \beta^o &\sim \mathtt{MultiNormal}(0, \mathsf{diag}(1)) -->
<!-- \end{aligned} -->
<!-- $$ -->
<!-- ($\mathsf{diag}(x)$ is a matrix with the diagonal vector $x$.) -->

<!-- The covariance matrices for $\theta_j$ and $\theta_k$ are defined as -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \forall k: \Sigma_k^\text{village} &= \mathsf{diag}(\sigma^\text{village}) \Omega_k^\text{village} \mathsf{diag}(\sigma^\text{village}) \\ -->
<!-- \Sigma^\text{county} &= \mathsf{diag}(\sigma^\text{county}) \Omega^\text{county} \mathsf{diag}(\sigma^\text{county}) -->
<!-- \end{aligned} -->
<!-- $$ -->
<!-- where $\Omega_k^\text{village}$ and $\Omega^\text{county}$ are correlation matrices with their own prior distributions. -->

<!-- Other hyperparameters have the following prior distributions -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \nu^\text{village} &\sim \Gamma(2, 0.1) \\ -->
<!-- \nu^\text{county} &\sim \Gamma(2, 0.1) \\ -->
<!-- \sigma^\text{village} &\sim \mathtt{HalfMultiNormal}(0, \mathsf{diag}(1)) \\ -->
<!-- \sigma^\text{county} &\sim \mathtt{HalfMultiNormal}(0, \mathsf{diag}(1)) \\ -->
<!-- \end{aligned} -->
<!-- $$ -->

<!-- ### Posterior Distribution of Model Parameters -->

<!-- Let $\theta$ be a vector of all linear model parameters at all levels and $\phi$ is a vector of all hyperparameters, and $\mathbf{Y}$ is a matrix of all observed outcomes. To conduct our inference we need to calculate the distribution -->
<!-- $$ -->
<!-- p(\theta,\phi|\mathbf{Y}^\text{observed}, \mathbf{Z}^\text{observed}, \mathbf{X}) = p(\mathbf{Y}^\text{observed} | \mathbf{Z}^\text{observed}, \mathbf{X}, \theta, \phi) p(\theta | \phi) p(\phi) -->
<!-- $$ -->

<!-- ### Inference -->

<!-- After calculating the posterior distribution of the model's parameters we want to be able to calculate, for any two treatments $z$ and $z'$, the distribution of the average treatment effect -->
<!-- $$ -->
<!-- \frac{1}{N} \Sigma_i Y_i(z) - Y_i(z') -->
<!-- $$ -->

<!-- Since we only observe at most one outcome of $Y_i(\cdot)$, we need to quantify the distribution of _missing_ counterfactuals: -->
<!-- $$ -->
<!-- p(\mathbf{Y}^\text{missing} | \mathbf{Y}^\text{observed}, \mathbf{Z}^\text{observed}, \mathbf{Z}^\text{missing}, \mathbf{X}) = \int p(\mathbf{Y}^\text{missing} | \mathbf{Z}^\text{missing}, \mathbf{X}, \theta, \phi) \cdot p(\theta,\phi|\mathbf{Y}^\text{observed}, \mathbf{Z}^\text{observed}, \mathbf{X})\, d\theta d\phi -->
<!-- $$ -->

<!-- ## Dynamic Model -->

<!-- The text message treatment may only imperfectly capture the potential salience and information effects of the bracelet and ink signals. Individuals might become inattentive to text messages over time, due to the repetitiveness of the reminder messages, or not pay sufficient attention to information about peer take-up as it is communicated in an abstract way (e.g. "few" versus "half" of people dewormed). The possible difference in salience and information effects of text messages, and bracelets or ink is a valid concern. Individuals might become inattentive to text messages as the reminder content is the same each time, and information about peers' take-up might appear abstract (e.g., "few" versus "half" of people dewormed). Signals on the other hand, allow adults to observe on a daily basis who dewormed, providing information about the take-up decisions of specific friends, neighbors or family members. Further, despite adults' low private valuation of bracelets, bracelets could gain popularity and a fad could emerge as more adults start wearing the item. To separately identify these dynamic effects, we estimate a piecewise-constant proportional hazard model [@Wooldridge2010] that uses the full information about changes in take-up levels across the twelve days of deworming. We model the probability to deworm, conditional on not having already done so, extending the static model to twelve deworming days $m \in \{1,...,12\}$.^[The estimation is restricted to the sample of name-matched individuals.] -->

<!-- ### Likelihood Model -->

<!-- The dynamic model is extends the static model to the 12 deworming days. -->

<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \Pr[Y_{im} = 1 | Y_{i,m-1} = 0, \mathbf{Z}_i, \mathbf{X}_i, \theta_{j[i]}] &= g^{-1}(\eta_{im} | \theta_{j[i]}) \\ -->
<!-- \eta_{im} &= \log(\lambda_{k[i],m}) + f(\mathbf{Z}_i, \mathbf{X}_i | \theta^\text{static}_{j[i]}) + f_m(\mathbf{Z}_i, \mathbf{X}_i | \theta^\text{dynamic}_{k[i]}) \\ -->
<!-- \\ -->
<!-- \Pr[Y_{im} = 1 | Y_{i,m-1} = 1, \mathbf{Z}_i, \mathbf{X}_i, \theta_{j[i]}] &= 1 \\ -->
<!-- \Pr[Y_{im} = 0 | Y_{i,m-1} = 1, \mathbf{Z}_i, \mathbf{X}_i, \theta_{j[i]}] &= 0 -->
<!-- \end{aligned} -->
<!-- $$ -->

<!-- The link function $g$ here is a complementary log-log.^[Logit and probit work just as well.] $\lambda_{km}$ the is the piecewise-constant proportional hazard for deworming day $m$, that is, the the probability of deworming on day $m$ conditional on not having dewormed on day $m-1$. The term captures individuals' preferences for deworming on particular days, e.g., given individuals' different work arrangements some might prefer to come for deworming on weekends than weekdays. The linear function $f$ is the same as in the static model. Indicators for treatments (ink, calendar, bracelet; far distance; reminder and social info) enter linearly and are interacted. Dynamic treatment effect are captured by the $f_m$ quadratic function, where $m$ is interacted with treatment indicators.  -->

### Model Averaging

So far we described three models we will use to conduct our estimation of the effects of the incentives/signals, travel cost (distance), and isolated social signaling. These models defer significantly from each other in both the identification assumptions needed and the statistical parametric models used. In addition, it is very unlikely that any of these models is the true model generating the data we will observe. In particular the assumptions we made in the structural model help us build a convenient and tractable structure. Consider the following assumptions, not likely to be true

1. The prosocial type is assumed to have a standard normal distribution and all individuals have this information.
2. The $v^*$ cutoff is uniformally inferred by all and is assumed to be at the equilibrium level.
3. Unmodeled background variables (shocks or error terms) for the private consumption utility, reputational utility, prosocial utility, etc. are assumed to be additive.

Because of the diversity of models under consideration, estimation results are expected to differ between the models. Therefore we will need a way to combine these results quantitative manner.

@Yao2018 propose _stacking_ as a method of combining or averaging over a set of models that we know does not include the true model.^[This is referred to as an $\mathcal{M}$-open relationship between the true model and the candidate models.] This challenge has normally been addressed using other methods such as Bayesian model averaging, stacking of means, or mixture models. In the econometrics literature, a similar is proposed by Geweke and Amisano [-@Geweke; -@Geweke2012]: they also are dealing with the problem of how to avoid selecting one among a number of misspecified models but instead to place different weights on the models under consideration based on cross validation.

We use @Yao2018's method to calculate a weighted average of all the quantities estimated, using 10-fold cross validation.^[Leave-one-group-out cross validation is too time demanding and Pareto-smoothed importance sampling leave-one-out is not reliable using our data [@Vehtari2017].] For the estimands that are computable with all out models, such as the straight-forward intention-to-treat average treatment effects, we will calculate the stacked estimand using the (i) reduced form model, (ii) the structural no-salience model, and (iii) the structural with-salience model. For estimands only computable using the two structural model variants, we will produce a stacked estimands. 

For example, having calculated the stacking weights, $\bf{\hat{w}}$, we can can calculate the stacked quantity for $\fsexpect{Y(z,g)}$,

\[ \textrm{E}^\textrm{stacked}\left[\fsexpect{Y(z,g)}\right] \approx \frac{1}{S} \frac{1}{N} \sum_k \sum_s \sum_j \hat{w}_k \tilde{\bar{Y}}_{kjs}(z,g), \]
where $k$ is the model index.

## Willingness-to-Pay Model

Let

* $V^c_i$ and $V^b_i$ be an individual's monetary valuation of calendars and bracelets, respectively.
* $G_i \in \{0, 1\}$ indicates initial gift choice of calendar (vs bracelet). Also, let $\widetilde{G}_i \equiv 2\cdot G_i - 1 \in \{-1, 1\}$.
* $M_i \in \{0, 10, 20,\ldots, 100\}$ be the randomly assigned offer (in Ksh) to switch gifts choice (calendar instead of bracelet and v.v.)
* $W_i(m) \in \{0, 1\}$ indicates accepting $m$ Ksh to switch gift choice.

\begin{align*}
  V_i \equiv V^c_i - V^b_i &\sim \mathtt{StudentT}(\nu_v, \mu_{k[i]}, \sigma) \\
  \mu_k &\sim \mathtt{StudentT}(\nu_\mu, \mu, \tau_\mu) \\
  \mu &\sim \mathtt{StudentT}(\nu_\mu, 0, \tau_\mu) \\
  \sigma &\sim \mathtt{HalfStudentT}(\nu_\sigma, 0, \tau_\sigma)
\end{align*}

with fixed hyperparameters: $\nu_v, \nu_\mu, \nu_\sigma, \tau_\mu, \tau_\sigma$.

<!-- TODO Specify fixed hyperparameter values -->

We estimate these model parameters using the likelihood probability:

\begin{equation*}
\mathcal{L}_i = \left\{\widetilde{G}_i\cdot [F_V(\widetilde{G}_i \cdot M_i|\mu, \mu_{k[i]}, \sigma) - F_V(0|\mu, \mu_{k[i]}, \sigma)]\right\}^{W_i}\cdot\left\{ F_V(\widetilde{G}_i\cdot M_i|\mu, \mu_{k[i]}, \sigma)\right\}^{(1 - W_i)} 
\end{equation*}

## Beliefs and Knowledge Model

### Model subscripts 

* $i$: individuals
* $j$: clusters (villages)

### Variables

* $Y_i^\text{rec} \in \{0, 1, \ldots, 10\}$, the number of of individuals recognized (from a list of 10 randomly selected community members).
* $Y_i^\text{2ord} \in \{0, 1, \ldots, Y_i^\text{rec}\}(z)$, second-order beliefs about the $Y_i^\text{rec}$ recognized community members. $\overline{Y}^\text{ 2ord,fp}(z)$ is the estimated proportion of $X^\text{degree}_i$.
* $Y_i^\text{1ord} \in \{0, 1, \ldots, Y_i^\text{rec}\}$, first-order beliefs about the $Y_i^\text{rec}$ recognized community members. $\overline{Y}^\text{1ord,fp}(z)$ is the estimated proportion of $X^\text{degree}_i$.
* $N_j \in \mathcal{Z}^+$, the population size of village $j$ (observed from the census).
* $X_i^\text{degree} \in \{Y_i^\text{rec}, \ldots, N_{j[i]}\}$, the estimated number of community members $i$ recognizes.
* $\mathbf{Z}_i$, assigned treatment: incentive treatments, SMS treatment, distance treatment 

### Likelihood Model

#### Social connectness or recognition

The first stage is to impute each respondents' recognition degree by estimating a parametric binomial model. $g$ is a link function (e.g. logit). One thing doesn't makes sense here: $\delta^\text{rec}_{j}$ is the coefficient for a village level independent variable, $N_j$. It seems like $\delta^\text{rec}_j$ should just be a village level random effect or make it a county level parameter.

$$
\begin{aligned}
  Y_i^\text{rec} &\sim \mathtt{Binomial}(10, p_i^\text{rec}) \\
  p_i^\text{rec} &= g^{-1}(\alpha_i^\text{rec} + \delta_{j[i]}^\text{rec}\cdot N_{j[i]}) \\
  X_i^\text{degree} &= Y_i^\text{rec} + p^\text{rec}_i \cdot(N_{j[i]} - 10)  
\end{aligned}
$$

$X_i^\text{degree}$ is imputed by adding the known $Y_i^\text{rec}$ with the estimated number of community members (and not asked about in the survey) recognized.

#### Second-order beliefs

Same as above but with treatment assignment potentially having a causal effect. Same comment as above about parameter levels.

$$
\begin{aligned}
  Y_i^\text{2ord}(\mathbf{Z}_i) &\sim \mathtt{Binomial}(Y^\text{rec}_i, p_i^\text{2ord}(\mathbf{Z}_i)) \\
  p_i^\text{2ord}(\mathbf{z}) &= g^{-1}(\alpha_i^\text{2ord} + \mathbf{z}\cdot \beta_i^\text{2ord} + \delta_i^\text{2ord}\cdot N_{j[i]}) \\
  \overline{Y}^\text{ 2ord,fp}(\mathbf{Z}_i) &= \frac{Y_i^\text{2ord} + p_i^\text{2ord}(\mathbf{Z}_i)\cdot p_i^\text{rec}\cdot (N_{j[i]} - 10)}{X_i^\text{degree}}
\end{aligned} 
$$
The number of community members $i$ has second-order beliefs^[In the current model $Y_i^\text{2ord} = 1 \iff$ $i$ reports yes/no.] is the sum of the observed sampled $Y_i^\text{2ord}$ and the estimated beliefs about the remaining population not asked about, $p_i^\text{rec}\cdot(N_{j[i]} - 10)$.

For unobserved (missing) treatment $\mathbf{z}^\text{missing}$ we impute $\overline{Y}^\text{ 2ord,fp}(\mathbf{z}^\text{missing})$ as
$$
\overline{Y}^\text{ 2ord,fp}(\mathbf{z}^\text{missing}) = \frac{p_i^\text{2ord}(\mathbf{z}^\text{missing})\cdot p_i^\text{rec}\cdot N_{j[i]}}{X_i^\text{degree}}
$$

#### First-order beliefs

The first-order beliefs model is the same as the second-order model.

# Results

```{r load-beliefs-prep-data}
load(file.path("data", "stan_analysis_data", "beliefs_processed.RData"))
```

## Assumptions and Mechanisms

In our experiment, we assume that the bracelets and ink as signals increase the visiility of actions and lead adults to have more accurate beliefs about others' deworming decisions. At endline, we collected detailed data on the visibility of signals and adults' belief to verify these. We first provide descriptive data on visibility. Second we estimate the impact of signals on individuals' beliefs.   

###  Visibility of Signals {-}

Each respondent was asked if they had seen people with a bracelet, or ink on their finger, or a calendar.^[Respondents that said they were not aware that deworming was offered to their community, i.e. answered "No" to the question "Did you know that deworming was offered to adults in your community?" were not asked about the incentives. Respondents who knew about the signals/incentives were then asked "Have you seen people wearing these bracelets?" "Have you seen this mark of ink people's fingers?" "Have you seen this calendar?". By "people", respondents were asked to think of people outside their household.] 66 and 73 percent of respondents in the ink and calendar treatments respectively reported to have seen someone with the signal/incentive. For bracelets, the visibility was significantly higher with 95 percent of respondents reporting to have seen someone with a bracelet. Bracelets were also more durable as signals, increasing the length of time during which deworming decisions could be observed. At endline, 46 percent of dewormed adults in the bracelet treatment were still wearing the bracelet and 90 percent still had the bracelet.^[Surveyors from their own observation verified the retention of signals/incentives, answering the questions: "Is the person still wearing the bracelet?" "Is the ink still visible?" "Do you still have the calendar?"] Only 14 percent of dewormed adults in ink treatment still had ink on their finger. 95 percent of dewormed respondents in the calendar treatment, still had the calendar in their possession. Taken together, this shows that bracelets were significantly more visible than the ink and a more durable signal. The social visibility of ink was no different than that of a private incentive. Given the high retention and private visibility of calendars, the calendar incentive also provides an adequate control for any potential self-signaling value of bracelets.

###  Observability of Actions {-} 

To measure (perceived) information asymmetries in deworming decisions, we asked each endline respondent about a random subsample of ten other adults in their community. The objective was to learn about the information that adults have about other adults within their (potential) reference group (instead of only about close contacts e.g. household members, family). Conditional on recognizing the person's name, we asked  i) "Do you think this person came for deworming?", ii) "Do you think this person thinks you came for deworming, or do you think they think you did not come for deworming?", iii) "Why do you think they would think that?" and iv) "What is your relationship to the person?". Question i) measures first-order beliefs, capturing the information that respondents have about others' deworming status, and ii) measures second-order beliefs, capturing the information that respondents believe that others have about their deworming status. Both questions could be answered with Yes, No or Don't know.

```{r table-A-relationships, fig.width=8, fig.height=3, fig.cap="This figure displays the relationship between endline respondents and other adults in their community. Half of the sample of endline respondents (N = 1,626) were asked about a random subset of ten adults in their community. Among the 16,260 other adults named, 7,520 (46.25 percent) were recognized by respondents. Conditional on a name being recognized the respondent was asked about her/his relationship to the person."}
endline.know.table.data %>% 
  filter(know.table.type == "table.A", !is.na(relationship)) %>% 
  mutate(relationship = fct_infreq(relationship) %>% fct_relabel(str_to_title)) %>% {
    ggplot(.) +
      geom_bar(aes(relationship, y = ..count../sum(..count..)), alpha = 0.5, color = "black") + 
      labs(x = "Relationship", y = "Proportion", 
           title = "Reported Relationships", caption = sprintf("Number of knowledge queries: %d", nrow(.))) +
      scale_y_continuous(breaks = seq(0, 1, 0.1)) + 
      coord_flip() + 
      NULL
  }
```

```{r first-order-deworm-status, fig.width=8, fig.height=5, fig.cap="This figure shows endline respondents' first-order beliefs about other adults' deworming choices, by relationship. The proportions reported here are relative to the relationship group. Answers are pooled across control, ink, calendar and bracelet treatments. Half of the sample of endline respondents (N = 1,626) were asked about a random subset of ten adults in their community. Among the 16,260 adults named, 7,520 (46.25 percent) were recognized by respondents. Conditional on a name being recognized the respondent was asked \"Do you think this person came for deworming?\". The answer options were \"Yes\", \"No\" and \"Don't know\"."}
endline.know.table.data %>% 
  filter(know.table.type == "table.A", recognized == "yes") %>% 
  mutate(relationship = fct_infreq(relationship) %>% fct_relabel(str_to_title),
         dewormed = str_to_title(dewormed)) %>% 
  group_by(relationship) %>% 
  mutate(rel.size = n()) %>% 
  group_by(dewormed, add = TRUE) %>% 
  summarize(prop = n()/first(rel.size)) %>% 
  ungroup %>% {
    ggplot(., aes(x = relationship, group = dewormed)) +
      geom_col(aes(y = prop, fill = dewormed), position = "dodge", alpha = 0.5, color = "black") + 
      labs(x = "Relationship", y = "Proportion", title = "Do you think this person came for deworming?", 
           caption = "Proportions are relative to relationship group.") +
      scale_y_continuous(breaks = seq(0, 1, 0.1)) +
      scale_fill_discrete("Other Dewormed") +
      coord_flip()
  }
```

```{r second-order-deworm-status, fig.width=8, fig.height=6, fig.cap="The figure shows endline respondents' second-order beliefs about other adults' deworming decision, by relationship. The proportions reported here are relative to the relationship group. Answers are pooled across control, ink, calendar and bracelet treatments. Half of the sample of endline respondents (N = 1,626) were asked about a random subset of ten adults in their community. Among the 16,260 adults named, 7,520 (46.25 percent) were recognized by respondents. Conditional on a name being recognized the respondent was asked \"Do you think this person thinks you came for deworming, or do you think they think you did not come for deworming?\". The answer options were \"Yes\", \"No\" and \"Don't know\"."}
endline.know.table.data %>% 
  filter(know.table.type == "table.A", recognized == "yes") %>% 
  mutate(relationship = fct_infreq(relationship) %>% fct_relabel(str_to_title),
         second.order = str_to_title(second.order)) %>% 
  group_by(relationship) %>% 
  mutate(rel.size = n()) %>% 
  group_by(second.order, add = TRUE) %>% 
  summarize(prop = n()/first(rel.size)) %>% 
  ungroup %>% {
    ggplot(., aes(x = relationship, group = second.order)) +
      geom_col(aes(y = prop, fill = second.order), position = "dodge", alpha = 0.5, color = "black") + 
      labs(x = "Relationship", y = "Proportion", title = "Do you think this person thinks you came for deworming?", 
           caption = "Proportions are relative to relationship group.") +
      scale_y_continuous(breaks = seq(0, 1, 0.1)) +
      scale_fill_discrete("Other Dewormed") +
      coord_flip()
  }
```

Figure \ref{fig:table-A-relationships} shows that the majority of recognized adults are neighbors (49 percent) and extended family (29 percent). Figures \ref{fig:first-order-deworm-status} and \ref{fig:second-order-deworm-status} show that adults generally (believe to) have more information about the deworming status of household members and extended family, than of neighbors or community members.  

```{r fp-2ord-prop-knows-mean-all, fig.width=8, fig.height=3, fig.cap="Second order beliefs (levels)."}
plot_takeup(
  takeup_summ_data = fp_2ord_prop_knows_mean_all,
  data_preparer = . %>%
    filter(
      incentive_treatment != "Bracelet Social"
      ),
  incentive_treatment_col = "incentive_treatment",
  show_observed = FALSE
    ) +
  labs(title = "Second Order Beliefs (Levels)", 
       subtitle = "Proportion of recognized peers with knowledge of one's deworming status", y = "") 
```

```{r fp-1ord-prop-knows-mean-all, fig.width=8, fig.height=3, fig.cap="First order beliefs (levels)."}
plot_takeup(
  takeup_summ_data = fp_1ord_prop_knows_mean_all,
  data_preparer = . %>%
    filter(
      incentive_treatment != "Bracelet Social"
      ),
  incentive_treatment_col = "incentive_treatment",
  show_observed = FALSE
    ) +
  labs(title = "First Order Beliefs (Levels)", 
       subtitle = "Proportion of recognized peers whose deworming status is reported known", y = "") 
```


```{r fp_1ord_prop_knows_mean_phone, fig.width=8, fig.height=5, fig.cap="First order beliefs (levels), split by phone ownership.", eval=FALSE}
plot_takeup(
  takeup_summ_data = fp_1ord_prop_knows_mean_phone,
  data_preparer = . %>%
    filter(
      incentive_treatment != "Bracelet Social"
      ) %>% 
      mutate_at(vars(starts_with("phone_owner")), list(~ factor(., levels = c(FALSE, TRUE), labels = c("Non-Phone Owners", "Phone Owners")))), 
  incentive_treatment_col = "incentive_treatment",
  show_observed = FALSE
    ) +
  labs(title = "First Order Beliefs (Levels)", 
       subtitle = "Proportion of recognized peers whose deworming status is reported known", y = "") +
  facet_wrap(~ phone_owner, ncol = 1) 
  # theme(strip.text = element_text(size = 15, face = "bold"))
```

```{r fp_1ord_ate, fig.width=8, fig.height=3, eval=FALSE}
fp_1ord_prop_knows_ate_all %>%
  filter(incentive_treatment_left != "bracelet social",
         !(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar")) %>%
  plot_ate(
    ate_summ_data = .,
      data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"),
             incentive_treatment_left != incentive_treatment_right),
    incentive_treatment_left_col = "incentive_treatment_left" 
  ) + 
  labs(title = "First Order Beliefs (ATE)", 
       subtitle = "Average change in the proportion of recognized peers whose deworming status is reported known", 
       y = "") 
```

```{r fp_1ord_ate_phone, fig.width=8, fig.height=5, eval=FALSE}
fp_1ord_prop_knows_ate_phone %>%
  filter(incentive_treatment_left != "bracelet social",
         !(incentive_treatment_left == "bracelet" & incentive_treatment_right == "calendar")) %>%
  plot_ate(
    ate_summ_data = .,
      data_preparer = . %>% 
      filter(incentive_treatment_right %in% c("Control", "Calendar"),
             incentive_treatment_left != incentive_treatment_right) %>% 
      mutate_at(vars(starts_with("phone_owner")), list(~ factor(., levels = c(FALSE, TRUE), labels = c("Non-Phone Owners", "Phone Owners")))), 
    incentive_treatment_left_col = "incentive_treatment_left" 
  ) + 
  labs(title = "First Order Beliefs (ATE)", 
       subtitle = "Average change in the proportion of recognized peers whose deworming status is reported known", 
       y = "") +
  facet_wrap(~ phone_owner_left, ncol = 1) 
```

## Isolating Social Signaling

### Controlling for the Consumption Value of Bracelets {-} 

```{r wtp-stan-data, warning=FALSE}
wtp_stan_data <- analysis.data %>% 
  mutate(stratum = county) %>% 
  prepare_bayes_wtp_data(
    wtp.data,
    
    wtp_utility_df = 3,
    tau_mu_wtp_diff = 100,
    mu_wtp_df_student_t = 7,
    tau_sigma_wtp_diff = 50,
    sigma_wtp_df_student_t = 2.5
  )
```

```{r load-wtp-fit}
wtp_model_0_fit <- dir(file.path("data", "stanfit"), pattern = "wtp_model_2_[1-8].csv", full.names = TRUE) %>% 
  read_stan_csv()
```

```{r prepare-wtp-sim-data}
wtp_sim_data <- as.data.frame(wtp_model_0_fit, pars = c("sim_gift_choice", "sim_wtp_response")) %>% 
  mutate(run_id = seq_len(n())) %>% 
  gather(outcome_id, sim_outcome, -run_id) %>% 
  separate(outcome_id, c("outcome", "obs_id"), "(\\[)|\\]", extra = "drop") %>% 
  mutate_at(vars(obs_id), as.integer) 
```

```{r wtp-table, results="asis"}
wtp_model_0_fit %>% 
  summary(par = c("hyper_mu_wtp_diff", "sigma_wtp_diff", "mu_wtp_diff", "hyper_prob_prefer_calendar", "prob_prefer_calendar"), 
          probs = c(0.025, 0.05, 0.5, 0.95, 0.975)) %$% 
  summary %>% 
  xtable::xtable(caption = "Posterior Estimates for Willing-to-Pay Parameters\\label{tab:wtp}",
                 align = "lrrrrrrrrrr") %>% 
  print(sanitize.colnames.function = . %>% 
          str_replace_all(c("se\\_mean" = "$SE_{Mean}$",
                            "mean" = "Mean",
                            "sd" = "SD",
                            "%" = "\\\\%",
                            "n_eff" = "$N_{eff}$",
                            "Rhat" = "$\\\\hat{R}$")),
        sanitize.rownames.function = . %>% 
          str_replace_all(c("hyper_mu_wtp_diff" = "$\\\\mu$",
                            "sigma_wtp_diff" = "$\\\\sigma$",
                            "mu_wtp_diff\\[(\\d)\\]" = "$\\\\mu_\\1$",
                            "hyper_prob_prefer_calendar" = "$\\\\Pr[V^c_i > V^b_i]$",
                            "prob_prefer_calendar\\[(\\d)\\]" = "$\\\\Pr[V^c_i > V^b_i|k = \\1]$")),
        booktabs = TRUE,
        comment = FALSE)
```

To test the assumption that the consumption value of the bracelet is equal to that of the calendar, we conducted a separate willingness-to-pay experiment with a random subsample of adults in the control group as part of the endline survey. Adults had no prior exposure to the bracelet or calendar incentives. The experiment was conducted in two stages. First, as a gift for completing the survey, adults were offered a bracelet or calendar. The majority of people (75 percent) chose the calendar, 23 percent chose the bracelet and 2 percent wanted neither of the items. After choosing their preferred item, respondents were offered to exchange it for the not chosen item, plus a randomly assigned Kenyan Shilling (KSh) value between 0 and 100 (0 and \$1). We estimate the average utility difference between the two items. Table \ref{tab:wtp} shows the summary of the posterior distribution of the willingness-to-pay model. On average, individuals value the calendar between 42-53 KSh more than the bracelet (see $\mu_1$, $\mu_2$ and $\mu_3$ as separately estimated for each strata i.e., county). The calendar is therefore a valid control for the consumption value of the bracelet. In the following estimation we assume that the private value of bracelets is equal to calendars, which is a conservative assumption given the greater preference for calendars. 

<!-- ### Reminders and Information about Community Take-up Levels {-}  -->

<!-- ```{r social-info-reported, fig.width=8, fig.height=5, fig.cap="Social information reported to adults, split by distance."} -->
<!-- after.msg.days <- seq(3, 11, 2) -->

<!-- social.info.data %>% { -->
<!--   plot.takeup.dynamics(., .aes = aes(dewormed.day, cumul, color = assigned.treatment, linetype = dist.pot.group)) + -->
<!--     # geom_ribbon(aes(ymin = qant.25, ymax = qant.75, fill = assigned.treatment, color = NULL), alpha = 0.15) + -->
<!--     labs(y = "Reported Take-up", title = "Social Information Reported to Subjects", subtitle = "Split by incentive treatment") + -->
<!--     coord_cartesian(ylim = c(0, 0.8)) + -->
<!--     scale_linetype_discrete("Distance from PoT", labels = c("Close", "Far")) +  -->
<!--     theme(legend.position = "right") + -->
<!--     NULL -->
<!-- } -->
<!-- ``` -->

<!-- Given that signals increased the visibility of deworming (see First stage results), signals could _also_ have affected take-up decisions by acting as reminders, or causing individuals to update their beliefs about the overall level of take-up $\bar{y}$ and the benefits of deworming. To control for these effects, an ideal experiment would i) provide the same take-up information observed by individuals in the bracelet (ink) treatment to individuals in the calendar (control) treatment and ii) saturate individuals with reminders. Figure \ref{fig:social-info-reported} shows the actual information adults were texted. Texted take-up levels between bracelet and calendar, and control and ink for close communities are comparable.^[The information was texted in whole numbers such that 2.6 and 3.4 would be 3 out of 10.] For individuals located in far communities, texted take-up levels differed significantly between bracelet and calendar, and ink and control. We find that the text message treatment had no effect on adults' beliefs about community level take-up.  -->

## Main Results: Deworming Take-Up

Before discussing the main analysis results, we present some relevant analyses. First, we present in Figure \ref{fig:dist-results} the posterior distribution of distance in kilometers in response to assigned distance groups. We include a frequency plot to compare it against distances observed in the experiment. 

```{r dist-results, fig.width=8, fig.cap="Fit and observed distance to deworming treatment, conditional on assigned distance group."}
group_dist_param %>% 
  mutate(distrib_samples = map2(group_dist_mean, group_dist_sd,
                                ~ tibble(x = seq(-500, 3000, 10),
                                         density = dnorm(x, mean = ..1 * ..3, sd = ..2 * ..3)),
                                original_dist_sd = sd(stan_data$analysis_data$cluster.dist.to.pot))) %>%
  ungroup() %>% 
  select(iter_id:mix_index, group_dist_mix, distrib_samples) %>% 
  pivot_wider(id_cols = c(iter_id, assigned_dist_group), names_from = mix_index, values_from = c(group_dist_mix, distrib_samples)) %>% 
  mutate(distrib_samples = map2(distrib_samples_1, distrib_samples_2, inner_join, by = "x", suffix = c("_1", "_2")) %>% 
           map2(group_dist_mix_1, ~ mutate(.x, density = .y * density_1 + (1 - .y) * density_2))) %>% 
  select(-distrib_samples_1, -distrib_samples_2) %>% 
  unnest(distrib_samples) %>% 
  ggplot() +
  geom_line(aes(x, density, group = iter_id, color = "Posterior Samples"), alpha = 0.04) +
  geom_freqpoly(aes(x = cluster.dist.to.pot, y = stat(density), color = "Observed Sample Frequency"),
                 binwidth = 200,
                 size = 0.8,
                 data = stan_data$analysis_data %>% distinct(cluster_id, assigned_dist_group = dist.pot.group, cluster.dist.to.pot)) +
  scale_color_manual("", values = c("Posterior Samples" = "black", "Observed Sample Frequency" = "firebrick3")) +
  labs(
    title = "Fit and observed distance to deworming treatment, conditional on assigned distance group (g).",
    x = "Distance",
    y = "",
    caption = "The observed sample distance frequency plot was calculated using bins of width 200 meters.
               Posterior sample distributions are shown using 500 iterations."
  ) +
  coord_cartesian(xlim = c(0, 3000)) +
  theme(axis.text.y = element_blank()) +
  facet_wrap(vars(assigned_dist_group), ncol = 1, labeller = as_labeller(. %>% str_c("g = ", .))) +
  NULL
```

Second, we present the cross validation results and the stacking weights used in Table \ref{tab:cv-table}. We show the difference in expected log predictive density, the standard error of this difference, the stacking weights for all models, and the stacking weights for the structural models only. As can be seen, even if our goals was to select one of these models, we would not have been able to due to the large elpd difference standard errors. In the following sections, we will present results for all models but focus our discussion on the stacked models. 

```{r cv-table}
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), !is.na(stacking_weight)) %>% 
  select(model_name, elpd_diff, se_elpd_diff, stacking_weight, stacking_weight_by_type) %>% 
  kable(col.names = c("Model", "elpd Difference", "Difference SE", "Weight", "Weight (structural)"), 
        format = "latex", booktab = TRUE, longtable = FALSE, caption = "Cross validation results.")
```


### Result 1. The Effect of Visibility $x$ on Take-up Decisions {-}

```{r take-up-levels, fig.width=8,fig.height=6, fig.cap="Take-up levels in response to an incentive treatment intervention.",cache=FALSE}
dist_fit_data %>%
  filter(!fct_match(model, "STRUCTURAL_STACKED")) %>% 
  mutate(est_takeup_level = map(est_takeup_level, filter, is.na(mu_assigned_treatment) | mu_assigned_treatment == assigned_treatment)) %>% 
  select(est_takeup_level, model, model_name, fit_type) %>% 
  unnest(est_takeup_level) %>% 
  filter(is.na(assigned_dist_group)) %>% 
  plot_estimands(assigned_treatment) +
  scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
    labs(
      title = "Take-up levels in response to an incentive treatment intervention",
      subtitle = TeX("\\hat{E}\\[Y(z)\\]"),
      x = "Take-up Probability") +
  NULL
```

```{r take-up-ate, fig.width=8,fig.height=8.5, fig.cap="Average treatment effect in response to an incentive treatment intervention."}
dist_fit_data %>% 
  filter(!fct_match(model, "STRUCTURAL_STACKED")) %>% 
  mutate(est_takeup_te =
    map_if(est_takeup_te, 
           fct_match(model_type, "structural"), filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right) %>% 
    map(filter, 
        is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right),
        assigned_treatment_left != assigned_treatment_right,
        fct_match(assigned_treatment_right, c("control", "calendar")))) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  mutate_at(vars(starts_with("assigned_dist_group")), fct_explicit_na, "Combined") %>% 
  plot_estimands(assigned_treatment_left) +
  scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
    labs(
      title = "Average treatment effect in response to an incentive treatment intervention", 
      subtitle = TeX("\\hat{E}\\[Y(z)\\] - \\hat{E}\\[Y(z')\\]"),
      x = "Average Treatment Effect") +
  facet_wrap(vars(assigned_treatment_right), ncol = 1, labeller = as_labeller(. %>% str_c("Compared to, $z' = ", ., "$") %>% TeX(), default = label_parsed), scales = "free_y") +
  NULL
```


<!-- r str_credible_interval(dist_fit_data, "STRUCTURAL_LINEAR", est_takeup_level, fct_match(assigned_treatment, "control"), mu_assigned_treatment == assigned_treatment, is.na(assigned_dist_group)) -->

<!-- Figure \ref{fig:static_level_smsctrl} shows deworming take-up levels for the four main treatments, excluding individuals that received the text message treatment. Take-up levels are generally low, with only 36 percent of individuals coming for deworming treatment in the control group. Figure \ref{fig:static_ate_smsctrl-2} presents evidence on the impact of signals/incentives on take-up. In black we show the effects of treatments compared to the control. In blue, we estimate the effect of the bracelet holding constant the consumption value at the level of the calendar. Bracelets have a strong positive effect (8.4  percentage points / 5.6 percentage points) over the control and calendar group, increasing take-up by 24 percent and 13 percent respectively. Despite calendars being privately preferred to bracelets, the calendar increases take-up only marginally by 2.9 percentage points (one-third of bracelet effect). The mean average treatment effect of ink is positive but small and with greater uncertainty in its direction.  -->

Figure \ref{fig:take-up-levels} shows deworming take-up levels for the four main treatments. Take-up levels are generally low in the control arm, with below 40 percent of individuals coming for deworming treatment. Figure \ref{fig:take-up-ate} presents evidence of the impact of signals/incentives on take-up. The top panel shows estimation of the average treatment effect in comparison with the control arm, while the bottom panel shows estimation of the average treatment effect in comparison with the calendar incentive arm.  Bracelets have a strong positive effect: its 80% credible interval is
`r bracelet_vs_control_ate_ci` percentage points in comparison with the control and `r bracelet_vs_calendar_ate_ci` percentage in comparison to the calendar incentive. Using the posterior means of these average treatment effects and the control arm level, this is an increase in take-up of `r round(bracelet_vs_control_ate_mean/control_level_mean, 3) * 100` percent and `r round(bracelet_vs_calendar_ate_mean/control_level_mean, 3) * 100` percent, respectively. Despite calendars being privately preferred to bracelets, the 80% credible interval for the calendar average treatment effect is `r calendar_vs_control_ate_ci` percentage points, while ink has the uninformative interval `r ink_vs_control_ate_ci` percentage points---likely having too small of a positive effect or even a negative effect.

<!-- Figure \ref{fig:static_ate_all} compares the average treatment effects of signals/incentives for individuals in the control group without text messages to individuals that received the Social Info/Reminder text messages. Signal/incentive treatment effects remain stable and we find no evidence for substitution or complementarity effects between signaling treatments and reminders/social information. This suggests that our signaling treatments are not confounded and identify the partial effect of social signaling on deworming take-up. We interpret the difference in treatment effects between bracelets and ink as (partly) due to differences in the first stage. The ink treatment was much less visible and durable as signal than the bracelets. In addition, anecdotally some people expressed concerns about having their finger inked given its link to elections. It is therefore possible that the ink had a negative private consumption value which would have further lowered its effectiveness.    -->

<!-- ***The Persuasion Effect of Text Messages*** -->
<!-- you need to explain why the text message effect is so large. you need to explain why.... -->

<!-- Figure \ref{fig:static_ate_combined_sms} shows that the text message treatment had a large effect on deworming take-up. Text messages increased the average take-up level by 13 percentage points in the control, ink and calendar treatment and by 16 percentage points in the bracelet treatment. However, it is difficult to interpret these effects since the text message treatment was bundled with a recruitment visit. Only individuals in the Social Info/Reminder treatments were visited by a surveyor who explained the text messages, obtained individuals' consent to participate in the intervention and reminded them about the upcoming community deworming program. Individuals in the SMS control group did not receive a visit. To shed further light on the potential mechanism we can look at the dynamic effect of Social Info/Reminders across the twelve days of deworming. Figure 15 shows that text messages had the largest effect on day one and two, as a result of the reminder that was sent the day before treatment started. The treatment effects become negligible on later days, suggesting that text messages sent on days 4, 6, 8 and 10 and the social information contained in them had no relevant effect on deworming decisions. It is therefore likely that the initial "nudge" and/or the private recruitment visit is what most influenced individuals' decision to take up treatment. -->

```{r take-up-level-struct, fig.width=8, fig.height=5.15,fig.cap="Take-up levels in response to a signaling intervention, holding the private consumption utility at the control level."}
dist_fit_data %>%
  filter(fct_match(model_type, "structural")) %>% 
  select(est_takeup_level, model, model_name, fit_type) %>% 
  unnest(est_takeup_level) %>% 
  filter(is.na(assigned_dist_group),
         fct_match(assigned_treatment, "control"), !is.na(mu_assigned_treatment)) %>%
  mutate(mu_assigned_treatment = factor(mu_assigned_treatment, levels = levels(assigned_treatment))) %>% 
  plot_estimands(mu_assigned_treatment) +
  scale_y_discrete(TeX("Assigned Signaling Treatment (z)"), labels = str_to_title) +
    labs(
      title = "Take-up levels in response to a signaling intervention, holding the private\nconsumption utility at the control level",
      subtitle = TeX("\\hat{E}\\[Y(z,\\bar{B}(control))\\]"),
      x = "Take-up Probability") +
  NULL
```

```{r take-up-ate-struct, fig.width=8, fig.height=4.5, fig.cap="Average treatment effect of signaling holding consumption utility at the control level, compared to control."}
dist_fit_data %>% 
  filter(fct_match(model_type, "structural")) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  filter(
    is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right),
    fct_match(assigned_treatment_left, "control"), fct_match(assigned_treatment_right, "control"),
    !is.na(mu_assigned_treatment_left),
    !fct_match(mu_assigned_treatment_left, "control"),
    fct_match(mu_assigned_treatment_right, "control"),
  ) %>%
  plot_estimands(mu_assigned_treatment_left) +
  scale_y_discrete("Assigned\nSignaling Treatment (z)", labels = str_to_title) +
    labs(
      title = "Average treatment effect of signaling holding consumption utility at the control level,\ncompared to control",
      subtitle = TeX("\\hat{E}\\[Y(z,\\bar{B}(control))\\] - \\hat{E}\\[Y(control)\\]"),
      x = "Average Treatment Effect") +
  NULL
```

Figure \ref{fig:take-up-level-struct} shows the take-up levels of the four incentive/signal treatments, holding the private consumption benefit (and social learning/salience) at the control level. This shows the take-up level if the the treatments had a social signaling effect of the bracelet, ink, or calendar plus the private consumption of the control arm. Figure \ref{fig:take-up-ate-struct} shows the average social-signaling-only treatment effects of the three incentive arms net the private consumption utility and the social signaling utility of the control arm.  We find that all treatments have a social signaling effect, albeit with greater uncertainty than seen with the intention-to-treat estimands. Bracelets have the 80% credible interval `r bracelet_vs_control_struct_ate_ci`, ink `r ink_vs_control_struct_ate_ci`, and calendars `r calendar_vs_control_struct_ate_ci`. While there is too much uncertainty to distinguish between bracelet and ink, we find it surprising that the upper bound of the ink's credible interval is much higher than the bracelet's. This suggests that the ink incentive has a negative consumption utility cancelling out any reputational benefit it might have as seen in the intention-to-treat analysis. Even more surprising is the significant reputational effect calendars have. Our intention in adding a calendar arm to the experiment was to introduce an incentive with low signaling and private consumption utility comparable to that of the bracelets.

### Result 2: The Effect of Cost on Deworming Take-up {-} 

```{r take-up-levels-dist-split, fig.width=8,fig.height=10.25, fig.cap="Take-up levels in response to an incentive treatment intervention, split by assigned\ndistance group."}
dist_fit_data %>%
  filter(!fct_match(model, "STRUCTURAL_STACKED")) %>% 
  mutate(est_takeup_level = map(est_takeup_level, filter, is.na(mu_assigned_treatment) | mu_assigned_treatment == assigned_treatment)) %>%  
  select(est_takeup_level, model, model_name, fit_type) %>% 
  unnest(est_takeup_level) %>% 
  filter(!is.na(assigned_dist_group)) %>% 
  plot_estimands(assigned_treatment) +
  scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
    labs(
      title = "Take-up levels in response to an incentive treatment intervention, split by assigned distance group",
      subtitle = TeX("\\hat{E}\\[Y(z,g)\\]"),
      x = "Take-up Probability") +
  facet_wrap(vars(assigned_dist_group), ncol = 1, labeller = as_labeller(. %>% str_c("g = ", .) %>% TeX(), default = label_parsed)) +
  NULL
```

```{r take-up-ate-dist-effect, fig.width=8,fig.height=6, fig.cap="Average treatment effect in response to a change in distance."}
dist_fit_data %>% 
  filter(!fct_match(model, "STRUCTURAL_STACKED")) %>% 
  mutate(est_takeup_te =
    map_if(est_takeup_te, 
           fct_match(model_type, "structural"), filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right) %>% 
    map(filter, 
        !is.na(assigned_dist_group_left) & !is.na(assigned_dist_group_right),
        fct_match(assigned_dist_group_left, "far"), fct_match(assigned_dist_group_right, "close"),
        assigned_treatment_left == assigned_treatment_right)) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  plot_estimands(assigned_treatment_left) +
  scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
    labs(
      title = "Average treatment effect in response to a change in distance", 
      subtitle = TeX("\\hat{E}\\[Y(z,far)\\] - \\hat{E}\\[Y(z,close)\\]"),
      x = "Average Treatment Effect") +
  NULL
```

```{r take-up-ate-dist-split, fig.width=8,fig.height=8, fig.cap="Average treatment effect in response to an incentive treatment intervention, split by distance."}
dist_fit_data %>% 
  filter(!fct_match(model, "STRUCTURAL_STACKED")) %>% 
  mutate(est_takeup_te =
    map_if(est_takeup_te, 
           fct_match(model_type, "structural"), filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right) %>% 
    map(filter, 
        !is.na(assigned_dist_group_left) & !is.na(assigned_dist_group_right),
        assigned_dist_group_left == assigned_dist_group_right,
        assigned_treatment_left != assigned_treatment_right,
        fct_match(assigned_treatment_right, c("control", "calendar")))) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  plot_estimands(assigned_treatment_left) +
  scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
    labs(
      title = "Average treatment effect in response to an incentive treatment intervention", 
      subtitle = TeX("\\hat{E}\\[Y(z,g)\\] - \\hat{E}\\[Y(z',g)\\]"),
      x = "Average Treatment Effect") +
  facet_grid(rows = vars(assigned_treatment_right), cols = vars(assigned_dist_group_right), 
             labeller = labeller(assigned_treatment_right = as_labeller( . %>% str_c("Compared to, $z' = ", ., "$") %>% TeX(), default = label_parsed),
                                 assigned_dist_group_right = as_labeller(. %>% str_c("g = ", .))), 
             scales = "free_y") +
  NULL
```

```{r take-up-ate-diff-dist-effect, fig.width=8,fig.height=6, fig.cap="Average difference in the average treatment effect in response to a change in assigned distance to treatment, compared against the control average treatment effect.", eval=FALSE}
dist_fit_data %>% 
  filter(!fct_match(model, "STRUCTURAL_STACKED")) %>% 
  select(est_takeup_dist_te, model, fit_type) %>% 
  unnest(est_takeup_dist_te) %>%
  plot_estimands(assigned_treatment_left) +
  scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
  labs(
    title = "Average difference in the average treatment effect in response to a change in\nassigned distance to treatment, compared against the control average treatment effect",
    subtitle = TeX("(\\hat{E}\\[Y_{z,g=far}\\] - \\hat{E}\\[Y_{z,g=close}\\]) - (\\hat{E}\\[Y_{control,g=far}\\] - \\hat{E}\\[Y_{control,g=close}\\])"),
    x = "Average Treatment Effect") +
  NULL
  
  # ggplot(aes(x = per_0.5, y = assigned_treatment_left, group = model)) +
  # ggstance::geom_crossbarh(aes(xmin = per_0.25, xmax = per_0.75, color = model), width = 0.25, position = plot_pos) +
  # ggstance::geom_crossbarh(aes(xmin = per_0.1, xmax = per_0.9, color = model), width = 0.4, position = plot_pos) +
  # # ggstance::geom_linerangeh(aes(xmin = per_0.01, xmax = per_0.99, color = model), linetype = "dotted", fatten = 3, size = 0.75, position = plot_pos) +
  # ggstance::geom_linerangeh(aes(xmin = per_0.05, xmax = per_0.95, color = model), fatten = 3, size = 0.8, position = plot_pos) +
  # geom_point(aes(x = mean_est, color = model), fatten = 3, position = plot_pos) +
  # geom_point(aes(x = mean_est), color = "white", size = 0.75, position = plot_pos) +
  # geom_vline(xintercept = 0, linetype = "dotted") +
  # scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
  # scale_color_manual("Model", values = model_colors, labels = select(dist_fit_data, model, model_name) %>% deframe()) +
  # theme(legend.position = "top", legend.direction = "vertical") +
  # guides(color = guide_legend(ncol = 3)) +
  # NULL
```

<!-- Similar to previous findings in the literature [@Kremer2007] a small increase in cost leads to a dramatic reduction in the demand for deworming treatment. Figure \ref{fig:static_level_smsctrl_dist} shows that an increase in the mean walking distance by 1 kilometer (from 0.86km to 1.86km) led to a drop in deworming take-up from 44 percent to 28 percent in the control group. This is a decrease of 64  percent. Since we randomly assigned individuals to far and close treatment locations, we were able to hold the underlying preference distribution $G(v)$ and the private valuation that individuals assign to incentives constant, while _only_ shifting the marginal person $\hat{v}$. Figure \ref{fig:static_ate_smsctrl_dist} shows the treatment effects by distance. The effect of calendar, a consumption incentive, is constant for far and close communities, increasing take-up by 3  percentage points. The average treatment effects of ink and bracelet, however, sizably increased at far distances where take-up is lower. The average treatment effect of bracelets doubled from 5.5  percentage points to 11  percentage points. As a result, the take-up level for far communities in the bracelet treatment is 41 percent which is close to the take-up level for close communities in the control group. In other words, the signaling effect almost fully compensated for the increase in deworming cost. This is provides suggestive evidence for that changes in $\hat{v}$ can lead to significant changes in reputational returns.   -->

Similar to previous findings in the literature [@Kremer2007] a small increase in cost leads to a dramatic reduction in the demand for deworming treatment. Figure \ref{fig:take-up-levels-dist-split} presents the take-up levels in response to the four treatments, split by their distance to deworming treatment, while Figure \ref{fig:take-up-ate-dist-effect} show the estimated effect of moving from _close_ to _far_ treatment. Consider the effect of moving from _close_ to _far_ in the control arm: as shown in Table \ref{tab:mean-assigned-dist}, on average this is a one kilometer increase in distance, and it has resulted in a decrease in take-up with the 80% credible interval `r control_distance_diff_ci`. In terms of posterior averages, this is a `r abs(round(control_distance_diff_mean / control_close_level_mean, 3)) * 100` percent drop in deworming take-up.

Figure \ref{fig:take-up-ate-dist-split} shows how the incentive/signal treatment effect differs at different distances. In this plot we also show comparisons with the control and calendar arm. Results are overall very similar to what we see in Figure \ref{fig:take-up-ate} with the exception of what appears to be a slightly stronger effect in the in the _far_ treatment. We do continue to see that bracelets have an effect when compared against calendars: the 80% credible intervals are `r bracelet_vs_calendar_close_ate_ci` and `r bracelet_vs_calendar_far_ate_ci` percentage points, in the _close_ and _far_, respectively. The stronger effect in the _far_ treatments suggests that signaling is more effective as the cost of deworming increases.

```{r take-up-ate-struct-dist-effect, fig.width=8,fig.height=6, fig.cap="Average treatment effect in response to a change in distance.", eval=FALSE}
dist_fit_data %>% 
  filter(fct_match(model_type, "structural")) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  filter(
    mu_assigned_treatment_left == mu_assigned_treatment_right,
    assigned_treatment_left == assigned_treatment_right,
    fct_match(assigned_treatment_left, "control"),
    fct_match(assigned_dist_group_left, "far"),
    fct_match(assigned_dist_group_right, "close")
  ) %>% 
  plot_estimands(mu_assigned_treatment_left) +
  scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
    labs(
      title = "Average treatment effect in response to a change in distance", 
      subtitle = TeX("\\hat{E}\\[Y_{z,\\bar{B}_{control,g=far}}\\] - \\hat{E}\\[Y_{z,\\bar{B}_{control,g=close}}\\]"),
      x = "Average Treatment Effect") +
  NULL

  # ggplot(aes(x = per_0.5, y = mu_assigned_treatment_left, group = model)) +
  # ggstance::geom_crossbarh(aes(xmin = per_0.25, xmax = per_0.75, color = model), width = 0.25, position = plot_pos) +
  # ggstance::geom_crossbarh(aes(xmin = per_0.1, xmax = per_0.9, color = model), width = 0.4, position = plot_pos) +
  # # ggstance::geom_linerangeh(aes(xmin = per_0.01, xmax = per_0.99, color = model), linetype = "dotted", fatten = 3, size = 0.75, position = plot_pos) +
  # ggstance::geom_linerangeh(aes(xmin = per_0.05, xmax = per_0.95, color = model), fatten = 3, size = 0.8, position = plot_pos) +
  # geom_point(aes(x = mean_est, color = model), fatten = 3, position = plot_pos) +
  # geom_point(aes(x = mean_est), color = "white", size = 0.75, position = plot_pos) +
  # geom_vline(xintercept = 0, linetype = "dotted") +
  # scale_color_manual("Model", values = select(dist_fit_data, model, model_color) %>% deframe(), labels = dist_fit_data %>% select(model, model_name) %>% deframe()) +
  # scale_y_discrete("Assigned Treatment (z)", labels = str_to_title) +
  #   labs(
  #     title = "Average treatment effect in response to a change in distance", 
  #     subtitle = TeX("\\hat{E}\\[Y_{z,\\bar{B}_{control,g=far}}\\] - \\hat{E}\\[Y_{z,\\bar{B}_{control,g=close}}\\]"),
  #     x = "Average Treatment Effect",
  #     caption = #"Dotted line range: 98% credible interval." 
  #               "Line range: 90% credible interval. 
  #                Outer box: 80% credible interval. Inner box: 50% credible interval. 
  #                Thick vertical line: median. Point: mean.") +
  # theme(legend.position = "top", legend.direction = "vertical",
  #       panel.border = element_rect(colour = "darkgrey", fill = NA)) +
  # guides(color = guide_legend(ncol = 3)) +
  # NULL
```

```{r take-up-level-struct-dist-split, fig.width=8, fig.height=8.5,fig.cap="Take-up levels in response to a signaling intervention, holding the private consumption utility at the control level."}
dist_fit_data %>%
  filter(fct_match(model_type, "structural")) %>% 
  select(est_takeup_level, model, model_name, fit_type) %>% 
  unnest(est_takeup_level) %>% 
  filter(!is.na(assigned_dist_group),
         fct_match(assigned_treatment, "control"), !is.na(mu_assigned_treatment)) %>%
  mutate(mu_assigned_treatment = factor(mu_assigned_treatment, levels = levels(assigned_treatment))) %>% 
  plot_estimands(mu_assigned_treatment) +
  scale_y_discrete(TeX("Assigned Signaling Treatment (z')"), labels = str_to_title) +
    labs(
      title = "Take-up levels in response to a signaling intervention,\nholding the private consumption utility at the control level",
      subtitle = TeX("\\hat{E}\\[Y(control,g,\\bar{B}(z'))\\]"),
      x = "Take-up Probability") +
  facet_wrap(vars(assigned_dist_group), ncol = 1, labeller = as_labeller(. %>% str_c("g = ", .) %>% TeX(), default = label_parsed)) +
  NULL
```


```{r take-up-ate-struct-dist-split, fig.width=8, fig.height=7.25, fig.cap="Average treatment effect of signaling holding consumption utility at the control level, compared to control."}
dist_fit_data %>% 
  filter(fct_match(model_type, "structural")) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  filter(
    !is.na(assigned_dist_group_left) & !is.na(assigned_dist_group_right),
    assigned_dist_group_left == assigned_dist_group_right,
    fct_match(assigned_treatment_left, "control"), fct_match(assigned_treatment_right, "control"),
    !is.na(mu_assigned_treatment_left),
    !fct_match(mu_assigned_treatment_left, "control"),
    fct_match(mu_assigned_treatment_right, "control"),
  ) %>%
  plot_estimands(mu_assigned_treatment_left) +
  scale_y_discrete("Assigned\nSignaling Treatment (z')", labels = str_to_title) +
  labs(
    title = "Average treatment effect of signaling holding consumption utility at the control level,\ncompared to control",
    subtitle = TeX("\\hat{E}\\[Y(control,g,\\bar{B}(z'))\\] - \\hat{E}\\[Y(control,g)\\]"),
    x = "Average Treatment Effect") +
  facet_wrap(vars(assigned_dist_group_right), ncol = 1, labeller = as_labeller(. %>% str_c("g = ", .) %>% TeX(), default = label_parsed)) +
  NULL
```


Figures \ref{fig:take-up-level-struct-dist-split} and \ref{fig:take-up-ate-struct-dist-split} shows the levels and average treatment effects, manipulating the structural model to elicit the pure social signaling effect holding the private consumption utility at the control level, at different distance assignments. Here, we see little difference between _close_ and _far_. 

As mentioned in section \ref{theoretical-framework}, the signaling effect can be amplified when take-up is high and cost could be mitigated when take-up is low. The signaling effect appears to be slightly stronger when the cost is higher (the _far_ treatments), as shown the intention-to-treat analysis, while on the other hand it appears to change very little when using the structural models. However, to properly investigate this we need to estimate the social multiplier effect as defined in equations \eqref{eq:partials-at-value}; in order to compare between arms we need to hold fixed the initial level of $V^*$, otherwise we would not be evaluating how the same marginal person is affected by a change in cost/benefit (we do this by manipulating the cost as already explained). 

In Figure \ref{fig:cost-mitig-level}, subfigure (a) shows the expected level of take-up over a range of simulated cutoff values, to clarify how the range of simulated $v$ alters take-up. As expected the lower the $v$ the higher the level of take-up. In subfigure (b) we show the rate of change of the equilibrium $V^*$ cutoff in response to cost, $\overline{C}$, at different initial cutoffs, $v$. We do observe both the amplification effect for $v<0$ and the cost mitigation effect for $v > 0$, for all treatments, but stronger (and very similar) for the bracelet, ink, and calendar. Subfigure (c) presents the same result but in terms of the probability of deworming take-up and how it changes in response to $\overline{C}$. However, neither looking at the rate of change in utility nor the probability of take-up is very informative; it is difficult to have a clear interpretation for utility outcomes and we cannot consider the incentive/signal treatments without comparing them to their control counterfactual. 

In Figure \ref{fig:cost-mitig-diff} we compare the estimated changes in $V*$ and $\expect{Y}$ in response to cost, $\overline{C}$, between the three incentive arms and the control arm, as in equations \eqref{eq:partials-diff}. The main pattern to notice is that the change in the take-up probability in response to changes to cost/benefit is quite low for all signals, even at high levels of $v$ (high cost, low take-up). The highest credible (with 80% probability) change, for bracelets, is no more than 0.02: bracelets are only 0.02 higher than control in response to a unit change in $\overline{C}$. Therefore, we conclude that cost mitigation likely played a small role in this experiment; the increase in cost driven by the assigned distance to deworming locations did not result in a pattern of take-up for the incentive arms that is very different from the control arm. We do not conclude that there is no cost mitigation, only that the signals provided did not generate enough reputational utility to counter the increasing cost of deworming in comparison with the control and its own natural level of social signaling. On the other hand, the magnitude of the amplification effect as $V^*$ drops and take-up becomes more of a norm appears to be relatively higher for the signal treatments than the control. However, since in this experiment take-up is not observed at such high levels we do not consider the model's predictions at this range of $V^*$ to be reliable. 


```{r cost-mitig-level, fig.width=8,fig.height=6,fig.cap="Changes in $V^*$ and $E[Y]$ in response $\\overline{C}$."}
treatment_colors <- set_names(RColorBrewer::brewer.pal(4, "Set1"), c("control", "ink", "calendar", "bracelet"))

takeup_v_plot <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural"), fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_STACKED")) %>% 
  select(model, model_name, y_rate_of_change, fit_type) %>% 
  unnest(y_rate_of_change) %>% 
  unpack(prob_takeup) %>% 
  filter(fct_match(assigned_treatment, "control")) %>% 
  ggplot(aes(v, per_0.5)) +
  geom_line() + 
  coord_cartesian(xlim = c(-1, 1)) +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9), alpha = 0.25) +
  labs(subtitle = "Take-up", 
       y = TeX("E\\[Y\\]")) +
       # caption = "Ribbon represents the 80% credible interval.") +
  NULL

social_mult_v_plot <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural"), fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_STACKED")) %>% 
  select(model, model_name, y_rate_of_change, fit_type) %>% 
  unnest(y_rate_of_change) %>% 
  unpack(social_multiplier) %>% 
  ggplot(aes(v, -per_0.5, color = assigned_treatment)) +
  geom_line() + 
  coord_cartesian(xlim = c(-1, 1)) +
  scale_color_manual("Assigned Treatment (z)", values = treatment_colors, labels = str_to_title) +
  labs(subtitle = "Social Multiplier", y = bquote(frac(partialdiff ~ V^"*", partialdiff ~ bar(C)))) + # TeX("Change in $V^*$")) +
  theme(legend.position = "right") +
  NULL

takeup_partial_v_plot <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural"), fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_STACKED")) %>% 
  select(model, model_name, y_rate_of_change, fit_type) %>% 
  unnest(y_rate_of_change) %>% 
  unpack(partial_bbar) %>% 
  ggplot(aes(v, -per_0.5, color = assigned_treatment)) +
  geom_line(show.legend = FALSE) + 
  coord_cartesian(xlim = c(-1, 1)) +
  scale_color_manual("Assigned Treatment (z)", values = treatment_colors) +
  labs(subtitle = "Rate-of-change of Take-up", y = bquote(frac(partialdiff ~ "E[Y]", partialdiff ~ bar(C)))) + # TeX("Change in $E\\[Y(z,\\bar{b})\\]$")) +
  theme(legend.position = "right") +
  NULL

plot_grid(
  takeup_v_plot, 
  social_mult_v_plot + theme(legend.position = "none"), 
  takeup_partial_v_plot,
  get_legend(social_mult_v_plot), 
 
  labels = c("(a)", "(b)", "(c)"), 
  label_fontface = "plain"
)
```

```{r cost-mitig-diff, fig.width=8,fig.height=6,fig.cap="Differences in changes in $V^*$ and $E[Y]$ in response to $\\overline{C}$."}
diff_social_mult_v_plot <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural"), fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_STACKED")) %>% 
  select(model, model_name, diff_y_rate_of_change, fit_type) %>% 
  unnest(diff_y_rate_of_change) %>%
  filter(!fct_match(assigned_treatment_left, "control"), fct_match(assigned_treatment_right, "control")) %>% 
  unpack(diff_social_multiplier) %>% 
  ggplot(aes(v, -per_0.5, color = assigned_treatment_left)) +
  geom_line(show.legend = FALSE) + 
  geom_ribbon(aes(ymin = -per_0.1, ymax = -per_0.9, fill = assigned_treatment_left), color = NA, alpha = 0.25, show.legend = FALSE) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  coord_cartesian(xlim = c(-1, 1)) +
  scale_color_manual("Assigned Treatment (z)", values = treatment_colors) +
  scale_fill_manual("Assigned Treatment (z)", values = treatment_colors) +
  labs(subtitle = "Social Multiplier Compared to Control Level", y = bquote(frac(partialdiff ~ V^"*", partialdiff ~ bar(C)) ~ "Difference")) + # TeX("Change in $V^*$")) +
  theme(legend.position = "bottom") +
  facet_wrap(vars(assigned_treatment_left), labeller = as_labeller(str_to_title)) +
  NULL

diff_takeup_partial_v_plot <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural"), fct_match(fit_type, "fit"), fct_match(model, "STRUCTURAL_STACKED")) %>% 
  select(model, model_name, diff_y_rate_of_change, fit_type) %>% 
  unnest(diff_y_rate_of_change) %>% 
  unpack(diff_partial_bbar) %>% 
  filter(!fct_match(assigned_treatment_left, "control"), fct_match(assigned_treatment_right, "control")) %>% 
  ggplot(aes(v, -per_0.5, color = assigned_treatment_left)) +
  geom_line(show.legend = FALSE) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_ribbon(aes(ymin = -per_0.1, ymax = -per_0.9, fill = assigned_treatment_left), color = NA, alpha = 0.25, show.legend = FALSE) +
  coord_cartesian(xlim = c(-1, 1)) +
  scale_color_manual("Assigned Treatment (z)", values = treatment_colors, labels = str_to_title) +
  scale_fill_manual("Assigned Treatment (z)", values = treatment_colors) +
  labs(subtitle = "Rate-of-change of Take-up Compared to Control Level", y = bquote(frac(partialdiff ~ "E[Y]", partialdiff ~ bar(C)) ~ "Difference")) + # TeX("Change in $E\\[Y(z,\\bar{b})\\]$")) +
  facet_wrap(vars(assigned_treatment_left), labeller = as_labeller(str_to_title)) +
  NULL

plot_grid(
  diff_social_mult_v_plot, 
  diff_takeup_partial_v_plot,
  # get_legend(diff_social_mult_v_plot), 
 
  labels = c("(a)", "(b)"), 
  label_fontface = "plain", 
  align = "h", axis = "b",
  ncol = 1
)
```

<!-- ## Dynamic Take-up Model Results -->

<!-- Figure \ref{fig:param-dyn-ate-all} repeats the analysis done in the static model (Figure \ref{fig:static_ate_smsctrl-2}), estimating average treatment effects for incentives/signals compared to the control arm with no SMS treatment. There are some differences from the static model results, but not surprisingly so, considering the stronger model assumptions we place in the dynamic model on how the utility for deworming evolves over the twelve days. -->

<!-- The main purpose of analyzing this dynamic model is to impute normally unobservable dynamic outcomes, namely, what would deworming take-up look like were we able to shut down any treatment dynamics beyond what is normally observed in the control arm (as mention in section \ref{dynamic-model}, the dynamic model's piecewise-constant proportional hazard parameters represent individual's baseline deworming day preference). The dynamic model has two sets of treatment effect parameters, static and dynamic: Static treatment effects capture the utility of deworming on day one, while the dynamic parameters of a quadratic model capture the time-varying utility of deworming. The static component thus captures both the private utility of deworming (assuming it is static over twelve days) _and_ individuals' estimated reputational returns of signaling using their prior beliefs about the take-up of others. The dynamic component of the model captures how individuals' estimated reputational returns evolve in response to what they observe about their peers' deworming take-up, _as well as potentially other unmodeled channels of social learning distinct from prosocial signaling_. Hence, in other to focus on signaling returns, we impute the treatment effect of social signals but restricting the dynamic component to be that of the control arm.  -->

<!-- Figure \ref{fig:param-dyn-ate-all-2}, reports the average treatment effect of bracelets and ink, net their dynamic effects. While out estimates are imprecise, we continue to observe some potential static effect to the bracelets treatment. Keeping in mind that this calculation of the static effect is very likely a downward biased estimate, this presents compelling evidence that reputational concerns are motivating individuals to seek treatment.    -->

```{r load-param-dyn-est-data, cache=FALSE,eval=FALSE}
load(file.path("stan_analysis_data", "dynamic_processed.RData"))
load(file.path("stan_analysis_data", str_interp("model_${dyn_fit_version}.RData")))
```

```{r param-dyn-ate-all, fig.width=8, fig.height=3, fig.cap="Dynamic model incentive/signal treatment effect.", eval=FALSE}
est_deworming_takeup_dyn_ate_all %>% 
  # filter(incentive_treatment_static_left != "bracelet social") %>% 
  filter(incentive_treatment_static_left != "bracelet") %>% #pull(incentive_treatment_static_left) %>% fct_recode("x" = "bracelet social")
  plot_ate(
    ate_summ_data = .,
    data_preparer = . %>% 
      filter(incentive_treatment_static_left == incentive_treatment_dynamic_left,
         incentive_treatment_static_right == incentive_treatment_dynamic_right,
         sms.treatment.2_static_left == "No SMS",
         sms.treatment.2_dynamic_left == "No SMS",
         sms.treatment.2_static_right == "No SMS",
         sms.treatment.2_dynamic_right == "No SMS",
         incentive_treatment_static_right %in% c("Control")), #, "Calendar")),
    
    include_sms_treatment = TRUE
  ) + # facet_grid(incentive_treatment_static_right ~ ., scales = "free_y", space = "free_y") +
  labs(title = "Dynamic Model Incentive/Signal Average Treatment Effect") + 
  theme(legend.position = "bottom")
```

```{r param-dyn-ate-all-2, fig.width=8, fig.height=3, fig.cap="Signaling treatment effects, net any dynamic effects.",eval=FALSE}
est_deworming_takeup_dyn_ate_all %>% 
  filter(incentive_treatment_static_left != "calendar") %>% 
  # filter(incentive_treatment_static_left != "bracelet social") %>% 
  # filter(incentive_treatment_static_left == "bracelet") %>%  #count(incentive_treatment_static_left, incentive_treatment_dynamic_left, incentive_treatment_static_right, incentive_treatment_dynamic_right)
  # count(incentive_treatment_static_left, incentive_treatment_dynamic_left)
  plot_ate(
    ate_summ_data = .,
    data_preparer = . %>% 
      filter(
         incentive_treatment_dynamic_left == "Control",
         incentive_treatment_dynamic_right == "Control",
         sms.treatment.2_static_left == "No SMS",
         sms.treatment.2_dynamic_left == "No SMS",
         sms.treatment.2_static_right == "No SMS",
         sms.treatment.2_dynamic_right == "No SMS",
         incentive_treatment_static_right %in% c("Control")), #, "Calendar")),
    
    include_sms_treatment = TRUE
  ) + #facet_grid(incentive_treatment_static_right ~ ., scales = "free_y", space = "free_y") +
  theme(legend.position = "bottom")
```

```{r param-dyn-daily-takeup-levels-all, fig.width=8, fig.height=4, fig.cap="Daily take-up non-cumulative proportion for all incentive/signal treatment arms (No SMS treatment).",eval=FALSE}
est_deworming_day_all %>% 
  mutate(full_observation = incentive_treatment_static == incentive_treatment_dynamic) %>% 
  filter(full_observation,
         incentive_treatment_static != "bracelet social",
         sms.treatment.2_static == sms.treatment.2_dynamic,
         sms.treatment.2_static == "control") %>% 
  plot_dyn_takeup_daily(control_observation = FALSE) +
  coord_cartesian(ylim = c(0, 0.12)) +
  theme(legend.position = "bottom")
```

```{r param-dyn-daily-takeup-levels-with-sms, fig.width=7, fig.height=4, fig.cap="Daily take-up non-cumulative proportion for all incentive/signal treatments and SMS treatments (phone owners only).", eval=FALSE}
est_deworming_day_all %>% 
  mutate(full_observation = incentive_treatment_static == incentive_treatment_dynamic) %>% 
  filter(full_observation,
         incentive_treatment_static != "bracelet social",
         sms.treatment.2_static == sms.treatment.2_dynamic) %>% 
  # filter(full_observation | incentive_treatment_dynamic == "control") %>% 
  plot_dyn_takeup_daily(control_observation = FALSE, include_sms_treatment = TRUE) +
  coord_cartesian(ylim = c(0, 0.21)) +
  facet_wrap(~ incentive_treatment_static, nrow = 1) +
  theme(legend.position = "bottom", axis.text.x = element_text(size = 5))
```


```{r param-dyn-daily-takeup-levels-dist, fig.width=7, fig.height=4, fig.cap="Daily take-up non-cumulative proportion for all incentive/signal treatment arms (No SMS treatment), split by distance.", eval=FALSE}
est_deworming_day_dist %>% 
  mutate(full_observation = incentive_treatment_static == incentive_treatment_dynamic) %>% 
  filter(full_observation,
         incentive_treatment_static != "bracelet social",
         incentive_treatment_static == incentive_treatment_dynamic,
         sms.treatment.2_static == sms.treatment.2_dynamic,
         sms.treatment.2_static == "control",
         dist.pot.group_static == dist.pot.group_dynamic) %>% 
  mutate_at(vars(starts_with("dist.pot.group_static")), lst(~ fct_relabel(., str_to_title))) %>% 
  plot_dyn_takeup_daily() +
  facet_wrap(~ dist.pot.group_static, nrow = 1, scales = "free_y") +
  # scale_color_brewer("Incentive/Signal Treatment", type = "div", palette = "Spectral") +
  coord_cartesian(ylim = c(0, 0.13)) +
  theme(legend.position = "bottom")
```

```{r param-dyn-daily-takeup-levels-dist-with-sms, fig.width=8, fig.height=5, fig.cap="Daily take-up non-cumulative proportion for all incentive/signal treatments and SMS treatments (phone owners only), split by distance.", eval=FALSE}
est_deworming_day_dist %>% 
  mutate(full_observation = incentive_treatment_static == incentive_treatment_dynamic) %>% 
  filter(full_observation,
         incentive_treatment_static != "bracelet social",
         incentive_treatment_static == incentive_treatment_dynamic,
         sms.treatment.2_static == sms.treatment.2_dynamic,
         dist.pot.group_static == dist.pot.group_dynamic) %>% 
  mutate_at(vars(starts_with("dist.pot.group_static")), funs(fct_relabel(., str_to_title))) %>% 
  plot_dyn_takeup_daily(control_observation = FALSE, include_sms_treatment = TRUE) +
  # scale_color_brewer("SMS Treatment", type = "qual", palette = "Set2") +
  labs(subtitle = "Split by distance to point of treatment. For phone owners only.") + #+ facet_wrap(~ name_matched_left)
  # scale_color_brewer("SMS Treatment", type = "div", palette = "RdBu") +
  coord_cartesian(ylim = c(0, 0.24)) +
  facet_grid(dist.pot.group_static ~ incentive_treatment_static) +
  theme(legend.position = "bottom")
```

# Conclusion

This paper provides field experimental evidence on the effects of social signaling in the context of deworming. Working with the Kenyan Government, we introduced a new community deworming program where adults were offered free deworming treatment at central locations. We show that a social signal can lead to meaningful increases in deworming take-up and outperform material incentives. Our experiment overcomes a main identification challenges: separating the social signaling effect from the private consumption effect and the social learning/salience effect. We do this combining the experiment's randomized intervention and a structural causal model motivated by a theoretical social signaling model. Furthermore, in our study's context, we find that increasing costs by manipulating the distance to deworming treatment had a small cost mitigating effect. We believe that this research can be extended in several directions. First, it will be important to test whether social signals can have similar effects on take-up in future rounds of community deworming. Once community deworming is no longer novel and the signals are repeatedly implemented, will treatment effects disappear or could they increase as signals could contribute to forming stronger norms around community deworming. Second, it would be helpful to extend the range of costs and benefits to learn more about cost mitigation and utility amplification. It would be crucial to learn whether signaling could be utilized to extend the catchment area of centralized treatment locations and/or could be used to amplify private incentives.  


<!-- This paper provides field experimental evidence on the effects of social signaling in the context of deworming. Working with the Kenyan Government, we introduced a new community deworming program where adults were offered free deworming treatment at central locations. We show that a social signal can lead to meaningful increases in deworming take-up and outperform material incentives. Our experiment overcomes a main identification challenge when introducing visibility in actions in setting where individuals make decisions sequentially. Further, we show that the impact of signals varies with the cost of the action and therefore average take-up levels. Signals have large effects at low take-up levels, consistent with signaling models where reputational returns are higher as signals become more informative about types. We also provide evidence of the powerful nature of private nudges. The SMS treatment had the unintended consequence of being most effective in increasing deworming take-up. We believe that this research can be extended in several directions. First, it will be important to test whether social signals can have similar effects on take-up in future rounds of community deworming. Once community deworming is no longer novel and the signals are repeatedly implemented, will treatment effects disappear or could they increase as signals could contribute to forming stronger norms around community deworming. Second, given the large effects of private text message nudges it will be important to understand if the effects are dependent on the initial in-person recruitment that was part of this experiment, or if we could send simple text message reminders to all households in Kenya and thereby increase deworming take-up. -->

# Appendix A: Reduced Form Regression Results {-}

Figures \ref{fig:ols-no-sms}-\ref{fig:ols-sms-dist} present the OLS stratified regression analysis results, using robust standard errors clustered at the village level [@Imbens2015]. The overall pattern of effects (direction and magnitudes) is similar to the main analysis results in section \ref{results}. As expected, estimates are not exactly the same. Regression analyses report sample and null hypothesis test statistics, while multilevel Bayesian analyses rely on generative models to impute counterfactuals and calculate causal estimands. Using a null hypothesis testing framework with multiple comparisons is vulnerable to picking up spurious statistically significant effects [@Gelman2008;@Young2017], and thus we use a multilevel model to provide more conservative estimands and to avoid over-fitting.

```{r ols-basic-reg}
reg.output.sms.ctrl.covar <- analysis.data %>%  
  filter(monitored, sms.treatment.2 == "sms.control") %>% #, !hh.baseline.sample) %>% 
  anti_join(outlier.cells, c("assigned.treatment","sms.treatment", "mon_status", "cluster.id", "phone_owner")) %>% 
  run_strat_reg(dewormed.any ~ assigned.treatment, .strat.by = "county_dist_stratum", .cluster = "cluster.id", .covariates = reg.covar)

reg.output.sms.ctrl.dist.covar <- analysis.data %>%  
  filter(monitored, sms.treatment.2 == "sms.control") %>% #, !hh.baseline.sample) %>% 
  anti_join(outlier.cells, c("assigned.treatment","sms.treatment", "mon_status", "cluster.id", "phone_owner")) %>% 
  run_strat_reg(dewormed.any ~ assigned.treatment * dist.pot.group, .strat.by = "county", .cluster = "cluster.id", .covariates = reg.covar)

reg.output.sms.treat.covar <- analysis.data %>%  
  filter(monitored, sms.treated | have_phone == "Yes") %>% #, !hh.baseline.sample) %>% 
  anti_join(outlier.cells, c("assigned.treatment","sms.treatment", "mon_status", "cluster.id", "phone_owner")) %>% 
  mutate(sms.treatment = sms.treatment.2) %>% 
  run_strat_reg(dewormed.any ~ assigned.treatment * sms.treatment, .strat.by = "county_dist_stratum", .cluster = "cluster.id", .covariates = setdiff(reg.covar, "sms.ctrl.subpop"))

reg.output.sms.treat.dist.covar <- analysis.data %>%  
  filter(monitored, sms.treated | have_phone == "Yes") %>% #, !hh.baseline.sample) %>% 
  anti_join(outlier.cells, c("assigned.treatment","sms.treatment", "mon_status", "cluster.id", "phone_owner")) %>% 
  mutate(sms.treatment = sms.treatment.2) %>% 
  run_strat_reg(dewormed.any ~ assigned.treatment * sms.treatment * dist.pot.group, .strat.by = "county", .cluster = "cluster.id", .covariates = setdiff(reg.covar, "sms.ctrl.subpop"))
```

```{r ols-no-sms, fig.width=8, fig.height=4, fig.cap="OLS Regression Incentive/Signal Treatment Effects Analysis (No SMS Treatment)."}
prep.sms.ctrl.plot.data(reg.output.sms.ctrl.covar) %>% 
  filter(ref.treatment == "Control") %>% 
  plot.sms.ctrl.takeup(.facet.formula = NULL) + 
  theme(legend.position = "bottom") +
  coord_flip()
```

```{r ols-no-sms-dist, fig.width=8, fig.height=6, fig.cap="OLS Regression Incentive/Signal Treatment Effects Analysis (No SMS Treatment), Split By Distance."}
prep.sms.ctrl.plot.data(reg.output.sms.ctrl.dist.covar, .interact.with = "far") %>% 
  filter(ref.treatment == "Control") %>% 
  mutate(grp = factor(grp, levels = c("ref.grp", "compare.grp"), labels = c("Close", "Far"))) %>% 
  plot.sms.ctrl.takeup(.facet.formula = grp ~ .) +
  coord_flip()
```

```{r ols-with-sms, fig.height=4, fig.width=8, fig.cap="OLS Regression Incentive/Signal and SMS Treatment Effects Analysis (Phone Owners Only)."}
prep.sms.treat.plot.data(reg.output.sms.treat.covar) %>% 
  plot.sms.treat.takeup() +
  coord_flip()
```

```{r ols-sms-dist, fig.width=8, fig.height=6, fig.cap="OLS Regression Incentive/Signal and SMS Treatment Effects Analysis (Phone Owners Only), Split By Distance."}
prep.sms.treat.dist.plot.data(reg.output.sms.treat.dist.covar) %>% {
  plot.sms.treat.takeup(.) +
    facet_grid(dist ~ .) +
    labs(subtitle = "Split by distance.") +
    coord_flip()
}
```

# Appendix B: Flyers {-}

```{r control-flyer-img, fig.width=8, out.width="4in", fig.cap="Control group flyer distributed by Community Health Volunteers to all households prior to the start of the deworming program. Message on the flyer says: \"Treat worms: improve the health of your community. Help to eradicate/fight worms in your community. Where: [Cluster's Treatment Location]. When: [Dates Wave 1/2]. Medicines will be provided free of charge. Kenya's government against worms treatment for people over age 18.\""}
knitr::include_graphics(file.path("images", "flyer_control.png"))
```

```{r ink-flyer-img, fig.width=8, out.width="4in", fig.cap="Ink group flyer distributed by Community Health Volunteers to all households prior to the start of the deworming program. Message is identical to Control group and includes added message: \"Show your support by putting ink thumb\"."}
knitr::include_graphics(file.path("images", "flyer_ink.png"))
```

```{r calendar-flyer-img, fig.width=8, out.width="4in", fig.cap="Calendar group flyer distributed by Community Health Volunteers to all households prior to the start of the deworming program. Message is identical to Control group and includes added message: \"You will be given a calendar as a gift.\""}
knitr::include_graphics(file.path("images", "flyer_calendar.png"))
```

```{r bracelet-flyer-img, fig.width=8, out.width="4in", fig.cap="Bracelet group flyer distributed by Community Health Volunteers to all households prior to the start of the deworming program. Message is identical to Control group and includes added message: \"You will be given a bracelet as a gift.\""}
knitr::include_graphics(file.path("images", "flyer_bracelet.png"))
```

# References {-}

<div id="refs"></div>
